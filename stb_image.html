<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <title>stb_image.h</title>
  <link rel="stylesheet" href="pycco.css">
</head>
<body>
<div id='container'>
  <div id="background"></div>
  <div class='section'>
    <div class='docs'><h1>stb_image.h</h1></div>
  </div>
  <div class='clearall'>
  <div class='section' id='section-0'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-0'>#</a>
      </div>
      <p>stb_image - v2.12 - public domain image loader - http://nothings.org/stb_image.h
                                    no warranty implied; use at your own risk</p>
<p>Do this:
     #define STB_IMAGE_IMPLEMENTATION
  before you include this file in <em>one</em> C or C++ file to create the implementation.</p>
<p>// i.e. it should look like this:
  #include ...
  #include ...
  #include ...
  #define STB_IMAGE_IMPLEMENTATION
  #include "stb_image.h"</p>
<p>You can #define STBI_ASSERT(x) before the #include to avoid using assert.h.
  And #define STBI_MALLOC, STBI_REALLOC, and STBI_FREE to avoid using malloc,realloc,free</p>
<p>QUICK NOTES:
     Primarily of interest to game developers and other people who can
         avoid problematic images and only need the trivial interface</p>
<pre><code> JPEG baseline &amp; progressive (12 bpc/arithmetic not supported, same as stock IJG lib)
 PNG 1/2/4/8-bit-per-channel (16 bpc not supported)

 TGA (not sure what subset, if a subset)
 BMP non-1bpp, non-RLE
 PSD (composited view only, no extra channels, 8/16 bit-per-channel)

 GIF (*comp always reports as 4-channel)
 HDR (radiance rgbE format)
 PIC (Softimage PIC)
 PNM (PPM and PGM binary only)

 Animated GIF still needs a proper API, but here's one way to do it:
     http://gist.github.com/urraka/685d9a6340b26b830d49

 - decode from memory or through FILE (define STBI_NO_STDIO to remove code)
 - decode from arbitrary I/O callbacks
 - SIMD acceleration on x86/x64 (SSE2) and ARM (NEON)
</code></pre>
<p>Full documentation under "DOCUMENTATION" below.</p>
<p>Revision 2.00 release notes:</p>
<pre><code> - Progressive JPEG is now supported.

 - PPM and PGM binary formats are now supported, thanks to Ken Miller.

 - x86 platforms now make use of SSE2 SIMD instructions for
   JPEG decoding, and ARM platforms can use NEON SIMD if requested.
   This work was done by Fabian "ryg" Giesen. SSE2 is used by
   default, but NEON must be enabled explicitly; see docs.

   With other JPEG optimizations included in this version, we see
   2x speedup on a JPEG on an x86 machine, and a 1.5x speedup
   on a JPEG on an ARM machine, relative to previous versions of this
   library. The same results will not obtain for all JPGs and for all
   x86/ARM machines. (Note that progressive JPEGs are significantly
   slower to decode than regular JPEGs.) This doesn't mean that this
   is the fastest JPEG decoder in the land; rather, it brings it
   closer to parity with standard libraries. If you want the fastest
   decode, look elsewhere. (See "Philosophy" section of docs below.)

   See final bullet items below for more info on SIMD.

 - Added STBI_MALLOC, STBI_REALLOC, and STBI_FREE macros for replacing
   the memory allocator. Unlike other STBI libraries, these macros don't
   support a context parameter, so if you need to pass a context in to
   the allocator, you'll have to store it in a global or a thread-local
   variable.

 - Split existing STBI_NO_HDR flag into two flags, STBI_NO_HDR and
   STBI_NO_LINEAR.
       STBI_NO_HDR:     suppress implementation of .hdr reader format
       STBI_NO_LINEAR:  suppress high-dynamic-range light-linear float API

 - You can suppress implementation of any of the decoders to reduce
   your code footprint by #defining one or more of the following
   symbols before creating the implementation.

       STBI_NO_JPEG
       STBI_NO_PNG
       STBI_NO_BMP
       STBI_NO_PSD
       STBI_NO_TGA
       STBI_NO_GIF
       STBI_NO_HDR
       STBI_NO_PIC
       STBI_NO_PNM   (.ppm and .pgm)

 - You can request *only* certain decoders and suppress all other ones
   (this will be more forward-compatible, as addition of new decoders
   doesn't require you to disable them explicitly):

       STBI_ONLY_JPEG
       STBI_ONLY_PNG
       STBI_ONLY_BMP
       STBI_ONLY_PSD
       STBI_ONLY_TGA
       STBI_ONLY_GIF
       STBI_ONLY_HDR
       STBI_ONLY_PIC
       STBI_ONLY_PNM   (.ppm and .pgm)

    Note that you can define multiples of these, and you will get all
    of them ("only x" and "only y" is interpreted to mean "only x&amp;y").

  - If you use STBI_NO_PNG (or _ONLY_ without PNG), and you still
    want the zlib decoder to be available, #define STBI_SUPPORT_ZLIB

 - Compilation of all SIMD code can be suppressed with
       #define STBI_NO_SIMD
   It should not be necessary to disable SIMD unless you have issues
   compiling (e.g. using an x86 compiler which doesn't support SSE
   intrinsics or that doesn't support the method used to detect
   SSE2 support at run-time), and even those can be reported as
   bugs so I can refine the built-in compile-time checking to be
   smarter.

 - The old STBI_SIMD system which allowed installing a user-defined
   IDCT etc. has been removed. If you need this, don't upgrade. My
   assumption is that almost nobody was doing this, and those who
   were will find the built-in SIMD more satisfactory anyway.

 - RGB values computed for JPEG images are slightly different from
   previous versions of stb_image. (This is due to using less
   integer precision in SIMD.) The C code has been adjusted so
   that the same RGB values will be computed regardless of whether
   SIMD support is available, so your app should always produce
   consistent results. But these results are slightly different from
   previous versions. (Specifically, about 3% of available YCbCr values
   will compute different RGB results from pre-1.49 versions by +-1;
   most of the deviating values are one smaller in the G channel.)

 - If you must produce consistent results with previous versions of
   stb_image, #define STBI_JPEG_OLD and you will get the same results
   you used to; however, you will not get the SIMD speedups for
   the YCbCr-to-RGB conversion step (although you should still see
   significant JPEG speedup from the other changes).

   Please note that STBI_JPEG_OLD is a temporary feature; it will be
   removed in future versions of the library. It is only intended for
   near-term back-compatibility use.
</code></pre>
<p>Latest revision history:
     2.12  (2016-04-02) fix typo in 2.11 PSD fix that caused crashes
     2.11  (2016-04-02) 16-bit PNGS; enable SSE2 in non-gcc x64
                        RGB-format JPEG; remove white matting in PSD;
                        allocate large structures on the stack; 
                        correct channel count for PNG &amp; BMP
     2.10  (2016-01-22) avoid warning introduced in 2.09
     2.09  (2016-01-16) 16-bit TGA; comments in PNM files; STBI_REALLOC_SIZED
     2.08  (2015-09-13) fix to 2.07 cleanup, reading RGB PSD as RGBA
     2.07  (2015-09-13) partial animated GIF support
                        limited 16-bit PSD support
                        minor bugs, code cleanup, and compiler warnings
     2.06  (2015-04-19) fix bug where PSD returns wrong '<em>comp' value
     2.05  (2015-04-19) fix bug in progressive JPEG handling, fix warning
     2.04  (2015-04-15) try to re-enable SIMD on MinGW 64-bit
     2.03  (2015-04-12) additional corruption checking
                        stbi_set_flip_vertically_on_load
                        fix NEON support; fix mingw support
     2.02  (2015-01-19) fix incorrect assert, fix warning
     2.01  (2015-01-17) fix various warnings
     2.00b (2014-12-25) fix STBI_MALLOC in progressive JPEG
     2.00  (2014-12-25) optimize JPEG, including x86 SSE2 &amp; ARM NEON SIMD
                        progressive JPEG
                        PGM/PPM support
                        STBI_MALLOC,STBI_REALLOC,STBI_FREE
                        STBI_NO_</em>, STBI_ONLY_*
                        GIF bugfix</p>
<p>See end of file for full revision history.</p>
<p>============================    Contributors    =========================</p>
<p>Image formats                          Extensions, features
   Sean Barrett (jpeg, png, bmp)          Jetro Lauha (stbi_info)
   Nicolas Schulz (hdr, psd)              Martin "SpartanJ" Golini (stbi_info)
   Jonathan Dummer (tga)                  James "moose2000" Brown (iPhone PNG)
   Jean-Marc Lienher (gif)                Ben "Disch" Wenger (io callbacks)
   Tom Seddon (pic)                       Omar Cornut (1/2/4-bit PNG)
   Thatcher Ulrich (psd)                  Nicolas Guillemot (vertical flip)
   Ken Miller (pgm, ppm)                  Richard Mitton (16-bit PSD)
   urraka@github (animated gif)           Junggon Kim (PNM comments)
                                          Daniel Gibson (16-bit TGA)</p>
<p>Optimizations &amp; bugfixes
   Fabian "ryg" Giesen
   Arseny Kapoulkine</p>
<p>Bug &amp; warning fixes
   Marc LeBlanc            David Woo          Guillaume George   Martins Mozeiko
   Christpher Lloyd        Martin Golini      Jerry Jansson      Joseph Thomson
   Dave Moore              Roy Eltham         Hayaki Saito       Phil Jordan
   Won Chun                Luke Graham        Johan Duparc       Nathan Reed
   the Horde3D community   Thomas Ruf         Ronny Chevalier    Nick Verigakis
   Janez Zemva             John Bartholomew   Michal Cichon      svdijk@github
   Jonathan Blow           Ken Hamada         Tero Hanninen      Baldur Karlsson
   Laurent Gomila          Cort Stratton      Sergio Gonzalez    romigrou@github
   Aruelien Pocheville     Thibault Reuille   Cass Everitt       Matthew Gregan
   Ryamond Barbiero        Paul Du Bois       Engin Manap        snagar@github
   Michaelangel007@github  Oriol Ferrer Mesia socks-the-fox
   Blazej Dariusz Roszkowski</p>
<p>LICENSE</p>
<p>This software is dual-licensed to the public domain and under the following
license: you are granted a perpetual, irrevocable license to copy, modify,
publish, and distribute this file as you see fit.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span></span><span class="err">*/</span>

<span class="cp">#ifndef STBI_INCLUDE_STB_IMAGE_H</span>
<span class="cp">#define STBI_INCLUDE_STB_IMAGE_H</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-1'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-1'>#</a>
      </div>
      <p>DOCUMENTATION</p>
<p>Limitations:
   - no 16-bit-per-channel PNG
   - no 12-bit-per-channel JPEG
   - no JPEGs with arithmetic coding
   - no 1-bit BMP
   - GIF always returns *comp=4</p>
<p>Basic usage (see HDR discussion below for HDR usage):
   int x,y,n;
   unsigned char *data = stbi_load(filename, &amp;x, &amp;y, &amp;n, 0);
   // ... process data if not NULL ...
   // ... x = width, y = height, n = # 8-bit components per pixel ...
   // ... replace '0' with '1'..'4' to force that many components per pixel
   // ... but 'n' will always be the number that it would have been if you said 0
   stbi_image_free(data)</p>
<p>Standard parameters:
   int <em>x       -- outputs image width in pixels
   int </em>y       -- outputs image height in pixels
   int *comp    -- outputs # of image components in image file
   int req_comp -- if non-zero, # of image components requested in result</p>
<p>The return value from an image loader is an 'unsigned char <em>' which points
to the pixel data, or NULL on an allocation failure or if the image is
corrupt or invalid. The pixel data consists of </em>y scanlines of <em>x pixels,
with each pixel consisting of N interleaved 8-bit components; the first
pixel pointed to is top-left-most in the image. There is no padding between
image scanlines or between pixels, regardless of format. The number of
components N is 'req_comp' if req_comp is non-zero, or </em>comp otherwise.
If req_comp is non-zero, <em>comp has the number of components that <em>would</em>
have been output otherwise. E.g. if you set req_comp to 4, you will always
get RGBA output, but you can check </em>comp to see if it's trivially opaque
because e.g. there were only 3 channels in the source image.</p>
<p>An output image with N components has the following components interleaved
in this order in each pixel:</p>
<pre><code>N=#comp     components
  1           grey
  2           grey, alpha
  3           red, green, blue
  4           red, green, blue, alpha
</code></pre>
<p>If image loading fails for any reason, the return value will be NULL,
and <em>x, </em>y, *comp will be unchanged. The function stbi_failure_reason()
can be queried for an extremely brief, end-user unfriendly explanation
of why the load failed. Define STBI_NO_FAILURE_STRINGS to avoid
compiling these strings at all, and STBI_FAILURE_USERMSG to get slightly
more user-friendly ones.</p>
<p>Paletted PNG, BMP, GIF, and PIC images are automatically depalettized.</p>
<p>===========================================================================</p>
<p>Philosophy</p>
<p>stb libraries are designed with the following priorities:</p>
<ol>
<li>easy to use</li>
<li>easy to maintain</li>
<li>good performance</li>
</ol>
<p>Sometimes I let "good performance" creep up in priority over "easy to maintain",
and for best performance I may provide less-easy-to-use APIs that give higher
performance, in addition to the easy to use ones. Nevertheless, it's important
to keep in mind that from the standpoint of you, a client of this library,
all you care about is #1 and #3, and stb libraries do not emphasize #3 above all.</p>
<p>Some secondary priorities arise directly from the first two, some of which
make more explicit reasons why performance can't be emphasized.</p>
<ul>
<li>Portable ("ease of use")</li>
<li>Small footprint ("easy to maintain")</li>
<li>No dependencies ("ease of use")</li>
</ul>
<p>===========================================================================</p>
<p>I/O callbacks</p>
<p>I/O callbacks allow you to read from arbitrary sources, like packaged
files or some other source. Data read from callbacks are processed
through a small internal buffer (currently 128 bytes) to try to reduce
overhead.</p>
<p>The three functions you must define are "read" (reads some bytes of data),
"skip" (skips some bytes of data), "eof" (reports if the stream is at the end).</p>
<p>===========================================================================</p>
<p>SIMD support</p>
<p>The JPEG decoder will try to automatically use SIMD kernels on x86 when
supported by the compiler. For ARM Neon support, you must explicitly
request it.</p>
<p>(The old do-it-yourself SIMD API is no longer supported in the current
code.)</p>
<p>On x86, SSE2 will automatically be used when available based on a run-time
test; if not, the generic C versions are used as a fall-back. On ARM targets,
the typical path is to have separate builds for NEON and non-NEON devices
(at least this is true for iOS and Android). Therefore, the NEON support is
toggled by a build flag: define STBI_NEON to get NEON loops.</p>
<p>The output of the JPEG decoder is slightly different from versions where
SIMD support was introduced (that is, for versions before 1.49). The
difference is only +-1 in the 8-bit RGB channels, and only on a small
fraction of pixels. You can force the pre-1.49 behavior by defining
STBI_JPEG_OLD, but this will disable some of the SIMD decoding path
and hence cost some performance.</p>
<p>If for some reason you do not want to use any of SIMD code, or if
you have issues compiling it, you can disable it entirely by
defining STBI_NO_SIMD.</p>
<p>===========================================================================</p>
<p>HDR image support   (disable by defining STBI_NO_HDR)</p>
<p>stb_image now supports loading HDR images in general, and currently
the Radiance .HDR file format, although the support is provided
generically. You can still load any file through the existing interface;
if you attempt to load an HDR file, it will be automatically remapped to
LDR, assuming gamma 2.2 and an arbitrary scale factor defaulting to 1;
both of these constants can be reconfigured through this interface:</p>
<pre><code>stbi_hdr_to_ldr_gamma(2.2f);
stbi_hdr_to_ldr_scale(1.0f);
</code></pre>
<p>(note, do not use <em>inverse</em> constants; stbi_image will invert them
appropriately).</p>
<p>Additionally, there is a new, parallel interface for loading files as
(linear) floats to preserve the full dynamic range:</p>
<p>float *data = stbi_loadf(filename, &amp;x, &amp;y, &amp;n, 0);</p>
<p>If you load LDR images through this interface, those images will
be promoted to floating point values, run through the inverse of
constants corresponding to the above:</p>
<pre><code>stbi_ldr_to_hdr_scale(1.0f);
stbi_ldr_to_hdr_gamma(2.2f);
</code></pre>
<p>Finally, given a filename (or an open file or memory block--see header
file for details) containing image data, you can query for the "most
appropriate" interface to use (that is, whether the image is HDR or
not), using:</p>
<pre><code>stbi_is_hdr(char *filename);
</code></pre>
<p>===========================================================================</p>
<p>iPhone PNG support:</p>
<p>By default we convert iphone-formatted PNGs back to RGB, even though
they are internally encoded differently. You can disable this conversion
by by calling stbi_convert_iphone_png_to_rgb(0), in which case
you will always just get the native iphone "format" through (which
is BGR stored in RGB).</p>
<p>Call stbi_set_unpremultiply_on_load(1) as well to force a divide per
pixel to remove any premultiplied alpha <em>only</em> if the image file explicitly
says there's premultiplied data (currently only happens in iPhone images,
and only if iPhone convert-to-rgb processing is on).</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="cp">#ifndef STBI_NO_STDIO</span>
<span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<span class="cp">#endif </span><span class="c1">// STBI_NO_STDIO</span>

<span class="cp">#define STBI_VERSION 1</span>

<span class="k">enum</span>
<span class="p">{</span>
   <span class="n">STBI_default</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="c1">// only used for req_comp</span>

   <span class="n">STBI_grey</span>       <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
   <span class="n">STBI_grey_alpha</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
   <span class="n">STBI_rgb</span>        <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
   <span class="n">STBI_rgb_alpha</span>  <span class="o">=</span> <span class="mi">4</span>
<span class="p">};</span>

<span class="k">typedef</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">stbi_uc</span><span class="p">;</span>

<span class="cp">#ifdef __cplusplus</span>
<span class="k">extern</span> <span class="s">&quot;C&quot;</span> <span class="p">{</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef STB_IMAGE_STATIC</span>
<span class="cp">#define STBIDEF static</span>
<span class="cp">#else</span>
<span class="cp">#define STBIDEF extern</span>
<span class="cp">#endif</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-2'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-2'>#</a>
      </div>
      <p>////////////////////////////////////////////////////////////////////////////</p>
<p>PRIMARY API - works on images of any type</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-3'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-3'>#</a>
      </div>
      <p>load image by filename, open file, or memory buffer</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">typedef</span> <span class="k">struct</span>
<span class="p">{</span>
   <span class="kt">int</span>      <span class="p">(</span><span class="o">*</span><span class="n">read</span><span class="p">)</span>  <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">user</span><span class="p">,</span><span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span><span class="kt">int</span> <span class="n">size</span><span class="p">);</span>   <span class="c1">// fill &#39;data&#39; with &#39;size&#39; bytes.  return number of bytes actually read</span>
   <span class="kt">void</span>     <span class="p">(</span><span class="o">*</span><span class="n">skip</span><span class="p">)</span>  <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">user</span><span class="p">,</span><span class="kt">int</span> <span class="n">n</span><span class="p">);</span>                 <span class="c1">// skip the next &#39;n&#39; bytes, or &#39;unget&#39; the last -n bytes if negative</span>
   <span class="kt">int</span>      <span class="p">(</span><span class="o">*</span><span class="n">eof</span><span class="p">)</span>   <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">user</span><span class="p">);</span>                       <span class="c1">// returns nonzero if we are at end of file/data</span>
<span class="p">}</span> <span class="n">stbi_io_callbacks</span><span class="p">;</span>

<span class="n">STBIDEF</span> <span class="n">stbi_uc</span> <span class="o">*</span><span class="nf">stbi_load</span>               <span class="p">(</span><span class="kt">char</span>              <span class="k">const</span> <span class="o">*</span><span class="n">filename</span><span class="p">,</span>           <span class="kt">int</span> <span class="o">*</span><span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">y</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">comp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">req_comp</span><span class="p">);</span>
<span class="n">STBIDEF</span> <span class="n">stbi_uc</span> <span class="o">*</span><span class="nf">stbi_load_from_memory</span>   <span class="p">(</span><span class="n">stbi_uc</span>           <span class="k">const</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span>   <span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">y</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">comp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">req_comp</span><span class="p">);</span>
<span class="n">STBIDEF</span> <span class="n">stbi_uc</span> <span class="o">*</span><span class="nf">stbi_load_from_callbacks</span><span class="p">(</span><span class="n">stbi_io_callbacks</span> <span class="k">const</span> <span class="o">*</span><span class="n">clbk</span>  <span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">user</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">y</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">comp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">req_comp</span><span class="p">);</span>

<span class="cp">#ifndef STBI_NO_STDIO</span>
<span class="n">STBIDEF</span> <span class="n">stbi_uc</span> <span class="o">*</span><span class="nf">stbi_load_from_file</span>  <span class="p">(</span><span class="kt">FILE</span> <span class="o">*</span><span class="n">f</span><span class="p">,</span>                  <span class="kt">int</span> <span class="o">*</span><span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">y</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">comp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">req_comp</span><span class="p">);</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-4'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-4'>#</a>
      </div>
      <p>for stbi_load_from_file, file pointer is left pointing immediately after image</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="cp">#endif</span>

<span class="cp">#ifndef STBI_NO_LINEAR</span>
   <span class="n">STBIDEF</span> <span class="kt">float</span> <span class="o">*</span><span class="nf">stbi_loadf</span>                 <span class="p">(</span><span class="kt">char</span> <span class="k">const</span> <span class="o">*</span><span class="n">filename</span><span class="p">,</span>           <span class="kt">int</span> <span class="o">*</span><span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">y</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">comp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">req_comp</span><span class="p">);</span>
   <span class="n">STBIDEF</span> <span class="kt">float</span> <span class="o">*</span><span class="nf">stbi_loadf_from_memory</span>     <span class="p">(</span><span class="n">stbi_uc</span> <span class="k">const</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">y</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">comp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">req_comp</span><span class="p">);</span>
   <span class="n">STBIDEF</span> <span class="kt">float</span> <span class="o">*</span><span class="nf">stbi_loadf_from_callbacks</span>  <span class="p">(</span><span class="n">stbi_io_callbacks</span> <span class="k">const</span> <span class="o">*</span><span class="n">clbk</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">user</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">y</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">comp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">req_comp</span><span class="p">);</span>

   <span class="cp">#ifndef STBI_NO_STDIO</span>
   <span class="n">STBIDEF</span> <span class="kt">float</span> <span class="o">*</span><span class="nf">stbi_loadf_from_file</span>  <span class="p">(</span><span class="kt">FILE</span> <span class="o">*</span><span class="n">f</span><span class="p">,</span>                <span class="kt">int</span> <span class="o">*</span><span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">y</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">comp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">req_comp</span><span class="p">);</span>
   <span class="cp">#endif</span>
<span class="cp">#endif</span>

<span class="cp">#ifndef STBI_NO_HDR</span>
   <span class="n">STBIDEF</span> <span class="kt">void</span>   <span class="nf">stbi_hdr_to_ldr_gamma</span><span class="p">(</span><span class="kt">float</span> <span class="n">gamma</span><span class="p">);</span>
   <span class="n">STBIDEF</span> <span class="kt">void</span>   <span class="nf">stbi_hdr_to_ldr_scale</span><span class="p">(</span><span class="kt">float</span> <span class="n">scale</span><span class="p">);</span>
<span class="cp">#endif </span><span class="c1">// STBI_NO_HDR</span>

<span class="cp">#ifndef STBI_NO_LINEAR</span>
   <span class="n">STBIDEF</span> <span class="kt">void</span>   <span class="nf">stbi_ldr_to_hdr_gamma</span><span class="p">(</span><span class="kt">float</span> <span class="n">gamma</span><span class="p">);</span>
   <span class="n">STBIDEF</span> <span class="kt">void</span>   <span class="nf">stbi_ldr_to_hdr_scale</span><span class="p">(</span><span class="kt">float</span> <span class="n">scale</span><span class="p">);</span>
<span class="cp">#endif </span><span class="c1">// STBI_NO_LINEAR</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-5'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-5'>#</a>
      </div>
      <p>stbi_is_hdr is always defined, but always returns false if STBI_NO_HDR</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="n">STBIDEF</span> <span class="kt">int</span>    <span class="nf">stbi_is_hdr_from_callbacks</span><span class="p">(</span><span class="n">stbi_io_callbacks</span> <span class="k">const</span> <span class="o">*</span><span class="n">clbk</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">user</span><span class="p">);</span>
<span class="n">STBIDEF</span> <span class="kt">int</span>    <span class="nf">stbi_is_hdr_from_memory</span><span class="p">(</span><span class="n">stbi_uc</span> <span class="k">const</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">);</span>
<span class="cp">#ifndef STBI_NO_STDIO</span>
<span class="n">STBIDEF</span> <span class="kt">int</span>      <span class="nf">stbi_is_hdr</span>          <span class="p">(</span><span class="kt">char</span> <span class="k">const</span> <span class="o">*</span><span class="n">filename</span><span class="p">);</span>
<span class="n">STBIDEF</span> <span class="kt">int</span>      <span class="nf">stbi_is_hdr_from_file</span><span class="p">(</span><span class="kt">FILE</span> <span class="o">*</span><span class="n">f</span><span class="p">);</span>
<span class="cp">#endif </span><span class="c1">// STBI_NO_STDIO</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-6'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-6'>#</a>
      </div>
      <p>get a VERY brief reason for failure
NOT THREADSAFE</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="n">STBIDEF</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">stbi_failure_reason</span>  <span class="p">(</span><span class="kt">void</span><span class="p">);</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-7'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-7'>#</a>
      </div>
      <p>free the loaded image -- this is just free()</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="n">STBIDEF</span> <span class="kt">void</span>     <span class="nf">stbi_image_free</span>      <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">retval_from_stbi_load</span><span class="p">);</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-8'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-8'>#</a>
      </div>
      <p>get image dimensions &amp; components without fully decoding</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="n">STBIDEF</span> <span class="kt">int</span>      <span class="nf">stbi_info_from_memory</span><span class="p">(</span><span class="n">stbi_uc</span> <span class="k">const</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">y</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">comp</span><span class="p">);</span>
<span class="n">STBIDEF</span> <span class="kt">int</span>      <span class="nf">stbi_info_from_callbacks</span><span class="p">(</span><span class="n">stbi_io_callbacks</span> <span class="k">const</span> <span class="o">*</span><span class="n">clbk</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">user</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">y</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">comp</span><span class="p">);</span>

<span class="cp">#ifndef STBI_NO_STDIO</span>
<span class="n">STBIDEF</span> <span class="kt">int</span>      <span class="nf">stbi_info</span>            <span class="p">(</span><span class="kt">char</span> <span class="k">const</span> <span class="o">*</span><span class="n">filename</span><span class="p">,</span>     <span class="kt">int</span> <span class="o">*</span><span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">y</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">comp</span><span class="p">);</span>
<span class="n">STBIDEF</span> <span class="kt">int</span>      <span class="nf">stbi_info_from_file</span>  <span class="p">(</span><span class="kt">FILE</span> <span class="o">*</span><span class="n">f</span><span class="p">,</span>                  <span class="kt">int</span> <span class="o">*</span><span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">y</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">comp</span><span class="p">);</span>

<span class="cp">#endif</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-9'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-9'>#</a>
      </div>
      <p>for image formats that explicitly notate that they have premultiplied alpha,
we just return the colors as stored in the file. set this flag to force
unpremultiplication. results are undefined if the unpremultiply overflow.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="n">STBIDEF</span> <span class="kt">void</span> <span class="nf">stbi_set_unpremultiply_on_load</span><span class="p">(</span><span class="kt">int</span> <span class="n">flag_true_if_should_unpremultiply</span><span class="p">);</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-10'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-10'>#</a>
      </div>
      <p>indicate whether we should process iphone images back to canonical format,
or just pass them through "as-is"</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="n">STBIDEF</span> <span class="kt">void</span> <span class="nf">stbi_convert_iphone_png_to_rgb</span><span class="p">(</span><span class="kt">int</span> <span class="n">flag_true_if_should_convert</span><span class="p">);</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-11'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-11'>#</a>
      </div>
      <p>flip the image vertically, so the first pixel in the output array is the bottom left</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="n">STBIDEF</span> <span class="kt">void</span> <span class="nf">stbi_set_flip_vertically_on_load</span><span class="p">(</span><span class="kt">int</span> <span class="n">flag_true_if_should_flip</span><span class="p">);</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-12'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-12'>#</a>
      </div>
      <p>ZLIB client - used by PNG, available for other purposes</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="n">STBIDEF</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">stbi_zlib_decode_malloc_guesssize</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="kt">int</span> <span class="n">initial_size</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">outlen</span><span class="p">);</span>
<span class="n">STBIDEF</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">stbi_zlib_decode_malloc_guesssize_headerflag</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="kt">int</span> <span class="n">initial_size</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">outlen</span><span class="p">,</span> <span class="kt">int</span> <span class="n">parse_header</span><span class="p">);</span>
<span class="n">STBIDEF</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">stbi_zlib_decode_malloc</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">outlen</span><span class="p">);</span>
<span class="n">STBIDEF</span> <span class="kt">int</span>   <span class="nf">stbi_zlib_decode_buffer</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">obuffer</span><span class="p">,</span> <span class="kt">int</span> <span class="n">olen</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ibuffer</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ilen</span><span class="p">);</span>

<span class="n">STBIDEF</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">stbi_zlib_decode_noheader_malloc</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">outlen</span><span class="p">);</span>
<span class="n">STBIDEF</span> <span class="kt">int</span>   <span class="nf">stbi_zlib_decode_noheader_buffer</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">obuffer</span><span class="p">,</span> <span class="kt">int</span> <span class="n">olen</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ibuffer</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ilen</span><span class="p">);</span>


<span class="cp">#ifdef __cplusplus</span>
<span class="p">}</span>
<span class="cp">#endif</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-13'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-13'>#</a>
      </div>
      <p>//   end header file   /////////////////////////////////////////////////////</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="cp">#endif </span><span class="c1">// STBI_INCLUDE_STB_IMAGE_H</span>

<span class="cp">#ifdef STB_IMAGE_IMPLEMENTATION</span>

<span class="cp">#if defined(STBI_ONLY_JPEG) || defined(STBI_ONLY_PNG) || defined(STBI_ONLY_BMP) \</span>
<span class="cp">  || defined(STBI_ONLY_TGA) || defined(STBI_ONLY_GIF) || defined(STBI_ONLY_PSD) \</span>
<span class="cp">  || defined(STBI_ONLY_HDR) || defined(STBI_ONLY_PIC) || defined(STBI_ONLY_PNM) \</span>
<span class="cp">  || defined(STBI_ONLY_ZLIB)</span>
   <span class="cp">#ifndef STBI_ONLY_JPEG</span>
   <span class="cp">#define STBI_NO_JPEG</span>
   <span class="cp">#endif</span>
   <span class="cp">#ifndef STBI_ONLY_PNG</span>
   <span class="cp">#define STBI_NO_PNG</span>
   <span class="cp">#endif</span>
   <span class="cp">#ifndef STBI_ONLY_BMP</span>
   <span class="cp">#define STBI_NO_BMP</span>
   <span class="cp">#endif</span>
   <span class="cp">#ifndef STBI_ONLY_PSD</span>
   <span class="cp">#define STBI_NO_PSD</span>
   <span class="cp">#endif</span>
   <span class="cp">#ifndef STBI_ONLY_TGA</span>
   <span class="cp">#define STBI_NO_TGA</span>
   <span class="cp">#endif</span>
   <span class="cp">#ifndef STBI_ONLY_GIF</span>
   <span class="cp">#define STBI_NO_GIF</span>
   <span class="cp">#endif</span>
   <span class="cp">#ifndef STBI_ONLY_HDR</span>
   <span class="cp">#define STBI_NO_HDR</span>
   <span class="cp">#endif</span>
   <span class="cp">#ifndef STBI_ONLY_PIC</span>
   <span class="cp">#define STBI_NO_PIC</span>
   <span class="cp">#endif</span>
   <span class="cp">#ifndef STBI_ONLY_PNM</span>
   <span class="cp">#define STBI_NO_PNM</span>
   <span class="cp">#endif</span>
<span class="cp">#endif</span>

<span class="cp">#if defined(STBI_NO_PNG) &amp;&amp; !defined(STBI_SUPPORT_ZLIB) &amp;&amp; !defined(STBI_NO_ZLIB)</span>
<span class="cp">#define STBI_NO_ZLIB</span>
<span class="cp">#endif</span>


<span class="cp">#include</span> <span class="cpf">&lt;stdarg.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;stddef.h&gt; // ptrdiff_t on osx</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp"></span>

<span class="cp">#if !defined(STBI_NO_LINEAR) || !defined(STBI_NO_HDR)</span>
<span class="cp">#include</span> <span class="cpf">&lt;math.h&gt;  // ldexp</span><span class="cp"></span>
<span class="cp">#endif</span>

<span class="cp">#ifndef STBI_NO_STDIO</span>
<span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<span class="cp">#endif</span>

<span class="cp">#ifndef STBI_ASSERT</span>
<span class="cp">#include</span> <span class="cpf">&lt;assert.h&gt;</span><span class="cp"></span>
<span class="cp">#define STBI_ASSERT(x) assert(x)</span>
<span class="cp">#endif</span>


<span class="cp">#ifndef _MSC_VER</span>
   <span class="cp">#ifdef __cplusplus</span>
   <span class="cp">#define stbi_inline inline</span>
   <span class="cp">#else</span>
   <span class="cp">#define stbi_inline</span>
   <span class="cp">#endif</span>
<span class="cp">#else</span>
   <span class="cp">#define stbi_inline __forceinline</span>
<span class="cp">#endif</span>


<span class="cp">#ifdef _MSC_VER</span>
<span class="k">typedef</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">stbi__uint16</span><span class="p">;</span>
<span class="k">typedef</span>   <span class="kt">signed</span> <span class="kt">short</span> <span class="n">stbi__int16</span><span class="p">;</span>
<span class="k">typedef</span> <span class="kt">unsigned</span> <span class="kt">int</span>   <span class="n">stbi__uint32</span><span class="p">;</span>
<span class="k">typedef</span>   <span class="kt">signed</span> <span class="kt">int</span>   <span class="n">stbi__int32</span><span class="p">;</span>
<span class="cp">#else</span>
<span class="cp">#include</span> <span class="cpf">&lt;stdint.h&gt;</span><span class="cp"></span>
<span class="k">typedef</span> <span class="kt">uint16_t</span> <span class="n">stbi__uint16</span><span class="p">;</span>
<span class="k">typedef</span> <span class="kt">int16_t</span>  <span class="n">stbi__int16</span><span class="p">;</span>
<span class="k">typedef</span> <span class="kt">uint32_t</span> <span class="n">stbi__uint32</span><span class="p">;</span>
<span class="k">typedef</span> <span class="kt">int32_t</span>  <span class="n">stbi__int32</span><span class="p">;</span>
<span class="cp">#endif</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-14'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-14'>#</a>
      </div>
      <p>should produce compiler error if size is wrong</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">typedef</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">validate_uint32</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="n">stbi__uint32</span><span class="p">)</span><span class="o">==</span><span class="mi">4</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">];</span>

<span class="cp">#ifdef _MSC_VER</span>
<span class="cp">#define STBI_NOTUSED(v)  (void)(v)</span>
<span class="cp">#else</span>
<span class="cp">#define STBI_NOTUSED(v)  (void)sizeof(v)</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef _MSC_VER</span>
<span class="cp">#define STBI_HAS_LROTL</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef STBI_HAS_LROTL</span>
   <span class="cp">#define stbi_lrot(x,y)  _lrotl(x,y)</span>
<span class="cp">#else</span>
   <span class="cp">#define stbi_lrot(x,y)  (((x) &lt;&lt; (y)) | ((x) &gt;&gt; (32 - (y))))</span>
<span class="cp">#endif</span>

<span class="cp">#if defined(STBI_MALLOC) &amp;&amp; defined(STBI_FREE) &amp;&amp; (defined(STBI_REALLOC) || defined(STBI_REALLOC_SIZED))</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-15'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-15'>#</a>
      </div>
      <p>ok</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="cp">#elif !defined(STBI_MALLOC) &amp;&amp; !defined(STBI_FREE) &amp;&amp; !defined(STBI_REALLOC) &amp;&amp; !defined(STBI_REALLOC_SIZED)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-16'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-16'>#</a>
      </div>
      <p>ok</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="cp">#else</span>
<span class="cp">#error &quot;Must define all or none of STBI_MALLOC, STBI_FREE, and STBI_REALLOC (or STBI_REALLOC_SIZED).&quot;</span>
<span class="cp">#endif</span>

<span class="cp">#ifndef STBI_MALLOC</span>
<span class="cp">#define STBI_MALLOC(sz)           malloc(sz)</span>
<span class="cp">#define STBI_REALLOC(p,newsz)     realloc(p,newsz)</span>
<span class="cp">#define STBI_FREE(p)              free(p)</span>
<span class="cp">#endif</span>

<span class="cp">#ifndef STBI_REALLOC_SIZED</span>
<span class="cp">#define STBI_REALLOC_SIZED(p,oldsz,newsz) STBI_REALLOC(p,newsz)</span>
<span class="cp">#endif</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-17'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-17'>#</a>
      </div>
      <p>x86/x64 detection</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="cp">#if defined(__x86_64__) || defined(_M_X64)</span>
<span class="cp">#define STBI__X64_TARGET</span>
<span class="cp">#elif defined(__i386) || defined(_M_IX86)</span>
<span class="cp">#define STBI__X86_TARGET</span>
<span class="cp">#endif</span>

<span class="cp">#if defined(__GNUC__) &amp;&amp; (defined(STBI__X86_TARGET) || defined(STBI__X64_TARGET)) &amp;&amp; !defined(__SSE2__) &amp;&amp; !defined(STBI_NO_SIMD)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-18'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-18'>#</a>
      </div>
      <p>NOTE: not clear do we actually need this for the 64-bit path?
gcc doesn't support sse2 intrinsics unless you compile with -msse2,
(but compiling with -msse2 allows the compiler to use SSE2 everywhere;
this is just broken and gcc are jerks for not fixing it properly
http://www.virtualdub.org/blog/pivot/entry.php?id=363 )</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="cp">#define STBI_NO_SIMD</span>
<span class="cp">#endif</span>

<span class="cp">#if defined(__MINGW32__) &amp;&amp; defined(STBI__X86_TARGET) &amp;&amp; !defined(STBI_MINGW_ENABLE_SSE2) &amp;&amp; !defined(STBI_NO_SIMD)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-19'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-19'>#</a>
      </div>
      <p>Note that <strong>MINGW32</strong> doesn't actually mean 32-bit, so we have to avoid STBI__X64_TARGET</p>
<p>32-bit MinGW wants ESP to be 16-byte aligned, but this is not in the
Windows ABI and VC++ as well as Windows DLLs don't maintain that invariant.
As a result, enabling SSE2 on 32-bit MinGW is dangerous when not
simultaneously enabling "-mstackrealign".</p>
<p>See https://github.com/nothings/stb/issues/81 for more information.</p>
<p>So default to no SSE2 on 32-bit MinGW. If you've read this far and added
-mstackrealign to your build settings, feel free to #define STBI_MINGW_ENABLE_SSE2.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="cp">#define STBI_NO_SIMD</span>
<span class="cp">#endif</span>

<span class="cp">#if !defined(STBI_NO_SIMD) &amp;&amp; (defined(STBI__X86_TARGET) || defined(STBI__X64_TARGET))</span>
<span class="cp">#define STBI_SSE2</span>
<span class="cp">#include</span> <span class="cpf">&lt;emmintrin.h&gt;</span><span class="cp"></span>

<span class="cp">#ifdef _MSC_VER</span>

<span class="cp">#if _MSC_VER &gt;= 1400  </span><span class="c1">// not VC6</span>
<span class="cp">#include</span> <span class="cpf">&lt;intrin.h&gt; // __cpuid</span><span class="cp"></span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">stbi__cpuid3</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
   <span class="kt">int</span> <span class="n">info</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
   <span class="n">__cpuid</span><span class="p">(</span><span class="n">info</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
   <span class="k">return</span> <span class="n">info</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">stbi__cpuid3</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
   <span class="kt">int</span> <span class="n">res</span><span class="p">;</span>
   <span class="kr">__asm</span> <span class="p">{</span>
      <span class="n">mov</span>  <span class="n">eax</span><span class="p">,</span><span class="mi">1</span>
      <span class="n">cpuid</span>
      <span class="n">mov</span>  <span class="n">res</span><span class="p">,</span><span class="n">edx</span>
   <span class="p">}</span>
   <span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cp">#define STBI_SIMD_ALIGN(type, name) __declspec(align(16)) type name</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">stbi__sse2_available</span><span class="p">()</span>
<span class="p">{</span>
   <span class="kt">int</span> <span class="n">info3</span> <span class="o">=</span> <span class="n">stbi__cpuid3</span><span class="p">();</span>
   <span class="k">return</span> <span class="p">((</span><span class="n">info3</span> <span class="o">&gt;&gt;</span> <span class="mi">26</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#else </span><span class="c1">// assume GCC-style if not VC++</span>
<span class="cp">#define STBI_SIMD_ALIGN(type, name) type name __attribute__((aligned(16)))</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">stbi__sse2_available</span><span class="p">()</span>
<span class="p">{</span>
<span class="cp">#if defined(__GNUC__) &amp;&amp; (__GNUC__ * 100 + __GNUC_MINOR__) &gt;= 408 </span><span class="c1">// GCC 4.8 or later</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-20'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-20'>#</a>
      </div>
      <p>GCC 4.8+ has a nice way to do this</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>   <span class="k">return</span> <span class="n">__builtin_cpu_supports</span><span class="p">(</span><span class="s">&quot;sse2&quot;</span><span class="p">);</span>
<span class="cp">#else</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-21'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-21'>#</a>
      </div>
      <p>portable way to do this, preferably without using GCC inline ASM?
just bail for now.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>   <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="p">}</span>
<span class="cp">#endif</span>
<span class="cp">#endif</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-22'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-22'>#</a>
      </div>
      <p>ARM NEON</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="cp">#if defined(STBI_NO_SIMD) &amp;&amp; defined(STBI_NEON)</span>
<span class="cp">#undef STBI_NEON</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef STBI_NEON</span>
<span class="cp">#include</span> <span class="cpf">&lt;arm_neon.h&gt;</span><span class="cp"></span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-23'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-23'>#</a>
      </div>
      <p>assume GCC or Clang on ARM targets</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="cp">#define STBI_SIMD_ALIGN(type, name) type name __attribute__((aligned(16)))</span>
<span class="cp">#endif</span>

<span class="cp">#ifndef STBI_SIMD_ALIGN</span>
<span class="cp">#define STBI_SIMD_ALIGN(type, name) type name</span>
<span class="cp">#endif</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-24'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-24'>#</a>
      </div>
      <p>/////////////////////////////////////////////</p>
<p>stbi__context struct and start_xxx functions</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-25'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-25'>#</a>
      </div>
      <p>stbi__context structure is our basic context used by all images, so it
contains all the IO context, plus some basic image information</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">typedef</span> <span class="k">struct</span>
<span class="p">{</span>
   <span class="n">stbi__uint32</span> <span class="n">img_x</span><span class="p">,</span> <span class="n">img_y</span><span class="p">;</span>
   <span class="kt">int</span> <span class="n">img_n</span><span class="p">,</span> <span class="n">img_out_n</span><span class="p">;</span>

   <span class="n">stbi_io_callbacks</span> <span class="n">io</span><span class="p">;</span>
   <span class="kt">void</span> <span class="o">*</span><span class="n">io_user_data</span><span class="p">;</span>

   <span class="kt">int</span> <span class="n">read_from_callbacks</span><span class="p">;</span>
   <span class="kt">int</span> <span class="n">buflen</span><span class="p">;</span>
   <span class="n">stbi_uc</span> <span class="n">buffer_start</span><span class="p">[</span><span class="mi">128</span><span class="p">];</span>

   <span class="n">stbi_uc</span> <span class="o">*</span><span class="n">img_buffer</span><span class="p">,</span> <span class="o">*</span><span class="n">img_buffer_end</span><span class="p">;</span>
   <span class="n">stbi_uc</span> <span class="o">*</span><span class="n">img_buffer_original</span><span class="p">,</span> <span class="o">*</span><span class="n">img_buffer_original_end</span><span class="p">;</span>
<span class="p">}</span> <span class="n">stbi__context</span><span class="p">;</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">stbi__refill_buffer</span><span class="p">(</span><span class="n">stbi__context</span> <span class="o">*</span><span class="n">s</span><span class="p">);</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-26'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-26'>#</a>
      </div>
      <p>initialize a memory-decode context</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">static</span> <span class="kt">void</span> <span class="nf">stbi__start_mem</span><span class="p">(</span><span class="n">stbi__context</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="n">stbi_uc</span> <span class="k">const</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
   <span class="n">s</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">read</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
   <span class="n">s</span><span class="o">-&gt;</span><span class="n">read_from_callbacks</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
   <span class="n">s</span><span class="o">-&gt;</span><span class="n">img_buffer</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">img_buffer_original</span> <span class="o">=</span> <span class="p">(</span><span class="n">stbi_uc</span> <span class="o">*</span><span class="p">)</span> <span class="n">buffer</span><span class="p">;</span>
   <span class="n">s</span><span class="o">-&gt;</span><span class="n">img_buffer_end</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">img_buffer_original_end</span> <span class="o">=</span> <span class="p">(</span><span class="n">stbi_uc</span> <span class="o">*</span><span class="p">)</span> <span class="n">buffer</span><span class="o">+</span><span class="n">len</span><span class="p">;</span>
<span class="p">}</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-27'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-27'>#</a>
      </div>
      <p>initialize a callback-based context</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">static</span> <span class="kt">void</span> <span class="nf">stbi__start_callbacks</span><span class="p">(</span><span class="n">stbi__context</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="n">stbi_io_callbacks</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">user</span><span class="p">)</span>
<span class="p">{</span>
   <span class="n">s</span><span class="o">-&gt;</span><span class="n">io</span> <span class="o">=</span> <span class="o">*</span><span class="n">c</span><span class="p">;</span>
   <span class="n">s</span><span class="o">-&gt;</span><span class="n">io_user_data</span> <span class="o">=</span> <span class="n">user</span><span class="p">;</span>
   <span class="n">s</span><span class="o">-&gt;</span><span class="n">buflen</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">buffer_start</span><span class="p">);</span>
   <span class="n">s</span><span class="o">-&gt;</span><span class="n">read_from_callbacks</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
   <span class="n">s</span><span class="o">-&gt;</span><span class="n">img_buffer_original</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">buffer_start</span><span class="p">;</span>
   <span class="n">stbi__refill_buffer</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
   <span class="n">s</span><span class="o">-&gt;</span><span class="n">img_buffer_original_end</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">img_buffer_end</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifndef STBI_NO_STDIO</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">stbi__stdio_read</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">user</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
   <span class="k">return</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">fread</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">size</span><span class="p">,(</span><span class="kt">FILE</span><span class="o">*</span><span class="p">)</span> <span class="n">user</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">stbi__stdio_skip</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">user</span><span class="p">,</span> <span class="kt">int</span> <span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
   <span class="n">fseek</span><span class="p">((</span><span class="kt">FILE</span><span class="o">*</span><span class="p">)</span> <span class="n">user</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">SEEK_CUR</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">stbi__stdio_eof</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">user</span><span class="p">)</span>
<span class="p">{</span>
   <span class="k">return</span> <span class="n">feof</span><span class="p">((</span><span class="kt">FILE</span><span class="o">*</span><span class="p">)</span> <span class="n">user</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">stbi_io_callbacks</span> <span class="n">stbi__stdio_callbacks</span> <span class="o">=</span>
<span class="p">{</span>
   <span class="n">stbi__stdio_read</span><span class="p">,</span>
   <span class="n">stbi__stdio_skip</span><span class="p">,</span>
   <span class="n">stbi__stdio_eof</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">stbi__start_file</span><span class="p">(</span><span class="n">stbi__context</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">FILE</span> <span class="o">*</span><span class="n">f</span><span class="p">)</span>
<span class="p">{</span>
   <span class="n">stbi__start_callbacks</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">stbi__stdio_callbacks</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">f</span><span class="p">);</span>
<span class="p">}</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-28'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-28'>#</a>
      </div>
      <p>static void stop_file(stbi__context *s) { }</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="cp">#endif </span><span class="c1">// !STBI_NO_STDIO</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">stbi__rewind</span><span class="p">(</span><span class="n">stbi__context</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-29'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-29'>#</a>
      </div>
      <p>conceptually rewind SHOULD rewind to the beginning of the stream,
but we just rewind to the beginning of the initial buffer, because
we only use it after doing 'test', which only ever looks at at most 92 bytes</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>   <span class="n">s</span><span class="o">-&gt;</span><span class="n">img_buffer</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">img_buffer_original</span><span class="p">;</span>
   <span class="n">s</span><span class="o">-&gt;</span><span class="n">img_buffer_end</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">img_buffer_original_end</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifndef STBI_NO_JPEG</span>
<span class="k">static</span> <span class="kt">int</span>      <span class="nf">stbi__jpeg_test</span><span class="p">(</span><span class="n">stbi__context</span> <span class="o">*</span><span class="n">s</span><span class="p">);</span>
<span class="k">static</span> <span class="n">stbi_uc</span> <span class="o">*</span><span class="nf">stbi__jpeg_load</span><span class="p">(</span><span class="n">stbi__context</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">y</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">comp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">req_comp</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>      <span class="nf">stbi__jpeg_info</span><span class="p">(</span><span class="n">stbi__context</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">y</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">comp</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="cp">#ifndef STBI_NO_PNG</span>
<span class="k">static</span> <span class="kt">int</span>      <span class="nf">stbi__png_test</span><span class="p">(</span><span class="n">stbi__context</span> <span class="o">*</span><span class="n">s</span><span class="p">);</span>
<span class="k">static</span> <span class="n">stbi_uc</span> <span class="o">*</span><span class="nf">stbi__png_load</span><span class="p">(</span><span class="n">stbi__context</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">y</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">comp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">req_comp</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>      <span class="nf">stbi__png_info</span><span class="p">(</span><span class="n">stbi__context</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">y</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">comp</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="cp">#ifndef STBI_NO_BMP</span>
<span class="k">static</span> <span class="kt">int</span>      <span class="nf">stbi__bmp_test</span><span class="p">(</span><span class="n">stbi__context</span> <span class="o">*</span><span class="n">s</span><span class="p">);</span>
<span class="k">static</span> <span class="n">stbi_uc</span> <span class="o">*</span><span class="nf">stbi__bmp_load</span><span class="p">(</span><span class="n">stbi__context</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">y</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">comp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">req_comp</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>      <span class="nf">stbi__bmp_info</span><span class="p">(</span><span class="n">stbi__context</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">y</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">comp</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="cp">#ifndef STBI_NO_TGA</span>
<span class="k">static</span> <span class="kt">int</span>      <span class="nf">stbi__tga_test</span><span class="p">(</span><span class="n">stbi__context</span> <span class="o">*</span><span class="n">s</span><span class="p">);</span>
<span class="k">static</span> <span class="n">stbi_uc</span> <span class="o">*</span><span class="nf">stbi__tga_load</span><span class="p">(</span><span class="n">stbi__context</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">y</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">comp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">req_comp</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>      <span class="nf">stbi__tga_info</span><span class="p">(</span><span class="n">stbi__context</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">y</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">comp</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="cp">#ifndef STBI_NO_PSD</span>
<span class="k">static</span> <span class="kt">int</span>      <span class="nf">stbi__psd_test</span><span class="p">(</span><span class="n">stbi__context</span> <span class="o">*</span><span class="n">s</span><span class="p">);</span>
<span class="k">static</span> <span class="n">stbi_uc</span> <span class="o">*</span><span class="nf">stbi__psd_load</span><span class="p">(</span><span class="n">stbi__context</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">y</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">comp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">req_comp</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>      <span class="nf">stbi__psd_info</span><span class="p">(</span><span class="n">stbi__context</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">y</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">comp</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="cp">#ifndef STBI_NO_HDR</span>
<span class="k">static</span> <span class="kt">int</span>      <span class="nf">stbi__hdr_test</span><span class="p">(</span><span class="n">stbi__context</span> <span class="o">*</span><span class="n">s</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">float</span>   <span class="o">*</span><span class="nf">stbi__hdr_load</span><span class="p">(</span><span class="n">stbi__context</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">y</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">comp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">req_comp</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>      <span class="nf">stbi__hdr_info</span><span class="p">(</span><span class="n">stbi__context</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">y</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">comp</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="cp">#ifndef STBI_NO_PIC</span>
<span class="k">static</span> <span class="kt">int</span>      <span class="nf">stbi__pic_test</span><span class="p">(</span><span class="n">stbi__context</span> <span class="o">*</span><span class="n">s</span><span class="p">);</span>
<span class="k">static</span> <span class="n">stbi_uc</span> <span class="o">*</span><span class="nf">stbi__pic_load</span><span class="p">(</span><span class="n">stbi__context</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">y</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">comp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">req_comp</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>      <span class="nf">stbi__pic_info</span><span class="p">(</span><span class="n">stbi__context</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">y</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">comp</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="cp">#ifndef STBI_NO_GIF</span>
<span class="k">static</span> <span class="kt">int</span>      <span class="nf">stbi__gif_test</span><span class="p">(</span><span class="n">stbi__context</span> <span class="o">*</span><span class="n">s</span><span class="p">);</span>
<span class="k">static</span> <span class="n">stbi_uc</span> <span class="o">*</span><span class="nf">stbi__gif_load</span><span class="p">(</span><span class="n">stbi__context</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">y</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">comp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">req_comp</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>      <span class="nf">stbi__gif_info</span><span class="p">(</span><span class="n">stbi__context</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">y</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">comp</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="cp">#ifndef STBI_NO_PNM</span>
<span class="k">static</span> <span class="kt">int</span>      <span class="nf">stbi__pnm_test</span><span class="p">(</span><span class="n">stbi__context</span> <span class="o">*</span><span class="n">s</span><span class="p">);</span>
<span class="k">static</span> <span class="n">stbi_uc</span> <span class="o">*</span><span class="nf">stbi__pnm_load</span><span class="p">(</span><span class="n">stbi__context</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">y</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">comp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">req_comp</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>      <span class="nf">stbi__pnm_info</span><span class="p">(</span><span class="n">stbi__context</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">y</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">comp</span><span class="p">);</span>
<span class="cp">#endif</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-30'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-30'>#</a>
      </div>
      <p>this is not threadsafe</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">stbi__g_failure_reason</span><span class="p">;</span>

<span class="n">STBIDEF</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">stbi_failure_reason</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
   <span class="k">return</span> <span class="n">stbi__g_failure_reason</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">stbi__err</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">)</span>
<span class="p">{</span>
   <span class="n">stbi__g_failure_reason</span> <span class="o">=</span> <span class="n">str</span><span class="p">;</span>
   <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">stbi__malloc</span><span class="p">(</span><span class="kt">size_t</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="n">STBI_MALLOC</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>
<span class="p">}</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-31'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-31'>#</a>
      </div>
      <p>stbi<strong>err - error
stbi</strong>errpf - error returning pointer to float
stbi__errpuc - error returning pointer to unsigned char</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="cp">#ifdef STBI_NO_FAILURE_STRINGS</span>
   <span class="cp">#define stbi__err(x,y)  0</span>
<span class="cp">#elif defined(STBI_FAILURE_USERMSG)</span>
   <span class="cp">#define stbi__err(x,y)  stbi__err(y)</span>
<span class="cp">#else</span>
   <span class="cp">#define stbi__err(x,y)  stbi__err(x)</span>
<span class="cp">#endif</span>

<span class="cp">#define stbi__errpf(x,y)   ((float *)(size_t) (stbi__err(x,y)?NULL:NULL))</span>
<span class="cp">#define stbi__errpuc(x,y)  ((unsigned char *)(size_t) (stbi__err(x,y)?NULL:NULL))</span>

<span class="n">STBIDEF</span> <span class="kt">void</span> <span class="nf">stbi_image_free</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">retval_from_stbi_load</span><span class="p">)</span>
<span class="p">{</span>
   <span class="n">STBI_FREE</span><span class="p">(</span><span class="n">retval_from_stbi_load</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifndef STBI_NO_LINEAR</span>
<span class="k">static</span> <span class="kt">float</span>   <span class="o">*</span><span class="nf">stbi__ldr_to_hdr</span><span class="p">(</span><span class="n">stbi_uc</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="n">y</span><span class="p">,</span> <span class="kt">int</span> <span class="n">comp</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="cp">#ifndef STBI_NO_HDR</span>
<span class="k">static</span> <span class="n">stbi_uc</span> <span class="o">*</span><span class="nf">stbi__hdr_to_ldr</span><span class="p">(</span><span class="kt">float</span>   <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="n">y</span><span class="p">,</span> <span class="kt">int</span> <span class="n">comp</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">stbi__vertically_flip_on_load</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="n">STBIDEF</span> <span class="kt">void</span> <span class="nf">stbi_set_flip_vertically_on_load</span><span class="p">(</span><span class="kt">int</span> <span class="n">flag_true_if_should_flip</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">stbi__vertically_flip_on_load</span> <span class="o">=</span> <span class="n">flag_true_if_should_flip</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">stbi__load_main</span><span class="p">(</span><span class="n">stbi__context</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">y</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">comp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">req_comp</span><span class="p">)</span>
<span class="p">{</span>
   <span class="cp">#ifndef STBI_NO_JPEG</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">stbi__jpeg_test</span><span class="p">(</span><span class="n">s</span><span class="p">))</span> <span class="k">return</span> <span class="n">stbi__jpeg_load</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">comp</span><span class="p">,</span><span class="n">req_comp</span><span class="p">);</span>
   <span class="cp">#endif</span>
   <span class="cp">#ifndef STBI_NO_PNG</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">stbi__png_test</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>  <span class="k">return</span> <span class="n">stbi__png_load</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">comp</span><span class="p">,</span><span class="n">req_comp</span><span class="p">);</span>
   <span class="cp">#endif</span>
   <span class="cp">#ifndef STBI_NO_BMP</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">stbi__bmp_test</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>  <span class="k">return</span> <span class="n">stbi__bmp_load</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">comp</span><span class="p">,</span><span class="n">req_comp</span><span class="p">);</span>
   <span class="cp">#endif</span>
   <span class="cp">#ifndef STBI_NO_GIF</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">stbi__gif_test</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>  <span class="k">return</span> <span class="n">stbi__gif_load</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">comp</span><span class="p">,</span><span class="n">req_comp</span><span class="p">);</span>
   <span class="cp">#endif</span>
   <span class="cp">#ifndef STBI_NO_PSD</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">stbi__psd_test</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>  <span class="k">return</span> <span class="n">stbi__psd_load</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">comp</span><span class="p">,</span><span class="n">req_comp</span><span class="p">);</span>
   <span class="cp">#endif</span>
   <span class="cp">#ifndef STBI_NO_PIC</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">stbi__pic_test</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>  <span class="k">return</span> <span class="n">stbi__pic_load</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">comp</span><span class="p">,</span><span class="n">req_comp</span><span class="p">);</span>
   <span class="cp">#endif</span>
   <span class="cp">#ifndef STBI_NO_PNM</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">stbi__pnm_test</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>  <span class="k">return</span> <span class="n">stbi__pnm_load</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">comp</span><span class="p">,</span><span class="n">req_comp</span><span class="p">);</span>
   <span class="cp">#endif</span>

   <span class="cp">#ifndef STBI_NO_HDR</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">stbi__hdr_test</span><span class="p">(</span><span class="n">s</span><span class="p">))</span> <span class="p">{</span>
      <span class="kt">float</span> <span class="o">*</span><span class="n">hdr</span> <span class="o">=</span> <span class="n">stbi__hdr_load</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">comp</span><span class="p">,</span><span class="n">req_comp</span><span class="p">);</span>
      <span class="k">return</span> <span class="n">stbi__hdr_to_ldr</span><span class="p">(</span><span class="n">hdr</span><span class="p">,</span> <span class="o">*</span><span class="n">x</span><span class="p">,</span> <span class="o">*</span><span class="n">y</span><span class="p">,</span> <span class="n">req_comp</span> <span class="o">?</span> <span class="nl">req_comp</span> <span class="p">:</span> <span class="o">*</span><span class="n">comp</span><span class="p">);</span>
   <span class="p">}</span>
   <span class="cp">#endif</span>

   <span class="cp">#ifndef STBI_NO_TGA</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-32'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-32'>#</a>
      </div>
      <p>test tga last because it's a crappy test!</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>   <span class="k">if</span> <span class="p">(</span><span class="n">stbi__tga_test</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>
      <span class="k">return</span> <span class="n">stbi__tga_load</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">comp</span><span class="p">,</span><span class="n">req_comp</span><span class="p">);</span>
   <span class="cp">#endif</span>

   <span class="k">return</span> <span class="n">stbi__errpuc</span><span class="p">(</span><span class="s">&quot;unknown image type&quot;</span><span class="p">,</span> <span class="s">&quot;Image not of any known type, or corrupt&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">stbi__load_flip</span><span class="p">(</span><span class="n">stbi__context</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">y</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">comp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">req_comp</span><span class="p">)</span>
<span class="p">{</span>
   <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">result</span> <span class="o">=</span> <span class="n">stbi__load_main</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">comp</span><span class="p">,</span> <span class="n">req_comp</span><span class="p">);</span>

   <span class="k">if</span> <span class="p">(</span><span class="n">stbi__vertically_flip_on_load</span> <span class="o">&amp;&amp;</span> <span class="n">result</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
      <span class="kt">int</span> <span class="n">w</span> <span class="o">=</span> <span class="o">*</span><span class="n">x</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="o">*</span><span class="n">y</span><span class="p">;</span>
      <span class="kt">int</span> <span class="n">depth</span> <span class="o">=</span> <span class="n">req_comp</span> <span class="o">?</span> <span class="nl">req_comp</span> <span class="p">:</span> <span class="o">*</span><span class="n">comp</span><span class="p">;</span>
      <span class="kt">int</span> <span class="n">row</span><span class="p">,</span><span class="n">col</span><span class="p">,</span><span class="n">z</span><span class="p">;</span>
      <span class="n">stbi_uc</span> <span class="n">temp</span><span class="p">;</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-33'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-33'>#</a>
      </div>
      <p>@OPTIMIZE: use a bigger temp buffer and memcpy multiple pixels at once</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>      <span class="k">for</span> <span class="p">(</span><span class="n">row</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">row</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">h</span><span class="o">&gt;&gt;</span><span class="mi">1</span><span class="p">);</span> <span class="n">row</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
         <span class="k">for</span> <span class="p">(</span><span class="n">col</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">col</span> <span class="o">&lt;</span> <span class="n">w</span><span class="p">;</span> <span class="n">col</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">z</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">z</span> <span class="o">&lt;</span> <span class="n">depth</span><span class="p">;</span> <span class="n">z</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
               <span class="n">temp</span> <span class="o">=</span> <span class="n">result</span><span class="p">[(</span><span class="n">row</span> <span class="o">*</span> <span class="n">w</span> <span class="o">+</span> <span class="n">col</span><span class="p">)</span> <span class="o">*</span> <span class="n">depth</span> <span class="o">+</span> <span class="n">z</span><span class="p">];</span>
               <span class="n">result</span><span class="p">[(</span><span class="n">row</span> <span class="o">*</span> <span class="n">w</span> <span class="o">+</span> <span class="n">col</span><span class="p">)</span> <span class="o">*</span> <span class="n">depth</span> <span class="o">+</span> <span class="n">z</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="p">[((</span><span class="n">h</span> <span class="o">-</span> <span class="n">row</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">w</span> <span class="o">+</span> <span class="n">col</span><span class="p">)</span> <span class="o">*</span> <span class="n">depth</span> <span class="o">+</span> <span class="n">z</span><span class="p">];</span>
               <span class="n">result</span><span class="p">[((</span><span class="n">h</span> <span class="o">-</span> <span class="n">row</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">w</span> <span class="o">+</span> <span class="n">col</span><span class="p">)</span> <span class="o">*</span> <span class="n">depth</span> <span class="o">+</span> <span class="n">z</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp</span><span class="p">;</span>
            <span class="p">}</span>
         <span class="p">}</span>
      <span class="p">}</span>
   <span class="p">}</span>

   <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifndef STBI_NO_HDR</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">stbi__float_postprocess</span><span class="p">(</span><span class="kt">float</span> <span class="o">*</span><span class="n">result</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">y</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">comp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">req_comp</span><span class="p">)</span>
<span class="p">{</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">stbi__vertically_flip_on_load</span> <span class="o">&amp;&amp;</span> <span class="n">result</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
      <span class="kt">int</span> <span class="n">w</span> <span class="o">=</span> <span class="o">*</span><span class="n">x</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="o">*</span><span class="n">y</span><span class="p">;</span>
      <span class="kt">int</span> <span class="n">depth</span> <span class="o">=</span> <span class="n">req_comp</span> <span class="o">?</span> <span class="nl">req_comp</span> <span class="p">:</span> <span class="o">*</span><span class="n">comp</span><span class="p">;</span>
      <span class="kt">int</span> <span class="n">row</span><span class="p">,</span><span class="n">col</span><span class="p">,</span><span class="n">z</span><span class="p">;</span>
      <span class="kt">float</span> <span class="n">temp</span><span class="p">;</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-34'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-34'>#</a>
      </div>
      <p>@OPTIMIZE: use a bigger temp buffer and memcpy multiple pixels at once</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>      <span class="k">for</span> <span class="p">(</span><span class="n">row</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">row</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">h</span><span class="o">&gt;&gt;</span><span class="mi">1</span><span class="p">);</span> <span class="n">row</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
         <span class="k">for</span> <span class="p">(</span><span class="n">col</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">col</span> <span class="o">&lt;</span> <span class="n">w</span><span class="p">;</span> <span class="n">col</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">z</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">z</span> <span class="o">&lt;</span> <span class="n">depth</span><span class="p">;</span> <span class="n">z</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
               <span class="n">temp</span> <span class="o">=</span> <span class="n">result</span><span class="p">[(</span><span class="n">row</span> <span class="o">*</span> <span class="n">w</span> <span class="o">+</span> <span class="n">col</span><span class="p">)</span> <span class="o">*</span> <span class="n">depth</span> <span class="o">+</span> <span class="n">z</span><span class="p">];</span>
               <span class="n">result</span><span class="p">[(</span><span class="n">row</span> <span class="o">*</span> <span class="n">w</span> <span class="o">+</span> <span class="n">col</span><span class="p">)</span> <span class="o">*</span> <span class="n">depth</span> <span class="o">+</span> <span class="n">z</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="p">[((</span><span class="n">h</span> <span class="o">-</span> <span class="n">row</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">w</span> <span class="o">+</span> <span class="n">col</span><span class="p">)</span> <span class="o">*</span> <span class="n">depth</span> <span class="o">+</span> <span class="n">z</span><span class="p">];</span>
               <span class="n">result</span><span class="p">[((</span><span class="n">h</span> <span class="o">-</span> <span class="n">row</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">w</span> <span class="o">+</span> <span class="n">col</span><span class="p">)</span> <span class="o">*</span> <span class="n">depth</span> <span class="o">+</span> <span class="n">z</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp</span><span class="p">;</span>
            <span class="p">}</span>
         <span class="p">}</span>
      <span class="p">}</span>
   <span class="p">}</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cp">#ifndef STBI_NO_STDIO</span>

<span class="k">static</span> <span class="kt">FILE</span> <span class="o">*</span><span class="nf">stbi__fopen</span><span class="p">(</span><span class="kt">char</span> <span class="k">const</span> <span class="o">*</span><span class="n">filename</span><span class="p">,</span> <span class="kt">char</span> <span class="k">const</span> <span class="o">*</span><span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
   <span class="kt">FILE</span> <span class="o">*</span><span class="n">f</span><span class="p">;</span>
<span class="cp">#if defined(_MSC_VER) &amp;&amp; _MSC_VER &gt;= 1400</span>
   <span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="n">fopen_s</span><span class="p">(</span><span class="o">&amp;</span><span class="n">f</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">mode</span><span class="p">))</span>
      <span class="n">f</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<span class="cp">#else</span>
   <span class="n">f</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
<span class="cp">#endif</span>
   <span class="k">return</span> <span class="n">f</span><span class="p">;</span>
<span class="p">}</span>


<span class="n">STBIDEF</span> <span class="n">stbi_uc</span> <span class="o">*</span><span class="nf">stbi_load</span><span class="p">(</span><span class="kt">char</span> <span class="k">const</span> <span class="o">*</span><span class="n">filename</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">y</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">comp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">req_comp</span><span class="p">)</span>
<span class="p">{</span>
   <span class="kt">FILE</span> <span class="o">*</span><span class="n">f</span> <span class="o">=</span> <span class="n">stbi__fopen</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">&quot;rb&quot;</span><span class="p">);</span>
   <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">result</span><span class="p">;</span>
   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">f</span><span class="p">)</span> <span class="k">return</span> <span class="n">stbi__errpuc</span><span class="p">(</span><span class="s">&quot;can&#39;t fopen&quot;</span><span class="p">,</span> <span class="s">&quot;Unable to open file&quot;</span><span class="p">);</span>
   <span class="n">result</span> <span class="o">=</span> <span class="n">stbi_load_from_file</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">comp</span><span class="p">,</span><span class="n">req_comp</span><span class="p">);</span>
   <span class="n">fclose</span><span class="p">(</span><span class="n">f</span><span class="p">);</span>
   <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">STBIDEF</span> <span class="n">stbi_uc</span> <span class="o">*</span><span class="nf">stbi_load_from_file</span><span class="p">(</span><span class="kt">FILE</span> <span class="o">*</span><span class="n">f</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">y</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">comp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">req_comp</span><span class="p">)</span>
<span class="p">{</span>
   <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">result</span><span class="p">;</span>
   <span class="n">stbi__context</span> <span class="n">s</span><span class="p">;</span>
   <span class="n">stbi__start_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="p">,</span><span class="n">f</span><span class="p">);</span>
   <span class="n">result</span> <span class="o">=</span> <span class="n">stbi__load_flip</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">comp</span><span class="p">,</span><span class="n">req_comp</span><span class="p">);</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-35'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-35'>#</a>
      </div>
      <p>need to 'unget' all the characters in the IO buffer</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>      <span class="n">fseek</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="o">-</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">img_buffer_end</span> <span class="o">-</span> <span class="n">s</span><span class="p">.</span><span class="n">img_buffer</span><span class="p">),</span> <span class="n">SEEK_CUR</span><span class="p">);</span>
   <span class="p">}</span>
   <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="c1">//!STBI_NO_STDIO</span>

<span class="n">STBIDEF</span> <span class="n">stbi_uc</span> <span class="o">*</span><span class="nf">stbi_load_from_memory</span><span class="p">(</span><span class="n">stbi_uc</span> <span class="k">const</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">y</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">comp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">req_comp</span><span class="p">)</span>
<span class="p">{</span>
   <span class="n">stbi__context</span> <span class="n">s</span><span class="p">;</span>
   <span class="n">stbi__start_mem</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="p">,</span><span class="n">buffer</span><span class="p">,</span><span class="n">len</span><span class="p">);</span>
   <span class="k">return</span> <span class="n">stbi__load_flip</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">comp</span><span class="p">,</span><span class="n">req_comp</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">STBIDEF</span> <span class="n">stbi_uc</span> <span class="o">*</span><span class="nf">stbi_load_from_callbacks</span><span class="p">(</span><span class="n">stbi_io_callbacks</span> <span class="k">const</span> <span class="o">*</span><span class="n">clbk</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">user</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">y</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">comp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">req_comp</span><span class="p">)</span>
<span class="p">{</span>
   <span class="n">stbi__context</span> <span class="n">s</span><span class="p">;</span>
   <span class="n">stbi__start_callbacks</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="p">,</span> <span class="p">(</span><span class="n">stbi_io_callbacks</span> <span class="o">*</span><span class="p">)</span> <span class="n">clbk</span><span class="p">,</span> <span class="n">user</span><span class="p">);</span>
   <span class="k">return</span> <span class="n">stbi__load_flip</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">comp</span><span class="p">,</span><span class="n">req_comp</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifndef STBI_NO_LINEAR</span>
<span class="k">static</span> <span class="kt">float</span> <span class="o">*</span><span class="nf">stbi__loadf_main</span><span class="p">(</span><span class="n">stbi__context</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">y</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">comp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">req_comp</span><span class="p">)</span>
<span class="p">{</span>
   <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
   <span class="cp">#ifndef STBI_NO_HDR</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">stbi__hdr_test</span><span class="p">(</span><span class="n">s</span><span class="p">))</span> <span class="p">{</span>
      <span class="kt">float</span> <span class="o">*</span><span class="n">hdr_data</span> <span class="o">=</span> <span class="n">stbi__hdr_load</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">comp</span><span class="p">,</span><span class="n">req_comp</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">hdr_data</span><span class="p">)</span>
         <span class="n">stbi__float_postprocess</span><span class="p">(</span><span class="n">hdr_data</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">comp</span><span class="p">,</span><span class="n">req_comp</span><span class="p">);</span>
      <span class="k">return</span> <span class="n">hdr_data</span><span class="p">;</span>
   <span class="p">}</span>
   <span class="cp">#endif</span>
   <span class="n">data</span> <span class="o">=</span> <span class="n">stbi__load_flip</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">comp</span><span class="p">,</span> <span class="n">req_comp</span><span class="p">);</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">stbi__ldr_to_hdr</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="o">*</span><span class="n">x</span><span class="p">,</span> <span class="o">*</span><span class="n">y</span><span class="p">,</span> <span class="n">req_comp</span> <span class="o">?</span> <span class="nl">req_comp</span> <span class="p">:</span> <span class="o">*</span><span class="n">comp</span><span class="p">);</span>
   <span class="k">return</span> <span class="n">stbi__errpf</span><span class="p">(</span><span class="s">&quot;unknown image type&quot;</span><span class="p">,</span> <span class="s">&quot;Image not of any known type, or corrupt&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">STBIDEF</span> <span class="kt">float</span> <span class="o">*</span><span class="nf">stbi_loadf_from_memory</span><span class="p">(</span><span class="n">stbi_uc</span> <span class="k">const</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">y</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">comp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">req_comp</span><span class="p">)</span>
<span class="p">{</span>
   <span class="n">stbi__context</span> <span class="n">s</span><span class="p">;</span>
   <span class="n">stbi__start_mem</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="p">,</span><span class="n">buffer</span><span class="p">,</span><span class="n">len</span><span class="p">);</span>
   <span class="k">return</span> <span class="n">stbi__loadf_main</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">comp</span><span class="p">,</span><span class="n">req_comp</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">STBIDEF</span> <span class="kt">float</span> <span class="o">*</span><span class="nf">stbi_loadf_from_callbacks</span><span class="p">(</span><span class="n">stbi_io_callbacks</span> <span class="k">const</span> <span class="o">*</span><span class="n">clbk</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">user</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">y</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">comp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">req_comp</span><span class="p">)</span>
<span class="p">{</span>
   <span class="n">stbi__context</span> <span class="n">s</span><span class="p">;</span>
   <span class="n">stbi__start_callbacks</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="p">,</span> <span class="p">(</span><span class="n">stbi_io_callbacks</span> <span class="o">*</span><span class="p">)</span> <span class="n">clbk</span><span class="p">,</span> <span class="n">user</span><span class="p">);</span>
   <span class="k">return</span> <span class="n">stbi__loadf_main</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">comp</span><span class="p">,</span><span class="n">req_comp</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifndef STBI_NO_STDIO</span>
<span class="n">STBIDEF</span> <span class="kt">float</span> <span class="o">*</span><span class="nf">stbi_loadf</span><span class="p">(</span><span class="kt">char</span> <span class="k">const</span> <span class="o">*</span><span class="n">filename</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">y</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">comp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">req_comp</span><span class="p">)</span>
<span class="p">{</span>
   <span class="kt">float</span> <span class="o">*</span><span class="n">result</span><span class="p">;</span>
   <span class="kt">FILE</span> <span class="o">*</span><span class="n">f</span> <span class="o">=</span> <span class="n">stbi__fopen</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">&quot;rb&quot;</span><span class="p">);</span>
   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">f</span><span class="p">)</span> <span class="k">return</span> <span class="n">stbi__errpf</span><span class="p">(</span><span class="s">&quot;can&#39;t fopen&quot;</span><span class="p">,</span> <span class="s">&quot;Unable to open file&quot;</span><span class="p">);</span>
   <span class="n">result</span> <span class="o">=</span> <span class="n">stbi_loadf_from_file</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">comp</span><span class="p">,</span><span class="n">req_comp</span><span class="p">);</span>
   <span class="n">fclose</span><span class="p">(</span><span class="n">f</span><span class="p">);</span>
   <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">STBIDEF</span> <span class="kt">float</span> <span class="o">*</span><span class="nf">stbi_loadf_from_file</span><span class="p">(</span><span class="kt">FILE</span> <span class="o">*</span><span class="n">f</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">y</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">comp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">req_comp</span><span class="p">)</span>
<span class="p">{</span>
   <span class="n">stbi__context</span> <span class="n">s</span><span class="p">;</span>
   <span class="n">stbi__start_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="p">,</span><span class="n">f</span><span class="p">);</span>
   <span class="k">return</span> <span class="n">stbi__loadf_main</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">comp</span><span class="p">,</span><span class="n">req_comp</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="c1">// !STBI_NO_STDIO</span>

<span class="cp">#endif </span><span class="c1">// !STBI_NO_LINEAR</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-36'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-36'>#</a>
      </div>
      <p>these is-hdr-or-not is defined independent of whether STBI_NO_LINEAR is
defined, for API simplicity; if STBI_NO_LINEAR is defined, it always
reports false!</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="n">STBIDEF</span> <span class="kt">int</span> <span class="nf">stbi_is_hdr_from_memory</span><span class="p">(</span><span class="n">stbi_uc</span> <span class="k">const</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
   <span class="cp">#ifndef STBI_NO_HDR</span>
   <span class="n">stbi__context</span> <span class="n">s</span><span class="p">;</span>
   <span class="n">stbi__start_mem</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="p">,</span><span class="n">buffer</span><span class="p">,</span><span class="n">len</span><span class="p">);</span>
   <span class="k">return</span> <span class="n">stbi__hdr_test</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="p">);</span>
   <span class="cp">#else</span>
   <span class="n">STBI_NOTUSED</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span>
   <span class="n">STBI_NOTUSED</span><span class="p">(</span><span class="n">len</span><span class="p">);</span>
   <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
   <span class="cp">#endif</span>
<span class="p">}</span>

<span class="cp">#ifndef STBI_NO_STDIO</span>
<span class="n">STBIDEF</span> <span class="kt">int</span>      <span class="nf">stbi_is_hdr</span>          <span class="p">(</span><span class="kt">char</span> <span class="k">const</span> <span class="o">*</span><span class="n">filename</span><span class="p">)</span>
<span class="p">{</span>
   <span class="kt">FILE</span> <span class="o">*</span><span class="n">f</span> <span class="o">=</span> <span class="n">stbi__fopen</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">&quot;rb&quot;</span><span class="p">);</span>
   <span class="kt">int</span> <span class="n">result</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">result</span> <span class="o">=</span> <span class="n">stbi_is_hdr_from_file</span><span class="p">(</span><span class="n">f</span><span class="p">);</span>
      <span class="n">fclose</span><span class="p">(</span><span class="n">f</span><span class="p">);</span>
   <span class="p">}</span>
   <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">STBIDEF</span> <span class="kt">int</span>      <span class="nf">stbi_is_hdr_from_file</span><span class="p">(</span><span class="kt">FILE</span> <span class="o">*</span><span class="n">f</span><span class="p">)</span>
<span class="p">{</span>
   <span class="cp">#ifndef STBI_NO_HDR</span>
   <span class="n">stbi__context</span> <span class="n">s</span><span class="p">;</span>
   <span class="n">stbi__start_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="p">,</span><span class="n">f</span><span class="p">);</span>
   <span class="k">return</span> <span class="n">stbi__hdr_test</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="p">);</span>
   <span class="cp">#else</span>
   <span class="n">STBI_NOTUSED</span><span class="p">(</span><span class="n">f</span><span class="p">);</span>
   <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
   <span class="cp">#endif</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="c1">// !STBI_NO_STDIO</span>

<span class="n">STBIDEF</span> <span class="kt">int</span>      <span class="nf">stbi_is_hdr_from_callbacks</span><span class="p">(</span><span class="n">stbi_io_callbacks</span> <span class="k">const</span> <span class="o">*</span><span class="n">clbk</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">user</span><span class="p">)</span>
<span class="p">{</span>
   <span class="cp">#ifndef STBI_NO_HDR</span>
   <span class="n">stbi__context</span> <span class="n">s</span><span class="p">;</span>
   <span class="n">stbi__start_callbacks</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="p">,</span> <span class="p">(</span><span class="n">stbi_io_callbacks</span> <span class="o">*</span><span class="p">)</span> <span class="n">clbk</span><span class="p">,</span> <span class="n">user</span><span class="p">);</span>
   <span class="k">return</span> <span class="n">stbi__hdr_test</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="p">);</span>
   <span class="cp">#else</span>
   <span class="n">STBI_NOTUSED</span><span class="p">(</span><span class="n">clbk</span><span class="p">);</span>
   <span class="n">STBI_NOTUSED</span><span class="p">(</span><span class="n">user</span><span class="p">);</span>
   <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
   <span class="cp">#endif</span>
<span class="p">}</span>

<span class="cp">#ifndef STBI_NO_LINEAR</span>
<span class="k">static</span> <span class="kt">float</span> <span class="n">stbi__l2h_gamma</span><span class="o">=</span><span class="mf">2.2f</span><span class="p">,</span> <span class="n">stbi__l2h_scale</span><span class="o">=</span><span class="mf">1.0f</span><span class="p">;</span>

<span class="n">STBIDEF</span> <span class="kt">void</span>   <span class="nf">stbi_ldr_to_hdr_gamma</span><span class="p">(</span><span class="kt">float</span> <span class="n">gamma</span><span class="p">)</span> <span class="p">{</span> <span class="n">stbi__l2h_gamma</span> <span class="o">=</span> <span class="n">gamma</span><span class="p">;</span> <span class="p">}</span>
<span class="n">STBIDEF</span> <span class="kt">void</span>   <span class="nf">stbi_ldr_to_hdr_scale</span><span class="p">(</span><span class="kt">float</span> <span class="n">scale</span><span class="p">)</span> <span class="p">{</span> <span class="n">stbi__l2h_scale</span> <span class="o">=</span> <span class="n">scale</span><span class="p">;</span> <span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">float</span> <span class="n">stbi__h2l_gamma_i</span><span class="o">=</span><span class="mf">1.0f</span><span class="o">/</span><span class="mf">2.2f</span><span class="p">,</span> <span class="n">stbi__h2l_scale_i</span><span class="o">=</span><span class="mf">1.0f</span><span class="p">;</span>

<span class="n">STBIDEF</span> <span class="kt">void</span>   <span class="nf">stbi_hdr_to_ldr_gamma</span><span class="p">(</span><span class="kt">float</span> <span class="n">gamma</span><span class="p">)</span> <span class="p">{</span> <span class="n">stbi__h2l_gamma_i</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">gamma</span><span class="p">;</span> <span class="p">}</span>
<span class="n">STBIDEF</span> <span class="kt">void</span>   <span class="nf">stbi_hdr_to_ldr_scale</span><span class="p">(</span><span class="kt">float</span> <span class="n">scale</span><span class="p">)</span> <span class="p">{</span> <span class="n">stbi__h2l_scale_i</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">scale</span><span class="p">;</span> <span class="p">}</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-37'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-37'>#</a>
      </div>
      <p>////////////////////////////////////////////////////////////////////////////</p>
<p>Common code used by all image loaders</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">enum</span>
<span class="p">{</span>
   <span class="n">STBI__SCAN_load</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
   <span class="n">STBI__SCAN_type</span><span class="p">,</span>
   <span class="n">STBI__SCAN_header</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">stbi__refill_buffer</span><span class="p">(</span><span class="n">stbi__context</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
   <span class="kt">int</span> <span class="n">n</span> <span class="o">=</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">read</span><span class="p">)(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">io_user_data</span><span class="p">,(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">buffer_start</span><span class="p">,</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">buflen</span><span class="p">);</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-38'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-38'>#</a>
      </div>
      <p>at end of file, treat same as if from memory, but need to handle case
where s-&gt;img_buffer isn't pointing to safe memory, e.g. 0-byte file</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>      <span class="n">s</span><span class="o">-&gt;</span><span class="n">read_from_callbacks</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="n">s</span><span class="o">-&gt;</span><span class="n">img_buffer</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">buffer_start</span><span class="p">;</span>
      <span class="n">s</span><span class="o">-&gt;</span><span class="n">img_buffer_end</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">buffer_start</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
      <span class="o">*</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">img_buffer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
   <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="n">s</span><span class="o">-&gt;</span><span class="n">img_buffer</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">buffer_start</span><span class="p">;</span>
      <span class="n">s</span><span class="o">-&gt;</span><span class="n">img_buffer_end</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">buffer_start</span> <span class="o">+</span> <span class="n">n</span><span class="p">;</span>
   <span class="p">}</span>
<span class="p">}</span>

<span class="n">stbi_inline</span> <span class="k">static</span> <span class="n">stbi_uc</span> <span class="nf">stbi__get8</span><span class="p">(</span><span class="n">stbi__context</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">img_buffer</span> <span class="o">&lt;</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">img_buffer_end</span><span class="p">)</span>
      <span class="k">return</span> <span class="o">*</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">img_buffer</span><span class="o">++</span><span class="p">;</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">read_from_callbacks</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">stbi__refill_buffer</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
      <span class="k">return</span> <span class="o">*</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">img_buffer</span><span class="o">++</span><span class="p">;</span>
   <span class="p">}</span>
   <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">stbi_inline</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">stbi__at_eof</span><span class="p">(</span><span class="n">stbi__context</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">read</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">eof</span><span class="p">)(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">io_user_data</span><span class="p">))</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-39'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-39'>#</a>
      </div>
      <p>if feof() is true, check if buffer = end
special case: we've only got the special 0 character at the end</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>      <span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">read_from_callbacks</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="k">return</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">img_buffer</span> <span class="o">&gt;=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">img_buffer_end</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">stbi__skip</span><span class="p">(</span><span class="n">stbi__context</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">int</span> <span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">s</span><span class="o">-&gt;</span><span class="n">img_buffer</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">img_buffer_end</span><span class="p">;</span>
      <span class="k">return</span><span class="p">;</span>
   <span class="p">}</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">read</span><span class="p">)</span> <span class="p">{</span>
      <span class="kt">int</span> <span class="n">blen</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">img_buffer_end</span> <span class="o">-</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">img_buffer</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">blen</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">)</span> <span class="p">{</span>
         <span class="n">s</span><span class="o">-&gt;</span><span class="n">img_buffer</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">img_buffer_end</span><span class="p">;</span>
         <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">skip</span><span class="p">)(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">io_user_data</span><span class="p">,</span> <span class="n">n</span> <span class="o">-</span> <span class="n">blen</span><span class="p">);</span>
         <span class="k">return</span><span class="p">;</span>
      <span class="p">}</span>
   <span class="p">}</span>
   <span class="n">s</span><span class="o">-&gt;</span><span class="n">img_buffer</span> <span class="o">+=</span> <span class="n">n</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">stbi__getn</span><span class="p">(</span><span class="n">stbi__context</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="n">stbi_uc</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="kt">int</span> <span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">read</span><span class="p">)</span> <span class="p">{</span>
      <span class="kt">int</span> <span class="n">blen</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">img_buffer_end</span> <span class="o">-</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">img_buffer</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">blen</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">)</span> <span class="p">{</span>
         <span class="kt">int</span> <span class="n">res</span><span class="p">,</span> <span class="n">count</span><span class="p">;</span>

         <span class="n">memcpy</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">img_buffer</span><span class="p">,</span> <span class="n">blen</span><span class="p">);</span>

         <span class="n">count</span> <span class="o">=</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">read</span><span class="p">)(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">io_user_data</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span> <span class="n">buffer</span> <span class="o">+</span> <span class="n">blen</span><span class="p">,</span> <span class="n">n</span> <span class="o">-</span> <span class="n">blen</span><span class="p">);</span>
         <span class="n">res</span> <span class="o">=</span> <span class="p">(</span><span class="n">count</span> <span class="o">==</span> <span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="n">blen</span><span class="p">));</span>
         <span class="n">s</span><span class="o">-&gt;</span><span class="n">img_buffer</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">img_buffer_end</span><span class="p">;</span>
         <span class="k">return</span> <span class="n">res</span><span class="p">;</span>
      <span class="p">}</span>
   <span class="p">}</span>

   <span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">img_buffer</span><span class="o">+</span><span class="n">n</span> <span class="o">&lt;=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">img_buffer_end</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">memcpy</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">img_buffer</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>
      <span class="n">s</span><span class="o">-&gt;</span><span class="n">img_buffer</span> <span class="o">+=</span> <span class="n">n</span><span class="p">;</span>
      <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
   <span class="p">}</span> <span class="k">else</span>
      <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">stbi__get16be</span><span class="p">(</span><span class="n">stbi__context</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
   <span class="kt">int</span> <span class="n">z</span> <span class="o">=</span> <span class="n">stbi__get8</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
   <span class="k">return</span> <span class="p">(</span><span class="n">z</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="n">stbi__get8</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">stbi__uint32</span> <span class="nf">stbi__get32be</span><span class="p">(</span><span class="n">stbi__context</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
   <span class="n">stbi__uint32</span> <span class="n">z</span> <span class="o">=</span> <span class="n">stbi__get16be</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
   <span class="k">return</span> <span class="p">(</span><span class="n">z</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">+</span> <span class="n">stbi__get16be</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#if defined(STBI_NO_BMP) &amp;&amp; defined(STBI_NO_TGA) &amp;&amp; defined(STBI_NO_GIF)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-40'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-40'>#</a>
      </div>
      <p>nothing</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="cp">#else</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">stbi__get16le</span><span class="p">(</span><span class="n">stbi__context</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
   <span class="kt">int</span> <span class="n">z</span> <span class="o">=</span> <span class="n">stbi__get8</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
   <span class="k">return</span> <span class="n">z</span> <span class="o">+</span> <span class="p">(</span><span class="n">stbi__get8</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cp">#ifndef STBI_NO_BMP</span>
<span class="k">static</span> <span class="n">stbi__uint32</span> <span class="nf">stbi__get32le</span><span class="p">(</span><span class="n">stbi__context</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
   <span class="n">stbi__uint32</span> <span class="n">z</span> <span class="o">=</span> <span class="n">stbi__get16le</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
   <span class="k">return</span> <span class="n">z</span> <span class="o">+</span> <span class="p">(</span><span class="n">stbi__get16le</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cp">#define STBI__BYTECAST(x)  ((stbi_uc) ((x) &amp; 255))  </span><span class="c1">// truncate int to byte without warnings</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-41'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-41'>#</a>
      </div>
      <p>////////////////////////////////////////////////////////////////////////////</p>
<p>generic converter from built-in img_n to req_comp
   individual types do this automatically as much as possible (e.g. jpeg
   does all cases internally since it needs to colorspace convert anyway,
   and it never has alpha, so very few cases ). png can automatically
   interleave an alpha=255 channel, but falls back to this for other cases</p>
<p>assume data buffer is malloced, so malloc a new one and free that one
 only failure mode is malloc failing</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">static</span> <span class="n">stbi_uc</span> <span class="nf">stbi__compute_y</span><span class="p">(</span><span class="kt">int</span> <span class="n">r</span><span class="p">,</span> <span class="kt">int</span> <span class="n">g</span><span class="p">,</span> <span class="kt">int</span> <span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
   <span class="k">return</span> <span class="p">(</span><span class="n">stbi_uc</span><span class="p">)</span> <span class="p">(((</span><span class="n">r</span><span class="o">*</span><span class="mi">77</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">g</span><span class="o">*</span><span class="mi">150</span><span class="p">)</span> <span class="o">+</span>  <span class="p">(</span><span class="mi">29</span><span class="o">*</span><span class="n">b</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">stbi__convert_format</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">img_n</span><span class="p">,</span> <span class="kt">int</span> <span class="n">req_comp</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">y</span><span class="p">)</span>
<span class="p">{</span>
   <span class="kt">int</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">;</span>
   <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">good</span><span class="p">;</span>

   <span class="k">if</span> <span class="p">(</span><span class="n">req_comp</span> <span class="o">==</span> <span class="n">img_n</span><span class="p">)</span> <span class="k">return</span> <span class="n">data</span><span class="p">;</span>
   <span class="n">STBI_ASSERT</span><span class="p">(</span><span class="n">req_comp</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">req_comp</span> <span class="o">&lt;=</span> <span class="mi">4</span><span class="p">);</span>

   <span class="n">good</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">stbi__malloc</span><span class="p">(</span><span class="n">req_comp</span> <span class="o">*</span> <span class="n">x</span> <span class="o">*</span> <span class="n">y</span><span class="p">);</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">good</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">STBI_FREE</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
      <span class="k">return</span> <span class="n">stbi__errpuc</span><span class="p">(</span><span class="s">&quot;outofmem&quot;</span><span class="p">,</span> <span class="s">&quot;Out of memory&quot;</span><span class="p">);</span>
   <span class="p">}</span>

   <span class="k">for</span> <span class="p">(</span><span class="n">j</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">y</span><span class="p">;</span> <span class="o">++</span><span class="n">j</span><span class="p">)</span> <span class="p">{</span>
      <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">src</span>  <span class="o">=</span> <span class="n">data</span> <span class="o">+</span> <span class="n">j</span> <span class="o">*</span> <span class="n">x</span> <span class="o">*</span> <span class="n">img_n</span>   <span class="p">;</span>
      <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">dest</span> <span class="o">=</span> <span class="n">good</span> <span class="o">+</span> <span class="n">j</span> <span class="o">*</span> <span class="n">x</span> <span class="o">*</span> <span class="n">req_comp</span><span class="p">;</span>

      <span class="cp">#define COMBO(a,b)  ((a)*8+(b))</span>
      <span class="cp">#define CASE(a,b)   case COMBO(a,b): for(i=x-1; i &gt;= 0; --i, src += a, dest += b)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-42'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-42'>#</a>
      </div>
      <p>convert source image with img_n components to one with req_comp components;
avoid switch per pixel, so use switch per scanline and massive macros</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>      <span class="k">switch</span> <span class="p">(</span><span class="n">COMBO</span><span class="p">(</span><span class="n">img_n</span><span class="p">,</span> <span class="n">req_comp</span><span class="p">))</span> <span class="p">{</span>
         <span class="n">CASE</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="n">dest</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">src</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dest</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="mi">255</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
         <span class="n">CASE</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> <span class="n">dest</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">dest</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">dest</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="n">src</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span> <span class="k">break</span><span class="p">;</span>
         <span class="n">CASE</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span> <span class="n">dest</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">dest</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">dest</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="n">src</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dest</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">=</span><span class="mi">255</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
         <span class="n">CASE</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="n">dest</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">src</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span> <span class="k">break</span><span class="p">;</span>
         <span class="n">CASE</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> <span class="n">dest</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">dest</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">dest</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="n">src</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span> <span class="k">break</span><span class="p">;</span>
         <span class="n">CASE</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span> <span class="n">dest</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">dest</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">dest</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="n">src</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dest</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">=</span><span class="n">src</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span> <span class="k">break</span><span class="p">;</span>
         <span class="n">CASE</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span> <span class="n">dest</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">src</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">dest</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">src</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">dest</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="n">src</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">dest</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">=</span><span class="mi">255</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
         <span class="n">CASE</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="n">dest</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">stbi__compute_y</span><span class="p">(</span><span class="n">src</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">src</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">src</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span> <span class="k">break</span><span class="p">;</span>
         <span class="n">CASE</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="n">dest</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">stbi__compute_y</span><span class="p">(</span><span class="n">src</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">src</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">src</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="n">dest</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">255</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
         <span class="n">CASE</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="n">dest</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">stbi__compute_y</span><span class="p">(</span><span class="n">src</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">src</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">src</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span> <span class="k">break</span><span class="p">;</span>
         <span class="n">CASE</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="n">dest</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">stbi__compute_y</span><span class="p">(</span><span class="n">src</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">src</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">src</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="n">dest</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">src</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span> <span class="k">break</span><span class="p">;</span>
         <span class="n">CASE</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> <span class="n">dest</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">src</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">dest</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">src</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">dest</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="n">src</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span> <span class="k">break</span><span class="p">;</span>
         <span class="k">default</span><span class="o">:</span> <span class="n">STBI_ASSERT</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="cp">#undef CASE</span>
   <span class="p">}</span>

   <span class="n">STBI_FREE</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
   <span class="k">return</span> <span class="n">good</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifndef STBI_NO_LINEAR</span>
<span class="k">static</span> <span class="kt">float</span>   <span class="o">*</span><span class="nf">stbi__ldr_to_hdr</span><span class="p">(</span><span class="n">stbi_uc</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="n">y</span><span class="p">,</span> <span class="kt">int</span> <span class="n">comp</span><span class="p">)</span>
<span class="p">{</span>
   <span class="kt">int</span> <span class="n">i</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">n</span><span class="p">;</span>
   <span class="kt">float</span> <span class="o">*</span><span class="n">output</span> <span class="o">=</span> <span class="p">(</span><span class="kt">float</span> <span class="o">*</span><span class="p">)</span> <span class="n">stbi__malloc</span><span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="n">y</span> <span class="o">*</span> <span class="n">comp</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">));</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">output</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span> <span class="n">STBI_FREE</span><span class="p">(</span><span class="n">data</span><span class="p">);</span> <span class="k">return</span> <span class="n">stbi__errpf</span><span class="p">(</span><span class="s">&quot;outofmem&quot;</span><span class="p">,</span> <span class="s">&quot;Out of memory&quot;</span><span class="p">);</span> <span class="p">}</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-43'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-43'>#</a>
      </div>
      <p>compute number of non-alpha components</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>   <span class="k">if</span> <span class="p">(</span><span class="n">comp</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="n">n</span> <span class="o">=</span> <span class="n">comp</span><span class="p">;</span> <span class="k">else</span> <span class="n">n</span> <span class="o">=</span> <span class="n">comp</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
   <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">x</span><span class="o">*</span><span class="n">y</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">for</span> <span class="p">(</span><span class="n">k</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="o">++</span><span class="n">k</span><span class="p">)</span> <span class="p">{</span>
         <span class="n">output</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="n">comp</span> <span class="o">+</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">float</span><span class="p">)</span> <span class="p">(</span><span class="n">pow</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="n">comp</span><span class="o">+</span><span class="n">k</span><span class="p">]</span><span class="o">/</span><span class="mf">255.0f</span><span class="p">,</span> <span class="n">stbi__l2h_gamma</span><span class="p">)</span> <span class="o">*</span> <span class="n">stbi__l2h_scale</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">k</span> <span class="o">&lt;</span> <span class="n">comp</span><span class="p">)</span> <span class="n">output</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="n">comp</span> <span class="o">+</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="n">comp</span><span class="o">+</span><span class="n">k</span><span class="p">]</span><span class="o">/</span><span class="mf">255.0f</span><span class="p">;</span>
   <span class="p">}</span>
   <span class="n">STBI_FREE</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
   <span class="k">return</span> <span class="n">output</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cp">#ifndef STBI_NO_HDR</span>
<span class="cp">#define stbi__float2int(x)   ((int) (x))</span>
<span class="k">static</span> <span class="n">stbi_uc</span> <span class="o">*</span><span class="nf">stbi__hdr_to_ldr</span><span class="p">(</span><span class="kt">float</span>   <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="n">y</span><span class="p">,</span> <span class="kt">int</span> <span class="n">comp</span><span class="p">)</span>
<span class="p">{</span>
   <span class="kt">int</span> <span class="n">i</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">n</span><span class="p">;</span>
   <span class="n">stbi_uc</span> <span class="o">*</span><span class="n">output</span> <span class="o">=</span> <span class="p">(</span><span class="n">stbi_uc</span> <span class="o">*</span><span class="p">)</span> <span class="n">stbi__malloc</span><span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="n">y</span> <span class="o">*</span> <span class="n">comp</span><span class="p">);</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">output</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span> <span class="n">STBI_FREE</span><span class="p">(</span><span class="n">data</span><span class="p">);</span> <span class="k">return</span> <span class="n">stbi__errpuc</span><span class="p">(</span><span class="s">&quot;outofmem&quot;</span><span class="p">,</span> <span class="s">&quot;Out of memory&quot;</span><span class="p">);</span> <span class="p">}</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-44'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-44'>#</a>
      </div>
      <p>compute number of non-alpha components</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>   <span class="k">if</span> <span class="p">(</span><span class="n">comp</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="n">n</span> <span class="o">=</span> <span class="n">comp</span><span class="p">;</span> <span class="k">else</span> <span class="n">n</span> <span class="o">=</span> <span class="n">comp</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
   <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">x</span><span class="o">*</span><span class="n">y</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">for</span> <span class="p">(</span><span class="n">k</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="o">++</span><span class="n">k</span><span class="p">)</span> <span class="p">{</span>
         <span class="kt">float</span> <span class="n">z</span> <span class="o">=</span> <span class="p">(</span><span class="kt">float</span><span class="p">)</span> <span class="n">pow</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="n">comp</span><span class="o">+</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="n">stbi__h2l_scale_i</span><span class="p">,</span> <span class="n">stbi__h2l_gamma_i</span><span class="p">)</span> <span class="o">*</span> <span class="mi">255</span> <span class="o">+</span> <span class="mf">0.5f</span><span class="p">;</span>
         <span class="k">if</span> <span class="p">(</span><span class="n">z</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="n">z</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
         <span class="k">if</span> <span class="p">(</span><span class="n">z</span> <span class="o">&gt;</span> <span class="mi">255</span><span class="p">)</span> <span class="n">z</span> <span class="o">=</span> <span class="mi">255</span><span class="p">;</span>
         <span class="n">output</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="n">comp</span> <span class="o">+</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">stbi_uc</span><span class="p">)</span> <span class="n">stbi__float2int</span><span class="p">(</span><span class="n">z</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">k</span> <span class="o">&lt;</span> <span class="n">comp</span><span class="p">)</span> <span class="p">{</span>
         <span class="kt">float</span> <span class="n">z</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="n">comp</span><span class="o">+</span><span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="mi">255</span> <span class="o">+</span> <span class="mf">0.5f</span><span class="p">;</span>
         <span class="k">if</span> <span class="p">(</span><span class="n">z</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="n">z</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
         <span class="k">if</span> <span class="p">(</span><span class="n">z</span> <span class="o">&gt;</span> <span class="mi">255</span><span class="p">)</span> <span class="n">z</span> <span class="o">=</span> <span class="mi">255</span><span class="p">;</span>
         <span class="n">output</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="n">comp</span> <span class="o">+</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">stbi_uc</span><span class="p">)</span> <span class="n">stbi__float2int</span><span class="p">(</span><span class="n">z</span><span class="p">);</span>
      <span class="p">}</span>
   <span class="p">}</span>
   <span class="n">STBI_FREE</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
   <span class="k">return</span> <span class="n">output</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-45'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-45'>#</a>
      </div>
      <p>////////////////////////////////////////////////////////////////////////////</p>
<p>"baseline" JPEG/JFIF decoder</p>
<p>simple implementation
     - doesn't support delayed output of y-dimension
     - simple interface (only one output format: 8-bit interleaved RGB)
     - doesn't try to recover corrupt jpegs
     - doesn't allow partial loading, loading multiple at once
     - still fast on x86 (copying globals into locals doesn't help x86)
     - allocates lots of intermediate memory (full size of all components)
       - non-interleaved case requires this anyway
       - allows good upsampling (see next)
   high-quality
     - upsampled channels are bilinearly interpolated, even across blocks
     - quality integer IDCT derived from IJG's 'slow'
   performance
     - fast huffman; reasonable integer IDCT
     - some SIMD kernels for common paths on targets with SSE2/NEON
     - uses a lot of intermediate memory, could cache poorly</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="cp">#ifndef STBI_NO_JPEG</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-46'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-46'>#</a>
      </div>
      <p>huffman decoding acceleration</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="cp">#define FAST_BITS   9  </span><span class="c1">// larger handles more cases; smaller stomps less cache</span>

<span class="k">typedef</span> <span class="k">struct</span>
<span class="p">{</span>
   <span class="n">stbi_uc</span>  <span class="n">fast</span><span class="p">[</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">FAST_BITS</span><span class="p">];</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-47'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-47'>#</a>
      </div>
      <p>weirdly, repacking this into AoS is a 10% speed loss, instead of a win</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>   <span class="n">stbi__uint16</span> <span class="n">code</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>
   <span class="n">stbi_uc</span>  <span class="n">values</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>
   <span class="n">stbi_uc</span>  <span class="n">size</span><span class="p">[</span><span class="mi">257</span><span class="p">];</span>
   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">maxcode</span><span class="p">[</span><span class="mi">18</span><span class="p">];</span>
   <span class="kt">int</span>    <span class="n">delta</span><span class="p">[</span><span class="mi">17</span><span class="p">];</span>   <span class="c1">// old &#39;firstsymbol&#39; - old &#39;firstcode&#39;</span>
<span class="p">}</span> <span class="n">stbi__huffman</span><span class="p">;</span>

<span class="k">typedef</span> <span class="k">struct</span>
<span class="p">{</span>
   <span class="n">stbi__context</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>
   <span class="n">stbi__huffman</span> <span class="n">huff_dc</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
   <span class="n">stbi__huffman</span> <span class="n">huff_ac</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
   <span class="n">stbi_uc</span> <span class="n">dequant</span><span class="p">[</span><span class="mi">4</span><span class="p">][</span><span class="mi">64</span><span class="p">];</span>
   <span class="n">stbi__int16</span> <span class="n">fast_ac</span><span class="p">[</span><span class="mi">4</span><span class="p">][</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">FAST_BITS</span><span class="p">];</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-48'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-48'>#</a>
      </div>
      <p>sizes for components, interleaved MCUs</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>   <span class="kt">int</span> <span class="n">img_h_max</span><span class="p">,</span> <span class="n">img_v_max</span><span class="p">;</span>
   <span class="kt">int</span> <span class="n">img_mcu_x</span><span class="p">,</span> <span class="n">img_mcu_y</span><span class="p">;</span>
   <span class="kt">int</span> <span class="n">img_mcu_w</span><span class="p">,</span> <span class="n">img_mcu_h</span><span class="p">;</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-49'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-49'>#</a>
      </div>
      <p>definition of jpeg image component</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>   <span class="k">struct</span>
   <span class="p">{</span>
      <span class="kt">int</span> <span class="n">id</span><span class="p">;</span>
      <span class="kt">int</span> <span class="n">h</span><span class="p">,</span><span class="n">v</span><span class="p">;</span>
      <span class="kt">int</span> <span class="n">tq</span><span class="p">;</span>
      <span class="kt">int</span> <span class="n">hd</span><span class="p">,</span><span class="n">ha</span><span class="p">;</span>
      <span class="kt">int</span> <span class="n">dc_pred</span><span class="p">;</span>

      <span class="kt">int</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">w2</span><span class="p">,</span><span class="n">h2</span><span class="p">;</span>
      <span class="n">stbi_uc</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
      <span class="kt">void</span> <span class="o">*</span><span class="n">raw_data</span><span class="p">,</span> <span class="o">*</span><span class="n">raw_coeff</span><span class="p">;</span>
      <span class="n">stbi_uc</span> <span class="o">*</span><span class="n">linebuf</span><span class="p">;</span>
      <span class="kt">short</span>   <span class="o">*</span><span class="n">coeff</span><span class="p">;</span>   <span class="c1">// progressive only</span>
      <span class="kt">int</span>      <span class="n">coeff_w</span><span class="p">,</span> <span class="n">coeff_h</span><span class="p">;</span> <span class="c1">// number of 8x8 coefficient blocks</span>
   <span class="p">}</span> <span class="n">img_comp</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>

   <span class="n">stbi__uint32</span>   <span class="n">code_buffer</span><span class="p">;</span> <span class="c1">// jpeg entropy-coded buffer</span>
   <span class="kt">int</span>            <span class="n">code_bits</span><span class="p">;</span>   <span class="c1">// number of valid bits</span>
   <span class="kt">unsigned</span> <span class="kt">char</span>  <span class="n">marker</span><span class="p">;</span>      <span class="c1">// marker seen while filling entropy buffer</span>
   <span class="kt">int</span>            <span class="n">nomore</span><span class="p">;</span>      <span class="c1">// flag if we saw a marker so must stop</span>

   <span class="kt">int</span>            <span class="n">progressive</span><span class="p">;</span>
   <span class="kt">int</span>            <span class="n">spec_start</span><span class="p">;</span>
   <span class="kt">int</span>            <span class="n">spec_end</span><span class="p">;</span>
   <span class="kt">int</span>            <span class="n">succ_high</span><span class="p">;</span>
   <span class="kt">int</span>            <span class="n">succ_low</span><span class="p">;</span>
   <span class="kt">int</span>            <span class="n">eob_run</span><span class="p">;</span>
   <span class="kt">int</span>            <span class="n">rgb</span><span class="p">;</span>

   <span class="kt">int</span> <span class="n">scan_n</span><span class="p">,</span> <span class="n">order</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
   <span class="kt">int</span> <span class="n">restart_interval</span><span class="p">,</span> <span class="n">todo</span><span class="p">;</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-50'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-50'>#</a>
      </div>
      <p>kernels</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>   <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">idct_block_kernel</span><span class="p">)(</span><span class="n">stbi_uc</span> <span class="o">*</span><span class="n">out</span><span class="p">,</span> <span class="kt">int</span> <span class="n">out_stride</span><span class="p">,</span> <span class="kt">short</span> <span class="n">data</span><span class="p">[</span><span class="mi">64</span><span class="p">]);</span>
   <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">YCbCr_to_RGB_kernel</span><span class="p">)(</span><span class="n">stbi_uc</span> <span class="o">*</span><span class="n">out</span><span class="p">,</span> <span class="k">const</span> <span class="n">stbi_uc</span> <span class="o">*</span><span class="n">y</span><span class="p">,</span> <span class="k">const</span> <span class="n">stbi_uc</span> <span class="o">*</span><span class="n">pcb</span><span class="p">,</span> <span class="k">const</span> <span class="n">stbi_uc</span> <span class="o">*</span><span class="n">pcr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">,</span> <span class="kt">int</span> <span class="n">step</span><span class="p">);</span>
   <span class="n">stbi_uc</span> <span class="o">*</span><span class="p">(</span><span class="o">*</span><span class="n">resample_row_hv_2_kernel</span><span class="p">)(</span><span class="n">stbi_uc</span> <span class="o">*</span><span class="n">out</span><span class="p">,</span> <span class="n">stbi_uc</span> <span class="o">*</span><span class="n">in_near</span><span class="p">,</span> <span class="n">stbi_uc</span> <span class="o">*</span><span class="n">in_far</span><span class="p">,</span> <span class="kt">int</span> <span class="n">w</span><span class="p">,</span> <span class="kt">int</span> <span class="n">hs</span><span class="p">);</span>
<span class="p">}</span> <span class="n">stbi__jpeg</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">stbi__build_huffman</span><span class="p">(</span><span class="n">stbi__huffman</span> <span class="o">*</span><span class="n">h</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
   <span class="kt">int</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">code</span><span class="p">;</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-51'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-51'>#</a>
      </div>
      <p>build size list for each symbol (from JPEG spec)</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>   <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
      <span class="k">for</span> <span class="p">(</span><span class="n">j</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">[</span><span class="n">i</span><span class="p">];</span> <span class="o">++</span><span class="n">j</span><span class="p">)</span>
         <span class="n">h</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">[</span><span class="n">k</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">stbi_uc</span><span class="p">)</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
   <span class="n">h</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-52'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-52'>#</a>
      </div>
      <p>compute actual symbols (from jpeg spec)</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>   <span class="n">code</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
   <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
   <span class="k">for</span><span class="p">(</span><span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;=</span> <span class="mi">16</span><span class="p">;</span> <span class="o">++</span><span class="n">j</span><span class="p">)</span> <span class="p">{</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-53'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-53'>#</a>
      </div>
      <p>compute delta to add to code to compute symbol id</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>      <span class="n">h</span><span class="o">-&gt;</span><span class="n">delta</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">k</span> <span class="o">-</span> <span class="n">code</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">==</span> <span class="n">j</span><span class="p">)</span> <span class="p">{</span>
         <span class="k">while</span> <span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">==</span> <span class="n">j</span><span class="p">)</span>
            <span class="n">h</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">[</span><span class="n">k</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">stbi__uint16</span><span class="p">)</span> <span class="p">(</span><span class="n">code</span><span class="o">++</span><span class="p">);</span>
         <span class="k">if</span> <span class="p">(</span><span class="n">code</span><span class="o">-</span><span class="mi">1</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">j</span><span class="p">))</span> <span class="k">return</span> <span class="n">stbi__err</span><span class="p">(</span><span class="s">&quot;bad code lengths&quot;</span><span class="p">,</span><span class="s">&quot;Corrupt JPEG&quot;</span><span class="p">);</span>
      <span class="p">}</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-54'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-54'>#</a>
      </div>
      <p>compute largest code + 1 for this size, preshifted as needed later</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>      <span class="n">h</span><span class="o">-&gt;</span><span class="n">maxcode</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">code</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">16</span><span class="o">-</span><span class="n">j</span><span class="p">);</span>
      <span class="n">code</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>
   <span class="p">}</span>
   <span class="n">h</span><span class="o">-&gt;</span><span class="n">maxcode</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xffffffff</span><span class="p">;</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-55'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-55'>#</a>
      </div>
      <p>build non-spec acceleration table; 255 is flag for not-accelerated</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>   <span class="n">memset</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">fast</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">FAST_BITS</span><span class="p">);</span>
   <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">k</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
      <span class="kt">int</span> <span class="n">s</span> <span class="o">=</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&lt;=</span> <span class="n">FAST_BITS</span><span class="p">)</span> <span class="p">{</span>
         <span class="kt">int</span> <span class="n">c</span> <span class="o">=</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">FAST_BITS</span><span class="o">-</span><span class="n">s</span><span class="p">);</span>
         <span class="kt">int</span> <span class="n">m</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">FAST_BITS</span><span class="o">-</span><span class="n">s</span><span class="p">);</span>
         <span class="k">for</span> <span class="p">(</span><span class="n">j</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">m</span><span class="p">;</span> <span class="o">++</span><span class="n">j</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">h</span><span class="o">-&gt;</span><span class="n">fast</span><span class="p">[</span><span class="n">c</span><span class="o">+</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">stbi_uc</span><span class="p">)</span> <span class="n">i</span><span class="p">;</span>
         <span class="p">}</span>
      <span class="p">}</span>
   <span class="p">}</span>
   <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-56'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-56'>#</a>
      </div>
      <p>build a table that decodes both magnitude and value of small ACs in
one go.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">static</span> <span class="kt">void</span> <span class="nf">stbi__build_fast_ac</span><span class="p">(</span><span class="n">stbi__int16</span> <span class="o">*</span><span class="n">fast_ac</span><span class="p">,</span> <span class="n">stbi__huffman</span> <span class="o">*</span><span class="n">h</span><span class="p">)</span>
<span class="p">{</span>
   <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
   <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">FAST_BITS</span><span class="p">);</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">stbi_uc</span> <span class="n">fast</span> <span class="o">=</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">fast</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
      <span class="n">fast_ac</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">fast</span> <span class="o">&lt;</span> <span class="mi">255</span><span class="p">)</span> <span class="p">{</span>
         <span class="kt">int</span> <span class="n">rs</span> <span class="o">=</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">values</span><span class="p">[</span><span class="n">fast</span><span class="p">];</span>
         <span class="kt">int</span> <span class="n">run</span> <span class="o">=</span> <span class="p">(</span><span class="n">rs</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">15</span><span class="p">;</span>
         <span class="kt">int</span> <span class="n">magbits</span> <span class="o">=</span> <span class="n">rs</span> <span class="o">&amp;</span> <span class="mi">15</span><span class="p">;</span>
         <span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">[</span><span class="n">fast</span><span class="p">];</span>

         <span class="k">if</span> <span class="p">(</span><span class="n">magbits</span> <span class="o">&amp;&amp;</span> <span class="n">len</span> <span class="o">+</span> <span class="n">magbits</span> <span class="o">&lt;=</span> <span class="n">FAST_BITS</span><span class="p">)</span> <span class="p">{</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-57'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-57'>#</a>
      </div>
      <p>magnitude code followed by receive_extend code</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="kt">int</span> <span class="n">k</span> <span class="o">=</span> <span class="p">((</span><span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="n">len</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">FAST_BITS</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">FAST_BITS</span> <span class="o">-</span> <span class="n">magbits</span><span class="p">);</span>
            <span class="kt">int</span> <span class="n">m</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">magbits</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">k</span> <span class="o">&lt;</span> <span class="n">m</span><span class="p">)</span> <span class="n">k</span> <span class="o">+=</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">magbits</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-58'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-58'>#</a>
      </div>
      <p>if the result is small enough, we can fit it in fast_ac table</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="k">if</span> <span class="p">(</span><span class="n">k</span> <span class="o">&gt;=</span> <span class="o">-</span><span class="mi">128</span> <span class="o">&amp;&amp;</span> <span class="n">k</span> <span class="o">&lt;=</span> <span class="mi">127</span><span class="p">)</span>
               <span class="n">fast_ac</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">stbi__int16</span><span class="p">)</span> <span class="p">((</span><span class="n">k</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">run</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">len</span> <span class="o">+</span> <span class="n">magbits</span><span class="p">));</span>
         <span class="p">}</span>
      <span class="p">}</span>
   <span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">stbi__grow_buffer_unsafe</span><span class="p">(</span><span class="n">stbi__jpeg</span> <span class="o">*</span><span class="n">j</span><span class="p">)</span>
<span class="p">{</span>
   <span class="k">do</span> <span class="p">{</span>
      <span class="kt">int</span> <span class="n">b</span> <span class="o">=</span> <span class="n">j</span><span class="o">-&gt;</span><span class="n">nomore</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">stbi__get8</span><span class="p">(</span><span class="n">j</span><span class="o">-&gt;</span><span class="n">s</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">b</span> <span class="o">==</span> <span class="mh">0xff</span><span class="p">)</span> <span class="p">{</span>
         <span class="kt">int</span> <span class="n">c</span> <span class="o">=</span> <span class="n">stbi__get8</span><span class="p">(</span><span class="n">j</span><span class="o">-&gt;</span><span class="n">s</span><span class="p">);</span>
         <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">j</span><span class="o">-&gt;</span><span class="n">marker</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="n">c</span><span class="p">;</span>
            <span class="n">j</span><span class="o">-&gt;</span><span class="n">nomore</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
            <span class="k">return</span><span class="p">;</span>
         <span class="p">}</span>
      <span class="p">}</span>
      <span class="n">j</span><span class="o">-&gt;</span><span class="n">code_buffer</span> <span class="o">|=</span> <span class="n">b</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">24</span> <span class="o">-</span> <span class="n">j</span><span class="o">-&gt;</span><span class="n">code_bits</span><span class="p">);</span>
      <span class="n">j</span><span class="o">-&gt;</span><span class="n">code_bits</span> <span class="o">+=</span> <span class="mi">8</span><span class="p">;</span>
   <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">j</span><span class="o">-&gt;</span><span class="n">code_bits</span> <span class="o">&lt;=</span> <span class="mi">24</span><span class="p">);</span>
<span class="p">}</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-59'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-59'>#</a>
      </div>
      <p>(1 &lt;&lt; n) - 1</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">static</span> <span class="n">stbi__uint32</span> <span class="n">stbi__bmask</span><span class="p">[</span><span class="mi">17</span><span class="p">]</span><span class="o">=</span><span class="p">{</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">15</span><span class="p">,</span><span class="mi">31</span><span class="p">,</span><span class="mi">63</span><span class="p">,</span><span class="mi">127</span><span class="p">,</span><span class="mi">255</span><span class="p">,</span><span class="mi">511</span><span class="p">,</span><span class="mi">1023</span><span class="p">,</span><span class="mi">2047</span><span class="p">,</span><span class="mi">4095</span><span class="p">,</span><span class="mi">8191</span><span class="p">,</span><span class="mi">16383</span><span class="p">,</span><span class="mi">32767</span><span class="p">,</span><span class="mi">65535</span><span class="p">};</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-60'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-60'>#</a>
      </div>
      <p>decode a jpeg huffman value from the bitstream</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="n">stbi_inline</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">stbi__jpeg_huff_decode</span><span class="p">(</span><span class="n">stbi__jpeg</span> <span class="o">*</span><span class="n">j</span><span class="p">,</span> <span class="n">stbi__huffman</span> <span class="o">*</span><span class="n">h</span><span class="p">)</span>
<span class="p">{</span>
   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">temp</span><span class="p">;</span>
   <span class="kt">int</span> <span class="n">c</span><span class="p">,</span><span class="n">k</span><span class="p">;</span>

   <span class="k">if</span> <span class="p">(</span><span class="n">j</span><span class="o">-&gt;</span><span class="n">code_bits</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="n">stbi__grow_buffer_unsafe</span><span class="p">(</span><span class="n">j</span><span class="p">);</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-61'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-61'>#</a>
      </div>
      <p>look at the top FAST_BITS and determine what symbol ID it is,
if the code is &lt;= FAST_BITS</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>   <span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="n">j</span><span class="o">-&gt;</span><span class="n">code_buffer</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="mi">32</span> <span class="o">-</span> <span class="n">FAST_BITS</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">FAST_BITS</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
   <span class="n">k</span> <span class="o">=</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">fast</span><span class="p">[</span><span class="n">c</span><span class="p">];</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">k</span> <span class="o">&lt;</span> <span class="mi">255</span><span class="p">)</span> <span class="p">{</span>
      <span class="kt">int</span> <span class="n">s</span> <span class="o">=</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">[</span><span class="n">k</span><span class="p">];</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&gt;</span> <span class="n">j</span><span class="o">-&gt;</span><span class="n">code_bits</span><span class="p">)</span>
         <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
      <span class="n">j</span><span class="o">-&gt;</span><span class="n">code_buffer</span> <span class="o">&lt;&lt;=</span> <span class="n">s</span><span class="p">;</span>
      <span class="n">j</span><span class="o">-&gt;</span><span class="n">code_bits</span> <span class="o">-=</span> <span class="n">s</span><span class="p">;</span>
      <span class="k">return</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">values</span><span class="p">[</span><span class="n">k</span><span class="p">];</span>
   <span class="p">}</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-62'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-62'>#</a>
      </div>
      <p>naive test is to shift the code_buffer down so k bits are
valid, then test against maxcode. To speed this up, we've
preshifted maxcode left so that it has (16-k) 0s at the
end; in other words, regardless of the number of bits, it
wants to be compared against something shifted to have 16;
that way we don't need to shift inside the loop.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>   <span class="n">temp</span> <span class="o">=</span> <span class="n">j</span><span class="o">-&gt;</span><span class="n">code_buffer</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>
   <span class="k">for</span> <span class="p">(</span><span class="n">k</span><span class="o">=</span><span class="n">FAST_BITS</span><span class="o">+</span><span class="mi">1</span> <span class="p">;</span> <span class="p">;</span> <span class="o">++</span><span class="n">k</span><span class="p">)</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">temp</span> <span class="o">&lt;</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">maxcode</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
         <span class="k">break</span><span class="p">;</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">k</span> <span class="o">==</span> <span class="mi">17</span><span class="p">)</span> <span class="p">{</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-63'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-63'>#</a>
      </div>
      <p>error! code not found</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>      <span class="n">j</span><span class="o">-&gt;</span><span class="n">code_bits</span> <span class="o">-=</span> <span class="mi">16</span><span class="p">;</span>
      <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="k">if</span> <span class="p">(</span><span class="n">k</span> <span class="o">&gt;</span> <span class="n">j</span><span class="o">-&gt;</span><span class="n">code_bits</span><span class="p">)</span>
      <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-64'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-64'>#</a>
      </div>
      <p>convert the huffman code to the symbol id</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>   <span class="n">c</span> <span class="o">=</span> <span class="p">((</span><span class="n">j</span><span class="o">-&gt;</span><span class="n">code_buffer</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="mi">32</span> <span class="o">-</span> <span class="n">k</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">stbi__bmask</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="o">+</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">delta</span><span class="p">[</span><span class="n">k</span><span class="p">];</span>
   <span class="n">STBI_ASSERT</span><span class="p">((((</span><span class="n">j</span><span class="o">-&gt;</span><span class="n">code_buffer</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="mi">32</span> <span class="o">-</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">[</span><span class="n">c</span><span class="p">]))</span> <span class="o">&amp;</span> <span class="n">stbi__bmask</span><span class="p">[</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">[</span><span class="n">c</span><span class="p">]])</span> <span class="o">==</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">[</span><span class="n">c</span><span class="p">]);</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-65'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-65'>#</a>
      </div>
      <p>convert the id to a symbol</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>   <span class="n">j</span><span class="o">-&gt;</span><span class="n">code_bits</span> <span class="o">-=</span> <span class="n">k</span><span class="p">;</span>
   <span class="n">j</span><span class="o">-&gt;</span><span class="n">code_buffer</span> <span class="o">&lt;&lt;=</span> <span class="n">k</span><span class="p">;</span>
   <span class="k">return</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">values</span><span class="p">[</span><span class="n">c</span><span class="p">];</span>
<span class="p">}</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-66'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-66'>#</a>
      </div>
      <p>bias[n] = (-1&lt;&lt;n) + 1</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">static</span> <span class="kt">int</span> <span class="k">const</span> <span class="n">stbi__jbias</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span><span class="o">-</span><span class="mi">7</span><span class="p">,</span><span class="o">-</span><span class="mi">15</span><span class="p">,</span><span class="o">-</span><span class="mi">31</span><span class="p">,</span><span class="o">-</span><span class="mi">63</span><span class="p">,</span><span class="o">-</span><span class="mi">127</span><span class="p">,</span><span class="o">-</span><span class="mi">255</span><span class="p">,</span><span class="o">-</span><span class="mi">511</span><span class="p">,</span><span class="o">-</span><span class="mi">1023</span><span class="p">,</span><span class="o">-</span><span class="mi">2047</span><span class="p">,</span><span class="o">-</span><span class="mi">4095</span><span class="p">,</span><span class="o">-</span><span class="mi">8191</span><span class="p">,</span><span class="o">-</span><span class="mi">16383</span><span class="p">,</span><span class="o">-</span><span class="mi">32767</span><span class="p">};</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-67'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-67'>#</a>
      </div>
      <p>combined JPEG 'receive' and JPEG 'extend', since baseline
always extends everything it receives.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="n">stbi_inline</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">stbi__extend_receive</span><span class="p">(</span><span class="n">stbi__jpeg</span> <span class="o">*</span><span class="n">j</span><span class="p">,</span> <span class="kt">int</span> <span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">k</span><span class="p">;</span>
   <span class="kt">int</span> <span class="n">sgn</span><span class="p">;</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">j</span><span class="o">-&gt;</span><span class="n">code_bits</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">)</span> <span class="n">stbi__grow_buffer_unsafe</span><span class="p">(</span><span class="n">j</span><span class="p">);</span>

   <span class="n">sgn</span> <span class="o">=</span> <span class="p">(</span><span class="n">stbi__int32</span><span class="p">)</span><span class="n">j</span><span class="o">-&gt;</span><span class="n">code_buffer</span> <span class="o">&gt;&gt;</span> <span class="mi">31</span><span class="p">;</span> <span class="c1">// sign bit is always in MSB</span>
   <span class="n">k</span> <span class="o">=</span> <span class="n">stbi_lrot</span><span class="p">(</span><span class="n">j</span><span class="o">-&gt;</span><span class="n">code_buffer</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>
   <span class="n">STBI_ASSERT</span><span class="p">(</span><span class="n">n</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">stbi__bmask</span><span class="p">)</span><span class="o">/</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">stbi__bmask</span><span class="p">)));</span>
   <span class="n">j</span><span class="o">-&gt;</span><span class="n">code_buffer</span> <span class="o">=</span> <span class="n">k</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">stbi__bmask</span><span class="p">[</span><span class="n">n</span><span class="p">];</span>
   <span class="n">k</span> <span class="o">&amp;=</span> <span class="n">stbi__bmask</span><span class="p">[</span><span class="n">n</span><span class="p">];</span>
   <span class="n">j</span><span class="o">-&gt;</span><span class="n">code_bits</span> <span class="o">-=</span> <span class="n">n</span><span class="p">;</span>
   <span class="k">return</span> <span class="n">k</span> <span class="o">+</span> <span class="p">(</span><span class="n">stbi__jbias</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">sgn</span><span class="p">);</span>
<span class="p">}</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-68'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-68'>#</a>
      </div>
      <p>get some unsigned bits</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="n">stbi_inline</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">stbi__jpeg_get_bits</span><span class="p">(</span><span class="n">stbi__jpeg</span> <span class="o">*</span><span class="n">j</span><span class="p">,</span> <span class="kt">int</span> <span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">k</span><span class="p">;</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">j</span><span class="o">-&gt;</span><span class="n">code_bits</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">)</span> <span class="n">stbi__grow_buffer_unsafe</span><span class="p">(</span><span class="n">j</span><span class="p">);</span>
   <span class="n">k</span> <span class="o">=</span> <span class="n">stbi_lrot</span><span class="p">(</span><span class="n">j</span><span class="o">-&gt;</span><span class="n">code_buffer</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>
   <span class="n">j</span><span class="o">-&gt;</span><span class="n">code_buffer</span> <span class="o">=</span> <span class="n">k</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">stbi__bmask</span><span class="p">[</span><span class="n">n</span><span class="p">];</span>
   <span class="n">k</span> <span class="o">&amp;=</span> <span class="n">stbi__bmask</span><span class="p">[</span><span class="n">n</span><span class="p">];</span>
   <span class="n">j</span><span class="o">-&gt;</span><span class="n">code_bits</span> <span class="o">-=</span> <span class="n">n</span><span class="p">;</span>
   <span class="k">return</span> <span class="n">k</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">stbi_inline</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">stbi__jpeg_get_bit</span><span class="p">(</span><span class="n">stbi__jpeg</span> <span class="o">*</span><span class="n">j</span><span class="p">)</span>
<span class="p">{</span>
   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">k</span><span class="p">;</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">j</span><span class="o">-&gt;</span><span class="n">code_bits</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="n">stbi__grow_buffer_unsafe</span><span class="p">(</span><span class="n">j</span><span class="p">);</span>
   <span class="n">k</span> <span class="o">=</span> <span class="n">j</span><span class="o">-&gt;</span><span class="n">code_buffer</span><span class="p">;</span>
   <span class="n">j</span><span class="o">-&gt;</span><span class="n">code_buffer</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>
   <span class="o">--</span><span class="n">j</span><span class="o">-&gt;</span><span class="n">code_bits</span><span class="p">;</span>
   <span class="k">return</span> <span class="n">k</span> <span class="o">&amp;</span> <span class="mh">0x80000000</span><span class="p">;</span>
<span class="p">}</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-69'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-69'>#</a>
      </div>
      <p>given a value that's at position X in the zigzag stream,
where does it appear in the 8x8 matrix coded as row-major?</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">static</span> <span class="n">stbi_uc</span> <span class="n">stbi__jpeg_dezigzag</span><span class="p">[</span><span class="mi">64</span><span class="o">+</span><span class="mi">15</span><span class="p">]</span> <span class="o">=</span>
<span class="p">{</span>
    <span class="mi">0</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span>  <span class="mi">8</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span>  <span class="mi">9</span><span class="p">,</span>  <span class="mi">2</span><span class="p">,</span>  <span class="mi">3</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span>
   <span class="mi">17</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span>  <span class="mi">4</span><span class="p">,</span>  <span class="mi">5</span><span class="p">,</span>
   <span class="mi">12</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">26</span><span class="p">,</span> <span class="mi">33</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">48</span><span class="p">,</span> <span class="mi">41</span><span class="p">,</span> <span class="mi">34</span><span class="p">,</span>
   <span class="mi">27</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span>  <span class="mi">6</span><span class="p">,</span>  <span class="mi">7</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span>
   <span class="mi">35</span><span class="p">,</span> <span class="mi">42</span><span class="p">,</span> <span class="mi">49</span><span class="p">,</span> <span class="mi">56</span><span class="p">,</span> <span class="mi">57</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">43</span><span class="p">,</span> <span class="mi">36</span><span class="p">,</span>
   <span class="mi">29</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">37</span><span class="p">,</span> <span class="mi">44</span><span class="p">,</span> <span class="mi">51</span><span class="p">,</span>
   <span class="mi">58</span><span class="p">,</span> <span class="mi">59</span><span class="p">,</span> <span class="mi">52</span><span class="p">,</span> <span class="mi">45</span><span class="p">,</span> <span class="mi">38</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">39</span><span class="p">,</span> <span class="mi">46</span><span class="p">,</span>
   <span class="mi">53</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">61</span><span class="p">,</span> <span class="mi">54</span><span class="p">,</span> <span class="mi">47</span><span class="p">,</span> <span class="mi">55</span><span class="p">,</span> <span class="mi">62</span><span class="p">,</span> <span class="mi">63</span><span class="p">,</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-70'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-70'>#</a>
      </div>
      <p>let corrupt input sample past end</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>   <span class="mi">63</span><span class="p">,</span> <span class="mi">63</span><span class="p">,</span> <span class="mi">63</span><span class="p">,</span> <span class="mi">63</span><span class="p">,</span> <span class="mi">63</span><span class="p">,</span> <span class="mi">63</span><span class="p">,</span> <span class="mi">63</span><span class="p">,</span> <span class="mi">63</span><span class="p">,</span>
   <span class="mi">63</span><span class="p">,</span> <span class="mi">63</span><span class="p">,</span> <span class="mi">63</span><span class="p">,</span> <span class="mi">63</span><span class="p">,</span> <span class="mi">63</span><span class="p">,</span> <span class="mi">63</span><span class="p">,</span> <span class="mi">63</span>
<span class="p">};</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-71'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-71'>#</a>
      </div>
      <p>decode one 64-entry block--</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">static</span> <span class="kt">int</span> <span class="nf">stbi__jpeg_decode_block</span><span class="p">(</span><span class="n">stbi__jpeg</span> <span class="o">*</span><span class="n">j</span><span class="p">,</span> <span class="kt">short</span> <span class="n">data</span><span class="p">[</span><span class="mi">64</span><span class="p">],</span> <span class="n">stbi__huffman</span> <span class="o">*</span><span class="n">hdc</span><span class="p">,</span> <span class="n">stbi__huffman</span> <span class="o">*</span><span class="n">hac</span><span class="p">,</span> <span class="n">stbi__int16</span> <span class="o">*</span><span class="n">fac</span><span class="p">,</span> <span class="kt">int</span> <span class="n">b</span><span class="p">,</span> <span class="n">stbi_uc</span> <span class="o">*</span><span class="n">dequant</span><span class="p">)</span>
<span class="p">{</span>
   <span class="kt">int</span> <span class="n">diff</span><span class="p">,</span><span class="n">dc</span><span class="p">,</span><span class="n">k</span><span class="p">;</span>
   <span class="kt">int</span> <span class="n">t</span><span class="p">;</span>

   <span class="k">if</span> <span class="p">(</span><span class="n">j</span><span class="o">-&gt;</span><span class="n">code_bits</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="n">stbi__grow_buffer_unsafe</span><span class="p">(</span><span class="n">j</span><span class="p">);</span>
   <span class="n">t</span> <span class="o">=</span> <span class="n">stbi__jpeg_huff_decode</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">hdc</span><span class="p">);</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">t</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="n">stbi__err</span><span class="p">(</span><span class="s">&quot;bad huffman code&quot;</span><span class="p">,</span><span class="s">&quot;Corrupt JPEG&quot;</span><span class="p">);</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-72'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-72'>#</a>
      </div>
      <p>0 all the ac values now so we can do it 32-bits at a time</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>   <span class="n">memset</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">64</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span>

   <span class="n">diff</span> <span class="o">=</span> <span class="n">t</span> <span class="o">?</span> <span class="n">stbi__extend_receive</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
   <span class="n">dc</span> <span class="o">=</span> <span class="n">j</span><span class="o">-&gt;</span><span class="n">img_comp</span><span class="p">[</span><span class="n">b</span><span class="p">].</span><span class="n">dc_pred</span> <span class="o">+</span> <span class="n">diff</span><span class="p">;</span>
   <span class="n">j</span><span class="o">-&gt;</span><span class="n">img_comp</span><span class="p">[</span><span class="n">b</span><span class="p">].</span><span class="n">dc_pred</span> <span class="o">=</span> <span class="n">dc</span><span class="p">;</span>
   <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">short</span><span class="p">)</span> <span class="p">(</span><span class="n">dc</span> <span class="o">*</span> <span class="n">dequant</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-73'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-73'>#</a>
      </div>
      <p>decode AC components, see JPEG spec</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>   <span class="n">k</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
   <span class="k">do</span> <span class="p">{</span>
      <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">zig</span><span class="p">;</span>
      <span class="kt">int</span> <span class="n">c</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">s</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">j</span><span class="o">-&gt;</span><span class="n">code_bits</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="n">stbi__grow_buffer_unsafe</span><span class="p">(</span><span class="n">j</span><span class="p">);</span>
      <span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="n">j</span><span class="o">-&gt;</span><span class="n">code_buffer</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="mi">32</span> <span class="o">-</span> <span class="n">FAST_BITS</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">FAST_BITS</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
      <span class="n">r</span> <span class="o">=</span> <span class="n">fac</span><span class="p">[</span><span class="n">c</span><span class="p">];</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// fast-AC path</span>
         <span class="n">k</span> <span class="o">+=</span> <span class="p">(</span><span class="n">r</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">15</span><span class="p">;</span> <span class="c1">// run</span>
         <span class="n">s</span> <span class="o">=</span> <span class="n">r</span> <span class="o">&amp;</span> <span class="mi">15</span><span class="p">;</span> <span class="c1">// combined length</span>
         <span class="n">j</span><span class="o">-&gt;</span><span class="n">code_buffer</span> <span class="o">&lt;&lt;=</span> <span class="n">s</span><span class="p">;</span>
         <span class="n">j</span><span class="o">-&gt;</span><span class="n">code_bits</span> <span class="o">-=</span> <span class="n">s</span><span class="p">;</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-74'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-74'>#</a>
      </div>
      <p>decode into unzigzag'd location</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>         <span class="n">zig</span> <span class="o">=</span> <span class="n">stbi__jpeg_dezigzag</span><span class="p">[</span><span class="n">k</span><span class="o">++</span><span class="p">];</span>
         <span class="n">data</span><span class="p">[</span><span class="n">zig</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">short</span><span class="p">)</span> <span class="p">((</span><span class="n">r</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">*</span> <span class="n">dequant</span><span class="p">[</span><span class="n">zig</span><span class="p">]);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
         <span class="kt">int</span> <span class="n">rs</span> <span class="o">=</span> <span class="n">stbi__jpeg_huff_decode</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">hac</span><span class="p">);</span>
         <span class="k">if</span> <span class="p">(</span><span class="n">rs</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="n">stbi__err</span><span class="p">(</span><span class="s">&quot;bad huffman code&quot;</span><span class="p">,</span><span class="s">&quot;Corrupt JPEG&quot;</span><span class="p">);</span>
         <span class="n">s</span> <span class="o">=</span> <span class="n">rs</span> <span class="o">&amp;</span> <span class="mi">15</span><span class="p">;</span>
         <span class="n">r</span> <span class="o">=</span> <span class="n">rs</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">;</span>
         <span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">rs</span> <span class="o">!=</span> <span class="mh">0xf0</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span> <span class="c1">// end block</span>
            <span class="n">k</span> <span class="o">+=</span> <span class="mi">16</span><span class="p">;</span>
         <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">k</span> <span class="o">+=</span> <span class="n">r</span><span class="p">;</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-75'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-75'>#</a>
      </div>
      <p>decode into unzigzag'd location</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="n">zig</span> <span class="o">=</span> <span class="n">stbi__jpeg_dezigzag</span><span class="p">[</span><span class="n">k</span><span class="o">++</span><span class="p">];</span>
            <span class="n">data</span><span class="p">[</span><span class="n">zig</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">short</span><span class="p">)</span> <span class="p">(</span><span class="n">stbi__extend_receive</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">s</span><span class="p">)</span> <span class="o">*</span> <span class="n">dequant</span><span class="p">[</span><span class="n">zig</span><span class="p">]);</span>
         <span class="p">}</span>
      <span class="p">}</span>
   <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">k</span> <span class="o">&lt;</span> <span class="mi">64</span><span class="p">);</span>
   <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">stbi__jpeg_decode_block_prog_dc</span><span class="p">(</span><span class="n">stbi__jpeg</span> <span class="o">*</span><span class="n">j</span><span class="p">,</span> <span class="kt">short</span> <span class="n">data</span><span class="p">[</span><span class="mi">64</span><span class="p">],</span> <span class="n">stbi__huffman</span> <span class="o">*</span><span class="n">hdc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
   <span class="kt">int</span> <span class="n">diff</span><span class="p">,</span><span class="n">dc</span><span class="p">;</span>
   <span class="kt">int</span> <span class="n">t</span><span class="p">;</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">j</span><span class="o">-&gt;</span><span class="n">spec_end</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="n">stbi__err</span><span class="p">(</span><span class="s">&quot;can&#39;t merge dc and ac&quot;</span><span class="p">,</span> <span class="s">&quot;Corrupt JPEG&quot;</span><span class="p">);</span>

   <span class="k">if</span> <span class="p">(</span><span class="n">j</span><span class="o">-&gt;</span><span class="n">code_bits</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="n">stbi__grow_buffer_unsafe</span><span class="p">(</span><span class="n">j</span><span class="p">);</span>

   <span class="k">if</span> <span class="p">(</span><span class="n">j</span><span class="o">-&gt;</span><span class="n">succ_high</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-76'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-76'>#</a>
      </div>
      <p>first scan for DC coefficient, must be first</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>      <span class="n">memset</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">64</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span> <span class="c1">// 0 all the ac values now</span>
      <span class="n">t</span> <span class="o">=</span> <span class="n">stbi__jpeg_huff_decode</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">hdc</span><span class="p">);</span>
      <span class="n">diff</span> <span class="o">=</span> <span class="n">t</span> <span class="o">?</span> <span class="n">stbi__extend_receive</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

      <span class="n">dc</span> <span class="o">=</span> <span class="n">j</span><span class="o">-&gt;</span><span class="n">img_comp</span><span class="p">[</span><span class="n">b</span><span class="p">].</span><span class="n">dc_pred</span> <span class="o">+</span> <span class="n">diff</span><span class="p">;</span>
      <span class="n">j</span><span class="o">-&gt;</span><span class="n">img_comp</span><span class="p">[</span><span class="n">b</span><span class="p">].</span><span class="n">dc_pred</span> <span class="o">=</span> <span class="n">dc</span><span class="p">;</span>
      <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">short</span><span class="p">)</span> <span class="p">(</span><span class="n">dc</span> <span class="o">&lt;&lt;</span> <span class="n">j</span><span class="o">-&gt;</span><span class="n">succ_low</span><span class="p">);</span>
   <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-77'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-77'>#</a>
      </div>
      <p>refinement scan for DC coefficient</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>      <span class="k">if</span> <span class="p">(</span><span class="n">stbi__jpeg_get_bit</span><span class="p">(</span><span class="n">j</span><span class="p">))</span>
         <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span><span class="kt">short</span><span class="p">)</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">j</span><span class="o">-&gt;</span><span class="n">succ_low</span><span class="p">);</span>
   <span class="p">}</span>
   <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-78'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-78'>#</a>
      </div>
      <p>@OPTIMIZE: store non-zigzagged during the decode passes,
and only de-zigzag when dequantizing</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">static</span> <span class="kt">int</span> <span class="nf">stbi__jpeg_decode_block_prog_ac</span><span class="p">(</span><span class="n">stbi__jpeg</span> <span class="o">*</span><span class="n">j</span><span class="p">,</span> <span class="kt">short</span> <span class="n">data</span><span class="p">[</span><span class="mi">64</span><span class="p">],</span> <span class="n">stbi__huffman</span> <span class="o">*</span><span class="n">hac</span><span class="p">,</span> <span class="n">stbi__int16</span> <span class="o">*</span><span class="n">fac</span><span class="p">)</span>
<span class="p">{</span>
   <span class="kt">int</span> <span class="n">k</span><span class="p">;</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">j</span><span class="o">-&gt;</span><span class="n">spec_start</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="n">stbi__err</span><span class="p">(</span><span class="s">&quot;can&#39;t merge dc and ac&quot;</span><span class="p">,</span> <span class="s">&quot;Corrupt JPEG&quot;</span><span class="p">);</span>

   <span class="k">if</span> <span class="p">(</span><span class="n">j</span><span class="o">-&gt;</span><span class="n">succ_high</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="kt">int</span> <span class="n">shift</span> <span class="o">=</span> <span class="n">j</span><span class="o">-&gt;</span><span class="n">succ_low</span><span class="p">;</span>

      <span class="k">if</span> <span class="p">(</span><span class="n">j</span><span class="o">-&gt;</span><span class="n">eob_run</span><span class="p">)</span> <span class="p">{</span>
         <span class="o">--</span><span class="n">j</span><span class="o">-&gt;</span><span class="n">eob_run</span><span class="p">;</span>
         <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="n">k</span> <span class="o">=</span> <span class="n">j</span><span class="o">-&gt;</span><span class="n">spec_start</span><span class="p">;</span>
      <span class="k">do</span> <span class="p">{</span>
         <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">zig</span><span class="p">;</span>
         <span class="kt">int</span> <span class="n">c</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">s</span><span class="p">;</span>
         <span class="k">if</span> <span class="p">(</span><span class="n">j</span><span class="o">-&gt;</span><span class="n">code_bits</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="n">stbi__grow_buffer_unsafe</span><span class="p">(</span><span class="n">j</span><span class="p">);</span>
         <span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="n">j</span><span class="o">-&gt;</span><span class="n">code_buffer</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="mi">32</span> <span class="o">-</span> <span class="n">FAST_BITS</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">FAST_BITS</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
         <span class="n">r</span> <span class="o">=</span> <span class="n">fac</span><span class="p">[</span><span class="n">c</span><span class="p">];</span>
         <span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// fast-AC path</span>
            <span class="n">k</span> <span class="o">+=</span> <span class="p">(</span><span class="n">r</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">15</span><span class="p">;</span> <span class="c1">// run</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">r</span> <span class="o">&amp;</span> <span class="mi">15</span><span class="p">;</span> <span class="c1">// combined length</span>
            <span class="n">j</span><span class="o">-&gt;</span><span class="n">code_buffer</span> <span class="o">&lt;&lt;=</span> <span class="n">s</span><span class="p">;</span>
            <span class="n">j</span><span class="o">-&gt;</span><span class="n">code_bits</span> <span class="o">-=</span> <span class="n">s</span><span class="p">;</span>
            <span class="n">zig</span> <span class="o">=</span> <span class="n">stbi__jpeg_dezigzag</span><span class="p">[</span><span class="n">k</span><span class="o">++</span><span class="p">];</span>
            <span class="n">data</span><span class="p">[</span><span class="n">zig</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">short</span><span class="p">)</span> <span class="p">((</span><span class="n">r</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">shift</span><span class="p">);</span>
         <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="kt">int</span> <span class="n">rs</span> <span class="o">=</span> <span class="n">stbi__jpeg_huff_decode</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">hac</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">rs</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="n">stbi__err</span><span class="p">(</span><span class="s">&quot;bad huffman code&quot;</span><span class="p">,</span><span class="s">&quot;Corrupt JPEG&quot;</span><span class="p">);</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">rs</span> <span class="o">&amp;</span> <span class="mi">15</span><span class="p">;</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">rs</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
               <span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">&lt;</span> <span class="mi">15</span><span class="p">)</span> <span class="p">{</span>
                  <span class="n">j</span><span class="o">-&gt;</span><span class="n">eob_run</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">r</span><span class="p">);</span>
                  <span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
                     <span class="n">j</span><span class="o">-&gt;</span><span class="n">eob_run</span> <span class="o">+=</span> <span class="n">stbi__jpeg_get_bits</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>
                  <span class="o">--</span><span class="n">j</span><span class="o">-&gt;</span><span class="n">eob_run</span><span class="p">;</span>
                  <span class="k">break</span><span class="p">;</span>
               <span class="p">}</span>
               <span class="n">k</span> <span class="o">+=</span> <span class="mi">16</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
               <span class="n">k</span> <span class="o">+=</span> <span class="n">r</span><span class="p">;</span>
               <span class="n">zig</span> <span class="o">=</span> <span class="n">stbi__jpeg_dezigzag</span><span class="p">[</span><span class="n">k</span><span class="o">++</span><span class="p">];</span>
               <span class="n">data</span><span class="p">[</span><span class="n">zig</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">short</span><span class="p">)</span> <span class="p">(</span><span class="n">stbi__extend_receive</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">s</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">shift</span><span class="p">);</span>
            <span class="p">}</span>
         <span class="p">}</span>
      <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">k</span> <span class="o">&lt;=</span> <span class="n">j</span><span class="o">-&gt;</span><span class="n">spec_end</span><span class="p">);</span>
   <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-79'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-79'>#</a>
      </div>
      <p>refinement scan for these AC coefficients</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>      <span class="kt">short</span> <span class="n">bit</span> <span class="o">=</span> <span class="p">(</span><span class="kt">short</span><span class="p">)</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">j</span><span class="o">-&gt;</span><span class="n">succ_low</span><span class="p">);</span>

      <span class="k">if</span> <span class="p">(</span><span class="n">j</span><span class="o">-&gt;</span><span class="n">eob_run</span><span class="p">)</span> <span class="p">{</span>
         <span class="o">--</span><span class="n">j</span><span class="o">-&gt;</span><span class="n">eob_run</span><span class="p">;</span>
         <span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="n">j</span><span class="o">-&gt;</span><span class="n">spec_start</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;=</span> <span class="n">j</span><span class="o">-&gt;</span><span class="n">spec_end</span><span class="p">;</span> <span class="o">++</span><span class="n">k</span><span class="p">)</span> <span class="p">{</span>
            <span class="kt">short</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">[</span><span class="n">stbi__jpeg_dezigzag</span><span class="p">[</span><span class="n">k</span><span class="p">]];</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
               <span class="k">if</span> <span class="p">(</span><span class="n">stbi__jpeg_get_bit</span><span class="p">(</span><span class="n">j</span><span class="p">))</span>
                  <span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">p</span> <span class="o">&amp;</span> <span class="n">bit</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                     <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
                        <span class="o">*</span><span class="n">p</span> <span class="o">+=</span> <span class="n">bit</span><span class="p">;</span>
                     <span class="k">else</span>
                        <span class="o">*</span><span class="n">p</span> <span class="o">-=</span> <span class="n">bit</span><span class="p">;</span>
                  <span class="p">}</span>
         <span class="p">}</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
         <span class="n">k</span> <span class="o">=</span> <span class="n">j</span><span class="o">-&gt;</span><span class="n">spec_start</span><span class="p">;</span>
         <span class="k">do</span> <span class="p">{</span>
            <span class="kt">int</span> <span class="n">r</span><span class="p">,</span><span class="n">s</span><span class="p">;</span>
            <span class="kt">int</span> <span class="n">rs</span> <span class="o">=</span> <span class="n">stbi__jpeg_huff_decode</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">hac</span><span class="p">);</span> <span class="c1">// @OPTIMIZE see if we can use the fast path here, advance-by-r is so slow, eh</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">rs</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="n">stbi__err</span><span class="p">(</span><span class="s">&quot;bad huffman code&quot;</span><span class="p">,</span><span class="s">&quot;Corrupt JPEG&quot;</span><span class="p">);</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">rs</span> <span class="o">&amp;</span> <span class="mi">15</span><span class="p">;</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">rs</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
               <span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">&lt;</span> <span class="mi">15</span><span class="p">)</span> <span class="p">{</span>
                  <span class="n">j</span><span class="o">-&gt;</span><span class="n">eob_run</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">r</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
                  <span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
                     <span class="n">j</span><span class="o">-&gt;</span><span class="n">eob_run</span> <span class="o">+=</span> <span class="n">stbi__jpeg_get_bits</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>
                  <span class="n">r</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span> <span class="c1">// force end of block</span>
               <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-80'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-80'>#</a>
      </div>
      <p>r=15 s=0 should write 16 0s, so we just do
a run of 15 0s and then write s (which is 0),
so we don't have to do anything special here</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>               <span class="p">}</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
               <span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="k">return</span> <span class="n">stbi__err</span><span class="p">(</span><span class="s">&quot;bad huffman code&quot;</span><span class="p">,</span> <span class="s">&quot;Corrupt JPEG&quot;</span><span class="p">);</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-81'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-81'>#</a>
      </div>
      <p>sign bit</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>               <span class="k">if</span> <span class="p">(</span><span class="n">stbi__jpeg_get_bit</span><span class="p">(</span><span class="n">j</span><span class="p">))</span>
                  <span class="n">s</span> <span class="o">=</span> <span class="n">bit</span><span class="p">;</span>
               <span class="k">else</span>
                  <span class="n">s</span> <span class="o">=</span> <span class="o">-</span><span class="n">bit</span><span class="p">;</span>
            <span class="p">}</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-82'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-82'>#</a>
      </div>
      <p>advance by r</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="k">while</span> <span class="p">(</span><span class="n">k</span> <span class="o">&lt;=</span> <span class="n">j</span><span class="o">-&gt;</span><span class="n">spec_end</span><span class="p">)</span> <span class="p">{</span>
               <span class="kt">short</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">[</span><span class="n">stbi__jpeg_dezigzag</span><span class="p">[</span><span class="n">k</span><span class="o">++</span><span class="p">]];</span>
               <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                  <span class="k">if</span> <span class="p">(</span><span class="n">stbi__jpeg_get_bit</span><span class="p">(</span><span class="n">j</span><span class="p">))</span>
                     <span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">p</span> <span class="o">&amp;</span> <span class="n">bit</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
                           <span class="o">*</span><span class="n">p</span> <span class="o">+=</span> <span class="n">bit</span><span class="p">;</span>
                        <span class="k">else</span>
                           <span class="o">*</span><span class="n">p</span> <span class="o">-=</span> <span class="n">bit</span><span class="p">;</span>
                     <span class="p">}</span>
               <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                  <span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                     <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="kt">short</span><span class="p">)</span> <span class="n">s</span><span class="p">;</span>
                     <span class="k">break</span><span class="p">;</span>
                  <span class="p">}</span>
                  <span class="o">--</span><span class="n">r</span><span class="p">;</span>
               <span class="p">}</span>
            <span class="p">}</span>
         <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">k</span> <span class="o">&lt;=</span> <span class="n">j</span><span class="o">-&gt;</span><span class="n">spec_end</span><span class="p">);</span>
      <span class="p">}</span>
   <span class="p">}</span>
   <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-83'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-83'>#</a>
      </div>
      <p>take a -128..127 value and stbi__clamp it and convert to 0..255</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="n">stbi_inline</span> <span class="k">static</span> <span class="n">stbi_uc</span> <span class="nf">stbi__clamp</span><span class="p">(</span><span class="kt">int</span> <span class="n">x</span><span class="p">)</span>
<span class="p">{</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-84'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-84'>#</a>
      </div>
      <p>trick to use a single test to catch both cases</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>   <span class="k">if</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="mi">255</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">x</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">x</span> <span class="o">&gt;</span> <span class="mi">255</span><span class="p">)</span> <span class="k">return</span> <span class="mi">255</span><span class="p">;</span>
   <span class="p">}</span>
   <span class="k">return</span> <span class="p">(</span><span class="n">stbi_uc</span><span class="p">)</span> <span class="n">x</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define stbi__f2f(x)  ((int) (((x) * 4096 + 0.5)))</span>
<span class="cp">#define stbi__fsh(x)  ((x) &lt;&lt; 12)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-85'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-85'>#</a>
      </div>
      <p>derived from jidctint -- DCT_ISLOW</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="cp">#define STBI__IDCT_1D(s0,s1,s2,s3,s4,s5,s6,s7) \</span>
<span class="cp">   int t0,t1,t2,t3,p1,p2,p3,p4,p5,x0,x1,x2,x3; \</span>
<span class="cp">   p2 = s2;                                    \</span>
<span class="cp">   p3 = s6;                                    \</span>
<span class="cp">   p1 = (p2+p3) * stbi__f2f(0.5411961f);       \</span>
<span class="cp">   t2 = p1 + p3*stbi__f2f(-1.847759065f);      \</span>
<span class="cp">   t3 = p1 + p2*stbi__f2f( 0.765366865f);      \</span>
<span class="cp">   p2 = s0;                                    \</span>
<span class="cp">   p3 = s4;                                    \</span>
<span class="cp">   t0 = stbi__fsh(p2+p3);                      \</span>
<span class="cp">   t1 = stbi__fsh(p2-p3);                      \</span>
<span class="cp">   x0 = t0+t3;                                 \</span>
<span class="cp">   x3 = t0-t3;                                 \</span>
<span class="cp">   x1 = t1+t2;                                 \</span>
<span class="cp">   x2 = t1-t2;                                 \</span>
<span class="cp">   t0 = s7;                                    \</span>
<span class="cp">   t1 = s5;                                    \</span>
<span class="cp">   t2 = s3;                                    \</span>
<span class="cp">   t3 = s1;                                    \</span>
<span class="cp">   p3 = t0+t2;                                 \</span>
<span class="cp">   p4 = t1+t3;                                 \</span>
<span class="cp">   p1 = t0+t3;                                 \</span>
<span class="cp">   p2 = t1+t2;                                 \</span>
<span class="cp">   p5 = (p3+p4)*stbi__f2f( 1.175875602f);      \</span>
<span class="cp">   t0 = t0*stbi__f2f( 0.298631336f);           \</span>
<span class="cp">   t1 = t1*stbi__f2f( 2.053119869f);           \</span>
<span class="cp">   t2 = t2*stbi__f2f( 3.072711026f);           \</span>
<span class="cp">   t3 = t3*stbi__f2f( 1.501321110f);           \</span>
<span class="cp">   p1 = p5 + p1*stbi__f2f(-0.899976223f);      \</span>
<span class="cp">   p2 = p5 + p2*stbi__f2f(-2.562915447f);      \</span>
<span class="cp">   p3 = p3*stbi__f2f(-1.961570560f);           \</span>
<span class="cp">   p4 = p4*stbi__f2f(-0.390180644f);           \</span>
<span class="cp">   t3 += p1+p4;                                \</span>
<span class="cp">   t2 += p2+p3;                                \</span>
<span class="cp">   t1 += p2+p4;                                \</span>
<span class="cp">   t0 += p1+p3;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">stbi__idct_block</span><span class="p">(</span><span class="n">stbi_uc</span> <span class="o">*</span><span class="n">out</span><span class="p">,</span> <span class="kt">int</span> <span class="n">out_stride</span><span class="p">,</span> <span class="kt">short</span> <span class="n">data</span><span class="p">[</span><span class="mi">64</span><span class="p">])</span>
<span class="p">{</span>
   <span class="kt">int</span> <span class="n">i</span><span class="p">,</span><span class="n">val</span><span class="p">[</span><span class="mi">64</span><span class="p">],</span><span class="o">*</span><span class="n">v</span><span class="o">=</span><span class="n">val</span><span class="p">;</span>
   <span class="n">stbi_uc</span> <span class="o">*</span><span class="n">o</span><span class="p">;</span>
   <span class="kt">short</span> <span class="o">*</span><span class="n">d</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-86'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-86'>#</a>
      </div>
      <p>columns</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>   <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">,</span><span class="o">++</span><span class="n">d</span><span class="p">,</span> <span class="o">++</span><span class="n">v</span><span class="p">)</span> <span class="p">{</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-87'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-87'>#</a>
      </div>
      <p>if all zeroes, shortcut -- this avoids dequantizing 0s and IDCTing</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>      <span class="k">if</span> <span class="p">(</span><span class="n">d</span><span class="p">[</span> <span class="mi">8</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">d</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">d</span><span class="p">[</span><span class="mi">24</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">d</span><span class="p">[</span><span class="mi">32</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span>
           <span class="o">&amp;&amp;</span> <span class="n">d</span><span class="p">[</span><span class="mi">40</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">d</span><span class="p">[</span><span class="mi">48</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">d</span><span class="p">[</span><span class="mi">56</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-88'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-88'>#</a>
      </div>
      <p>no shortcut                 0     seconds
   (1|2|3|4|5|6|7)==0          0     seconds
   all separate               -0.047 seconds
   1 &amp;&amp; 2|3 &amp;&amp; 4|5 &amp;&amp; 6|7:    -0.047 seconds</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>         <span class="kt">int</span> <span class="n">dcterm</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">;</span>
         <span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="mi">24</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="mi">32</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="mi">40</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="mi">48</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="mi">56</span><span class="p">]</span> <span class="o">=</span> <span class="n">dcterm</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
         <span class="n">STBI__IDCT_1D</span><span class="p">(</span><span class="n">d</span><span class="p">[</span> <span class="mi">0</span><span class="p">],</span><span class="n">d</span><span class="p">[</span> <span class="mi">8</span><span class="p">],</span><span class="n">d</span><span class="p">[</span><span class="mi">16</span><span class="p">],</span><span class="n">d</span><span class="p">[</span><span class="mi">24</span><span class="p">],</span><span class="n">d</span><span class="p">[</span><span class="mi">32</span><span class="p">],</span><span class="n">d</span><span class="p">[</span><span class="mi">40</span><span class="p">],</span><span class="n">d</span><span class="p">[</span><span class="mi">48</span><span class="p">],</span><span class="n">d</span><span class="p">[</span><span class="mi">56</span><span class="p">])</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-89'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-89'>#</a>
      </div>
      <p>constants scaled things up by 1&lt;&lt;12; let's bring them back
down, but keep 2 extra bits of precision</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>         <span class="n">x0</span> <span class="o">+=</span> <span class="mi">512</span><span class="p">;</span> <span class="n">x1</span> <span class="o">+=</span> <span class="mi">512</span><span class="p">;</span> <span class="n">x2</span> <span class="o">+=</span> <span class="mi">512</span><span class="p">;</span> <span class="n">x3</span> <span class="o">+=</span> <span class="mi">512</span><span class="p">;</span>
         <span class="n">v</span><span class="p">[</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">x0</span><span class="o">+</span><span class="n">t3</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">;</span>
         <span class="n">v</span><span class="p">[</span><span class="mi">56</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">x0</span><span class="o">-</span><span class="n">t3</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">;</span>
         <span class="n">v</span><span class="p">[</span> <span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">x1</span><span class="o">+</span><span class="n">t2</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">;</span>
         <span class="n">v</span><span class="p">[</span><span class="mi">48</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">x1</span><span class="o">-</span><span class="n">t2</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">;</span>
         <span class="n">v</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">x2</span><span class="o">+</span><span class="n">t1</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">;</span>
         <span class="n">v</span><span class="p">[</span><span class="mi">40</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">x2</span><span class="o">-</span><span class="n">t1</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">;</span>
         <span class="n">v</span><span class="p">[</span><span class="mi">24</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">x3</span><span class="o">+</span><span class="n">t0</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">;</span>
         <span class="n">v</span><span class="p">[</span><span class="mi">32</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">x3</span><span class="o">-</span><span class="n">t0</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">;</span>
      <span class="p">}</span>
   <span class="p">}</span>

   <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">v</span><span class="o">=</span><span class="n">val</span><span class="p">,</span> <span class="n">o</span><span class="o">=</span><span class="n">out</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">,</span><span class="n">v</span><span class="o">+=</span><span class="mi">8</span><span class="p">,</span><span class="n">o</span><span class="o">+=</span><span class="n">out_stride</span><span class="p">)</span> <span class="p">{</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-90'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-90'>#</a>
      </div>
      <p>no fast case since the first 1D IDCT spread components out</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>      <span class="n">STBI__IDCT_1D</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">v</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">v</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">v</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span><span class="n">v</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span><span class="n">v</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span><span class="n">v</span><span class="p">[</span><span class="mi">7</span><span class="p">])</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-91'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-91'>#</a>
      </div>
      <p>constants scaled things up by 1&lt;&lt;12, plus we had 1&lt;&lt;2 from first
loop, plus horizontal and vertical each scale by sqrt(8) so together
we've got an extra 1&lt;&lt;3, so 1&lt;&lt;17 total we need to remove.
so we want to round that, which means adding 0.5 * 1&lt;&lt;17,
aka 65536. Also, we'll end up with -128 to 127 that we want
to encode as 0..255 by adding 128, so we'll add that before the shift</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>      <span class="n">x0</span> <span class="o">+=</span> <span class="mi">65536</span> <span class="o">+</span> <span class="p">(</span><span class="mi">128</span><span class="o">&lt;&lt;</span><span class="mi">17</span><span class="p">);</span>
      <span class="n">x1</span> <span class="o">+=</span> <span class="mi">65536</span> <span class="o">+</span> <span class="p">(</span><span class="mi">128</span><span class="o">&lt;&lt;</span><span class="mi">17</span><span class="p">);</span>
      <span class="n">x2</span> <span class="o">+=</span> <span class="mi">65536</span> <span class="o">+</span> <span class="p">(</span><span class="mi">128</span><span class="o">&lt;&lt;</span><span class="mi">17</span><span class="p">);</span>
      <span class="n">x3</span> <span class="o">+=</span> <span class="mi">65536</span> <span class="o">+</span> <span class="p">(</span><span class="mi">128</span><span class="o">&lt;&lt;</span><span class="mi">17</span><span class="p">);</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-92'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-92'>#</a>
      </div>
      <p>tried computing the shifts into temps, or'ing the temps to see
if any were out of range, but that was slower</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>      <span class="n">o</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">stbi__clamp</span><span class="p">((</span><span class="n">x0</span><span class="o">+</span><span class="n">t3</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">17</span><span class="p">);</span>
      <span class="n">o</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="n">stbi__clamp</span><span class="p">((</span><span class="n">x0</span><span class="o">-</span><span class="n">t3</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">17</span><span class="p">);</span>
      <span class="n">o</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">stbi__clamp</span><span class="p">((</span><span class="n">x1</span><span class="o">+</span><span class="n">t2</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">17</span><span class="p">);</span>
      <span class="n">o</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">stbi__clamp</span><span class="p">((</span><span class="n">x1</span><span class="o">-</span><span class="n">t2</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">17</span><span class="p">);</span>
      <span class="n">o</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">stbi__clamp</span><span class="p">((</span><span class="n">x2</span><span class="o">+</span><span class="n">t1</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">17</span><span class="p">);</span>
      <span class="n">o</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">stbi__clamp</span><span class="p">((</span><span class="n">x2</span><span class="o">-</span><span class="n">t1</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">17</span><span class="p">);</span>
      <span class="n">o</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">stbi__clamp</span><span class="p">((</span><span class="n">x3</span><span class="o">+</span><span class="n">t0</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">17</span><span class="p">);</span>
      <span class="n">o</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">stbi__clamp</span><span class="p">((</span><span class="n">x3</span><span class="o">-</span><span class="n">t0</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">17</span><span class="p">);</span>
   <span class="p">}</span>
<span class="p">}</span>

<span class="cp">#ifdef STBI_SSE2</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-93'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-93'>#</a>
      </div>
      <p>sse2 integer IDCT. not the fastest possible implementation but it
produces bit-identical results to the generic C version so it's
fully "transparent".</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">static</span> <span class="kt">void</span> <span class="nf">stbi__idct_simd</span><span class="p">(</span><span class="n">stbi_uc</span> <span class="o">*</span><span class="n">out</span><span class="p">,</span> <span class="kt">int</span> <span class="n">out_stride</span><span class="p">,</span> <span class="kt">short</span> <span class="n">data</span><span class="p">[</span><span class="mi">64</span><span class="p">])</span>
<span class="p">{</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-94'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-94'>#</a>
      </div>
      <p>This is constructed to match our regular (generic) integer IDCT exactly.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>   <span class="kr">__m128i</span> <span class="n">row0</span><span class="p">,</span> <span class="n">row1</span><span class="p">,</span> <span class="n">row2</span><span class="p">,</span> <span class="n">row3</span><span class="p">,</span> <span class="n">row4</span><span class="p">,</span> <span class="n">row5</span><span class="p">,</span> <span class="n">row6</span><span class="p">,</span> <span class="n">row7</span><span class="p">;</span>
   <span class="kr">__m128i</span> <span class="n">tmp</span><span class="p">;</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-95'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-95'>#</a>
      </div>
      <p>dot product constant: even elems=x, odd elems=y</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>   <span class="cp">#define dct_const(x,y)  _mm_setr_epi16((x),(y),(x),(y),(x),(y),(x),(y))</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-96'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-96'>#</a>
      </div>
      <p>out(0) = c0[even]<em>x + c0[odd]</em>y   (c0, x, y 16-bit, out 32-bit)
out(1) = c1[even]<em>x + c1[odd]</em>y</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>   <span class="cp">#define dct_rot(out0,out1, x,y,c0,c1) \</span>
<span class="cp">      __m128i c0##lo = _mm_unpacklo_epi16((x),(y)); \</span>
<span class="cp">      __m128i c0##hi = _mm_unpackhi_epi16((x),(y)); \</span>
<span class="cp">      __m128i out0##_l = _mm_madd_epi16(c0##lo, c0); \</span>
<span class="cp">      __m128i out0##_h = _mm_madd_epi16(c0##hi, c0); \</span>
<span class="cp">      __m128i out1##_l = _mm_madd_epi16(c0##lo, c1); \</span>
<span class="cp">      __m128i out1##_h = _mm_madd_epi16(c0##hi, c1)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-97'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-97'>#</a>
      </div>
      <p>out = in &lt;&lt; 12  (in 16-bit, out 32-bit)</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>   <span class="cp">#define dct_widen(out, in) \</span>
<span class="cp">      __m128i out##_l = _mm_srai_epi32(_mm_unpacklo_epi16(_mm_setzero_si128(), (in)), 4); \</span>
<span class="cp">      __m128i out##_h = _mm_srai_epi32(_mm_unpackhi_epi16(_mm_setzero_si128(), (in)), 4)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-98'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-98'>#</a>
      </div>
      <p>wide add</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>   <span class="cp">#define dct_wadd(out, a, b) \</span>
<span class="cp">      __m128i out##_l = _mm_add_epi32(a##_l, b##_l); \</span>
<span class="cp">      __m128i out##_h = _mm_add_epi32(a##_h, b##_h)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-99'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-99'>#</a>
      </div>
      <p>wide sub</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>   <span class="cp">#define dct_wsub(out, a, b) \</span>
<span class="cp">      __m128i out##_l = _mm_sub_epi32(a##_l, b##_l); \</span>
<span class="cp">      __m128i out##_h = _mm_sub_epi32(a##_h, b##_h)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-100'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-100'>#</a>
      </div>
      <p>butterfly a/b, add bias, then shift by "s" and pack</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>   <span class="cp">#define dct_bfly32o(out0, out1, a,b,bias,s) \</span>
<span class="cp">      { \</span>
<span class="cp">         __m128i abiased_l = _mm_add_epi32(a##_l, bias); \</span>
<span class="cp">         __m128i abiased_h = _mm_add_epi32(a##_h, bias); \</span>
<span class="cp">         dct_wadd(sum, abiased, b); \</span>
<span class="cp">         dct_wsub(dif, abiased, b); \</span>
<span class="cp">         out0 = _mm_packs_epi32(_mm_srai_epi32(sum_l, s), _mm_srai_epi32(sum_h, s)); \</span>
<span class="cp">         out1 = _mm_packs_epi32(_mm_srai_epi32(dif_l, s), _mm_srai_epi32(dif_h, s)); \</span>
<span class="cp">      }</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-101'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-101'>#</a>
      </div>
      <p>8-bit interleave step (for transposes)</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>   <span class="cp">#define dct_interleave8(a, b) \</span>
<span class="cp">      tmp = a; \</span>
<span class="cp">      a = _mm_unpacklo_epi8(a, b); \</span>
<span class="cp">      b = _mm_unpackhi_epi8(tmp, b)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-102'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-102'>#</a>
      </div>
      <p>16-bit interleave step (for transposes)
odd part  \</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>   <span class="cp">#define dct_interleave16(a, b) \</span>
<span class="cp">      tmp = a; \</span>
<span class="cp">      a = _mm_unpacklo_epi16(a, b); \</span>
<span class="cp">      b = _mm_unpackhi_epi16(tmp, b)</span>

   <span class="cp">#define dct_pass(bias,shift) \</span>
<span class="cp">      { \</span>
<span class="cp">         </span><span class="cm">/* even part */</span><span class="cp"> \</span>
<span class="cp">         dct_rot(t2e,t3e, row2,row6, rot0_0,rot0_1); \</span>
<span class="cp">         __m128i sum04 = _mm_add_epi16(row0, row4); \</span>
<span class="cp">         __m128i dif04 = _mm_sub_epi16(row0, row4); \</span>
<span class="cp">         dct_widen(t0e, sum04); \</span>
<span class="cp">         dct_widen(t1e, dif04); \</span>
<span class="cp">         dct_wadd(x0, t0e, t3e); \</span>
<span class="cp">         dct_wsub(x3, t0e, t3e); \</span>
<span class="cp">         dct_wadd(x1, t1e, t2e); \</span>
<span class="cp">         dct_wsub(x2, t1e, t2e); \</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-103'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-103'>#</a>
      </div>
      <pre><code>     dct_rot(y0o,y2o, row7,row3, rot2_0,rot2_1); \
     dct_rot(y1o,y3o, row5,row1, rot3_0,rot3_1); \
     __m128i sum17 = _mm_add_epi16(row1, row7); \
     __m128i sum35 = _mm_add_epi16(row3, row5); \
     dct_rot(y4o,y5o, sum17,sum35, rot1_0,rot1_1); \
     dct_wadd(x4, y0o, y4o); \
     dct_wadd(x5, y1o, y5o); \
     dct_wadd(x6, y2o, y5o); \
     dct_wadd(x7, y3o, y4o); \
     dct_bfly32o(row0,row7, x0,x7,bias,shift); \
     dct_bfly32o(row1,row6, x1,x6,bias,shift); \
     dct_bfly32o(row2,row5, x2,x5,bias,shift); \
     dct_bfly32o(row3,row4, x3,x4,bias,shift); \
  }
</code></pre>
<p><strong>m128i rot0_0 = dct_const(stbi</strong>f2f(0.5411961f), stbi<strong>f2f(0.5411961f) + stbi</strong>f2f(-1.847759065f));
   <strong>m128i rot0_1 = dct_const(stbi</strong>f2f(0.5411961f) + stbi<strong>f2f( 0.765366865f), stbi</strong>f2f(0.5411961f));
   <strong>m128i rot1_0 = dct_const(stbi</strong>f2f(1.175875602f) + stbi<strong>f2f(-0.899976223f), stbi</strong>f2f(1.175875602f));
   <strong>m128i rot1_1 = dct_const(stbi</strong>f2f(1.175875602f), stbi<strong>f2f(1.175875602f) + stbi</strong>f2f(-2.562915447f));
   <strong>m128i rot2_0 = dct_const(stbi</strong>f2f(-1.961570560f) + stbi<strong>f2f( 0.298631336f), stbi</strong>f2f(-1.961570560f));
   <strong>m128i rot2_1 = dct_const(stbi</strong>f2f(-1.961570560f), stbi<strong>f2f(-1.961570560f) + stbi</strong>f2f( 3.072711026f));
   <strong>m128i rot3_0 = dct_const(stbi</strong>f2f(-0.390180644f) + stbi<strong>f2f( 2.053119869f), stbi</strong>f2f(-0.390180644f));
   <strong>m128i rot3_1 = dct_const(stbi</strong>f2f(-0.390180644f), stbi<strong>f2f(-0.390180644f) + stbi</strong>f2f( 1.501321110f));</p>
<p>// rounding biases in column/row passes, see stbi<strong>idct_block for explanation.
   </strong>m128i bias_0 = _mm_set1_epi32(512);
   __m128i bias_1 = _mm_set1_epi32(65536 + (128&lt;&lt;17));</p>
<p>// load
   row0 = _mm_load_si128((const <strong>m128i <em>) (data + 0</em>8));
   row1 = _mm_load_si128((const </strong>m128i <em>) (data + 1</em>8));
   row2 = _mm_load_si128((const <strong>m128i <em>) (data + 2</em>8));
   row3 = _mm_load_si128((const </strong>m128i <em>) (data + 3</em>8));
   row4 = _mm_load_si128((const <strong>m128i <em>) (data + 4</em>8));
   row5 = _mm_load_si128((const </strong>m128i <em>) (data + 5</em>8));
   row6 = _mm_load_si128((const <strong>m128i <em>) (data + 6</em>8));
   row7 = _mm_load_si128((const </strong>m128i <em>) (data + 7</em>8));</p>
<p>// column pass
   dct_pass(bias_0, 10);</p>
<p>{
      // 16bit 8x8 transpose pass 1
      dct_interleave16(row0, row4);
      dct_interleave16(row1, row5);
      dct_interleave16(row2, row6);
      dct_interleave16(row3, row7);</p>
<pre><code>  // transpose pass 2
  dct_interleave16(row0, row2);
  dct_interleave16(row1, row3);
  dct_interleave16(row4, row6);
  dct_interleave16(row5, row7);

  // transpose pass 3
  dct_interleave16(row0, row1);
  dct_interleave16(row2, row3);
  dct_interleave16(row4, row5);
  dct_interleave16(row6, row7);
</code></pre>
<p>}</p>
<p>// row pass
   dct_pass(bias_1, 17);</p>
<p>{
      // pack
      <strong>m128i p0 = _mm_packus_epi16(row0, row1); // a0a1a2a3...a7b0b1b2b3...b7
      </strong>m128i p1 = _mm_packus_epi16(row2, row3);
      <strong>m128i p2 = _mm_packus_epi16(row4, row5);
      </strong>m128i p3 = _mm_packus_epi16(row6, row7);</p>
<pre><code>  // 8bit 8x8 transpose pass 1
  dct_interleave8(p0, p2); // a0e0a1e1...
  dct_interleave8(p1, p3); // c0g0c1g1...

  // transpose pass 2
  dct_interleave8(p0, p1); // a0c0e0g0...
  dct_interleave8(p2, p3); // b0d0f0h0...

  // transpose pass 3
  dct_interleave8(p0, p2); // a0b0c0d0...
  dct_interleave8(p1, p3); // a4b4c4d4...

  // store
  _mm_storel_epi64((__m128i *) out, p0); out += out_stride;
  _mm_storel_epi64((__m128i *) out, _mm_shuffle_epi32(p0, 0x4e)); out += out_stride;
  _mm_storel_epi64((__m128i *) out, p2); out += out_stride;
  _mm_storel_epi64((__m128i *) out, _mm_shuffle_epi32(p2, 0x4e)); out += out_stride;
  _mm_storel_epi64((__m128i *) out, p1); out += out_stride;
  _mm_storel_epi64((__m128i *) out, _mm_shuffle_epi32(p1, 0x4e)); out += out_stride;
  _mm_storel_epi64((__m128i *) out, p3); out += out_stride;
  _mm_storel_epi64((__m128i *) out, _mm_shuffle_epi32(p3, 0x4e));
</code></pre>
<p>}</p>
<h1>undef dct_const</h1>
<h1>undef dct_rot</h1>
<h1>undef dct_widen</h1>
<h1>undef dct_wadd</h1>
<h1>undef dct_wsub</h1>
<h1>undef dct_bfly32o</h1>
<h1>undef dct_interleave8</h1>
<h1>undef dct_interleave16</h1>
<h1>undef dct_pass</h1>
<p>}</p>
<h1>endif // STBI_SSE2</h1>
<h1>ifdef STBI_NEON</h1>
<p>// NEON integer IDCT. should produce bit-identical
// results to the generic C version.
static void stbi__idct_simd(stbi_uc *out, int out_stride, short data[64])
{
   int16x8_t row0, row1, row2, row3, row4, row5, row6, row7;</p>
<p>int16x4_t rot0_0 = vdup_n_s16(stbi<strong>f2f(0.5411961f));
   int16x4_t rot0_1 = vdup_n_s16(stbi</strong>f2f(-1.847759065f));
   int16x4_t rot0_2 = vdup_n_s16(stbi<strong>f2f( 0.765366865f));
   int16x4_t rot1_0 = vdup_n_s16(stbi</strong>f2f( 1.175875602f));
   int16x4_t rot1_1 = vdup_n_s16(stbi<strong>f2f(-0.899976223f));
   int16x4_t rot1_2 = vdup_n_s16(stbi</strong>f2f(-2.562915447f));
   int16x4_t rot2_0 = vdup_n_s16(stbi<strong>f2f(-1.961570560f));
   int16x4_t rot2_1 = vdup_n_s16(stbi</strong>f2f(-0.390180644f));
   int16x4_t rot3_0 = vdup_n_s16(stbi<strong>f2f( 0.298631336f));
   int16x4_t rot3_1 = vdup_n_s16(stbi</strong>f2f( 2.053119869f));
   int16x4_t rot3_2 = vdup_n_s16(stbi<strong>f2f( 3.072711026f));
   int16x4_t rot3_3 = vdup_n_s16(stbi</strong>f2f( 1.501321110f));</p>
<h1>define dct_long_mul(out, inq, coeff) \</h1>
<p>int32x4_t out##_l = vmull_s16(vget_low_s16(inq), coeff); \
   int32x4_t out##_h = vmull_s16(vget_high_s16(inq), coeff)</p>
<h1>define dct_long_mac(out, acc, inq, coeff) \</h1>
<p>int32x4_t out##_l = vmlal_s16(acc##_l, vget_low_s16(inq), coeff); \
   int32x4_t out##_h = vmlal_s16(acc##_h, vget_high_s16(inq), coeff)</p>
<h1>define dct_widen(out, inq) \</h1>
<p>int32x4_t out##_l = vshll_n_s16(vget_low_s16(inq), 12); \
   int32x4_t out##_h = vshll_n_s16(vget_high_s16(inq), 12)</p>
<p>// wide add</p>
<h1>define dct_wadd(out, a, b) \</h1>
<p>int32x4_t out##_l = vaddq_s32(a##_l, b##_l); \
   int32x4_t out##_h = vaddq_s32(a##_h, b##_h)</p>
<p>// wide sub</p>
<h1>define dct_wsub(out, a, b) \</h1>
<p>int32x4_t out##_l = vsubq_s32(a##_l, b##_l); \
   int32x4_t out##_h = vsubq_s32(a##_h, b##_h)</p>
<p>// butterfly a/b, then shift using "shiftop" by "s" and pack</p>
<h1>define dct_bfly32o(out0,out1, a,b,shiftop,s) \</h1>
<p>{ \
      dct_wadd(sum, a, b); \
      dct_wsub(dif, a, b); \
      out0 = vcombine_s16(shiftop(sum_l, s), shiftop(sum_h, s)); \
      out1 = vcombine_s16(shiftop(dif_l, s), shiftop(dif_h, s)); \
   }</p>
<h1>define dct_pass(shiftop, shift) \</h1>
<p>{ \
even part  \
odd part  \</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>      <span class="n">int16x8_t</span> <span class="n">sum26</span> <span class="o">=</span> <span class="n">vaddq_s16</span><span class="p">(</span><span class="n">row2</span><span class="p">,</span> <span class="n">row6</span><span class="p">);</span> \
      <span class="n">dct_long_mul</span><span class="p">(</span><span class="n">p1e</span><span class="p">,</span> <span class="n">sum26</span><span class="p">,</span> <span class="n">rot0_0</span><span class="p">);</span> \
      <span class="n">dct_long_mac</span><span class="p">(</span><span class="n">t2e</span><span class="p">,</span> <span class="n">p1e</span><span class="p">,</span> <span class="n">row6</span><span class="p">,</span> <span class="n">rot0_1</span><span class="p">);</span> \
      <span class="n">dct_long_mac</span><span class="p">(</span><span class="n">t3e</span><span class="p">,</span> <span class="n">p1e</span><span class="p">,</span> <span class="n">row2</span><span class="p">,</span> <span class="n">rot0_2</span><span class="p">);</span> \
      <span class="n">int16x8_t</span> <span class="n">sum04</span> <span class="o">=</span> <span class="n">vaddq_s16</span><span class="p">(</span><span class="n">row0</span><span class="p">,</span> <span class="n">row4</span><span class="p">);</span> \
      <span class="n">int16x8_t</span> <span class="n">dif04</span> <span class="o">=</span> <span class="n">vsubq_s16</span><span class="p">(</span><span class="n">row0</span><span class="p">,</span> <span class="n">row4</span><span class="p">);</span> \
      <span class="n">dct_widen</span><span class="p">(</span><span class="n">t0e</span><span class="p">,</span> <span class="n">sum04</span><span class="p">);</span> \
      <span class="n">dct_widen</span><span class="p">(</span><span class="n">t1e</span><span class="p">,</span> <span class="n">dif04</span><span class="p">);</span> \
      <span class="n">dct_wadd</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">t0e</span><span class="p">,</span> <span class="n">t3e</span><span class="p">);</span> \
      <span class="n">dct_wsub</span><span class="p">(</span><span class="n">x3</span><span class="p">,</span> <span class="n">t0e</span><span class="p">,</span> <span class="n">t3e</span><span class="p">);</span> \
      <span class="n">dct_wadd</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">t1e</span><span class="p">,</span> <span class="n">t2e</span><span class="p">);</span> \
      <span class="n">dct_wsub</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="n">t1e</span><span class="p">,</span> <span class="n">t2e</span><span class="p">);</span> \</pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-104'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-104'>#</a>
      </div>
      <pre><code>  int16x8_t sum15 = vaddq_s16(row1, row5); \
  int16x8_t sum17 = vaddq_s16(row1, row7); \
  int16x8_t sum35 = vaddq_s16(row3, row5); \
  int16x8_t sum37 = vaddq_s16(row3, row7); \
  int16x8_t sumodd = vaddq_s16(sum17, sum35); \
  dct_long_mul(p5o, sumodd, rot1_0); \
  dct_long_mac(p1o, p5o, sum17, rot1_1); \
  dct_long_mac(p2o, p5o, sum35, rot1_2); \
  dct_long_mul(p3o, sum37, rot2_0); \
  dct_long_mul(p4o, sum15, rot2_1); \
  dct_wadd(sump13o, p1o, p3o); \
  dct_wadd(sump24o, p2o, p4o); \
  dct_wadd(sump23o, p2o, p3o); \
  dct_wadd(sump14o, p1o, p4o); \
  dct_long_mac(x4, sump13o, row7, rot3_0); \
  dct_long_mac(x5, sump24o, row5, rot3_1); \
  dct_long_mac(x6, sump23o, row3, rot3_2); \
  dct_long_mac(x7, sump14o, row1, rot3_3); \
  dct_bfly32o(row0,row7, x0,x7,shiftop,shift); \
  dct_bfly32o(row1,row6, x1,x6,shiftop,shift); \
  dct_bfly32o(row2,row5, x2,x5,shiftop,shift); \
  dct_bfly32o(row3,row4, x3,x4,shiftop,shift); \
</code></pre>
<p>}</p>
<p>// load
   row0 = vld1q_s16(data + 0<em>8);
   row1 = vld1q_s16(data + 1</em>8);
   row2 = vld1q_s16(data + 2<em>8);
   row3 = vld1q_s16(data + 3</em>8);
   row4 = vld1q_s16(data + 4<em>8);
   row5 = vld1q_s16(data + 5</em>8);
   row6 = vld1q_s16(data + 6<em>8);
   row7 = vld1q_s16(data + 7</em>8);</p>
<p>// add DC bias
   row0 = vaddq_s16(row0, vsetq_lane_s16(1024, vdupq_n_s16(0), 0));</p>
<p>// column pass
   dct_pass(vrshrn_n_s32, 10);</p>
<p>// 16bit 8x8 transpose
   {
// these three map to a single VTRN.16, VTRN.32, and VSWP, respectively.
// whether compilers actually get this is another story, sadly.</p>
<h1>define dct_trn16(x, y) { int16x8x2_t t = vtrnq_s16(x, y); x = t.val[0]; y = t.val[1]; }</h1>
<h1>define dct_trn32(x, y) { int32x4x2_t t = vtrnq_s32(vreinterpretq_s32_s16(x), vreinterpretq_s32_s16(y)); x = vreinterpretq_s16_s32(t.val[0]); y = vreinterpretq_s16_s32(t.val[1]); }</h1>
<h1>define dct_trn64(x, y) { int16x8_t x0 = x; int16x8_t y0 = y; x = vcombine_s16(vget_low_s16(x0), vget_low_s16(y0)); y = vcombine_s16(vget_high_s16(x0), vget_high_s16(y0)); }</h1>
<pre><code>  // pass 1
  dct_trn16(row0, row1); // a0b0a2b2a4b4a6b6
  dct_trn16(row2, row3);
  dct_trn16(row4, row5);
  dct_trn16(row6, row7);

  // pass 2
  dct_trn32(row0, row2); // a0b0c0d0a4b4c4d4
  dct_trn32(row1, row3);
  dct_trn32(row4, row6);
  dct_trn32(row5, row7);

  // pass 3
  dct_trn64(row0, row4); // a0b0c0d0e0f0g0h0
  dct_trn64(row1, row5);
  dct_trn64(row2, row6);
  dct_trn64(row3, row7);
</code></pre>
<h1>undef dct_trn16</h1>
<h1>undef dct_trn32</h1>
<h1>undef dct_trn64</h1>
<p>}</p>
<p>// row pass
   // vrshrn_n_s32 only supports shifts up to 16, we need
   // 17. so do a non-rounding shift of 16 first then follow
   // up with a rounding shift by 1.
   dct_pass(vshrn_n_s32, 16);</p>
<p>{
      // pack and round
      uint8x8_t p0 = vqrshrun_n_s16(row0, 1);
      uint8x8_t p1 = vqrshrun_n_s16(row1, 1);
      uint8x8_t p2 = vqrshrun_n_s16(row2, 1);
      uint8x8_t p3 = vqrshrun_n_s16(row3, 1);
      uint8x8_t p4 = vqrshrun_n_s16(row4, 1);
      uint8x8_t p5 = vqrshrun_n_s16(row5, 1);
      uint8x8_t p6 = vqrshrun_n_s16(row6, 1);
      uint8x8_t p7 = vqrshrun_n_s16(row7, 1);</p>
<pre><code>  // again, these can translate into one instruction, but often don't.
</code></pre>
<h1>define dct_trn8_8(x, y) { uint8x8x2_t t = vtrn_u8(x, y); x = t.val[0]; y = t.val[1]; }</h1>
<h1>define dct_trn8_16(x, y) { uint16x4x2_t t = vtrn_u16(vreinterpret_u16_u8(x), vreinterpret_u16_u8(y)); x = vreinterpret_u8_u16(t.val[0]); y = vreinterpret_u8_u16(t.val[1]); }</h1>
<h1>define dct_trn8_32(x, y) { uint32x2x2_t t = vtrn_u32(vreinterpret_u32_u8(x), vreinterpret_u32_u8(y)); x = vreinterpret_u8_u32(t.val[0]); y = vreinterpret_u8_u32(t.val[1]); }</h1>
<pre><code>  // sadly can't use interleaved stores here since we only write
  // 8 bytes to each scan line!

  // 8x8 8-bit transpose pass 1
  dct_trn8_8(p0, p1);
  dct_trn8_8(p2, p3);
  dct_trn8_8(p4, p5);
  dct_trn8_8(p6, p7);

  // pass 2
  dct_trn8_16(p0, p2);
  dct_trn8_16(p1, p3);
  dct_trn8_16(p4, p6);
  dct_trn8_16(p5, p7);

  // pass 3
  dct_trn8_32(p0, p4);
  dct_trn8_32(p1, p5);
  dct_trn8_32(p2, p6);
  dct_trn8_32(p3, p7);

  // store
  vst1_u8(out, p0); out += out_stride;
  vst1_u8(out, p1); out += out_stride;
  vst1_u8(out, p2); out += out_stride;
  vst1_u8(out, p3); out += out_stride;
  vst1_u8(out, p4); out += out_stride;
  vst1_u8(out, p5); out += out_stride;
  vst1_u8(out, p6); out += out_stride;
  vst1_u8(out, p7);
</code></pre>
<h1>undef dct_trn8_8</h1>
<h1>undef dct_trn8_16</h1>
<h1>undef dct_trn8_32</h1>
<p>}</p>
<h1>undef dct_long_mul</h1>
<h1>undef dct_long_mac</h1>
<h1>undef dct_widen</h1>
<h1>undef dct_wadd</h1>
<h1>undef dct_wsub</h1>
<h1>undef dct_bfly32o</h1>
<h1>undef dct_pass</h1>
<p>}</p>
<h1>endif // STBI_NEON</h1>
<h1>define STBI__MARKER_none  0xff</h1>
<p>// if there's a pending marker from the entropy stream, return that
// otherwise, fetch from the stream and get a marker. if there's no
// marker, return 0xff, which is never a valid marker value
static stbi_uc stbi<strong>get_marker(stbi</strong>jpeg *j)
{
   stbi_uc x;
   if (j-&gt;marker != STBI<strong>MARKER_none) { x = j-&gt;marker; j-&gt;marker = STBI</strong>MARKER_none; return x; }
   x = stbi<strong>get8(j-&gt;s);
   if (x != 0xff) return STBI</strong>MARKER_none;
   while (x == 0xff)
      x = stbi__get8(j-&gt;s);
   return x;
}</p>
<p>// in each scan, we'll have scan_n components, and the order
// of the components is specified by order[]</p>
<h1>define STBI__RESTART(x)     ((x) &gt;= 0xd0 &amp;&amp; (x) &lt;= 0xd7)</h1>
<p>// after a restart interval, stbi<strong>jpeg_reset the entropy decoder and
// the dc prediction
static void stbi</strong>jpeg_reset(stbi<strong>jpeg *j)
{
   j-&gt;code_bits = 0;
   j-&gt;code_buffer = 0;
   j-&gt;nomore = 0;
   j-&gt;img_comp[0].dc_pred = j-&gt;img_comp[1].dc_pred = j-&gt;img_comp[2].dc_pred = 0;
   j-&gt;marker = STBI</strong>MARKER_none;
   j-&gt;todo = j-&gt;restart_interval ? j-&gt;restart_interval : 0x7fffffff;
   j-&gt;eob_run = 0;
   // no more than 1&lt;&lt;31 MCUs if no restart_interal? that's plenty safe,
   // since we don't even allow 1&lt;&lt;30 pixels
}</p>
<p>static int stbi<strong>parse_entropy_coded_data(stbi</strong>jpeg <em>z)
{
   stbi<strong>jpeg_reset(z);
   if (!z-&gt;progressive) {
      if (z-&gt;scan_n == 1) {
  int i,j;
  STBI_SIMD_ALIGN(short, data[64]);
  int n = z-&gt;order[0];
  // non-interleaved data, we just need to process one block at a time,
  // in trivial scanline order
  // number of blocks to do just depends on how many actual "pixels" this
  // component has, independent of interleaved MCU blocking and such
  int w = (z-&gt;img_comp[n].x+7) &gt;&gt; 3;
  int h = (z-&gt;img_comp[n].y+7) &gt;&gt; 3;
  for (j=0; j &lt; h; ++j) {
     for (i=0; i &lt; w; ++i) {
        int ha = z-&gt;img_comp[n].ha;
        if (!stbi</strong>jpeg_decode_block(z, data, z-&gt;huff_dc+z-&gt;img_comp[n].hd, z-&gt;huff_ac+ha, z-&gt;fast_ac[ha], n, z-&gt;dequant[z-&gt;img_comp[n].tq])) return 0;
        z-&gt;idct_block_kernel(z-&gt;img_comp[n].data+z-&gt;img_comp[n].w2</em>j<em>8+i</em>8, z-&gt;img_comp[n].w2, data);
        // every data block is an MCU, so countdown the restart interval
        if (--z-&gt;todo &lt;= 0) {
           if (z-&gt;code_bits &lt; 24) stbi<strong>grow_buffer_unsafe(z);
           // if it's NOT a restart, then just bail, so we get corrupt data
           // rather than no data
           if (!STBI</strong>RESTART(z-&gt;marker)) return 1;
           stbi<strong>jpeg_reset(z);
        }
     }
  }
  return 1;
      } else { // interleaved
  int i,j,k,x,y;
  STBI_SIMD_ALIGN(short, data[64]);
  for (j=0; j &lt; z-&gt;img_mcu_y; ++j) {
     for (i=0; i &lt; z-&gt;img_mcu_x; ++i) {
        // scan an interleaved mcu... process scan_n components in order
        for (k=0; k &lt; z-&gt;scan_n; ++k) {
           int n = z-&gt;order[k];
           // scan out an mcu's worth of this component; that's just determined
           // by the basic H and V specified for the component
           for (y=0; y &lt; z-&gt;img_comp[n].v; ++y) {
              for (x=0; x &lt; z-&gt;img_comp[n].h; ++x) {
                 int x2 = (i<em>z-&gt;img_comp[n].h + x)</em>8;
                 int y2 = (j<em>z-&gt;img_comp[n].v + y)</em>8;
                 int ha = z-&gt;img_comp[n].ha;
                 if (!stbi</strong>jpeg_decode_block(z, data, z-&gt;huff_dc+z-&gt;img_comp[n].hd, z-&gt;huff_ac+ha, z-&gt;fast_ac[ha], n, z-&gt;dequant[z-&gt;img_comp[n].tq])) return 0;
                 z-&gt;idct_block_kernel(z-&gt;img_comp[n].data+z-&gt;img_comp[n].w2<em>y2+x2, z-&gt;img_comp[n].w2, data);
              }
           }
        }
        // after all interleaved components, that's an interleaved MCU,
        // so now count down the restart interval
        if (--z-&gt;todo &lt;= 0) {
           if (z-&gt;code_bits &lt; 24) stbi<strong>grow_buffer_unsafe(z);
           if (!STBI</strong>RESTART(z-&gt;marker)) return 1;
           stbi<strong>jpeg_reset(z);
        }
     }
  }
  return 1;
      }
   } else {
      if (z-&gt;scan_n == 1) {
  int i,j;
  int n = z-&gt;order[0];
  // non-interleaved data, we just need to process one block at a time,
  // in trivial scanline order
  // number of blocks to do just depends on how many actual "pixels" this
  // component has, independent of interleaved MCU blocking and such
  int w = (z-&gt;img_comp[n].x+7) &gt;&gt; 3;
  int h = (z-&gt;img_comp[n].y+7) &gt;&gt; 3;
  for (j=0; j &lt; h; ++j) {
     for (i=0; i &lt; w; ++i) {
        short *data = z-&gt;img_comp[n].coeff + 64 * (i + j * z-&gt;img_comp[n].coeff_w);
        if (z-&gt;spec_start == 0) {
           if (!stbi</strong>jpeg_decode_block_prog_dc(z, data, &amp;z-&gt;huff_dc[z-&gt;img_comp[n].hd], n))
              return 0;
        } else {
           int ha = z-&gt;img_comp[n].ha;
           if (!stbi<strong>jpeg_decode_block_prog_ac(z, data, &amp;z-&gt;huff_ac[ha], z-&gt;fast_ac[ha]))
              return 0;
        }
        // every data block is an MCU, so countdown the restart interval
        if (--z-&gt;todo &lt;= 0) {
           if (z-&gt;code_bits &lt; 24) stbi</strong>grow_buffer_unsafe(z);
           if (!STBI<strong>RESTART(z-&gt;marker)) return 1;
           stbi</strong>jpeg_reset(z);
        }
     }
  }
  return 1;
      } else { // interleaved
  int i,j,k,x,y;
  for (j=0; j &lt; z-&gt;img_mcu_y; ++j) {
     for (i=0; i &lt; z-&gt;img_mcu_x; ++i) {
        // scan an interleaved mcu... process scan_n components in order
        for (k=0; k &lt; z-&gt;scan_n; ++k) {
           int n = z-&gt;order[k];
           // scan out an mcu's worth of this component; that's just determined
           // by the basic H and V specified for the component
           for (y=0; y &lt; z-&gt;img_comp[n].v; ++y) {
              for (x=0; x &lt; z-&gt;img_comp[n].h; ++x) {
                 int x2 = (i</em>z-&gt;img_comp[n].h + x);
                 int y2 = (j<em>z-&gt;img_comp[n].v + y);
                 short </em>data = z-&gt;img_comp[n].coeff + 64 * (x2 + y2 * z-&gt;img_comp[n].coeff_w);
                 if (!stbi<strong>jpeg_decode_block_prog_dc(z, data, &amp;z-&gt;huff_dc[z-&gt;img_comp[n].hd], n))
                    return 0;
              }
           }
        }
        // after all interleaved components, that's an interleaved MCU,
        // so now count down the restart interval
        if (--z-&gt;todo &lt;= 0) {
           if (z-&gt;code_bits &lt; 24) stbi</strong>grow_buffer_unsafe(z);
           if (!STBI<strong>RESTART(z-&gt;marker)) return 1;
           stbi</strong>jpeg_reset(z);
        }
     }
  }
  return 1;
      }
   }
}</p>
<p>static void stbi__jpeg_dequantize(short <em>data, stbi_uc </em>dequant)
{
   int i;
   for (i=0; i &lt; 64; ++i)
      data[i] *= dequant[i];
}</p>
<p>static void stbi<strong>jpeg_finish(stbi</strong>jpeg <em>z)
{
   if (z-&gt;progressive) {
      // dequantize and idct the data
      int i,j,n;
      for (n=0; n &lt; z-&gt;s-&gt;img_n; ++n) {
  int w = (z-&gt;img_comp[n].x+7) &gt;&gt; 3;
  int h = (z-&gt;img_comp[n].y+7) &gt;&gt; 3;
  for (j=0; j &lt; h; ++j) {
     for (i=0; i &lt; w; ++i) {
        short </em>data = z-&gt;img_comp[n].coeff + 64 * (i + j * z-&gt;img_comp[n].coeff_w);
        stbi__jpeg_dequantize(data, z-&gt;dequant[z-&gt;img_comp[n].tq]);
        z-&gt;idct_block_kernel(z-&gt;img_comp[n].data+z-&gt;img_comp[n].w2<em>j</em>8+i*8, z-&gt;img_comp[n].w2, data);
     }
  }
      }
   }
}</p>
<p>static int stbi<strong>process_marker(stbi</strong>jpeg *z, int m)
{
   int L;
   switch (m) {
      case STBI<strong>MARKER_none: // no marker found
  return stbi</strong>err("expected marker","Corrupt JPEG");</p>
<pre><code>  case 0xDD: // DRI - specify restart interval
</code></pre>
<p>if (stbi<strong>get16be(z-&gt;s) != 4) return stbi</strong>err("bad DRI len","Corrupt JPEG");
  z-&gt;restart_interval = stbi__get16be(z-&gt;s);
  return 1;</p>
<pre><code>  case 0xDB: // DQT - define quantization table
</code></pre>
<p>L = stbi<strong>get16be(z-&gt;s)-2;
  while (L &gt; 0) {
     int q = stbi</strong>get8(z-&gt;s);
     int p = q &gt;&gt; 4;
     int t = q &amp; 15,i;
     if (p != 0) return stbi<strong>err("bad DQT type","Corrupt JPEG");
     if (t &gt; 3) return stbi</strong>err("bad DQT table","Corrupt JPEG");
     for (i=0; i &lt; 64; ++i)
        z-&gt;dequant[t][stbi<strong>jpeg_dezigzag[i]] = stbi</strong>get8(z-&gt;s);
     L -= 65;
  }
  return L==0;</p>
<pre><code>  case 0xC4: // DHT - define huffman table
</code></pre>
<p>L = stbi<strong>get16be(z-&gt;s)-2;
  while (L &gt; 0) {
     stbi_uc *v;
     int sizes[16],i,n=0;
     int q = stbi</strong>get8(z-&gt;s);
     int tc = q &gt;&gt; 4;
     int th = q &amp; 15;
     if (tc &gt; 1 || th &gt; 3) return stbi<strong>err("bad DHT header","Corrupt JPEG");
     for (i=0; i &lt; 16; ++i) {
        sizes[i] = stbi</strong>get8(z-&gt;s);
        n += sizes[i];
     }
     L -= 17;
     if (tc == 0) {
        if (!stbi<strong>build_huffman(z-&gt;huff_dc+th, sizes)) return 0;
        v = z-&gt;huff_dc[th].values;
     } else {
        if (!stbi</strong>build_huffman(z-&gt;huff_ac+th, sizes)) return 0;
        v = z-&gt;huff_ac[th].values;
     }
     for (i=0; i &lt; n; ++i)
        v[i] = stbi<strong>get8(z-&gt;s);
     if (tc != 0)
        stbi</strong>build_fast_ac(z-&gt;fast_ac[th], z-&gt;huff_ac + th);
     L -= n;
  }
  return L==0;
   }
   // check for comment block or APP blocks
   if ((m &gt;= 0xE0 &amp;&amp; m &lt;= 0xEF) || m == 0xFE) {
      stbi<strong>skip(z-&gt;s, stbi</strong>get16be(z-&gt;s)-2);
      return 1;
   }
   return 0;
}</p>
<p>// after we see SOS
static int stbi<strong>process_scan_header(stbi</strong>jpeg *z)
{
   int i;
   int Ls = stbi<strong>get16be(z-&gt;s);
   z-&gt;scan_n = stbi</strong>get8(z-&gt;s);
   if (z-&gt;scan_n &lt; 1 || z-&gt;scan_n &gt; 4 || z-&gt;scan_n &gt; (int) z-&gt;s-&gt;img_n) return stbi<strong>err("bad SOS component count","Corrupt JPEG");
   if (Ls != 6+2*z-&gt;scan_n) return stbi</strong>err("bad SOS len","Corrupt JPEG");
   for (i=0; i &lt; z-&gt;scan_n; ++i) {
      int id = stbi<strong>get8(z-&gt;s), which;
      int q = stbi</strong>get8(z-&gt;s);
      for (which = 0; which &lt; z-&gt;s-&gt;img_n; ++which)
  if (z-&gt;img_comp[which].id == id)
     break;
      if (which == z-&gt;s-&gt;img_n) return 0; // no match
      z-&gt;img_comp[which].hd = q &gt;&gt; 4;   if (z-&gt;img_comp[which].hd &gt; 3) return stbi<strong>err("bad DC huff","Corrupt JPEG");
      z-&gt;img_comp[which].ha = q &amp; 15;   if (z-&gt;img_comp[which].ha &gt; 3) return stbi</strong>err("bad AC huff","Corrupt JPEG");
      z-&gt;order[i] = which;
   }</p>
<p>{
      int aa;
      z-&gt;spec_start = stbi<strong>get8(z-&gt;s);
      z-&gt;spec_end   = stbi</strong>get8(z-&gt;s); // should be 63, but might be 0
      aa = stbi<strong>get8(z-&gt;s);
      z-&gt;succ_high = (aa &gt;&gt; 4);
      z-&gt;succ_low  = (aa &amp; 15);
      if (z-&gt;progressive) {
  if (z-&gt;spec_start &gt; 63 || z-&gt;spec_end &gt; 63  || z-&gt;spec_start &gt; z-&gt;spec_end || z-&gt;succ_high &gt; 13 || z-&gt;succ_low &gt; 13)
     return stbi</strong>err("bad SOS", "Corrupt JPEG");
      } else {
  if (z-&gt;spec_start != 0) return stbi<strong>err("bad SOS","Corrupt JPEG");
  if (z-&gt;succ_high != 0 || z-&gt;succ_low != 0) return stbi</strong>err("bad SOS","Corrupt JPEG");
  z-&gt;spec_end = 63;
      }
   }</p>
<p>return 1;
}</p>
<p>static int stbi<strong>process_frame_header(stbi</strong>jpeg *z, int scan)
{
   stbi<strong>context *s = z-&gt;s;
   int Lf,p,i,q, h_max=1,v_max=1,c;
   Lf = stbi</strong>get16be(s);         if (Lf &lt; 11) return stbi<strong>err("bad SOF len","Corrupt JPEG"); // JPEG
   p  = stbi</strong>get8(s);            if (p != 8) return stbi<strong>err("only 8-bit","JPEG format not supported: 8-bit only"); // JPEG baseline
   s-&gt;img_y = stbi</strong>get16be(s);   if (s-&gt;img_y == 0) return stbi<strong>err("no header height", "JPEG format not supported: delayed height"); // Legal, but we don't handle it--but neither does IJG
   s-&gt;img_x = stbi</strong>get16be(s);   if (s-&gt;img_x == 0) return stbi<strong>err("0 width","Corrupt JPEG"); // JPEG requires
   c = stbi</strong>get8(s);
   if (c != 3 &amp;&amp; c != 1) return stbi__err("bad component count","Corrupt JPEG");    // JFIF requires
   s-&gt;img_n = c;
   for (i=0; i &lt; c; ++i) {
      z-&gt;img_comp[i].data = NULL;
      z-&gt;img_comp[i].linebuf = NULL;
   }</p>
<p>if (Lf != 8+3*s-&gt;img_n) return stbi__err("bad SOF len","Corrupt JPEG");</p>
<p>z-&gt;rgb = 0;
   for (i=0; i &lt; s-&gt;img_n; ++i) {
      static unsigned char rgb[3] = { 'R', 'G', 'B' };
      z-&gt;img_comp[i].id = stbi<strong>get8(s);
      if (z-&gt;img_comp[i].id != i+1)   // JFIF requires
  if (z-&gt;img_comp[i].id != i) {  // some version of jpegtran outputs non-JFIF-compliant files!
     // somethings output this (see http://fileformats.archiveteam.org/wiki/JPEG#Color_format)
     if (z-&gt;img_comp[i].id != rgb[i])
        return stbi</strong>err("bad component ID","Corrupt JPEG");
     ++z-&gt;rgb;
  }
      q = stbi<strong>get8(s);
      z-&gt;img_comp[i].h = (q &gt;&gt; 4);  if (!z-&gt;img_comp[i].h || z-&gt;img_comp[i].h &gt; 4) return stbi</strong>err("bad H","Corrupt JPEG");
      z-&gt;img_comp[i].v = q &amp; 15;    if (!z-&gt;img_comp[i].v || z-&gt;img_comp[i].v &gt; 4) return stbi<strong>err("bad V","Corrupt JPEG");
      z-&gt;img_comp[i].tq = stbi</strong>get8(s);  if (z-&gt;img_comp[i].tq &gt; 3) return stbi__err("bad TQ","Corrupt JPEG");
   }</p>
<p>if (scan != STBI__SCAN_load) return 1;</p>
<p>if ((1 &lt;&lt; 30) / s-&gt;img_x / s-&gt;img_n &lt; s-&gt;img_y) return stbi__err("too large", "Image too large to decode");</p>
<p>for (i=0; i &lt; s-&gt;img_n; ++i) {
      if (z-&gt;img_comp[i].h &gt; h_max) h_max = z-&gt;img_comp[i].h;
      if (z-&gt;img_comp[i].v &gt; v_max) v_max = z-&gt;img_comp[i].v;
   }</p>
<p>// compute interleaved mcu info
   z-&gt;img_h_max = h_max;
   z-&gt;img_v_max = v_max;
   z-&gt;img_mcu_w = h_max * 8;
   z-&gt;img_mcu_h = v_max * 8;
   z-&gt;img_mcu_x = (s-&gt;img_x + z-&gt;img_mcu_w-1) / z-&gt;img_mcu_w;
   z-&gt;img_mcu_y = (s-&gt;img_y + z-&gt;img_mcu_h-1) / z-&gt;img_mcu_h;</p>
<p>for (i=0; i &lt; s-&gt;img_n; ++i) {
      // number of effective pixels (e.g. for non-interleaved MCU)
      z-&gt;img_comp[i].x = (s-&gt;img_x * z-&gt;img_comp[i].h + h_max-1) / h_max;
      z-&gt;img_comp[i].y = (s-&gt;img_y * z-&gt;img_comp[i].v + v_max-1) / v_max;
      // to simplify generation, we'll allocate enough memory to decode
      // the bogus oversized data from using interleaved MCUs and their
      // big blocks (e.g. a 16x16 iMCU on an image of width 33); we won't
      // discard the extra data until colorspace conversion
      z-&gt;img_comp[i].w2 = z-&gt;img_mcu_x * z-&gt;img_comp[i].h * 8;
      z-&gt;img_comp[i].h2 = z-&gt;img_mcu_y * z-&gt;img_comp[i].v * 8;
      z-&gt;img_comp[i].raw_data = stbi__malloc(z-&gt;img_comp[i].w2 * z-&gt;img_comp[i].h2+15);</p>
<pre><code>  if (z-&gt;img_comp[i].raw_data == NULL) {
</code></pre>
<p>for(--i; i &gt;= 0; --i) {
     STBI_FREE(z-&gt;img_comp[i].raw_data);
     z-&gt;img_comp[i].raw_data = NULL;
  }
  return stbi__err("outofmem", "Out of memory");
      }
      // align blocks for idct using mmx/sse
      z-&gt;img_comp[i].data = (stbi_uc<em>) (((size_t) z-&gt;img_comp[i].raw_data + 15) &amp; ~15);
      z-&gt;img_comp[i].linebuf = NULL;
      if (z-&gt;progressive) {
  z-&gt;img_comp[i].coeff_w = (z-&gt;img_comp[i].w2 + 7) &gt;&gt; 3;
  z-&gt;img_comp[i].coeff_h = (z-&gt;img_comp[i].h2 + 7) &gt;&gt; 3;
  z-&gt;img_comp[i].raw_coeff = STBI_MALLOC(z-&gt;img_comp[i].coeff_w * z-&gt;img_comp[i].coeff_h * 64 * sizeof(short) + 15);
  z-&gt;img_comp[i].coeff = (short</em>) (((size_t) z-&gt;img_comp[i].raw_coeff + 15) &amp; ~15);
      } else {
  z-&gt;img_comp[i].coeff = 0;
  z-&gt;img_comp[i].raw_coeff = 0;
      }
   }</p>
<p>return 1;
}</p>
<p>// use comparisons since in some cases we handle more than one case (e.g. SOF)</p>
<h1>define stbi__DNL(x)         ((x) == 0xdc)</h1>
<h1>define stbi__SOI(x)         ((x) == 0xd8)</h1>
<h1>define stbi__EOI(x)         ((x) == 0xd9)</h1>
<h1>define stbi__SOF(x)         ((x) == 0xc0 || (x) == 0xc1 || (x) == 0xc2)</h1>
<h1>define stbi__SOS(x)         ((x) == 0xda)</h1>
<h1>define stbi__SOF_progressive(x)   ((x) == 0xc2)</h1>
<p>static int stbi<strong>decode_jpeg_header(stbi</strong>jpeg *z, int scan)
{
   int m;
   z-&gt;marker = STBI<strong>MARKER_none; // initialize cached marker to empty
   m = stbi</strong>get_marker(z);
   if (!stbi<strong>SOI(m)) return stbi</strong>err("no SOI","Corrupt JPEG");
   if (scan == STBI<strong>SCAN_type) return 1;
   m = stbi</strong>get_marker(z);
   while (!stbi<strong>SOF(m)) {
      if (!stbi</strong>process_marker(z,m)) return 0;
      m = stbi<strong>get_marker(z);
      while (m == STBI</strong>MARKER_none) {
  // some files have extra padding after their blocks, so ok, we'll scan
  if (stbi<strong>at_eof(z-&gt;s)) return stbi</strong>err("no SOF", "Corrupt JPEG");
  m = stbi<strong>get_marker(z);
      }
   }
   z-&gt;progressive = stbi</strong>SOF_progressive(m);
   if (!stbi__process_frame_header(z, scan)) return 0;
   return 1;
}</p>
<p>// decode image to YCbCr format
static int stbi<strong>decode_jpeg_image(stbi</strong>jpeg *j)
{
   int m;
   for (m = 0; m &lt; 4; m++) {
      j-&gt;img_comp[m].raw_data = NULL;
      j-&gt;img_comp[m].raw_coeff = NULL;
   }
   j-&gt;restart_interval = 0;
   if (!stbi<strong>decode_jpeg_header(j, STBI</strong>SCAN_load)) return 0;
   m = stbi<strong>get_marker(j);
   while (!stbi</strong>EOI(m)) {
      if (stbi<strong>SOS(m)) {
  if (!stbi</strong>process_scan_header(j)) return 0;
  if (!stbi<strong>parse_entropy_coded_data(j)) return 0;
  if (j-&gt;marker == STBI</strong>MARKER_none ) {
     // handle 0s at the end of image data from IP Kamera 9060
     while (!stbi<strong>at_eof(j-&gt;s)) {
        int x = stbi</strong>get8(j-&gt;s);
        if (x == 255) {
           j-&gt;marker = stbi<strong>get8(j-&gt;s);
           break;
        } else if (x != 0) {
           return stbi</strong>err("junk before marker", "Corrupt JPEG");
        }
     }
     // if we reach eof without hitting a marker, stbi<strong>get_marker() below will fail and we'll eventually return 0
  }
      } else {
  if (!stbi</strong>process_marker(j, m)) return 0;
      }
      m = stbi<strong>get_marker(j);
   }
   if (j-&gt;progressive)
      stbi</strong>jpeg_finish(j);
   return 1;
}</p>
<p>// static jfif-centered resampling (across block boundaries)</p>
<p>typedef stbi_uc <em>(</em>resample_row_func)(stbi_uc <em>out, stbi_uc </em>in0, stbi_uc *in1,
                             int w, int hs);</p>
<h1>define stbi__div4(x) ((stbi_uc) ((x) &gt;&gt; 2))</h1>
<p>static stbi_uc <em>resample_row_1(stbi_uc </em>out, stbi_uc <em>in_near, stbi_uc </em>in_far, int w, int hs)
{
   STBI_NOTUSED(out);
   STBI_NOTUSED(in_far);
   STBI_NOTUSED(w);
   STBI_NOTUSED(hs);
   return in_near;
}</p>
<p>static stbi_uc<em> stbi<strong>resample_row_v_2(stbi_uc <em>out, stbi_uc </em>in_near, stbi_uc *in_far, int w, int hs)
{
   // need to generate two samples vertically for every one in input
   int i;
   STBI_NOTUSED(hs);
   for (i=0; i &lt; w; ++i)
      out[i] = stbi</strong>div4(3</em>in_near[i] + in_far[i] + 2);
   return out;
}</p>
<p>static stbi_uc<em>  stbi__resample_row_h_2(stbi_uc </em>out, stbi_uc <em>in_near, stbi_uc </em>in_far, int w, int hs)
{
   // need to generate two samples horizontally for every one in input
   int i;
   stbi_uc *input = in_near;</p>
<p>if (w == 1) {
      // if only one sample, can't do any interpolation
      out[0] = out[1] = input[0];
      return out;
   }</p>
<p>out[0] = input[0];
   out[1] = stbi<strong>div4(input[0]<em>3 + input[1] + 2);
   for (i=1; i &lt; w-1; ++i) {
      int n = 3</em>input[i]+2;
      out[i*2+0] = stbi</strong>div4(n+input[i-1]);
      out[i<em>2+1] = stbi<strong>div4(n+input[i+1]);
   }
   out[i*2+0] = stbi</strong>div4(input[w-2]</em>3 + input[w-1] + 2);
   out[i*2+1] = input[w-1];</p>
<p>STBI_NOTUSED(in_far);
   STBI_NOTUSED(hs);</p>
<p>return out;
}</p>
<h1>define stbi__div16(x) ((stbi_uc) ((x) &gt;&gt; 4))</h1>
<p>static stbi_uc <em>stbi<strong>resample_row_hv_2(stbi_uc <em>out, stbi_uc </em>in_near, stbi_uc *in_far, int w, int hs)
{
   // need to generate 2x2 samples for every one in input
   int i,t0,t1;
   if (w == 1) {
      out[0] = out[1] = stbi</strong>div4(3</em>in_near[0] + in_far[0] + 2);
      return out;
   }</p>
<p>t1 = 3<em>in_near[0] + in_far[0];
   out[0] = stbi<strong>div4(t1+2);
   for (i=1; i &lt; w; ++i) {
      t0 = t1;
      t1 = 3<em>in_near[i]+in_far[i];
      out[i</em>2-1] = stbi</strong>div16(3</em>t0 + t1 + 8);
      out[i*2  ] = stbi<strong>div16(3<em>t1 + t0 + 8);
   }
   out[w</em>2-1] = stbi</strong>div4(t1+2);</p>
<p>STBI_NOTUSED(hs);</p>
<p>return out;
}</p>
<h1>if defined(STBI_SSE2) || defined(STBI_NEON)</h1>
<p>static stbi_uc <em>stbi__resample_row_hv_2_simd(stbi_uc </em>out, stbi_uc <em>in_near, stbi_uc </em>in_far, int w, int hs)
{
   // need to generate 2x2 samples for every one in input
   int i=0,t0,t1;</p>
<p>if (w == 1) {
      out[0] = out[1] = stbi__div4(3*in_near[0] + in_far[0] + 2);
      return out;
   }</p>
<p>t1 = 3*in_near[0] + in_far[0];
   // process groups of 8 pixels for as long as we can.
   // note we can't handle the last pixel in a row in this loop
   // because we need to handle the filter boundary conditions.
   for (; i &lt; ((w-1) &amp; ~7); i += 8) {</p>
<h1>if defined(STBI_SSE2)</h1>
<pre><code>  // load and perform the vertical filtering pass
  // this uses 3*x + y = 4*x + (y - x)
  __m128i zero  = _mm_setzero_si128();
  __m128i farb  = _mm_loadl_epi64((__m128i *) (in_far + i));
  __m128i nearb = _mm_loadl_epi64((__m128i *) (in_near + i));
  __m128i farw  = _mm_unpacklo_epi8(farb, zero);
  __m128i nearw = _mm_unpacklo_epi8(nearb, zero);
  __m128i diff  = _mm_sub_epi16(farw, nearw);
  __m128i nears = _mm_slli_epi16(nearw, 2);
  __m128i curr  = _mm_add_epi16(nears, diff); // current row

  // horizontal filter works the same based on shifted vers of current
  // row. "prev" is current row shifted right by 1 pixel; we need to
  // insert the previous pixel value (from t1).
  // "next" is current row shifted left by 1 pixel, with first pixel
  // of next block of 8 pixels added in.
  __m128i prv0 = _mm_slli_si128(curr, 2);
  __m128i nxt0 = _mm_srli_si128(curr, 2);
  __m128i prev = _mm_insert_epi16(prv0, t1, 0);
  __m128i next = _mm_insert_epi16(nxt0, 3*in_near[i+8] + in_far[i+8], 7);

  // horizontal filter, polyphase implementation since it's convenient:
  // even pixels = 3*cur + prev = cur*4 + (prev - cur)
  // odd  pixels = 3*cur + next = cur*4 + (next - cur)
  // note the shared term.
  __m128i bias  = _mm_set1_epi16(8);
  __m128i curs = _mm_slli_epi16(curr, 2);
  __m128i prvd = _mm_sub_epi16(prev, curr);
  __m128i nxtd = _mm_sub_epi16(next, curr);
  __m128i curb = _mm_add_epi16(curs, bias);
  __m128i even = _mm_add_epi16(prvd, curb);
  __m128i odd  = _mm_add_epi16(nxtd, curb);

  // interleave even and odd pixels, then undo scaling.
  __m128i int0 = _mm_unpacklo_epi16(even, odd);
  __m128i int1 = _mm_unpackhi_epi16(even, odd);
  __m128i de0  = _mm_srli_epi16(int0, 4);
  __m128i de1  = _mm_srli_epi16(int1, 4);

  // pack and write output
  __m128i outv = _mm_packus_epi16(de0, de1);
  _mm_storeu_si128((__m128i *) (out + i*2), outv);
</code></pre>
<h1>elif defined(STBI_NEON)</h1>
<pre><code>  // load and perform the vertical filtering pass
  // this uses 3*x + y = 4*x + (y - x)
  uint8x8_t farb  = vld1_u8(in_far + i);
  uint8x8_t nearb = vld1_u8(in_near + i);
  int16x8_t diff  = vreinterpretq_s16_u16(vsubl_u8(farb, nearb));
  int16x8_t nears = vreinterpretq_s16_u16(vshll_n_u8(nearb, 2));
  int16x8_t curr  = vaddq_s16(nears, diff); // current row

  // horizontal filter works the same based on shifted vers of current
  // row. "prev" is current row shifted right by 1 pixel; we need to
  // insert the previous pixel value (from t1).
  // "next" is current row shifted left by 1 pixel, with first pixel
  // of next block of 8 pixels added in.
  int16x8_t prv0 = vextq_s16(curr, curr, 7);
  int16x8_t nxt0 = vextq_s16(curr, curr, 1);
  int16x8_t prev = vsetq_lane_s16(t1, prv0, 0);
  int16x8_t next = vsetq_lane_s16(3*in_near[i+8] + in_far[i+8], nxt0, 7);

  // horizontal filter, polyphase implementation since it's convenient:
  // even pixels = 3*cur + prev = cur*4 + (prev - cur)
  // odd  pixels = 3*cur + next = cur*4 + (next - cur)
  // note the shared term.
  int16x8_t curs = vshlq_n_s16(curr, 2);
  int16x8_t prvd = vsubq_s16(prev, curr);
  int16x8_t nxtd = vsubq_s16(next, curr);
  int16x8_t even = vaddq_s16(curs, prvd);
  int16x8_t odd  = vaddq_s16(curs, nxtd);

  // undo scaling and round, then store with even/odd phases interleaved
  uint8x8x2_t o;
  o.val[0] = vqrshrun_n_s16(even, 4);
  o.val[1] = vqrshrun_n_s16(odd,  4);
  vst2_u8(out + i*2, o);
</code></pre>
<h1>endif</h1>
<pre><code>  // "previous" value for next iter
  t1 = 3*in_near[i+7] + in_far[i+7];
</code></pre>
<p>}</p>
<p>t0 = t1;
   t1 = 3<em>in_near[i] + in_far[i];
   out[i</em>2] = stbi__div16(3*t1 + t0 + 8);</p>
<p>for (++i; i &lt; w; ++i) {
      t0 = t1;
      t1 = 3<em>in_near[i]+in_far[i];
      out[i</em>2-1] = stbi<strong>div16(3<em>t0 + t1 + 8);
      out[i</em>2  ] = stbi</strong>div16(3<em>t1 + t0 + 8);
   }
   out[w</em>2-1] = stbi__div4(t1+2);</p>
<p>STBI_NOTUSED(hs);</p>
<p>return out;
}</p>
<h1>endif</h1>
<p>static stbi_uc <em>stbi__resample_row_generic(stbi_uc </em>out, stbi_uc <em>in_near, stbi_uc </em>in_far, int w, int hs)
{
   // resample with nearest-neighbor
   int i,j;
   STBI_NOTUSED(in_far);
   for (i=0; i &lt; w; ++i)
      for (j=0; j &lt; hs; ++j)
  out[i*hs+j] = in_near[i];
   return out;
}</p>
<h1>ifdef STBI_JPEG_OLD</h1>
<p>// this is the same YCbCr-to-RGB calculation that stb_image has used
// historically before the algorithm changes in 1.49</p>
<h1>define float2fixed(x)  ((int) ((x) * 65536 + 0.5))</h1>
<p>static void stbi__YCbCr_to_RGB_row(stbi_uc <em>out, const stbi_uc </em>y, const stbi_uc <em>pcb, const stbi_uc </em>pcr, int count, int step)
{
   int i;
   for (i=0; i &lt; count; ++i) {
      int y_fixed = (y[i] &lt;&lt; 16) + 32768; // rounding
      int r,g,b;
      int cr = pcr[i] - 128;
      int cb = pcb[i] - 128;
      r = y_fixed + cr<em>float2fixed(1.40200f);
      g = y_fixed - cr</em>float2fixed(0.71414f) - cb<em>float2fixed(0.34414f);
      b = y_fixed                            + cb</em>float2fixed(1.77200f);
      r &gt;&gt;= 16;
      g &gt;&gt;= 16;
      b &gt;&gt;= 16;
      if ((unsigned) r &gt; 255) { if (r &lt; 0) r = 0; else r = 255; }
      if ((unsigned) g &gt; 255) { if (g &lt; 0) g = 0; else g = 255; }
      if ((unsigned) b &gt; 255) { if (b &lt; 0) b = 0; else b = 255; }
      out[0] = (stbi_uc)r;
      out[1] = (stbi_uc)g;
      out[2] = (stbi_uc)b;
      out[3] = 255;
      out += step;
   }
}</p>
<h1>else</h1>
<p>// this is a reduced-precision calculation of YCbCr-to-RGB introduced
// to make sure the code produces the same results in both SIMD and scalar</p>
<h1>define float2fixed(x)  (((int) ((x) * 4096.0f + 0.5f)) &lt;&lt; 8)</h1>
<p>static void stbi__YCbCr_to_RGB_row(stbi_uc <em>out, const stbi_uc </em>y, const stbi_uc <em>pcb, const stbi_uc </em>pcr, int count, int step)
{
   int i;
   for (i=0; i &lt; count; ++i) {
      int y_fixed = (y[i] &lt;&lt; 20) + (1&lt;&lt;19); // rounding
      int r,g,b;
      int cr = pcr[i] - 128;
      int cb = pcb[i] - 128;
      r = y_fixed +  cr<em> float2fixed(1.40200f);
      g = y_fixed + (cr</em>-float2fixed(0.71414f)) + ((cb<em>-float2fixed(0.34414f)) &amp; 0xffff0000);
      b = y_fixed                               +   cb</em> float2fixed(1.77200f);
      r &gt;&gt;= 20;
      g &gt;&gt;= 20;
      b &gt;&gt;= 20;
      if ((unsigned) r &gt; 255) { if (r &lt; 0) r = 0; else r = 255; }
      if ((unsigned) g &gt; 255) { if (g &lt; 0) g = 0; else g = 255; }
      if ((unsigned) b &gt; 255) { if (b &lt; 0) b = 0; else b = 255; }
      out[0] = (stbi_uc)r;
      out[1] = (stbi_uc)g;
      out[2] = (stbi_uc)b;
      out[3] = 255;
      out += step;
   }
}</p>
<h1>endif</h1>
<h1>if defined(STBI_SSE2) || defined(STBI_NEON)</h1>
<p>static void stbi__YCbCr_to_RGB_simd(stbi_uc <em>out, stbi_uc const </em>y, stbi_uc const <em>pcb, stbi_uc const </em>pcr, int count, int step)
{
   int i = 0;</p>
<h1>ifdef STBI_SSE2</h1>
<p>// step == 3 is pretty ugly on the final interleave, and i'm not convinced
   // it's useful in practice (you wouldn't use it for textures, for example).
   // so just accelerate step == 4 case.
   if (step == 4) {
      // this is a fairly straightforward implementation and not super-optimized.
      <strong>m128i signflip  = _mm_set1_epi8(-0x80);
      </strong>m128i cr_const0 = _mm_set1_epi16(   (short) ( 1.40200f<em>4096.0f+0.5f));
      <strong>m128i cr_const1 = _mm_set1_epi16( - (short) ( 0.71414f*4096.0f+0.5f));
      </strong>m128i cb_const0 = _mm_set1_epi16( - (short) ( 0.34414f</em>4096.0f+0.5f));
      <strong>m128i cb_const1 = _mm_set1_epi16(   (short) ( 1.77200f*4096.0f+0.5f));
      </strong>m128i y_bias = _mm_set1_epi8((char) (unsigned char) 128);
      __m128i xw = _mm_set1_epi16(255); // alpha channel</p>
<pre><code>  for (; i+7 &lt; count; i += 8) {
</code></pre>
<p>// load
  <strong>m128i y_bytes = _mm_loadl_epi64((</strong>m128i <em>) (y+i));
  <strong>m128i cr_bytes = _mm_loadl_epi64((</strong>m128i </em>) (pcr+i));
  <strong>m128i cb_bytes = _mm_loadl_epi64((</strong>m128i *) (pcb+i));
  <strong>m128i cr_biased = _mm_xor_si128(cr_bytes, signflip); // -128
  </strong>m128i cb_biased = _mm_xor_si128(cb_bytes, signflip); // -128</p>
<p>// unpack to short (and left-shift cr, cb by 8)
  <strong>m128i yw  = _mm_unpacklo_epi8(y_bias, y_bytes);
  </strong>m128i crw = _mm_unpacklo_epi8(_mm_setzero_si128(), cr_biased);
  __m128i cbw = _mm_unpacklo_epi8(_mm_setzero_si128(), cb_biased);</p>
<p>// color transform
  <strong>m128i yws = _mm_srli_epi16(yw, 4);
  </strong>m128i cr0 = _mm_mulhi_epi16(cr_const0, crw);
  <strong>m128i cb0 = _mm_mulhi_epi16(cb_const0, cbw);
  </strong>m128i cb1 = _mm_mulhi_epi16(cbw, cb_const1);
  <strong>m128i cr1 = _mm_mulhi_epi16(crw, cr_const1);
  </strong>m128i rws = _mm_add_epi16(cr0, yws);
  <strong>m128i gwt = _mm_add_epi16(cb0, yws);
  </strong>m128i bws = _mm_add_epi16(yws, cb1);
  __m128i gws = _mm_add_epi16(gwt, cr1);</p>
<p>// descale
  <strong>m128i rw = _mm_srai_epi16(rws, 4);
  </strong>m128i bw = _mm_srai_epi16(bws, 4);
  __m128i gw = _mm_srai_epi16(gws, 4);</p>
<p>// back to byte, set up for transpose
  <strong>m128i brb = _mm_packus_epi16(rw, bw);
  </strong>m128i gxb = _mm_packus_epi16(gw, xw);</p>
<p>// transpose to interleave channels
  <strong>m128i t0 = _mm_unpacklo_epi8(brb, gxb);
  </strong>m128i t1 = _mm_unpackhi_epi8(brb, gxb);
  <strong>m128i o0 = _mm_unpacklo_epi16(t0, t1);
  </strong>m128i o1 = _mm_unpackhi_epi16(t0, t1);</p>
<p>// store
  _mm_storeu_si128((<strong>m128i *) (out + 0), o0);
  _mm_storeu_si128((</strong>m128i *) (out + 16), o1);
  out += 32;
      }
   }</p>
<h1>endif</h1>
<h1>ifdef STBI_NEON</h1>
<p>// in this version, step=3 support would be easy to add. but is there demand?
   if (step == 4) {
      // this is a fairly straightforward implementation and not super-optimized.
      uint8x8_t signflip = vdup_n_u8(0x80);
      int16x8_t cr_const0 = vdupq_n_s16(   (short) ( 1.40200f<em>4096.0f+0.5f));
      int16x8_t cr_const1 = vdupq_n_s16( - (short) ( 0.71414f</em>4096.0f+0.5f));
      int16x8_t cb_const0 = vdupq_n_s16( - (short) ( 0.34414f<em>4096.0f+0.5f));
      int16x8_t cb_const1 = vdupq_n_s16(   (short) ( 1.77200f</em>4096.0f+0.5f));</p>
<pre><code>  for (; i+7 &lt; count; i += 8) {
</code></pre>
<p>// load
  uint8x8_t y_bytes  = vld1_u8(y + i);
  uint8x8_t cr_bytes = vld1_u8(pcr + i);
  uint8x8_t cb_bytes = vld1_u8(pcb + i);
  int8x8_t cr_biased = vreinterpret_s8_u8(vsub_u8(cr_bytes, signflip));
  int8x8_t cb_biased = vreinterpret_s8_u8(vsub_u8(cb_bytes, signflip));</p>
<p>// expand to s16
  int16x8_t yws = vreinterpretq_s16_u16(vshll_n_u8(y_bytes, 4));
  int16x8_t crw = vshll_n_s8(cr_biased, 7);
  int16x8_t cbw = vshll_n_s8(cb_biased, 7);</p>
<p>// color transform
  int16x8_t cr0 = vqdmulhq_s16(crw, cr_const0);
  int16x8_t cb0 = vqdmulhq_s16(cbw, cb_const0);
  int16x8_t cr1 = vqdmulhq_s16(crw, cr_const1);
  int16x8_t cb1 = vqdmulhq_s16(cbw, cb_const1);
  int16x8_t rws = vaddq_s16(yws, cr0);
  int16x8_t gws = vaddq_s16(vaddq_s16(yws, cb0), cr1);
  int16x8_t bws = vaddq_s16(yws, cb1);</p>
<p>// undo scaling, round, convert to byte
  uint8x8x4_t o;
  o.val[0] = vqrshrun_n_s16(rws, 4);
  o.val[1] = vqrshrun_n_s16(gws, 4);
  o.val[2] = vqrshrun_n_s16(bws, 4);
  o.val[3] = vdup_n_u8(255);</p>
<p>// store, interleaving r/g/b/a
  vst4_u8(out, o);
  out += 8*4;
      }
   }</p>
<h1>endif</h1>
<p>for (; i &lt; count; ++i) {
      int y_fixed = (y[i] &lt;&lt; 20) + (1&lt;&lt;19); // rounding
      int r,g,b;
      int cr = pcr[i] - 128;
      int cb = pcb[i] - 128;
      r = y_fixed + cr<em> float2fixed(1.40200f);
      g = y_fixed + cr</em>-float2fixed(0.71414f) + ((cb<em>-float2fixed(0.34414f)) &amp; 0xffff0000);
      b = y_fixed                             +   cb</em> float2fixed(1.77200f);
      r &gt;&gt;= 20;
      g &gt;&gt;= 20;
      b &gt;&gt;= 20;
      if ((unsigned) r &gt; 255) { if (r &lt; 0) r = 0; else r = 255; }
      if ((unsigned) g &gt; 255) { if (g &lt; 0) g = 0; else g = 255; }
      if ((unsigned) b &gt; 255) { if (b &lt; 0) b = 0; else b = 255; }
      out[0] = (stbi_uc)r;
      out[1] = (stbi_uc)g;
      out[2] = (stbi_uc)b;
      out[3] = 255;
      out += step;
   }
}</p>
<h1>endif</h1>
<p>// set up the kernels
static void stbi<strong>setup_jpeg(stbi</strong>jpeg *j)
{
   j-&gt;idct_block_kernel = stbi<strong>idct_block;
   j-&gt;YCbCr_to_RGB_kernel = stbi</strong>YCbCr_to_RGB_row;
   j-&gt;resample_row_hv_2_kernel = stbi__resample_row_hv_2;</p>
<h1>ifdef STBI_SSE2</h1>
<p>if (stbi<strong>sse2_available()) {
      j-&gt;idct_block_kernel = stbi</strong>idct_simd;
      #ifndef STBI_JPEG_OLD
      j-&gt;YCbCr_to_RGB_kernel = stbi<strong>YCbCr_to_RGB_simd;
      #endif
      j-&gt;resample_row_hv_2_kernel = stbi</strong>resample_row_hv_2_simd;
   }</p>
<h1>endif</h1>
<h1>ifdef STBI_NEON</h1>
<p>j-&gt;idct_block_kernel = stbi<strong>idct_simd;
   #ifndef STBI_JPEG_OLD
   j-&gt;YCbCr_to_RGB_kernel = stbi</strong>YCbCr_to_RGB_simd;
   #endif
   j-&gt;resample_row_hv_2_kernel = stbi__resample_row_hv_2_simd;</p>
<h1>endif</h1>
<p>}</p>
<p>// clean up the temporary component buffers
static void stbi<strong>cleanup_jpeg(stbi</strong>jpeg *j)
{
   int i;
   for (i=0; i &lt; j-&gt;s-&gt;img_n; ++i) {
      if (j-&gt;img_comp[i].raw_data) {
  STBI_FREE(j-&gt;img_comp[i].raw_data);
  j-&gt;img_comp[i].raw_data = NULL;
  j-&gt;img_comp[i].data = NULL;
      }
      if (j-&gt;img_comp[i].raw_coeff) {
  STBI_FREE(j-&gt;img_comp[i].raw_coeff);
  j-&gt;img_comp[i].raw_coeff = 0;
  j-&gt;img_comp[i].coeff = 0;
      }
      if (j-&gt;img_comp[i].linebuf) {
  STBI_FREE(j-&gt;img_comp[i].linebuf);
  j-&gt;img_comp[i].linebuf = NULL;
      }
   }
}</p>
<p>typedef struct
{
   resample_row_func resample;
   stbi_uc <em>line0,</em>line1;
   int hs,vs;   // expansion factor in each axis
   int w_lores; // horizontal pixels pre-expansion
   int ystep;   // how far through vertical expansion we are
   int ypos;    // which pre-expansion row we're on
} stbi__resample;</p>
<p>static stbi_uc *load_jpeg_image(stbi<strong>jpeg <em>z, int </em>out_x, int <em>out_y, int </em>comp, int req_comp)
{
   int n, decode_n;
   z-&gt;s-&gt;img_n = 0; // make stbi</strong>cleanup_jpeg safe</p>
<p>// validate req_comp
   if (req_comp &lt; 0 || req_comp &gt; 4) return stbi__errpuc("bad req_comp", "Internal error");</p>
<p>// load a jpeg image from whichever source, but leave in YCbCr format
   if (!stbi<strong>decode_jpeg_image(z)) { stbi</strong>cleanup_jpeg(z); return NULL; }</p>
<p>// determine actual number of components to generate
   n = req_comp ? req_comp : z-&gt;s-&gt;img_n;</p>
<p>if (z-&gt;s-&gt;img_n == 3 &amp;&amp; n &lt; 3)
      decode_n = 1;
   else
      decode_n = z-&gt;s-&gt;img_n;</p>
<p>// resample and color-convert
   {
      int k;
      unsigned int i,j;
      stbi_uc <em>output;
      stbi_uc </em>coutput[4];</p>
<pre><code>  stbi__resample res_comp[4];

  for (k=0; k &lt; decode_n; ++k) {
</code></pre>
<p>stbi__resample *r = &amp;res_comp[k];</p>
<p>// allocate line buffer big enough for upsampling off the edges
  // with upsample factor of 4
  z-&gt;img_comp[k].linebuf = (stbi_uc *) stbi<strong>malloc(z-&gt;s-&gt;img_x + 3);
  if (!z-&gt;img_comp[k].linebuf) { stbi</strong>cleanup_jpeg(z); return stbi__errpuc("outofmem", "Out of memory"); }</p>
<p>r-&gt;hs      = z-&gt;img_h_max / z-&gt;img_comp[k].h;
  r-&gt;vs      = z-&gt;img_v_max / z-&gt;img_comp[k].v;
  r-&gt;ystep   = r-&gt;vs &gt;&gt; 1;
  r-&gt;w_lores = (z-&gt;s-&gt;img_x + r-&gt;hs-1) / r-&gt;hs;
  r-&gt;ypos    = 0;
  r-&gt;line0   = r-&gt;line1 = z-&gt;img_comp[k].data;</p>
<p>if      (r-&gt;hs == 1 &amp;&amp; r-&gt;vs == 1) r-&gt;resample = resample_row_1;
  else if (r-&gt;hs == 1 &amp;&amp; r-&gt;vs == 2) r-&gt;resample = stbi<strong>resample_row_v_2;
  else if (r-&gt;hs == 2 &amp;&amp; r-&gt;vs == 1) r-&gt;resample = stbi</strong>resample_row_h_2;
  else if (r-&gt;hs == 2 &amp;&amp; r-&gt;vs == 2) r-&gt;resample = z-&gt;resample_row_hv_2_kernel;
  else                               r-&gt;resample = stbi__resample_row_generic;
      }</p>
<pre><code>  // can't error after this so, this is safe
  output = (stbi_uc *) stbi__malloc(n * z-&gt;s-&gt;img_x * z-&gt;s-&gt;img_y + 1);
  if (!output) { stbi__cleanup_jpeg(z); return stbi__errpuc("outofmem", "Out of memory"); }

  // now go ahead and resample
  for (j=0; j &lt; z-&gt;s-&gt;img_y; ++j) {
</code></pre>
<p>stbi_uc <em>out = output + n * z-&gt;s-&gt;img_x * j;
  for (k=0; k &lt; decode_n; ++k) {
     stbi<strong>resample <em>r = &amp;res_comp[k];
     int y_bot = r-&gt;ystep &gt;= (r-&gt;vs &gt;&gt; 1);
     coutput[k] = r-&gt;resample(z-&gt;img_comp[k].linebuf,
                              y_bot ? r-&gt;line1 : r-&gt;line0,
                              y_bot ? r-&gt;line0 : r-&gt;line1,
                              r-&gt;w_lores, r-&gt;hs);
     if (++r-&gt;ystep &gt;= r-&gt;vs) {
        r-&gt;ystep = 0;
        r-&gt;line0 = r-&gt;line1;
        if (++r-&gt;ypos &lt; z-&gt;img_comp[k].y)
           r-&gt;line1 += z-&gt;img_comp[k].w2;
     }
  }
  if (n &gt;= 3) {
     stbi_uc </em>y = coutput[0];
     if (z-&gt;s-&gt;img_n == 3) {
        if (z-&gt;rgb == 3) {
           for (i=0; i &lt; z-&gt;s-&gt;img_x; ++i) {
              out[0] = y[i];
              out[1] = coutput[1][i];
              out[2] = coutput[2][i];
              out[3] = 255;
              out += n;
           }
        } else {
           z-&gt;YCbCr_to_RGB_kernel(out, y, coutput[1], coutput[2], z-&gt;s-&gt;img_x, n);
        }
     } else
        for (i=0; i &lt; z-&gt;s-&gt;img_x; ++i) {
           out[0] = out[1] = out[2] = y[i];
           out[3] = 255; // not used if n==3
           out += n;
        }
  } else {
     stbi_uc <em>y = coutput[0];
     if (n == 1)
        for (i=0; i &lt; z-&gt;s-&gt;img_x; ++i) out[i] = y[i];
     else
        for (i=0; i &lt; z-&gt;s-&gt;img_x; ++i) </em>out++ = y[i], *out++ = 255;
  }
      }
      stbi</strong>cleanup_jpeg(z);
      </em>out_x = z-&gt;s-&gt;img_x;
      <em>out_y = z-&gt;s-&gt;img_y;
      if (comp) </em>comp  = z-&gt;s-&gt;img_n; // report original components, not output
      return output;
   }
}</p>
<p>static unsigned char <em>stbi<strong>jpeg_load(stbi</strong>context </em>s, int <em>x, int </em>y, int <em>comp, int req_comp)
{
   unsigned char</em> result;
   stbi<strong>jpeg* j = (stbi</strong>jpeg*) stbi<strong>malloc(sizeof(stbi</strong>jpeg));
   j-&gt;s = s;
   stbi__setup_jpeg(j);
   result = load_jpeg_image(j, x,y,comp,req_comp);
   STBI_FREE(j);
   return result;
}</p>
<p>static int stbi<strong>jpeg_test(stbi</strong>context *s)
{
   int r;
   stbi<strong>jpeg j;
   j.s = s;
   stbi</strong>setup_jpeg(&amp;j);
   r = stbi<strong>decode_jpeg_header(&amp;j, STBI</strong>SCAN_type);
   stbi__rewind(s);
   return r;
}</p>
<p>static int stbi<strong>jpeg_info_raw(stbi</strong>jpeg <em>j, int </em>x, int <em>y, int </em>comp)
{
   if (!stbi<strong>decode_jpeg_header(j, STBI</strong>SCAN_header)) {
      stbi__rewind( j-&gt;s );
      return 0;
   }
   if (x) <em>x = j-&gt;s-&gt;img_x;
   if (y) </em>y = j-&gt;s-&gt;img_y;
   if (comp) *comp = j-&gt;s-&gt;img_n;
   return 1;
}</p>
<p>static int stbi<strong>jpeg_info(stbi</strong>context <em>s, int </em>x, int <em>y, int </em>comp)
{
   int result;
   stbi<strong>jpeg* j = (stbi</strong>jpeg*) (stbi<strong>malloc(sizeof(stbi</strong>jpeg)));
   j-&gt;s = s;
   result = stbi__jpeg_info_raw(j, x, y, comp);
   STBI_FREE(j);
   return result;
}</p>
<h1>endif</h1>
<p>// public domain zlib decode    v0.2  Sean Barrett 2006-11-18
//    simple implementation
//      - all input must be provided in an upfront buffer
//      - all output is written to a single output buffer (can malloc/realloc)
//    performance
//      - fast huffman</p>
<h1>ifndef STBI_NO_ZLIB</h1>
<p>// fast-way is faster to check than jpeg huffman, but slow way is slower</p>
<h1>define STBI__ZFAST_BITS  9 // accelerate all cases in default tables</h1>
<h1>define STBI<strong>ZFAST_MASK  ((1 &lt;&lt; STBI</strong>ZFAST_BITS) - 1)</h1>
<p>// zlib-style huffman encoding
// (jpegs packs from left, zlib from right, so can't share code)
typedef struct
{
   stbi<strong>uint16 fast[1 &lt;&lt; STBI</strong>ZFAST_BITS];
   stbi<strong>uint16 firstcode[16];
   int maxcode[17];
   stbi</strong>uint16 firstsymbol[16];
   stbi_uc  size[288];
   stbi<strong>uint16 value[288];
} stbi</strong>zhuffman;</p>
<p>stbi_inline static int stbi__bitreverse16(int n)
{
  n = ((n &amp; 0xAAAA) &gt;&gt;  1) | ((n &amp; 0x5555) &lt;&lt; 1);
  n = ((n &amp; 0xCCCC) &gt;&gt;  2) | ((n &amp; 0x3333) &lt;&lt; 2);
  n = ((n &amp; 0xF0F0) &gt;&gt;  4) | ((n &amp; 0x0F0F) &lt;&lt; 4);
  n = ((n &amp; 0xFF00) &gt;&gt;  8) | ((n &amp; 0x00FF) &lt;&lt; 8);
  return n;
}</p>
<p>stbi_inline static int stbi<strong>bit_reverse(int v, int bits)
{
   STBI_ASSERT(bits &lt;= 16);
   // to bit reverse n bits, reverse 16 and shift
   // e.g. 11 bits, bit reverse and shift away 5
   return stbi</strong>bitreverse16(v) &gt;&gt; (16-bits);
}</p>
<p>static int stbi<strong>zbuild_huffman(stbi</strong>zhuffman <em>z, stbi_uc </em>sizelist, int num)
{
   int i,k=0;
   int code, next_code[16], sizes[17];</p>
<p>// DEFLATE spec for generating codes
   memset(sizes, 0, sizeof(sizes));
   memset(z-&gt;fast, 0, sizeof(z-&gt;fast));
   for (i=0; i &lt; num; ++i)
      ++sizes[sizelist[i]];
   sizes[0] = 0;
   for (i=1; i &lt; 16; ++i)
      if (sizes[i] &gt; (1 &lt;&lt; i))
  return stbi<strong>err("bad sizes", "Corrupt PNG");
   code = 0;
   for (i=1; i &lt; 16; ++i) {
      next_code[i] = code;
      z-&gt;firstcode[i] = (stbi</strong>uint16) code;
      z-&gt;firstsymbol[i] = (stbi<strong>uint16) k;
      code = (code + sizes[i]);
      if (sizes[i])
  if (code-1 &gt;= (1 &lt;&lt; i)) return stbi</strong>err("bad codelengths","Corrupt PNG");
      z-&gt;maxcode[i] = code &lt;&lt; (16-i); // preshift for inner loop
      code &lt;&lt;= 1;
      k += sizes[i];
   }
   z-&gt;maxcode[16] = 0x10000; // sentinel
   for (i=0; i &lt; num; ++i) {
      int s = sizelist[i];
      if (s) {
  int c = next_code[s] - z-&gt;firstcode[s] + z-&gt;firstsymbol[s];
  stbi<strong>uint16 fastv = (stbi</strong>uint16) ((s &lt;&lt; 9) | i);
  z-&gt;size [c] = (stbi_uc     ) s;
  z-&gt;value[c] = (stbi<strong>uint16) i;
  if (s &lt;= STBI</strong>ZFAST_BITS) {
     int j = stbi<strong>bit_reverse(next_code[s],s);
     while (j &lt; (1 &lt;&lt; STBI</strong>ZFAST_BITS)) {
        z-&gt;fast[j] = fastv;
        j += (1 &lt;&lt; s);
     }
  }
  ++next_code[s];
      }
   }
   return 1;
}</p>
<p>// zlib-from-memory implementation for PNG reading
//    because PNG allows splitting the zlib stream arbitrarily,
//    and it's annoying structurally to have PNG call ZLIB call PNG,
//    we require PNG read all the IDATs and combine them into a single
//    memory buffer</p>
<p>typedef struct
{
   stbi_uc <em>zbuffer, </em>zbuffer_end;
   int num_bits;
   stbi__uint32 code_buffer;</p>
<p>char <em>zout;
   char </em>zout_start;
   char *zout_end;
   int   z_expandable;</p>
<p>stbi<strong>zhuffman z_length, z_distance;
} stbi</strong>zbuf;</p>
<p>stbi_inline static stbi_uc stbi<strong>zget8(stbi</strong>zbuf <em>z)
{
   if (z-&gt;zbuffer &gt;= z-&gt;zbuffer_end) return 0;
   return </em>z-&gt;zbuffer++;
}</p>
<p>static void stbi<strong>fill_bits(stbi</strong>zbuf *z)
{
   do {
      STBI_ASSERT(z-&gt;code_buffer &lt; (1U &lt;&lt; z-&gt;num_bits));
      z-&gt;code_buffer |= (unsigned int) stbi__zget8(z) &lt;&lt; z-&gt;num_bits;
      z-&gt;num_bits += 8;
   } while (z-&gt;num_bits &lt;= 24);
}</p>
<p>stbi_inline static unsigned int stbi<strong>zreceive(stbi</strong>zbuf *z, int n)
{
   unsigned int k;
   if (z-&gt;num_bits &lt; n) stbi__fill_bits(z);
   k = z-&gt;code_buffer &amp; ((1 &lt;&lt; n) - 1);
   z-&gt;code_buffer &gt;&gt;= n;
   z-&gt;num_bits -= n;
   return k;
}</p>
<p>static int stbi<strong>zhuffman_decode_slowpath(stbi</strong>zbuf *a, stbi<strong>zhuffman *z)
{
   int b,s,k;
   // not resolved by fast table, so compute it the slow way
   // use jpeg approach, which requires MSbits at top
   k = stbi</strong>bit_reverse(a-&gt;code_buffer, 16);
   for (s=STBI__ZFAST_BITS+1; ; ++s)
      if (k &lt; z-&gt;maxcode[s])
  break;
   if (s == 16) return -1; // invalid code!
   // code size is s, so:
   b = (k &gt;&gt; (16-s)) - z-&gt;firstcode[s] + z-&gt;firstsymbol[s];
   STBI_ASSERT(z-&gt;size[b] == s);
   a-&gt;code_buffer &gt;&gt;= s;
   a-&gt;num_bits -= s;
   return z-&gt;value[b];
}</p>
<p>stbi_inline static int stbi<strong>zhuffman_decode(stbi</strong>zbuf *a, stbi<strong>zhuffman *z)
{
   int b,s;
   if (a-&gt;num_bits &lt; 16) stbi</strong>fill_bits(a);
   b = z-&gt;fast[a-&gt;code_buffer &amp; STBI<strong>ZFAST_MASK];
   if (b) {
      s = b &gt;&gt; 9;
      a-&gt;code_buffer &gt;&gt;= s;
      a-&gt;num_bits -= s;
      return b &amp; 511;
   }
   return stbi</strong>zhuffman_decode_slowpath(a, z);
}</p>
<p>static int stbi<strong>zexpand(stbi</strong>zbuf <em>z, char </em>zout, int n)  // need to make room for n bytes
{
   char *q;
   int cur, limit, old_limit;
   z-&gt;zout = zout;
   if (!z-&gt;z_expandable) return stbi<strong>err("output buffer limit","Corrupt PNG");
   cur   = (int) (z-&gt;zout     - z-&gt;zout_start);
   limit = old_limit = (int) (z-&gt;zout_end - z-&gt;zout_start);
   while (cur + n &gt; limit)
      limit <em>= 2;
   q = (char </em>) STBI_REALLOC_SIZED(z-&gt;zout_start, old_limit, limit);
   STBI_NOTUSED(old_limit);
   if (q == NULL) return stbi</strong>err("outofmem", "Out of memory");
   z-&gt;zout_start = q;
   z-&gt;zout       = q + cur;
   z-&gt;zout_end   = q + limit;
   return 1;
}</p>
<p>static int stbi__zlength_base[31] = {
   3,4,5,6,7,8,9,10,11,13,
   15,17,19,23,27,31,35,43,51,59,
   67,83,99,115,131,163,195,227,258,0,0 };</p>
<p>static int stbi__zlength_extra[31]=
{ 0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0 };</p>
<p>static int stbi__zdist_base[32] = { 1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,
257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577,0,0};</p>
<p>static int stbi__zdist_extra[32] =
{ 0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13};</p>
<p>static int stbi<strong>parse_huffman_block(stbi</strong>zbuf <em>a)
{
   char </em>zout = a-&gt;zout;
   for(;;) {
      int z = stbi<strong>zhuffman_decode(a, &amp;a-&gt;z_length);
      if (z &lt; 256) {
  if (z &lt; 0) return stbi</strong>err("bad huffman code","Corrupt PNG"); // error in huffman codes
  if (zout &gt;= a-&gt;zout_end) {
     if (!stbi<strong>zexpand(a, zout, 1)) return 0;
     zout = a-&gt;zout;
  }
  <em>zout++ = (char) z;
      } else {
  stbi_uc </em>p;
  int len,dist;
  if (z == 256) {
     a-&gt;zout = zout;
     return 1;
  }
  z -= 257;
  len = stbi</strong>zlength_base[z];
  if (stbi<strong>zlength_extra[z]) len += stbi</strong>zreceive(a, stbi<strong>zlength_extra[z]);
  z = stbi</strong>zhuffman_decode(a, &amp;a-&gt;z_distance);
  if (z &lt; 0) return stbi<strong>err("bad huffman code","Corrupt PNG");
  dist = stbi</strong>zdist_base[z];
  if (stbi<strong>zdist_extra[z]) dist += stbi</strong>zreceive(a, stbi<strong>zdist_extra[z]);
  if (zout - a-&gt;zout_start &lt; dist) return stbi</strong>err("bad dist","Corrupt PNG");
  if (zout + len &gt; a-&gt;zout_end) {
     if (!stbi__zexpand(a, zout, len)) return 0;
     zout = a-&gt;zout;
  }
  p = (stbi_uc <em>) (zout - dist);
  if (dist == 1) { // run of one byte; common in images.
     stbi_uc v = </em>p;
     if (len) { do <em>zout++ = v; while (--len); }
  } else {
     if (len) { do </em>zout++ = *p++; while (--len); }
  }
      }
   }
}</p>
<p>static int stbi<strong>compute_huffman_codes(stbi</strong>zbuf *a)
{
   static stbi_uc length_dezigzag[19] = { 16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15 };
   stbi__zhuffman z_codelength;
   stbi_uc lencodes[286+32+137];//padding for maximum single op
   stbi_uc codelength_sizes[19];
   int i,n;</p>
<p>int hlit  = stbi<strong>zreceive(a,5) + 257;
   int hdist = stbi</strong>zreceive(a,5) + 1;
   int hclen = stbi__zreceive(a,4) + 4;</p>
<p>memset(codelength_sizes, 0, sizeof(codelength_sizes));
   for (i=0; i &lt; hclen; ++i) {
      int s = stbi<strong>zreceive(a,3);
      codelength_sizes[length_dezigzag[i]] = (stbi_uc) s;
   }
   if (!stbi</strong>zbuild_huffman(&amp;z_codelength, codelength_sizes, 19)) return 0;</p>
<p>n = 0;
   while (n &lt; hlit + hdist) {
      int c = stbi<strong>zhuffman_decode(a, &amp;z_codelength);
      if (c &lt; 0 || c &gt;= 19) return stbi</strong>err("bad codelengths", "Corrupt PNG");
      if (c &lt; 16)
  lencodes[n++] = (stbi_uc) c;
      else if (c == 16) {
  c = stbi<strong>zreceive(a,2)+3;
  memset(lencodes+n, lencodes[n-1], c);
  n += c;
      } else if (c == 17) {
  c = stbi</strong>zreceive(a,3)+3;
  memset(lencodes+n, 0, c);
  n += c;
      } else {
  STBI_ASSERT(c == 18);
  c = stbi<strong>zreceive(a,7)+11;
  memset(lencodes+n, 0, c);
  n += c;
      }
   }
   if (n != hlit+hdist) return stbi</strong>err("bad codelengths","Corrupt PNG");
   if (!stbi<strong>zbuild_huffman(&amp;a-&gt;z_length, lencodes, hlit)) return 0;
   if (!stbi</strong>zbuild_huffman(&amp;a-&gt;z_distance, lencodes+hlit, hdist)) return 0;
   return 1;
}</p>
<p>static int stbi<strong>parse_uncompressed_block(stbi</strong>zbuf *a)
{
   stbi_uc header[4];
   int len,nlen,k;
   if (a-&gt;num_bits &amp; 7)
      stbi<strong>zreceive(a, a-&gt;num_bits &amp; 7); // discard
   // drain the bit-packed data into header
   k = 0;
   while (a-&gt;num_bits &gt; 0) {
      header[k++] = (stbi_uc) (a-&gt;code_buffer &amp; 255); // suppress MSVC run-time check
      a-&gt;code_buffer &gt;&gt;= 8;
      a-&gt;num_bits -= 8;
   }
   STBI_ASSERT(a-&gt;num_bits == 0);
   // now fill header the normal way
   while (k &lt; 4)
      header[k++] = stbi</strong>zget8(a);
   len  = header[1] * 256 + header[0];
   nlen = header[3] * 256 + header[2];
   if (nlen != (len ^ 0xffff)) return stbi<strong>err("zlib corrupt","Corrupt PNG");
   if (a-&gt;zbuffer + len &gt; a-&gt;zbuffer_end) return stbi</strong>err("read past buffer","Corrupt PNG");
   if (a-&gt;zout + len &gt; a-&gt;zout_end)
      if (!stbi__zexpand(a, a-&gt;zout, len)) return 0;
   memcpy(a-&gt;zout, a-&gt;zbuffer, len);
   a-&gt;zbuffer += len;
   a-&gt;zout += len;
   return 1;
}</p>
<p>static int stbi<strong>parse_zlib_header(stbi</strong>zbuf *a)
{
   int cmf   = stbi__zget8(a);
   int cm    = cmf &amp; 15;
int cinfo = cmf &gt;&gt; 4;</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>   <span class="kt">int</span> <span class="n">flg</span>   <span class="o">=</span> <span class="n">stbi__zget8</span><span class="p">(</span><span class="n">a</span><span class="p">);</span>
   <span class="k">if</span> <span class="p">((</span><span class="n">cmf</span><span class="o">*</span><span class="mi">256</span><span class="o">+</span><span class="n">flg</span><span class="p">)</span> <span class="o">%</span> <span class="mi">31</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="n">stbi__err</span><span class="p">(</span><span class="s">&quot;bad zlib header&quot;</span><span class="p">,</span><span class="s">&quot;Corrupt PNG&quot;</span><span class="p">);</span> <span class="c1">// zlib spec</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">flg</span> <span class="o">&amp;</span> <span class="mi">32</span><span class="p">)</span> <span class="k">return</span> <span class="n">stbi__err</span><span class="p">(</span><span class="s">&quot;no preset dict&quot;</span><span class="p">,</span><span class="s">&quot;Corrupt PNG&quot;</span><span class="p">);</span> <span class="c1">// preset dictionary not allowed in png</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">cm</span> <span class="o">!=</span> <span class="mi">8</span><span class="p">)</span> <span class="k">return</span> <span class="n">stbi__err</span><span class="p">(</span><span class="s">&quot;bad compression&quot;</span><span class="p">,</span><span class="s">&quot;Corrupt PNG&quot;</span><span class="p">);</span> <span class="c1">// DEFLATE required for png</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-105'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-105'>#</a>
      </div>
      <p>window = 1 &lt;&lt; (8 + cinfo)... but who cares, we fully buffer output</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>   <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-106'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-106'>#</a>
      </div>
      <p>@TODO: should statically initialize these for optimal thread safety</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">static</span> <span class="n">stbi_uc</span> <span class="n">stbi__zdefault_length</span><span class="p">[</span><span class="mi">288</span><span class="p">],</span> <span class="n">stbi__zdefault_distance</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">stbi__init_zdefaults</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
   <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>   <span class="c1">// use &lt;= to match clearly with spec</span>
   <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">143</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>     <span class="n">stbi__zdefault_length</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>   <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
   <span class="k">for</span> <span class="p">(</span>   <span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">255</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>     <span class="n">stbi__zdefault_length</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>   <span class="o">=</span> <span class="mi">9</span><span class="p">;</span>
   <span class="k">for</span> <span class="p">(</span>   <span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">279</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>     <span class="n">stbi__zdefault_length</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>   <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
   <span class="k">for</span> <span class="p">(</span>   <span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">287</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>     <span class="n">stbi__zdefault_length</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>   <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>

   <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span>  <span class="mi">31</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>     <span class="n">stbi__zdefault_distance</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">stbi__parse_zlib</span><span class="p">(</span><span class="n">stbi__zbuf</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="kt">int</span> <span class="n">parse_header</span><span class="p">)</span>
<span class="p">{</span>
   <span class="kt">int</span> <span class="n">final</span><span class="p">,</span> <span class="n">type</span><span class="p">;</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">parse_header</span><span class="p">)</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">stbi__parse_zlib_header</span><span class="p">(</span><span class="n">a</span><span class="p">))</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
   <span class="n">a</span><span class="o">-&gt;</span><span class="n">num_bits</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
   <span class="n">a</span><span class="o">-&gt;</span><span class="n">code_buffer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
   <span class="k">do</span> <span class="p">{</span>
      <span class="n">final</span> <span class="o">=</span> <span class="n">stbi__zreceive</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
      <span class="n">type</span> <span class="o">=</span> <span class="n">stbi__zreceive</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="mi">2</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
         <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">stbi__parse_uncompressed_block</span><span class="p">(</span><span class="n">a</span><span class="p">))</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
         <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
         <span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-107'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-107'>#</a>
      </div>
      <p>use fixed code lengths</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">stbi__zdefault_distance</span><span class="p">[</span><span class="mi">31</span><span class="p">])</span> <span class="n">stbi__init_zdefaults</span><span class="p">();</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">stbi__zbuild_huffman</span><span class="p">(</span><span class="o">&amp;</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">z_length</span>  <span class="p">,</span> <span class="n">stbi__zdefault_length</span>  <span class="p">,</span> <span class="mi">288</span><span class="p">))</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">stbi__zbuild_huffman</span><span class="p">(</span><span class="o">&amp;</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">z_distance</span><span class="p">,</span> <span class="n">stbi__zdefault_distance</span><span class="p">,</span>  <span class="mi">32</span><span class="p">))</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
         <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">stbi__compute_huffman_codes</span><span class="p">(</span><span class="n">a</span><span class="p">))</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
         <span class="p">}</span>
         <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">stbi__parse_huffman_block</span><span class="p">(</span><span class="n">a</span><span class="p">))</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
      <span class="p">}</span>
   <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">final</span><span class="p">);</span>
   <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">stbi__do_zlib</span><span class="p">(</span><span class="n">stbi__zbuf</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">obuf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">olen</span><span class="p">,</span> <span class="kt">int</span> <span class="n">exp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">parse_header</span><span class="p">)</span>
<span class="p">{</span>
   <span class="n">a</span><span class="o">-&gt;</span><span class="n">zout_start</span> <span class="o">=</span> <span class="n">obuf</span><span class="p">;</span>
   <span class="n">a</span><span class="o">-&gt;</span><span class="n">zout</span>       <span class="o">=</span> <span class="n">obuf</span><span class="p">;</span>
   <span class="n">a</span><span class="o">-&gt;</span><span class="n">zout_end</span>   <span class="o">=</span> <span class="n">obuf</span> <span class="o">+</span> <span class="n">olen</span><span class="p">;</span>
   <span class="n">a</span><span class="o">-&gt;</span><span class="n">z_expandable</span> <span class="o">=</span> <span class="n">exp</span><span class="p">;</span>

   <span class="k">return</span> <span class="n">stbi__parse_zlib</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">parse_header</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">STBIDEF</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">stbi_zlib_decode_malloc_guesssize</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="kt">int</span> <span class="n">initial_size</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">outlen</span><span class="p">)</span>
<span class="p">{</span>
   <span class="n">stbi__zbuf</span> <span class="n">a</span><span class="p">;</span>
   <span class="kt">char</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">stbi__malloc</span><span class="p">(</span><span class="n">initial_size</span><span class="p">);</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
   <span class="n">a</span><span class="p">.</span><span class="n">zbuffer</span> <span class="o">=</span> <span class="p">(</span><span class="n">stbi_uc</span> <span class="o">*</span><span class="p">)</span> <span class="n">buffer</span><span class="p">;</span>
   <span class="n">a</span><span class="p">.</span><span class="n">zbuffer_end</span> <span class="o">=</span> <span class="p">(</span><span class="n">stbi_uc</span> <span class="o">*</span><span class="p">)</span> <span class="n">buffer</span> <span class="o">+</span> <span class="n">len</span><span class="p">;</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">stbi__do_zlib</span><span class="p">(</span><span class="o">&amp;</span><span class="n">a</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">initial_size</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">outlen</span><span class="p">)</span> <span class="o">*</span><span class="n">outlen</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">zout</span> <span class="o">-</span> <span class="n">a</span><span class="p">.</span><span class="n">zout_start</span><span class="p">);</span>
      <span class="k">return</span> <span class="n">a</span><span class="p">.</span><span class="n">zout_start</span><span class="p">;</span>
   <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="n">STBI_FREE</span><span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">zout_start</span><span class="p">);</span>
      <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
   <span class="p">}</span>
<span class="p">}</span>

<span class="n">STBIDEF</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">stbi_zlib_decode_malloc</span><span class="p">(</span><span class="kt">char</span> <span class="k">const</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">outlen</span><span class="p">)</span>
<span class="p">{</span>
   <span class="k">return</span> <span class="n">stbi_zlib_decode_malloc_guesssize</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="mi">16384</span><span class="p">,</span> <span class="n">outlen</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">STBIDEF</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">stbi_zlib_decode_malloc_guesssize_headerflag</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="kt">int</span> <span class="n">initial_size</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">outlen</span><span class="p">,</span> <span class="kt">int</span> <span class="n">parse_header</span><span class="p">)</span>
<span class="p">{</span>
   <span class="n">stbi__zbuf</span> <span class="n">a</span><span class="p">;</span>
   <span class="kt">char</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">stbi__malloc</span><span class="p">(</span><span class="n">initial_size</span><span class="p">);</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
   <span class="n">a</span><span class="p">.</span><span class="n">zbuffer</span> <span class="o">=</span> <span class="p">(</span><span class="n">stbi_uc</span> <span class="o">*</span><span class="p">)</span> <span class="n">buffer</span><span class="p">;</span>
   <span class="n">a</span><span class="p">.</span><span class="n">zbuffer_end</span> <span class="o">=</span> <span class="p">(</span><span class="n">stbi_uc</span> <span class="o">*</span><span class="p">)</span> <span class="n">buffer</span> <span class="o">+</span> <span class="n">len</span><span class="p">;</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">stbi__do_zlib</span><span class="p">(</span><span class="o">&amp;</span><span class="n">a</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">initial_size</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">parse_header</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">outlen</span><span class="p">)</span> <span class="o">*</span><span class="n">outlen</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">zout</span> <span class="o">-</span> <span class="n">a</span><span class="p">.</span><span class="n">zout_start</span><span class="p">);</span>
      <span class="k">return</span> <span class="n">a</span><span class="p">.</span><span class="n">zout_start</span><span class="p">;</span>
   <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="n">STBI_FREE</span><span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">zout_start</span><span class="p">);</span>
      <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
   <span class="p">}</span>
<span class="p">}</span>

<span class="n">STBIDEF</span> <span class="kt">int</span> <span class="nf">stbi_zlib_decode_buffer</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">obuffer</span><span class="p">,</span> <span class="kt">int</span> <span class="n">olen</span><span class="p">,</span> <span class="kt">char</span> <span class="k">const</span> <span class="o">*</span><span class="n">ibuffer</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ilen</span><span class="p">)</span>
<span class="p">{</span>
   <span class="n">stbi__zbuf</span> <span class="n">a</span><span class="p">;</span>
   <span class="n">a</span><span class="p">.</span><span class="n">zbuffer</span> <span class="o">=</span> <span class="p">(</span><span class="n">stbi_uc</span> <span class="o">*</span><span class="p">)</span> <span class="n">ibuffer</span><span class="p">;</span>
   <span class="n">a</span><span class="p">.</span><span class="n">zbuffer_end</span> <span class="o">=</span> <span class="p">(</span><span class="n">stbi_uc</span> <span class="o">*</span><span class="p">)</span> <span class="n">ibuffer</span> <span class="o">+</span> <span class="n">ilen</span><span class="p">;</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">stbi__do_zlib</span><span class="p">(</span><span class="o">&amp;</span><span class="n">a</span><span class="p">,</span> <span class="n">obuffer</span><span class="p">,</span> <span class="n">olen</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
      <span class="k">return</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">zout</span> <span class="o">-</span> <span class="n">a</span><span class="p">.</span><span class="n">zout_start</span><span class="p">);</span>
   <span class="k">else</span>
      <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">STBIDEF</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">stbi_zlib_decode_noheader_malloc</span><span class="p">(</span><span class="kt">char</span> <span class="k">const</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">outlen</span><span class="p">)</span>
<span class="p">{</span>
   <span class="n">stbi__zbuf</span> <span class="n">a</span><span class="p">;</span>
   <span class="kt">char</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">stbi__malloc</span><span class="p">(</span><span class="mi">16384</span><span class="p">);</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
   <span class="n">a</span><span class="p">.</span><span class="n">zbuffer</span> <span class="o">=</span> <span class="p">(</span><span class="n">stbi_uc</span> <span class="o">*</span><span class="p">)</span> <span class="n">buffer</span><span class="p">;</span>
   <span class="n">a</span><span class="p">.</span><span class="n">zbuffer_end</span> <span class="o">=</span> <span class="p">(</span><span class="n">stbi_uc</span> <span class="o">*</span><span class="p">)</span> <span class="n">buffer</span><span class="o">+</span><span class="n">len</span><span class="p">;</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">stbi__do_zlib</span><span class="p">(</span><span class="o">&amp;</span><span class="n">a</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="mi">16384</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">outlen</span><span class="p">)</span> <span class="o">*</span><span class="n">outlen</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">zout</span> <span class="o">-</span> <span class="n">a</span><span class="p">.</span><span class="n">zout_start</span><span class="p">);</span>
      <span class="k">return</span> <span class="n">a</span><span class="p">.</span><span class="n">zout_start</span><span class="p">;</span>
   <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="n">STBI_FREE</span><span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">zout_start</span><span class="p">);</span>
      <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
   <span class="p">}</span>
<span class="p">}</span>

<span class="n">STBIDEF</span> <span class="kt">int</span> <span class="nf">stbi_zlib_decode_noheader_buffer</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">obuffer</span><span class="p">,</span> <span class="kt">int</span> <span class="n">olen</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ibuffer</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ilen</span><span class="p">)</span>
<span class="p">{</span>
   <span class="n">stbi__zbuf</span> <span class="n">a</span><span class="p">;</span>
   <span class="n">a</span><span class="p">.</span><span class="n">zbuffer</span> <span class="o">=</span> <span class="p">(</span><span class="n">stbi_uc</span> <span class="o">*</span><span class="p">)</span> <span class="n">ibuffer</span><span class="p">;</span>
   <span class="n">a</span><span class="p">.</span><span class="n">zbuffer_end</span> <span class="o">=</span> <span class="p">(</span><span class="n">stbi_uc</span> <span class="o">*</span><span class="p">)</span> <span class="n">ibuffer</span> <span class="o">+</span> <span class="n">ilen</span><span class="p">;</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">stbi__do_zlib</span><span class="p">(</span><span class="o">&amp;</span><span class="n">a</span><span class="p">,</span> <span class="n">obuffer</span><span class="p">,</span> <span class="n">olen</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
      <span class="k">return</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">zout</span> <span class="o">-</span> <span class="n">a</span><span class="p">.</span><span class="n">zout_start</span><span class="p">);</span>
   <span class="k">else</span>
      <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-108'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-108'>#</a>
      </div>
      <p>public domain "baseline" PNG decoder   v0.10  Sean Barrett 2006-11-18
   simple implementation
     - only 8-bit samples
     - no CRC checking
     - allocates lots of intermediate memory
       - avoids problem of streaming data between subsystems
       - avoids explicit window management
   performance
     - uses stb_zlib, a PD zlib implementation with fast huffman decoding</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="cp">#ifndef STBI_NO_PNG</span>
<span class="k">typedef</span> <span class="k">struct</span>
<span class="p">{</span>
   <span class="n">stbi__uint32</span> <span class="n">length</span><span class="p">;</span>
   <span class="n">stbi__uint32</span> <span class="n">type</span><span class="p">;</span>
<span class="p">}</span> <span class="n">stbi__pngchunk</span><span class="p">;</span>

<span class="k">static</span> <span class="n">stbi__pngchunk</span> <span class="nf">stbi__get_chunk_header</span><span class="p">(</span><span class="n">stbi__context</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
   <span class="n">stbi__pngchunk</span> <span class="n">c</span><span class="p">;</span>
   <span class="n">c</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">stbi__get32be</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
   <span class="n">c</span><span class="p">.</span><span class="n">type</span>   <span class="o">=</span> <span class="n">stbi__get32be</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
   <span class="k">return</span> <span class="n">c</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">stbi__check_png_header</span><span class="p">(</span><span class="n">stbi__context</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
   <span class="k">static</span> <span class="n">stbi_uc</span> <span class="n">png_sig</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">137</span><span class="p">,</span><span class="mi">80</span><span class="p">,</span><span class="mi">78</span><span class="p">,</span><span class="mi">71</span><span class="p">,</span><span class="mi">13</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">26</span><span class="p">,</span><span class="mi">10</span> <span class="p">};</span>
   <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
   <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">stbi__get8</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">!=</span> <span class="n">png_sig</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">return</span> <span class="n">stbi__err</span><span class="p">(</span><span class="s">&quot;bad png sig&quot;</span><span class="p">,</span><span class="s">&quot;Not a PNG&quot;</span><span class="p">);</span>
   <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">typedef</span> <span class="k">struct</span>
<span class="p">{</span>
   <span class="n">stbi__context</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>
   <span class="n">stbi_uc</span> <span class="o">*</span><span class="n">idata</span><span class="p">,</span> <span class="o">*</span><span class="n">expanded</span><span class="p">,</span> <span class="o">*</span><span class="n">out</span><span class="p">;</span>
   <span class="kt">int</span> <span class="n">depth</span><span class="p">;</span>
<span class="p">}</span> <span class="n">stbi__png</span><span class="p">;</span>


<span class="k">enum</span> <span class="p">{</span>
   <span class="n">STBI__F_none</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
   <span class="n">STBI__F_sub</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
   <span class="n">STBI__F_up</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
   <span class="n">STBI__F_avg</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
   <span class="n">STBI__F_paeth</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-109'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-109'>#</a>
      </div>
      <p>synthetic filters used for first scanline to avoid needing a dummy row of 0s</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>   <span class="n">STBI__F_avg_first</span><span class="p">,</span>
   <span class="n">STBI__F_paeth_first</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">stbi_uc</span> <span class="n">first_row_filter</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span>
<span class="p">{</span>
   <span class="n">STBI__F_none</span><span class="p">,</span>
   <span class="n">STBI__F_sub</span><span class="p">,</span>
   <span class="n">STBI__F_none</span><span class="p">,</span>
   <span class="n">STBI__F_avg_first</span><span class="p">,</span>
   <span class="n">STBI__F_paeth_first</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">stbi__paeth</span><span class="p">(</span><span class="kt">int</span> <span class="n">a</span><span class="p">,</span> <span class="kt">int</span> <span class="n">b</span><span class="p">,</span> <span class="kt">int</span> <span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
   <span class="kt">int</span> <span class="n">p</span> <span class="o">=</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span> <span class="o">-</span> <span class="n">c</span><span class="p">;</span>
   <span class="kt">int</span> <span class="n">pa</span> <span class="o">=</span> <span class="n">abs</span><span class="p">(</span><span class="n">p</span><span class="o">-</span><span class="n">a</span><span class="p">);</span>
   <span class="kt">int</span> <span class="n">pb</span> <span class="o">=</span> <span class="n">abs</span><span class="p">(</span><span class="n">p</span><span class="o">-</span><span class="n">b</span><span class="p">);</span>
   <span class="kt">int</span> <span class="n">pc</span> <span class="o">=</span> <span class="n">abs</span><span class="p">(</span><span class="n">p</span><span class="o">-</span><span class="n">c</span><span class="p">);</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">pa</span> <span class="o">&lt;=</span> <span class="n">pb</span> <span class="o">&amp;&amp;</span> <span class="n">pa</span> <span class="o">&lt;=</span> <span class="n">pc</span><span class="p">)</span> <span class="k">return</span> <span class="n">a</span><span class="p">;</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">pb</span> <span class="o">&lt;=</span> <span class="n">pc</span><span class="p">)</span> <span class="k">return</span> <span class="n">b</span><span class="p">;</span>
   <span class="k">return</span> <span class="n">c</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">stbi_uc</span> <span class="n">stbi__depth_scale_table</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x01</span> <span class="p">};</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-110'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-110'>#</a>
      </div>
      <p>create the png data from post-deflated data</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">static</span> <span class="kt">int</span> <span class="nf">stbi__create_png_image_raw</span><span class="p">(</span><span class="n">stbi__png</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="n">stbi_uc</span> <span class="o">*</span><span class="n">raw</span><span class="p">,</span> <span class="n">stbi__uint32</span> <span class="n">raw_len</span><span class="p">,</span> <span class="kt">int</span> <span class="n">out_n</span><span class="p">,</span> <span class="n">stbi__uint32</span> <span class="n">x</span><span class="p">,</span> <span class="n">stbi__uint32</span> <span class="n">y</span><span class="p">,</span> <span class="kt">int</span> <span class="n">depth</span><span class="p">,</span> <span class="kt">int</span> <span class="n">color</span><span class="p">)</span>
<span class="p">{</span>
   <span class="kt">int</span> <span class="n">bytes</span> <span class="o">=</span> <span class="p">(</span><span class="n">depth</span> <span class="o">==</span> <span class="mi">16</span><span class="o">?</span> <span class="mi">2</span> <span class="o">:</span> <span class="mi">1</span><span class="p">);</span>
   <span class="n">stbi__context</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">s</span><span class="p">;</span>
   <span class="n">stbi__uint32</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">stride</span> <span class="o">=</span> <span class="n">x</span><span class="o">*</span><span class="n">out_n</span><span class="o">*</span><span class="n">bytes</span><span class="p">;</span>
   <span class="n">stbi__uint32</span> <span class="n">img_len</span><span class="p">,</span> <span class="n">img_width_bytes</span><span class="p">;</span>
   <span class="kt">int</span> <span class="n">k</span><span class="p">;</span>
   <span class="kt">int</span> <span class="n">img_n</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">img_n</span><span class="p">;</span> <span class="c1">// copy it into a local for later</span>

   <span class="kt">int</span> <span class="n">output_bytes</span> <span class="o">=</span> <span class="n">out_n</span><span class="o">*</span><span class="n">bytes</span><span class="p">;</span>
   <span class="kt">int</span> <span class="n">filter_bytes</span> <span class="o">=</span> <span class="n">img_n</span><span class="o">*</span><span class="n">bytes</span><span class="p">;</span>
   <span class="kt">int</span> <span class="n">width</span> <span class="o">=</span> <span class="n">x</span><span class="p">;</span>

   <span class="n">STBI_ASSERT</span><span class="p">(</span><span class="n">out_n</span> <span class="o">==</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">img_n</span> <span class="o">||</span> <span class="n">out_n</span> <span class="o">==</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">img_n</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
   <span class="n">a</span><span class="o">-&gt;</span><span class="n">out</span> <span class="o">=</span> <span class="p">(</span><span class="n">stbi_uc</span> <span class="o">*</span><span class="p">)</span> <span class="n">stbi__malloc</span><span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="n">y</span> <span class="o">*</span> <span class="n">output_bytes</span><span class="p">);</span> <span class="c1">// extra bytes to write off the end into</span>
   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">)</span> <span class="k">return</span> <span class="n">stbi__err</span><span class="p">(</span><span class="s">&quot;outofmem&quot;</span><span class="p">,</span> <span class="s">&quot;Out of memory&quot;</span><span class="p">);</span>

   <span class="n">img_width_bytes</span> <span class="o">=</span> <span class="p">(((</span><span class="n">img_n</span> <span class="o">*</span> <span class="n">x</span> <span class="o">*</span> <span class="n">depth</span><span class="p">)</span> <span class="o">+</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">);</span>
   <span class="n">img_len</span> <span class="o">=</span> <span class="p">(</span><span class="n">img_width_bytes</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">y</span><span class="p">;</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">img_x</span> <span class="o">==</span> <span class="n">x</span> <span class="o">&amp;&amp;</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">img_y</span> <span class="o">==</span> <span class="n">y</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">raw_len</span> <span class="o">!=</span> <span class="n">img_len</span><span class="p">)</span> <span class="k">return</span> <span class="n">stbi__err</span><span class="p">(</span><span class="s">&quot;not enough pixels&quot;</span><span class="p">,</span><span class="s">&quot;Corrupt PNG&quot;</span><span class="p">);</span>
   <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="c1">// interlaced:</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">raw_len</span> <span class="o">&lt;</span> <span class="n">img_len</span><span class="p">)</span> <span class="k">return</span> <span class="n">stbi__err</span><span class="p">(</span><span class="s">&quot;not enough pixels&quot;</span><span class="p">,</span><span class="s">&quot;Corrupt PNG&quot;</span><span class="p">);</span>
   <span class="p">}</span>

   <span class="k">for</span> <span class="p">(</span><span class="n">j</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">y</span><span class="p">;</span> <span class="o">++</span><span class="n">j</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">stbi_uc</span> <span class="o">*</span><span class="n">cur</span> <span class="o">=</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">out</span> <span class="o">+</span> <span class="n">stride</span><span class="o">*</span><span class="n">j</span><span class="p">;</span>
      <span class="n">stbi_uc</span> <span class="o">*</span><span class="n">prior</span> <span class="o">=</span> <span class="n">cur</span> <span class="o">-</span> <span class="n">stride</span><span class="p">;</span>
      <span class="kt">int</span> <span class="n">filter</span> <span class="o">=</span> <span class="o">*</span><span class="n">raw</span><span class="o">++</span><span class="p">;</span>

      <span class="k">if</span> <span class="p">(</span><span class="n">filter</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">)</span>
         <span class="k">return</span> <span class="n">stbi__err</span><span class="p">(</span><span class="s">&quot;invalid filter&quot;</span><span class="p">,</span><span class="s">&quot;Corrupt PNG&quot;</span><span class="p">);</span>

      <span class="k">if</span> <span class="p">(</span><span class="n">depth</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
         <span class="n">STBI_ASSERT</span><span class="p">(</span><span class="n">img_width_bytes</span> <span class="o">&lt;=</span> <span class="n">x</span><span class="p">);</span>
         <span class="n">cur</span> <span class="o">+=</span> <span class="n">x</span><span class="o">*</span><span class="n">out_n</span> <span class="o">-</span> <span class="n">img_width_bytes</span><span class="p">;</span> <span class="c1">// store output to the rightmost img_len bytes, so we can decode in place</span>
         <span class="n">filter_bytes</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
         <span class="n">width</span> <span class="o">=</span> <span class="n">img_width_bytes</span><span class="p">;</span>
      <span class="p">}</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-111'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-111'>#</a>
      </div>
      <p>if first row, use special filter that doesn't sample previous row</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>      <span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="n">filter</span> <span class="o">=</span> <span class="n">first_row_filter</span><span class="p">[</span><span class="n">filter</span><span class="p">];</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-112'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-112'>#</a>
      </div>
      <p>handle first byte explicitly</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>      <span class="k">for</span> <span class="p">(</span><span class="n">k</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">filter_bytes</span><span class="p">;</span> <span class="o">++</span><span class="n">k</span><span class="p">)</span> <span class="p">{</span>
         <span class="k">switch</span> <span class="p">(</span><span class="n">filter</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">case</span> <span class="nl">STBI__F_none</span>       <span class="p">:</span> <span class="n">cur</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">raw</span><span class="p">[</span><span class="n">k</span><span class="p">];</span> <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="nl">STBI__F_sub</span>        <span class="p">:</span> <span class="n">cur</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">raw</span><span class="p">[</span><span class="n">k</span><span class="p">];</span> <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="nl">STBI__F_up</span>         <span class="p">:</span> <span class="n">cur</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">STBI__BYTECAST</span><span class="p">(</span><span class="n">raw</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">+</span> <span class="n">prior</span><span class="p">[</span><span class="n">k</span><span class="p">]);</span> <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="nl">STBI__F_avg</span>        <span class="p">:</span> <span class="n">cur</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">STBI__BYTECAST</span><span class="p">(</span><span class="n">raw</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">prior</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">&gt;&gt;</span><span class="mi">1</span><span class="p">));</span> <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="nl">STBI__F_paeth</span>      <span class="p">:</span> <span class="n">cur</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">STBI__BYTECAST</span><span class="p">(</span><span class="n">raw</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">+</span> <span class="n">stbi__paeth</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">prior</span><span class="p">[</span><span class="n">k</span><span class="p">],</span><span class="mi">0</span><span class="p">));</span> <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="nl">STBI__F_avg_first</span>  <span class="p">:</span> <span class="n">cur</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">raw</span><span class="p">[</span><span class="n">k</span><span class="p">];</span> <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="nl">STBI__F_paeth_first</span><span class="p">:</span> <span class="n">cur</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">raw</span><span class="p">[</span><span class="n">k</span><span class="p">];</span> <span class="k">break</span><span class="p">;</span>
         <span class="p">}</span>
      <span class="p">}</span>

      <span class="k">if</span> <span class="p">(</span><span class="n">depth</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
         <span class="k">if</span> <span class="p">(</span><span class="n">img_n</span> <span class="o">!=</span> <span class="n">out_n</span><span class="p">)</span>
            <span class="n">cur</span><span class="p">[</span><span class="n">img_n</span><span class="p">]</span> <span class="o">=</span> <span class="mi">255</span><span class="p">;</span> <span class="c1">// first pixel</span>
         <span class="n">raw</span> <span class="o">+=</span> <span class="n">img_n</span><span class="p">;</span>
         <span class="n">cur</span> <span class="o">+=</span> <span class="n">out_n</span><span class="p">;</span>
         <span class="n">prior</span> <span class="o">+=</span> <span class="n">out_n</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">depth</span> <span class="o">==</span> <span class="mi">16</span><span class="p">)</span> <span class="p">{</span>
         <span class="k">if</span> <span class="p">(</span><span class="n">img_n</span> <span class="o">!=</span> <span class="n">out_n</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">cur</span><span class="p">[</span><span class="n">filter_bytes</span><span class="p">]</span>   <span class="o">=</span> <span class="mi">255</span><span class="p">;</span> <span class="c1">// first pixel top byte</span>
            <span class="n">cur</span><span class="p">[</span><span class="n">filter_bytes</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">255</span><span class="p">;</span> <span class="c1">// first pixel bottom byte</span>
         <span class="p">}</span>
         <span class="n">raw</span> <span class="o">+=</span> <span class="n">filter_bytes</span><span class="p">;</span>
         <span class="n">cur</span> <span class="o">+=</span> <span class="n">output_bytes</span><span class="p">;</span>
         <span class="n">prior</span> <span class="o">+=</span> <span class="n">output_bytes</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
         <span class="n">raw</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
         <span class="n">cur</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
         <span class="n">prior</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
      <span class="p">}</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-113'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-113'>#</a>
      </div>
      <p>this is a little gross, so that we don't switch per-pixel or per-component</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>      <span class="k">if</span> <span class="p">(</span><span class="n">depth</span> <span class="o">&lt;</span> <span class="mi">8</span> <span class="o">||</span> <span class="n">img_n</span> <span class="o">==</span> <span class="n">out_n</span><span class="p">)</span> <span class="p">{</span>
         <span class="kt">int</span> <span class="n">nk</span> <span class="o">=</span> <span class="p">(</span><span class="n">width</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">filter_bytes</span><span class="p">;</span>
         <span class="cp">#define CASE(f) \</span>
<span class="cp">             case f:     \</span>
<span class="cp">                for (k=0; k &lt; nk; ++k)</span>
         <span class="k">switch</span> <span class="p">(</span><span class="n">filter</span><span class="p">)</span> <span class="p">{</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-114'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-114'>#</a>
      </div>
      <p>"none" filter turns into a memcpy here; make that explicit.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="k">case</span> <span class="nl">STBI__F_none</span><span class="p">:</span>         <span class="n">memcpy</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">raw</span><span class="p">,</span> <span class="n">nk</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
            <span class="n">CASE</span><span class="p">(</span><span class="n">STBI__F_sub</span><span class="p">)</span>          <span class="n">cur</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">STBI__BYTECAST</span><span class="p">(</span><span class="n">raw</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">+</span> <span class="n">cur</span><span class="p">[</span><span class="n">k</span><span class="o">-</span><span class="n">filter_bytes</span><span class="p">]);</span> <span class="k">break</span><span class="p">;</span>
            <span class="n">CASE</span><span class="p">(</span><span class="n">STBI__F_up</span><span class="p">)</span>           <span class="n">cur</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">STBI__BYTECAST</span><span class="p">(</span><span class="n">raw</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">+</span> <span class="n">prior</span><span class="p">[</span><span class="n">k</span><span class="p">]);</span> <span class="k">break</span><span class="p">;</span>
            <span class="n">CASE</span><span class="p">(</span><span class="n">STBI__F_avg</span><span class="p">)</span>          <span class="n">cur</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">STBI__BYTECAST</span><span class="p">(</span><span class="n">raw</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">+</span> <span class="p">((</span><span class="n">prior</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">+</span> <span class="n">cur</span><span class="p">[</span><span class="n">k</span><span class="o">-</span><span class="n">filter_bytes</span><span class="p">])</span><span class="o">&gt;&gt;</span><span class="mi">1</span><span class="p">));</span> <span class="k">break</span><span class="p">;</span>
            <span class="n">CASE</span><span class="p">(</span><span class="n">STBI__F_paeth</span><span class="p">)</span>        <span class="n">cur</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">STBI__BYTECAST</span><span class="p">(</span><span class="n">raw</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">+</span> <span class="n">stbi__paeth</span><span class="p">(</span><span class="n">cur</span><span class="p">[</span><span class="n">k</span><span class="o">-</span><span class="n">filter_bytes</span><span class="p">],</span><span class="n">prior</span><span class="p">[</span><span class="n">k</span><span class="p">],</span><span class="n">prior</span><span class="p">[</span><span class="n">k</span><span class="o">-</span><span class="n">filter_bytes</span><span class="p">]));</span> <span class="k">break</span><span class="p">;</span>
            <span class="n">CASE</span><span class="p">(</span><span class="n">STBI__F_avg_first</span><span class="p">)</span>    <span class="n">cur</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">STBI__BYTECAST</span><span class="p">(</span><span class="n">raw</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">cur</span><span class="p">[</span><span class="n">k</span><span class="o">-</span><span class="n">filter_bytes</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">));</span> <span class="k">break</span><span class="p">;</span>
            <span class="n">CASE</span><span class="p">(</span><span class="n">STBI__F_paeth_first</span><span class="p">)</span>  <span class="n">cur</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">STBI__BYTECAST</span><span class="p">(</span><span class="n">raw</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">+</span> <span class="n">stbi__paeth</span><span class="p">(</span><span class="n">cur</span><span class="p">[</span><span class="n">k</span><span class="o">-</span><span class="n">filter_bytes</span><span class="p">],</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">));</span> <span class="k">break</span><span class="p">;</span>
         <span class="p">}</span>
         <span class="cp">#undef CASE</span>
         <span class="n">raw</span> <span class="o">+=</span> <span class="n">nk</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
         <span class="n">STBI_ASSERT</span><span class="p">(</span><span class="n">img_n</span><span class="o">+</span><span class="mi">1</span> <span class="o">==</span> <span class="n">out_n</span><span class="p">);</span>
         <span class="cp">#define CASE(f) \</span>
<span class="cp">             case f:     \</span>
<span class="cp">                for (i=x-1; i &gt;= 1; --i, cur[filter_bytes]=255,raw+=filter_bytes,cur+=output_bytes,prior+=output_bytes) \</span>
<span class="cp">                   for (k=0; k &lt; filter_bytes; ++k)</span>
         <span class="k">switch</span> <span class="p">(</span><span class="n">filter</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">CASE</span><span class="p">(</span><span class="n">STBI__F_none</span><span class="p">)</span>         <span class="n">cur</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">raw</span><span class="p">[</span><span class="n">k</span><span class="p">];</span> <span class="k">break</span><span class="p">;</span>
            <span class="n">CASE</span><span class="p">(</span><span class="n">STBI__F_sub</span><span class="p">)</span>          <span class="n">cur</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">STBI__BYTECAST</span><span class="p">(</span><span class="n">raw</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">+</span> <span class="n">cur</span><span class="p">[</span><span class="n">k</span><span class="o">-</span> <span class="n">output_bytes</span><span class="p">]);</span> <span class="k">break</span><span class="p">;</span>
            <span class="n">CASE</span><span class="p">(</span><span class="n">STBI__F_up</span><span class="p">)</span>           <span class="n">cur</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">STBI__BYTECAST</span><span class="p">(</span><span class="n">raw</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">+</span> <span class="n">prior</span><span class="p">[</span><span class="n">k</span><span class="p">]);</span> <span class="k">break</span><span class="p">;</span>
            <span class="n">CASE</span><span class="p">(</span><span class="n">STBI__F_avg</span><span class="p">)</span>          <span class="n">cur</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">STBI__BYTECAST</span><span class="p">(</span><span class="n">raw</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">+</span> <span class="p">((</span><span class="n">prior</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">+</span> <span class="n">cur</span><span class="p">[</span><span class="n">k</span><span class="o">-</span> <span class="n">output_bytes</span><span class="p">])</span><span class="o">&gt;&gt;</span><span class="mi">1</span><span class="p">));</span> <span class="k">break</span><span class="p">;</span>
            <span class="n">CASE</span><span class="p">(</span><span class="n">STBI__F_paeth</span><span class="p">)</span>        <span class="n">cur</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">STBI__BYTECAST</span><span class="p">(</span><span class="n">raw</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">+</span> <span class="n">stbi__paeth</span><span class="p">(</span><span class="n">cur</span><span class="p">[</span><span class="n">k</span><span class="o">-</span> <span class="n">output_bytes</span><span class="p">],</span><span class="n">prior</span><span class="p">[</span><span class="n">k</span><span class="p">],</span><span class="n">prior</span><span class="p">[</span><span class="n">k</span><span class="o">-</span> <span class="n">output_bytes</span><span class="p">]));</span> <span class="k">break</span><span class="p">;</span>
            <span class="n">CASE</span><span class="p">(</span><span class="n">STBI__F_avg_first</span><span class="p">)</span>    <span class="n">cur</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">STBI__BYTECAST</span><span class="p">(</span><span class="n">raw</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">cur</span><span class="p">[</span><span class="n">k</span><span class="o">-</span> <span class="n">output_bytes</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">));</span> <span class="k">break</span><span class="p">;</span>
            <span class="n">CASE</span><span class="p">(</span><span class="n">STBI__F_paeth_first</span><span class="p">)</span>  <span class="n">cur</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">STBI__BYTECAST</span><span class="p">(</span><span class="n">raw</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">+</span> <span class="n">stbi__paeth</span><span class="p">(</span><span class="n">cur</span><span class="p">[</span><span class="n">k</span><span class="o">-</span> <span class="n">output_bytes</span><span class="p">],</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">));</span> <span class="k">break</span><span class="p">;</span>
         <span class="p">}</span>
         <span class="cp">#undef CASE</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-115'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-115'>#</a>
      </div>
      <p>the loop above sets the high byte of the pixels' alpha, but for
16 bit png files we also need the low byte set. we'll do that here.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>         <span class="k">if</span> <span class="p">(</span><span class="n">depth</span> <span class="o">==</span> <span class="mi">16</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">cur</span> <span class="o">=</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">out</span> <span class="o">+</span> <span class="n">stride</span><span class="o">*</span><span class="n">j</span><span class="p">;</span> <span class="c1">// start at the beginning of the row again</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">x</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">,</span><span class="n">cur</span><span class="o">+=</span><span class="n">output_bytes</span><span class="p">)</span> <span class="p">{</span>
               <span class="n">cur</span><span class="p">[</span><span class="n">filter_bytes</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">255</span><span class="p">;</span>
            <span class="p">}</span>
         <span class="p">}</span>
      <span class="p">}</span>
   <span class="p">}</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-116'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-116'>#</a>
      </div>
      <p>we make a separate pass to expand bits to pixels; for performance,
this could run two scanlines behind the above code, so it won't
intefere with filtering but will still be in the cache.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>   <span class="k">if</span> <span class="p">(</span><span class="n">depth</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">for</span> <span class="p">(</span><span class="n">j</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">y</span><span class="p">;</span> <span class="o">++</span><span class="n">j</span><span class="p">)</span> <span class="p">{</span>
         <span class="n">stbi_uc</span> <span class="o">*</span><span class="n">cur</span> <span class="o">=</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">out</span> <span class="o">+</span> <span class="n">stride</span><span class="o">*</span><span class="n">j</span><span class="p">;</span>
         <span class="n">stbi_uc</span> <span class="o">*</span><span class="n">in</span>  <span class="o">=</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">out</span> <span class="o">+</span> <span class="n">stride</span><span class="o">*</span><span class="n">j</span> <span class="o">+</span> <span class="n">x</span><span class="o">*</span><span class="n">out_n</span> <span class="o">-</span> <span class="n">img_width_bytes</span><span class="p">;</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-117'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-117'>#</a>
      </div>
      <p>unpack 1/2/4-bit into a 8-bit buffer. allows us to keep the common 8-bit path optimal at minimal cost for 1/2/4-bit
png guarante byte alignment, if width is not multiple of 8/4/2 we'll decode dummy trailing data that will be skipped in the later loop</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>         <span class="n">stbi_uc</span> <span class="n">scale</span> <span class="o">=</span> <span class="p">(</span><span class="n">color</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="n">stbi__depth_scale_table</span><span class="p">[</span><span class="n">depth</span><span class="p">]</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span> <span class="c1">// scale grayscale values to 0..255 range</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-118'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-118'>#</a>
      </div>
      <p>note that the final byte might overshoot and write more data than desired.
we can allocate enough data that this never writes out of memory, but it
could also overwrite the next scanline. can it overwrite non-empty data
on the next scanline? yes, consider 1-pixel-wide scanlines with 1-bit-per-pixel.
so we need to explicitly clamp the final ones</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>         <span class="k">if</span> <span class="p">(</span><span class="n">depth</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">k</span><span class="o">=</span><span class="n">x</span><span class="o">*</span><span class="n">img_n</span><span class="p">;</span> <span class="n">k</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">;</span> <span class="n">k</span><span class="o">-=</span><span class="mi">2</span><span class="p">,</span> <span class="o">++</span><span class="n">in</span><span class="p">)</span> <span class="p">{</span>
               <span class="o">*</span><span class="n">cur</span><span class="o">++</span> <span class="o">=</span> <span class="n">scale</span> <span class="o">*</span> <span class="p">((</span><span class="o">*</span><span class="n">in</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span>       <span class="p">);</span>
               <span class="o">*</span><span class="n">cur</span><span class="o">++</span> <span class="o">=</span> <span class="n">scale</span> <span class="o">*</span> <span class="p">((</span><span class="o">*</span><span class="n">in</span>     <span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">k</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">*</span><span class="n">cur</span><span class="o">++</span> <span class="o">=</span> <span class="n">scale</span> <span class="o">*</span> <span class="p">((</span><span class="o">*</span><span class="n">in</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span>       <span class="p">);</span>
         <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">depth</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">k</span><span class="o">=</span><span class="n">x</span><span class="o">*</span><span class="n">img_n</span><span class="p">;</span> <span class="n">k</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">;</span> <span class="n">k</span><span class="o">-=</span><span class="mi">4</span><span class="p">,</span> <span class="o">++</span><span class="n">in</span><span class="p">)</span> <span class="p">{</span>
               <span class="o">*</span><span class="n">cur</span><span class="o">++</span> <span class="o">=</span> <span class="n">scale</span> <span class="o">*</span> <span class="p">((</span><span class="o">*</span><span class="n">in</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">)</span>       <span class="p">);</span>
               <span class="o">*</span><span class="n">cur</span><span class="o">++</span> <span class="o">=</span> <span class="n">scale</span> <span class="o">*</span> <span class="p">((</span><span class="o">*</span><span class="n">in</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">);</span>
               <span class="o">*</span><span class="n">cur</span><span class="o">++</span> <span class="o">=</span> <span class="n">scale</span> <span class="o">*</span> <span class="p">((</span><span class="o">*</span><span class="n">in</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">);</span>
               <span class="o">*</span><span class="n">cur</span><span class="o">++</span> <span class="o">=</span> <span class="n">scale</span> <span class="o">*</span> <span class="p">((</span><span class="o">*</span><span class="n">in</span>     <span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">k</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">*</span><span class="n">cur</span><span class="o">++</span> <span class="o">=</span> <span class="n">scale</span> <span class="o">*</span> <span class="p">((</span><span class="o">*</span><span class="n">in</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">)</span>       <span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">k</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span><span class="n">cur</span><span class="o">++</span> <span class="o">=</span> <span class="n">scale</span> <span class="o">*</span> <span class="p">((</span><span class="o">*</span><span class="n">in</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">k</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span><span class="n">cur</span><span class="o">++</span> <span class="o">=</span> <span class="n">scale</span> <span class="o">*</span> <span class="p">((</span><span class="o">*</span><span class="n">in</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">);</span>
         <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">depth</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">k</span><span class="o">=</span><span class="n">x</span><span class="o">*</span><span class="n">img_n</span><span class="p">;</span> <span class="n">k</span> <span class="o">&gt;=</span> <span class="mi">8</span><span class="p">;</span> <span class="n">k</span><span class="o">-=</span><span class="mi">8</span><span class="p">,</span> <span class="o">++</span><span class="n">in</span><span class="p">)</span> <span class="p">{</span>
               <span class="o">*</span><span class="n">cur</span><span class="o">++</span> <span class="o">=</span> <span class="n">scale</span> <span class="o">*</span> <span class="p">((</span><span class="o">*</span><span class="n">in</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">)</span>       <span class="p">);</span>
               <span class="o">*</span><span class="n">cur</span><span class="o">++</span> <span class="o">=</span> <span class="n">scale</span> <span class="o">*</span> <span class="p">((</span><span class="o">*</span><span class="n">in</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">);</span>
               <span class="o">*</span><span class="n">cur</span><span class="o">++</span> <span class="o">=</span> <span class="n">scale</span> <span class="o">*</span> <span class="p">((</span><span class="o">*</span><span class="n">in</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">);</span>
               <span class="o">*</span><span class="n">cur</span><span class="o">++</span> <span class="o">=</span> <span class="n">scale</span> <span class="o">*</span> <span class="p">((</span><span class="o">*</span><span class="n">in</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">);</span>
               <span class="o">*</span><span class="n">cur</span><span class="o">++</span> <span class="o">=</span> <span class="n">scale</span> <span class="o">*</span> <span class="p">((</span><span class="o">*</span><span class="n">in</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">);</span>
               <span class="o">*</span><span class="n">cur</span><span class="o">++</span> <span class="o">=</span> <span class="n">scale</span> <span class="o">*</span> <span class="p">((</span><span class="o">*</span><span class="n">in</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">);</span>
               <span class="o">*</span><span class="n">cur</span><span class="o">++</span> <span class="o">=</span> <span class="n">scale</span> <span class="o">*</span> <span class="p">((</span><span class="o">*</span><span class="n">in</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">);</span>
               <span class="o">*</span><span class="n">cur</span><span class="o">++</span> <span class="o">=</span> <span class="n">scale</span> <span class="o">*</span> <span class="p">((</span><span class="o">*</span><span class="n">in</span>     <span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">k</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">*</span><span class="n">cur</span><span class="o">++</span> <span class="o">=</span> <span class="n">scale</span> <span class="o">*</span> <span class="p">((</span><span class="o">*</span><span class="n">in</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">)</span>       <span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">k</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span><span class="n">cur</span><span class="o">++</span> <span class="o">=</span> <span class="n">scale</span> <span class="o">*</span> <span class="p">((</span><span class="o">*</span><span class="n">in</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">k</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span><span class="n">cur</span><span class="o">++</span> <span class="o">=</span> <span class="n">scale</span> <span class="o">*</span> <span class="p">((</span><span class="o">*</span><span class="n">in</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">k</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">*</span><span class="n">cur</span><span class="o">++</span> <span class="o">=</span> <span class="n">scale</span> <span class="o">*</span> <span class="p">((</span><span class="o">*</span><span class="n">in</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">k</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">*</span><span class="n">cur</span><span class="o">++</span> <span class="o">=</span> <span class="n">scale</span> <span class="o">*</span> <span class="p">((</span><span class="o">*</span><span class="n">in</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">k</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">*</span><span class="n">cur</span><span class="o">++</span> <span class="o">=</span> <span class="n">scale</span> <span class="o">*</span> <span class="p">((</span><span class="o">*</span><span class="n">in</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">k</span> <span class="o">&gt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">*</span><span class="n">cur</span><span class="o">++</span> <span class="o">=</span> <span class="n">scale</span> <span class="o">*</span> <span class="p">((</span><span class="o">*</span><span class="n">in</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">);</span>
         <span class="p">}</span>
         <span class="k">if</span> <span class="p">(</span><span class="n">img_n</span> <span class="o">!=</span> <span class="n">out_n</span><span class="p">)</span> <span class="p">{</span>
            <span class="kt">int</span> <span class="n">q</span><span class="p">;</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-119'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-119'>#</a>
      </div>
      <p>insert alpha = 255</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="n">cur</span> <span class="o">=</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">out</span> <span class="o">+</span> <span class="n">stride</span><span class="o">*</span><span class="n">j</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">img_n</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
               <span class="k">for</span> <span class="p">(</span><span class="n">q</span><span class="o">=</span><span class="n">x</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="n">q</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="o">--</span><span class="n">q</span><span class="p">)</span> <span class="p">{</span>
                  <span class="n">cur</span><span class="p">[</span><span class="n">q</span><span class="o">*</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">255</span><span class="p">;</span>
                  <span class="n">cur</span><span class="p">[</span><span class="n">q</span><span class="o">*</span><span class="mi">2</span><span class="o">+</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cur</span><span class="p">[</span><span class="n">q</span><span class="p">];</span>
               <span class="p">}</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
               <span class="n">STBI_ASSERT</span><span class="p">(</span><span class="n">img_n</span> <span class="o">==</span> <span class="mi">3</span><span class="p">);</span>
               <span class="k">for</span> <span class="p">(</span><span class="n">q</span><span class="o">=</span><span class="n">x</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="n">q</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="o">--</span><span class="n">q</span><span class="p">)</span> <span class="p">{</span>
                  <span class="n">cur</span><span class="p">[</span><span class="n">q</span><span class="o">*</span><span class="mi">4</span><span class="o">+</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">255</span><span class="p">;</span>
                  <span class="n">cur</span><span class="p">[</span><span class="n">q</span><span class="o">*</span><span class="mi">4</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">cur</span><span class="p">[</span><span class="n">q</span><span class="o">*</span><span class="mi">3</span><span class="o">+</span><span class="mi">2</span><span class="p">];</span>
                  <span class="n">cur</span><span class="p">[</span><span class="n">q</span><span class="o">*</span><span class="mi">4</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cur</span><span class="p">[</span><span class="n">q</span><span class="o">*</span><span class="mi">3</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>
                  <span class="n">cur</span><span class="p">[</span><span class="n">q</span><span class="o">*</span><span class="mi">4</span><span class="o">+</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cur</span><span class="p">[</span><span class="n">q</span><span class="o">*</span><span class="mi">3</span><span class="o">+</span><span class="mi">0</span><span class="p">];</span>
               <span class="p">}</span>
            <span class="p">}</span>
         <span class="p">}</span>
      <span class="p">}</span>
   <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">depth</span> <span class="o">==</span> <span class="mi">16</span><span class="p">)</span> <span class="p">{</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-120'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-120'>#</a>
      </div>
      <p>force the image data from big-endian to platform-native.
this is done in a separate pass due to the decoding relying
on the data being untouched, but could probably be done
per-line during decode if care is taken.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>      <span class="n">stbi_uc</span> <span class="o">*</span><span class="n">cur</span> <span class="o">=</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">;</span>
      <span class="n">stbi__uint16</span> <span class="o">*</span><span class="n">cur16</span> <span class="o">=</span> <span class="p">(</span><span class="n">stbi__uint16</span><span class="o">*</span><span class="p">)</span><span class="n">cur</span><span class="p">;</span>

      <span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">x</span><span class="o">*</span><span class="n">y</span><span class="o">*</span><span class="n">out_n</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">,</span><span class="n">cur16</span><span class="o">++</span><span class="p">,</span><span class="n">cur</span><span class="o">+=</span><span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
         <span class="o">*</span><span class="n">cur16</span> <span class="o">=</span> <span class="p">(</span><span class="n">cur</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">cur</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
      <span class="p">}</span>
   <span class="p">}</span>

   <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">stbi__create_png_image</span><span class="p">(</span><span class="n">stbi__png</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="n">stbi_uc</span> <span class="o">*</span><span class="n">image_data</span><span class="p">,</span> <span class="n">stbi__uint32</span> <span class="n">image_data_len</span><span class="p">,</span> <span class="kt">int</span> <span class="n">out_n</span><span class="p">,</span> <span class="kt">int</span> <span class="n">depth</span><span class="p">,</span> <span class="kt">int</span> <span class="n">color</span><span class="p">,</span> <span class="kt">int</span> <span class="n">interlaced</span><span class="p">)</span>
<span class="p">{</span>
   <span class="n">stbi_uc</span> <span class="o">*</span><span class="n">final</span><span class="p">;</span>
   <span class="kt">int</span> <span class="n">p</span><span class="p">;</span>
   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">interlaced</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">stbi__create_png_image_raw</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">image_data</span><span class="p">,</span> <span class="n">image_data_len</span><span class="p">,</span> <span class="n">out_n</span><span class="p">,</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">img_x</span><span class="p">,</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">img_y</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">color</span><span class="p">);</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-121'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-121'>#</a>
      </div>
      <p>de-interlacing</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>   <span class="n">final</span> <span class="o">=</span> <span class="p">(</span><span class="n">stbi_uc</span> <span class="o">*</span><span class="p">)</span> <span class="n">stbi__malloc</span><span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">img_x</span> <span class="o">*</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">img_y</span> <span class="o">*</span> <span class="n">out_n</span><span class="p">);</span>
   <span class="k">for</span> <span class="p">(</span><span class="n">p</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">p</span> <span class="o">&lt;</span> <span class="mi">7</span><span class="p">;</span> <span class="o">++</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
      <span class="kt">int</span> <span class="n">xorig</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span> <span class="p">};</span>
      <span class="kt">int</span> <span class="n">yorig</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span> <span class="p">};</span>
      <span class="kt">int</span> <span class="n">xspc</span><span class="p">[]</span>  <span class="o">=</span> <span class="p">{</span> <span class="mi">8</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span> <span class="p">};</span>
      <span class="kt">int</span> <span class="n">yspc</span><span class="p">[]</span>  <span class="o">=</span> <span class="p">{</span> <span class="mi">8</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span> <span class="p">};</span>
      <span class="kt">int</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">;</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-122'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-122'>#</a>
      </div>
      <p>pass1_x[4] = 0, pass1_x[5] = 1, pass1_x[12] = 1</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>      <span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">img_x</span> <span class="o">-</span> <span class="n">xorig</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">+</span> <span class="n">xspc</span><span class="p">[</span><span class="n">p</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">xspc</span><span class="p">[</span><span class="n">p</span><span class="p">];</span>
      <span class="n">y</span> <span class="o">=</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">img_y</span> <span class="o">-</span> <span class="n">yorig</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">+</span> <span class="n">yspc</span><span class="p">[</span><span class="n">p</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">yspc</span><span class="p">[</span><span class="n">p</span><span class="p">];</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">x</span> <span class="o">&amp;&amp;</span> <span class="n">y</span><span class="p">)</span> <span class="p">{</span>
         <span class="n">stbi__uint32</span> <span class="n">img_len</span> <span class="o">=</span> <span class="p">((((</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">img_n</span> <span class="o">*</span> <span class="n">x</span> <span class="o">*</span> <span class="n">depth</span><span class="p">)</span> <span class="o">+</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">y</span><span class="p">;</span>
         <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">stbi__create_png_image_raw</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">image_data</span><span class="p">,</span> <span class="n">image_data_len</span><span class="p">,</span> <span class="n">out_n</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">color</span><span class="p">))</span> <span class="p">{</span>
            <span class="n">STBI_FREE</span><span class="p">(</span><span class="n">final</span><span class="p">);</span>
            <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
         <span class="p">}</span>
         <span class="k">for</span> <span class="p">(</span><span class="n">j</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">y</span><span class="p">;</span> <span class="o">++</span><span class="n">j</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">x</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
               <span class="kt">int</span> <span class="n">out_y</span> <span class="o">=</span> <span class="n">j</span><span class="o">*</span><span class="n">yspc</span><span class="p">[</span><span class="n">p</span><span class="p">]</span><span class="o">+</span><span class="n">yorig</span><span class="p">[</span><span class="n">p</span><span class="p">];</span>
               <span class="kt">int</span> <span class="n">out_x</span> <span class="o">=</span> <span class="n">i</span><span class="o">*</span><span class="n">xspc</span><span class="p">[</span><span class="n">p</span><span class="p">]</span><span class="o">+</span><span class="n">xorig</span><span class="p">[</span><span class="n">p</span><span class="p">];</span>
               <span class="n">memcpy</span><span class="p">(</span><span class="n">final</span> <span class="o">+</span> <span class="n">out_y</span><span class="o">*</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">img_x</span><span class="o">*</span><span class="n">out_n</span> <span class="o">+</span> <span class="n">out_x</span><span class="o">*</span><span class="n">out_n</span><span class="p">,</span>
                      <span class="n">a</span><span class="o">-&gt;</span><span class="n">out</span> <span class="o">+</span> <span class="p">(</span><span class="n">j</span><span class="o">*</span><span class="n">x</span><span class="o">+</span><span class="n">i</span><span class="p">)</span><span class="o">*</span><span class="n">out_n</span><span class="p">,</span> <span class="n">out_n</span><span class="p">);</span>
            <span class="p">}</span>
         <span class="p">}</span>
         <span class="n">STBI_FREE</span><span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">);</span>
         <span class="n">image_data</span> <span class="o">+=</span> <span class="n">img_len</span><span class="p">;</span>
         <span class="n">image_data_len</span> <span class="o">-=</span> <span class="n">img_len</span><span class="p">;</span>
      <span class="p">}</span>
   <span class="p">}</span>
   <span class="n">a</span><span class="o">-&gt;</span><span class="n">out</span> <span class="o">=</span> <span class="n">final</span><span class="p">;</span>

   <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">stbi__compute_transparency</span><span class="p">(</span><span class="n">stbi__png</span> <span class="o">*</span><span class="n">z</span><span class="p">,</span> <span class="n">stbi_uc</span> <span class="n">tc</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="kt">int</span> <span class="n">out_n</span><span class="p">)</span>
<span class="p">{</span>
   <span class="n">stbi__context</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="n">z</span><span class="o">-&gt;</span><span class="n">s</span><span class="p">;</span>
   <span class="n">stbi__uint32</span> <span class="n">i</span><span class="p">,</span> <span class="n">pixel_count</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">img_x</span> <span class="o">*</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">img_y</span><span class="p">;</span>
   <span class="n">stbi_uc</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">z</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">;</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-123'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-123'>#</a>
      </div>
      <p>compute color-based transparency, assuming we've
already got 255 as the alpha value in the output</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>   <span class="n">STBI_ASSERT</span><span class="p">(</span><span class="n">out_n</span> <span class="o">==</span> <span class="mi">2</span> <span class="o">||</span> <span class="n">out_n</span> <span class="o">==</span> <span class="mi">4</span><span class="p">);</span>

   <span class="k">if</span> <span class="p">(</span><span class="n">out_n</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">pixel_count</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
         <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">tc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">255</span><span class="p">);</span>
         <span class="n">p</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
      <span class="p">}</span>
   <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">pixel_count</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
         <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">tc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">tc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="n">tc</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="n">p</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
         <span class="n">p</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
      <span class="p">}</span>
   <span class="p">}</span>
   <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">stbi__compute_transparency16</span><span class="p">(</span><span class="n">stbi__png</span> <span class="o">*</span><span class="n">z</span><span class="p">,</span> <span class="n">stbi__uint16</span> <span class="n">tc</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="kt">int</span> <span class="n">out_n</span><span class="p">)</span>
<span class="p">{</span>
   <span class="n">stbi__context</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="n">z</span><span class="o">-&gt;</span><span class="n">s</span><span class="p">;</span>
   <span class="n">stbi__uint32</span> <span class="n">i</span><span class="p">,</span> <span class="n">pixel_count</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">img_x</span> <span class="o">*</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">img_y</span><span class="p">;</span>
   <span class="n">stbi__uint16</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">stbi__uint16</span><span class="o">*</span><span class="p">)</span> <span class="n">z</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">;</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-124'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-124'>#</a>
      </div>
      <p>compute color-based transparency, assuming we've
already got 65535 as the alpha value in the output</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>   <span class="n">STBI_ASSERT</span><span class="p">(</span><span class="n">out_n</span> <span class="o">==</span> <span class="mi">2</span> <span class="o">||</span> <span class="n">out_n</span> <span class="o">==</span> <span class="mi">4</span><span class="p">);</span>

   <span class="k">if</span> <span class="p">(</span><span class="n">out_n</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">pixel_count</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
         <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">tc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">65535</span><span class="p">);</span>
         <span class="n">p</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
      <span class="p">}</span>
   <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">pixel_count</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
         <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">tc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">tc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="n">tc</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="n">p</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
         <span class="n">p</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
      <span class="p">}</span>
   <span class="p">}</span>
   <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">stbi__expand_png_palette</span><span class="p">(</span><span class="n">stbi__png</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="n">stbi_uc</span> <span class="o">*</span><span class="n">palette</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pal_img_n</span><span class="p">)</span>
<span class="p">{</span>
   <span class="n">stbi__uint32</span> <span class="n">i</span><span class="p">,</span> <span class="n">pixel_count</span> <span class="o">=</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">img_x</span> <span class="o">*</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">img_y</span><span class="p">;</span>
   <span class="n">stbi_uc</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="o">*</span><span class="n">temp_out</span><span class="p">,</span> <span class="o">*</span><span class="n">orig</span> <span class="o">=</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">;</span>

   <span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">stbi_uc</span> <span class="o">*</span><span class="p">)</span> <span class="n">stbi__malloc</span><span class="p">(</span><span class="n">pixel_count</span> <span class="o">*</span> <span class="n">pal_img_n</span><span class="p">);</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="k">return</span> <span class="n">stbi__err</span><span class="p">(</span><span class="s">&quot;outofmem&quot;</span><span class="p">,</span> <span class="s">&quot;Out of memory&quot;</span><span class="p">);</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-125'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-125'>#</a>
      </div>
      <p>between here and free(out) below, exitting would leak</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>   <span class="n">temp_out</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>

   <span class="k">if</span> <span class="p">(</span><span class="n">pal_img_n</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">pixel_count</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
         <span class="kt">int</span> <span class="n">n</span> <span class="o">=</span> <span class="n">orig</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="mi">4</span><span class="p">;</span>
         <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">palette</span><span class="p">[</span><span class="n">n</span>  <span class="p">];</span>
         <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">palette</span><span class="p">[</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>
         <span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">palette</span><span class="p">[</span><span class="n">n</span><span class="o">+</span><span class="mi">2</span><span class="p">];</span>
         <span class="n">p</span> <span class="o">+=</span> <span class="mi">3</span><span class="p">;</span>
      <span class="p">}</span>
   <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">pixel_count</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
         <span class="kt">int</span> <span class="n">n</span> <span class="o">=</span> <span class="n">orig</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="mi">4</span><span class="p">;</span>
         <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">palette</span><span class="p">[</span><span class="n">n</span>  <span class="p">];</span>
         <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">palette</span><span class="p">[</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>
         <span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">palette</span><span class="p">[</span><span class="n">n</span><span class="o">+</span><span class="mi">2</span><span class="p">];</span>
         <span class="n">p</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">palette</span><span class="p">[</span><span class="n">n</span><span class="o">+</span><span class="mi">3</span><span class="p">];</span>
         <span class="n">p</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
      <span class="p">}</span>
   <span class="p">}</span>
   <span class="n">STBI_FREE</span><span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">);</span>
   <span class="n">a</span><span class="o">-&gt;</span><span class="n">out</span> <span class="o">=</span> <span class="n">temp_out</span><span class="p">;</span>

   <span class="n">STBI_NOTUSED</span><span class="p">(</span><span class="n">len</span><span class="p">);</span>

   <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">stbi__reduce_png</span><span class="p">(</span><span class="n">stbi__png</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
   <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
   <span class="kt">int</span> <span class="n">img_len</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">img_x</span> <span class="o">*</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">img_y</span> <span class="o">*</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">img_out_n</span><span class="p">;</span>
   <span class="n">stbi_uc</span> <span class="o">*</span><span class="n">reduced</span><span class="p">;</span>
   <span class="n">stbi__uint16</span> <span class="o">*</span><span class="n">orig</span> <span class="o">=</span> <span class="p">(</span><span class="n">stbi__uint16</span><span class="o">*</span><span class="p">)</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">;</span>

   <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">depth</span> <span class="o">!=</span> <span class="mi">16</span><span class="p">)</span> <span class="k">return</span> <span class="mi">1</span><span class="p">;</span> <span class="c1">// don&#39;t need to do anything if not 16-bit data</span>

   <span class="n">reduced</span> <span class="o">=</span> <span class="p">(</span><span class="n">stbi_uc</span> <span class="o">*</span><span class="p">)</span><span class="n">stbi__malloc</span><span class="p">(</span><span class="n">img_len</span><span class="p">);</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="k">return</span> <span class="n">stbi__err</span><span class="p">(</span><span class="s">&quot;outofmem&quot;</span><span class="p">,</span> <span class="s">&quot;Out of memory&quot;</span><span class="p">);</span>

   <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">img_len</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="n">reduced</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">stbi_uc</span><span class="p">)((</span><span class="n">orig</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">);</span> <span class="c1">// top half of each byte is a decent approx of 16-&gt;8 bit scaling</span>

   <span class="n">p</span><span class="o">-&gt;</span><span class="n">out</span> <span class="o">=</span> <span class="n">reduced</span><span class="p">;</span>
   <span class="n">STBI_FREE</span><span class="p">(</span><span class="n">orig</span><span class="p">);</span>

   <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">stbi__unpremultiply_on_load</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">stbi__de_iphone_flag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="n">STBIDEF</span> <span class="kt">void</span> <span class="nf">stbi_set_unpremultiply_on_load</span><span class="p">(</span><span class="kt">int</span> <span class="n">flag_true_if_should_unpremultiply</span><span class="p">)</span>
<span class="p">{</span>
   <span class="n">stbi__unpremultiply_on_load</span> <span class="o">=</span> <span class="n">flag_true_if_should_unpremultiply</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">STBIDEF</span> <span class="kt">void</span> <span class="nf">stbi_convert_iphone_png_to_rgb</span><span class="p">(</span><span class="kt">int</span> <span class="n">flag_true_if_should_convert</span><span class="p">)</span>
<span class="p">{</span>
   <span class="n">stbi__de_iphone_flag</span> <span class="o">=</span> <span class="n">flag_true_if_should_convert</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">stbi__de_iphone</span><span class="p">(</span><span class="n">stbi__png</span> <span class="o">*</span><span class="n">z</span><span class="p">)</span>
<span class="p">{</span>
   <span class="n">stbi__context</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="n">z</span><span class="o">-&gt;</span><span class="n">s</span><span class="p">;</span>
   <span class="n">stbi__uint32</span> <span class="n">i</span><span class="p">,</span> <span class="n">pixel_count</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">img_x</span> <span class="o">*</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">img_y</span><span class="p">;</span>
   <span class="n">stbi_uc</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">z</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">;</span>

   <span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">img_out_n</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>  <span class="c1">// convert bgr to rgb</span>
      <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">pixel_count</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
         <span class="n">stbi_uc</span> <span class="n">t</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
         <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
         <span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">t</span><span class="p">;</span>
         <span class="n">p</span> <span class="o">+=</span> <span class="mi">3</span><span class="p">;</span>
      <span class="p">}</span>
   <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="n">STBI_ASSERT</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">img_out_n</span> <span class="o">==</span> <span class="mi">4</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">stbi__unpremultiply_on_load</span><span class="p">)</span> <span class="p">{</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-126'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-126'>#</a>
      </div>
      <p>convert bgr to rgb and unpremultiply</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>         <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">pixel_count</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">stbi_uc</span> <span class="n">a</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
            <span class="n">stbi_uc</span> <span class="n">t</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="p">{</span>
               <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="mi">255</span> <span class="o">/</span> <span class="n">a</span><span class="p">;</span>
               <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="mi">255</span> <span class="o">/</span> <span class="n">a</span><span class="p">;</span>
               <span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span>  <span class="n">t</span>   <span class="o">*</span> <span class="mi">255</span> <span class="o">/</span> <span class="n">a</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
               <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
               <span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">t</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="n">p</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
         <span class="p">}</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-127'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-127'>#</a>
      </div>
      <p>convert bgr to rgb</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>         <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">pixel_count</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">stbi_uc</span> <span class="n">t</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
            <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
            <span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">t</span><span class="p">;</span>
            <span class="n">p</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
         <span class="p">}</span>
      <span class="p">}</span>
   <span class="p">}</span>
<span class="p">}</span>

<span class="cp">#define STBI__PNG_TYPE(a,b,c,d)  (((a) &lt;&lt; 24) + ((b) &lt;&lt; 16) + ((c) &lt;&lt; 8) + (d))</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">stbi__parse_png_file</span><span class="p">(</span><span class="n">stbi__png</span> <span class="o">*</span><span class="n">z</span><span class="p">,</span> <span class="kt">int</span> <span class="n">scan</span><span class="p">,</span> <span class="kt">int</span> <span class="n">req_comp</span><span class="p">)</span>
<span class="p">{</span>
   <span class="n">stbi_uc</span> <span class="n">palette</span><span class="p">[</span><span class="mi">1024</span><span class="p">],</span> <span class="n">pal_img_n</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
   <span class="n">stbi_uc</span> <span class="n">has_trans</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">tc</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
   <span class="n">stbi__uint16</span> <span class="n">tc16</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
   <span class="n">stbi__uint32</span> <span class="n">ioff</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">idata_limit</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">pal_len</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
   <span class="kt">int</span> <span class="n">first</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">interlace</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">is_iphone</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
   <span class="n">stbi__context</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="n">z</span><span class="o">-&gt;</span><span class="n">s</span><span class="p">;</span>

   <span class="n">z</span><span class="o">-&gt;</span><span class="n">expanded</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
   <span class="n">z</span><span class="o">-&gt;</span><span class="n">idata</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
   <span class="n">z</span><span class="o">-&gt;</span><span class="n">out</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">stbi__check_png_header</span><span class="p">(</span><span class="n">s</span><span class="p">))</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

   <span class="k">if</span> <span class="p">(</span><span class="n">scan</span> <span class="o">==</span> <span class="n">STBI__SCAN_type</span><span class="p">)</span> <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

   <span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
      <span class="n">stbi__pngchunk</span> <span class="n">c</span> <span class="o">=</span> <span class="n">stbi__get_chunk_header</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
      <span class="k">switch</span> <span class="p">(</span><span class="n">c</span><span class="p">.</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
         <span class="k">case</span> <span class="n">STBI__PNG_TYPE</span><span class="p">(</span><span class="sc">&#39;C&#39;</span><span class="p">,</span><span class="sc">&#39;g&#39;</span><span class="p">,</span><span class="sc">&#39;B&#39;</span><span class="p">,</span><span class="sc">&#39;I&#39;</span><span class="p">)</span><span class="o">:</span>
            <span class="n">is_iphone</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
            <span class="n">stbi__skip</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">c</span><span class="p">.</span><span class="n">length</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>
         <span class="k">case</span> <span class="n">STBI__PNG_TYPE</span><span class="p">(</span><span class="sc">&#39;I&#39;</span><span class="p">,</span><span class="sc">&#39;H&#39;</span><span class="p">,</span><span class="sc">&#39;D&#39;</span><span class="p">,</span><span class="sc">&#39;R&#39;</span><span class="p">)</span><span class="o">:</span> <span class="p">{</span>
            <span class="kt">int</span> <span class="n">comp</span><span class="p">,</span><span class="n">filter</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">first</span><span class="p">)</span> <span class="k">return</span> <span class="n">stbi__err</span><span class="p">(</span><span class="s">&quot;multiple IHDR&quot;</span><span class="p">,</span><span class="s">&quot;Corrupt PNG&quot;</span><span class="p">);</span>
            <span class="n">first</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="p">.</span><span class="n">length</span> <span class="o">!=</span> <span class="mi">13</span><span class="p">)</span> <span class="k">return</span> <span class="n">stbi__err</span><span class="p">(</span><span class="s">&quot;bad IHDR len&quot;</span><span class="p">,</span><span class="s">&quot;Corrupt PNG&quot;</span><span class="p">);</span>
            <span class="n">s</span><span class="o">-&gt;</span><span class="n">img_x</span> <span class="o">=</span> <span class="n">stbi__get32be</span><span class="p">(</span><span class="n">s</span><span class="p">);</span> <span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">img_x</span> <span class="o">&gt;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">))</span> <span class="k">return</span> <span class="n">stbi__err</span><span class="p">(</span><span class="s">&quot;too large&quot;</span><span class="p">,</span><span class="s">&quot;Very large image (corrupt?)&quot;</span><span class="p">);</span>
            <span class="n">s</span><span class="o">-&gt;</span><span class="n">img_y</span> <span class="o">=</span> <span class="n">stbi__get32be</span><span class="p">(</span><span class="n">s</span><span class="p">);</span> <span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">img_y</span> <span class="o">&gt;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">))</span> <span class="k">return</span> <span class="n">stbi__err</span><span class="p">(</span><span class="s">&quot;too large&quot;</span><span class="p">,</span><span class="s">&quot;Very large image (corrupt?)&quot;</span><span class="p">);</span>
            <span class="n">z</span><span class="o">-&gt;</span><span class="n">depth</span> <span class="o">=</span> <span class="n">stbi__get8</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>  <span class="k">if</span> <span class="p">(</span><span class="n">z</span><span class="o">-&gt;</span><span class="n">depth</span> <span class="o">!=</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">z</span><span class="o">-&gt;</span><span class="n">depth</span> <span class="o">!=</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="n">z</span><span class="o">-&gt;</span><span class="n">depth</span> <span class="o">!=</span> <span class="mi">4</span> <span class="o">&amp;&amp;</span> <span class="n">z</span><span class="o">-&gt;</span><span class="n">depth</span> <span class="o">!=</span> <span class="mi">8</span> <span class="o">&amp;&amp;</span> <span class="n">z</span><span class="o">-&gt;</span><span class="n">depth</span> <span class="o">!=</span> <span class="mi">16</span><span class="p">)</span>  <span class="k">return</span> <span class="n">stbi__err</span><span class="p">(</span><span class="s">&quot;1/2/4/8/16-bit only&quot;</span><span class="p">,</span><span class="s">&quot;PNG not supported: 1/2/4/8/16-bit only&quot;</span><span class="p">);</span>
            <span class="n">color</span> <span class="o">=</span> <span class="n">stbi__get8</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>  <span class="k">if</span> <span class="p">(</span><span class="n">color</span> <span class="o">&gt;</span> <span class="mi">6</span><span class="p">)</span>         <span class="k">return</span> <span class="n">stbi__err</span><span class="p">(</span><span class="s">&quot;bad ctype&quot;</span><span class="p">,</span><span class="s">&quot;Corrupt PNG&quot;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">color</span> <span class="o">==</span> <span class="mi">3</span> <span class="o">&amp;&amp;</span> <span class="n">z</span><span class="o">-&gt;</span><span class="n">depth</span> <span class="o">==</span> <span class="mi">16</span><span class="p">)</span>                  <span class="k">return</span> <span class="n">stbi__err</span><span class="p">(</span><span class="s">&quot;bad ctype&quot;</span><span class="p">,</span><span class="s">&quot;Corrupt PNG&quot;</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">color</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="n">pal_img_n</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">color</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="k">return</span> <span class="n">stbi__err</span><span class="p">(</span><span class="s">&quot;bad ctype&quot;</span><span class="p">,</span><span class="s">&quot;Corrupt PNG&quot;</span><span class="p">);</span>
            <span class="n">comp</span>  <span class="o">=</span> <span class="n">stbi__get8</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>  <span class="k">if</span> <span class="p">(</span><span class="n">comp</span><span class="p">)</span> <span class="k">return</span> <span class="n">stbi__err</span><span class="p">(</span><span class="s">&quot;bad comp method&quot;</span><span class="p">,</span><span class="s">&quot;Corrupt PNG&quot;</span><span class="p">);</span>
            <span class="n">filter</span><span class="o">=</span> <span class="n">stbi__get8</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>  <span class="k">if</span> <span class="p">(</span><span class="n">filter</span><span class="p">)</span> <span class="k">return</span> <span class="n">stbi__err</span><span class="p">(</span><span class="s">&quot;bad filter method&quot;</span><span class="p">,</span><span class="s">&quot;Corrupt PNG&quot;</span><span class="p">);</span>
            <span class="n">interlace</span> <span class="o">=</span> <span class="n">stbi__get8</span><span class="p">(</span><span class="n">s</span><span class="p">);</span> <span class="k">if</span> <span class="p">(</span><span class="n">interlace</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">)</span> <span class="k">return</span> <span class="n">stbi__err</span><span class="p">(</span><span class="s">&quot;bad interlace method&quot;</span><span class="p">,</span><span class="s">&quot;Corrupt PNG&quot;</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">img_x</span> <span class="o">||</span> <span class="o">!</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">img_y</span><span class="p">)</span> <span class="k">return</span> <span class="n">stbi__err</span><span class="p">(</span><span class="s">&quot;0-pixel image&quot;</span><span class="p">,</span><span class="s">&quot;Corrupt PNG&quot;</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pal_img_n</span><span class="p">)</span> <span class="p">{</span>
               <span class="n">s</span><span class="o">-&gt;</span><span class="n">img_n</span> <span class="o">=</span> <span class="p">(</span><span class="n">color</span> <span class="o">&amp;</span> <span class="mi">2</span> <span class="o">?</span> <span class="mi">3</span> <span class="o">:</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">color</span> <span class="o">&amp;</span> <span class="mi">4</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
               <span class="k">if</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">30</span><span class="p">)</span> <span class="o">/</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">img_x</span> <span class="o">/</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">img_n</span> <span class="o">&lt;</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">img_y</span><span class="p">)</span> <span class="k">return</span> <span class="n">stbi__err</span><span class="p">(</span><span class="s">&quot;too large&quot;</span><span class="p">,</span> <span class="s">&quot;Image too large to decode&quot;</span><span class="p">);</span>
               <span class="k">if</span> <span class="p">(</span><span class="n">scan</span> <span class="o">==</span> <span class="n">STBI__SCAN_header</span><span class="p">)</span> <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-128'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-128'>#</a>
      </div>
      <p>if paletted, then pal_n is our final components, and
img_n is # components to decompress/filter.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>               <span class="n">s</span><span class="o">-&gt;</span><span class="n">img_n</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
               <span class="k">if</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">30</span><span class="p">)</span> <span class="o">/</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">img_x</span> <span class="o">/</span> <span class="mi">4</span> <span class="o">&lt;</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">img_y</span><span class="p">)</span> <span class="k">return</span> <span class="n">stbi__err</span><span class="p">(</span><span class="s">&quot;too large&quot;</span><span class="p">,</span><span class="s">&quot;Corrupt PNG&quot;</span><span class="p">);</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-129'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-129'>#</a>
      </div>
      <p>if SCAN_header, have to scan to see if we have a tRNS</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="p">}</span>
            <span class="k">break</span><span class="p">;</span>
         <span class="p">}</span>

         <span class="k">case</span> <span class="n">STBI__PNG_TYPE</span><span class="p">(</span><span class="sc">&#39;P&#39;</span><span class="p">,</span><span class="sc">&#39;L&#39;</span><span class="p">,</span><span class="sc">&#39;T&#39;</span><span class="p">,</span><span class="sc">&#39;E&#39;</span><span class="p">)</span><span class="o">:</span>  <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">first</span><span class="p">)</span> <span class="k">return</span> <span class="n">stbi__err</span><span class="p">(</span><span class="s">&quot;first not IHDR&quot;</span><span class="p">,</span> <span class="s">&quot;Corrupt PNG&quot;</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="p">.</span><span class="n">length</span> <span class="o">&gt;</span> <span class="mi">256</span><span class="o">*</span><span class="mi">3</span><span class="p">)</span> <span class="k">return</span> <span class="n">stbi__err</span><span class="p">(</span><span class="s">&quot;invalid PLTE&quot;</span><span class="p">,</span><span class="s">&quot;Corrupt PNG&quot;</span><span class="p">);</span>
            <span class="n">pal_len</span> <span class="o">=</span> <span class="n">c</span><span class="p">.</span><span class="n">length</span> <span class="o">/</span> <span class="mi">3</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">pal_len</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">!=</span> <span class="n">c</span><span class="p">.</span><span class="n">length</span><span class="p">)</span> <span class="k">return</span> <span class="n">stbi__err</span><span class="p">(</span><span class="s">&quot;invalid PLTE&quot;</span><span class="p">,</span><span class="s">&quot;Corrupt PNG&quot;</span><span class="p">);</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">pal_len</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
               <span class="n">palette</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="mi">4</span><span class="o">+</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">stbi__get8</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
               <span class="n">palette</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="mi">4</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">stbi__get8</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
               <span class="n">palette</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="mi">4</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">stbi__get8</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
               <span class="n">palette</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="mi">4</span><span class="o">+</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">255</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">break</span><span class="p">;</span>
         <span class="p">}</span>

         <span class="k">case</span> <span class="n">STBI__PNG_TYPE</span><span class="p">(</span><span class="sc">&#39;t&#39;</span><span class="p">,</span><span class="sc">&#39;R&#39;</span><span class="p">,</span><span class="sc">&#39;N&#39;</span><span class="p">,</span><span class="sc">&#39;S&#39;</span><span class="p">)</span><span class="o">:</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">first</span><span class="p">)</span> <span class="k">return</span> <span class="n">stbi__err</span><span class="p">(</span><span class="s">&quot;first not IHDR&quot;</span><span class="p">,</span> <span class="s">&quot;Corrupt PNG&quot;</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">z</span><span class="o">-&gt;</span><span class="n">idata</span><span class="p">)</span> <span class="k">return</span> <span class="n">stbi__err</span><span class="p">(</span><span class="s">&quot;tRNS after IDAT&quot;</span><span class="p">,</span><span class="s">&quot;Corrupt PNG&quot;</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">pal_img_n</span><span class="p">)</span> <span class="p">{</span>
               <span class="k">if</span> <span class="p">(</span><span class="n">scan</span> <span class="o">==</span> <span class="n">STBI__SCAN_header</span><span class="p">)</span> <span class="p">{</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">img_n</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span> <span class="k">return</span> <span class="mi">1</span><span class="p">;</span> <span class="p">}</span>
               <span class="k">if</span> <span class="p">(</span><span class="n">pal_len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="n">stbi__err</span><span class="p">(</span><span class="s">&quot;tRNS before PLTE&quot;</span><span class="p">,</span><span class="s">&quot;Corrupt PNG&quot;</span><span class="p">);</span>
               <span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="p">.</span><span class="n">length</span> <span class="o">&gt;</span> <span class="n">pal_len</span><span class="p">)</span> <span class="k">return</span> <span class="n">stbi__err</span><span class="p">(</span><span class="s">&quot;bad tRNS len&quot;</span><span class="p">,</span><span class="s">&quot;Corrupt PNG&quot;</span><span class="p">);</span>
               <span class="n">pal_img_n</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
               <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">c</span><span class="p">.</span><span class="n">length</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
                  <span class="n">palette</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="mi">4</span><span class="o">+</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">stbi__get8</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
               <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">img_n</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">))</span> <span class="k">return</span> <span class="n">stbi__err</span><span class="p">(</span><span class="s">&quot;tRNS with alpha&quot;</span><span class="p">,</span><span class="s">&quot;Corrupt PNG&quot;</span><span class="p">);</span>
               <span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="p">.</span><span class="n">length</span> <span class="o">!=</span> <span class="p">(</span><span class="n">stbi__uint32</span><span class="p">)</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">img_n</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span> <span class="k">return</span> <span class="n">stbi__err</span><span class="p">(</span><span class="s">&quot;bad tRNS len&quot;</span><span class="p">,</span><span class="s">&quot;Corrupt PNG&quot;</span><span class="p">);</span>
               <span class="n">has_trans</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
               <span class="k">if</span> <span class="p">(</span><span class="n">z</span><span class="o">-&gt;</span><span class="n">depth</span> <span class="o">==</span> <span class="mi">16</span><span class="p">)</span> <span class="p">{</span>
                  <span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">img_n</span><span class="p">;</span> <span class="o">++</span><span class="n">k</span><span class="p">)</span> <span class="n">tc16</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">stbi__get16be</span><span class="p">(</span><span class="n">s</span><span class="p">);</span> <span class="c1">// copy the values as-is</span>
               <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                  <span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">img_n</span><span class="p">;</span> <span class="o">++</span><span class="n">k</span><span class="p">)</span> <span class="n">tc</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">stbi_uc</span><span class="p">)(</span><span class="n">stbi__get16be</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">255</span><span class="p">)</span> <span class="o">*</span> <span class="n">stbi__depth_scale_table</span><span class="p">[</span><span class="n">z</span><span class="o">-&gt;</span><span class="n">depth</span><span class="p">];</span> <span class="c1">// non 8-bit images will be larger</span>
               <span class="p">}</span>
            <span class="p">}</span>
            <span class="k">break</span><span class="p">;</span>
         <span class="p">}</span>

         <span class="k">case</span> <span class="n">STBI__PNG_TYPE</span><span class="p">(</span><span class="sc">&#39;I&#39;</span><span class="p">,</span><span class="sc">&#39;D&#39;</span><span class="p">,</span><span class="sc">&#39;A&#39;</span><span class="p">,</span><span class="sc">&#39;T&#39;</span><span class="p">)</span><span class="o">:</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">first</span><span class="p">)</span> <span class="k">return</span> <span class="n">stbi__err</span><span class="p">(</span><span class="s">&quot;first not IHDR&quot;</span><span class="p">,</span> <span class="s">&quot;Corrupt PNG&quot;</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">pal_img_n</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">pal_len</span><span class="p">)</span> <span class="k">return</span> <span class="n">stbi__err</span><span class="p">(</span><span class="s">&quot;no PLTE&quot;</span><span class="p">,</span><span class="s">&quot;Corrupt PNG&quot;</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">scan</span> <span class="o">==</span> <span class="n">STBI__SCAN_header</span><span class="p">)</span> <span class="p">{</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">img_n</span> <span class="o">=</span> <span class="n">pal_img_n</span><span class="p">;</span> <span class="k">return</span> <span class="mi">1</span><span class="p">;</span> <span class="p">}</span>
            <span class="k">if</span> <span class="p">((</span><span class="kt">int</span><span class="p">)(</span><span class="n">ioff</span> <span class="o">+</span> <span class="n">c</span><span class="p">.</span><span class="n">length</span><span class="p">)</span> <span class="o">&lt;</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">ioff</span><span class="p">)</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">ioff</span> <span class="o">+</span> <span class="n">c</span><span class="p">.</span><span class="n">length</span> <span class="o">&gt;</span> <span class="n">idata_limit</span><span class="p">)</span> <span class="p">{</span>
               <span class="n">stbi__uint32</span> <span class="n">idata_limit_old</span> <span class="o">=</span> <span class="n">idata_limit</span><span class="p">;</span>
               <span class="n">stbi_uc</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
               <span class="k">if</span> <span class="p">(</span><span class="n">idata_limit</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="n">idata_limit</span> <span class="o">=</span> <span class="n">c</span><span class="p">.</span><span class="n">length</span> <span class="o">&gt;</span> <span class="mi">4096</span> <span class="o">?</span> <span class="n">c</span><span class="p">.</span><span class="nl">length</span> <span class="p">:</span> <span class="mi">4096</span><span class="p">;</span>
               <span class="k">while</span> <span class="p">(</span><span class="n">ioff</span> <span class="o">+</span> <span class="n">c</span><span class="p">.</span><span class="n">length</span> <span class="o">&gt;</span> <span class="n">idata_limit</span><span class="p">)</span>
                  <span class="n">idata_limit</span> <span class="o">*=</span> <span class="mi">2</span><span class="p">;</span>
               <span class="n">STBI_NOTUSED</span><span class="p">(</span><span class="n">idata_limit_old</span><span class="p">);</span>
               <span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">stbi_uc</span> <span class="o">*</span><span class="p">)</span> <span class="n">STBI_REALLOC_SIZED</span><span class="p">(</span><span class="n">z</span><span class="o">-&gt;</span><span class="n">idata</span><span class="p">,</span> <span class="n">idata_limit_old</span><span class="p">,</span> <span class="n">idata_limit</span><span class="p">);</span> <span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="k">return</span> <span class="n">stbi__err</span><span class="p">(</span><span class="s">&quot;outofmem&quot;</span><span class="p">,</span> <span class="s">&quot;Out of memory&quot;</span><span class="p">);</span>
               <span class="n">z</span><span class="o">-&gt;</span><span class="n">idata</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">stbi__getn</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">z</span><span class="o">-&gt;</span><span class="n">idata</span><span class="o">+</span><span class="n">ioff</span><span class="p">,</span><span class="n">c</span><span class="p">.</span><span class="n">length</span><span class="p">))</span> <span class="k">return</span> <span class="n">stbi__err</span><span class="p">(</span><span class="s">&quot;outofdata&quot;</span><span class="p">,</span><span class="s">&quot;Corrupt PNG&quot;</span><span class="p">);</span>
            <span class="n">ioff</span> <span class="o">+=</span> <span class="n">c</span><span class="p">.</span><span class="n">length</span><span class="p">;</span>
            <span class="k">break</span><span class="p">;</span>
         <span class="p">}</span>

         <span class="k">case</span> <span class="n">STBI__PNG_TYPE</span><span class="p">(</span><span class="sc">&#39;I&#39;</span><span class="p">,</span><span class="sc">&#39;E&#39;</span><span class="p">,</span><span class="sc">&#39;N&#39;</span><span class="p">,</span><span class="sc">&#39;D&#39;</span><span class="p">)</span><span class="o">:</span> <span class="p">{</span>
            <span class="n">stbi__uint32</span> <span class="n">raw_len</span><span class="p">,</span> <span class="n">bpl</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">first</span><span class="p">)</span> <span class="k">return</span> <span class="n">stbi__err</span><span class="p">(</span><span class="s">&quot;first not IHDR&quot;</span><span class="p">,</span> <span class="s">&quot;Corrupt PNG&quot;</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">scan</span> <span class="o">!=</span> <span class="n">STBI__SCAN_load</span><span class="p">)</span> <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">z</span><span class="o">-&gt;</span><span class="n">idata</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="k">return</span> <span class="n">stbi__err</span><span class="p">(</span><span class="s">&quot;no IDAT&quot;</span><span class="p">,</span><span class="s">&quot;Corrupt PNG&quot;</span><span class="p">);</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-130'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-130'>#</a>
      </div>
      <p>initial guess for decoded data size to avoid unnecessary reallocs</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="n">bpl</span> <span class="o">=</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">img_x</span> <span class="o">*</span> <span class="n">z</span><span class="o">-&gt;</span><span class="n">depth</span> <span class="o">+</span> <span class="mi">7</span><span class="p">)</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span> <span class="c1">// bytes per line, per component</span>
            <span class="n">raw_len</span> <span class="o">=</span> <span class="n">bpl</span> <span class="o">*</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">img_y</span> <span class="o">*</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">img_n</span> <span class="cm">/* pixels */</span> <span class="o">+</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">img_y</span> <span class="cm">/* filter mode per row */</span><span class="p">;</span>
            <span class="n">z</span><span class="o">-&gt;</span><span class="n">expanded</span> <span class="o">=</span> <span class="p">(</span><span class="n">stbi_uc</span> <span class="o">*</span><span class="p">)</span> <span class="n">stbi_zlib_decode_malloc_guesssize_headerflag</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">z</span><span class="o">-&gt;</span><span class="n">idata</span><span class="p">,</span> <span class="n">ioff</span><span class="p">,</span> <span class="n">raw_len</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">raw_len</span><span class="p">,</span> <span class="o">!</span><span class="n">is_iphone</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">z</span><span class="o">-&gt;</span><span class="n">expanded</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="c1">// zlib should set error</span>
            <span class="n">STBI_FREE</span><span class="p">(</span><span class="n">z</span><span class="o">-&gt;</span><span class="n">idata</span><span class="p">);</span> <span class="n">z</span><span class="o">-&gt;</span><span class="n">idata</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">((</span><span class="n">req_comp</span> <span class="o">==</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">img_n</span><span class="o">+</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">req_comp</span> <span class="o">!=</span> <span class="mi">3</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">pal_img_n</span><span class="p">)</span> <span class="o">||</span> <span class="n">has_trans</span><span class="p">)</span>
               <span class="n">s</span><span class="o">-&gt;</span><span class="n">img_out_n</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">img_n</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
            <span class="k">else</span>
               <span class="n">s</span><span class="o">-&gt;</span><span class="n">img_out_n</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">img_n</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">stbi__create_png_image</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">z</span><span class="o">-&gt;</span><span class="n">expanded</span><span class="p">,</span> <span class="n">raw_len</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">img_out_n</span><span class="p">,</span> <span class="n">z</span><span class="o">-&gt;</span><span class="n">depth</span><span class="p">,</span> <span class="n">color</span><span class="p">,</span> <span class="n">interlace</span><span class="p">))</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">has_trans</span><span class="p">)</span> <span class="p">{</span>
               <span class="k">if</span> <span class="p">(</span><span class="n">z</span><span class="o">-&gt;</span><span class="n">depth</span> <span class="o">==</span> <span class="mi">16</span><span class="p">)</span> <span class="p">{</span>
                  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">stbi__compute_transparency16</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">tc16</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">img_out_n</span><span class="p">))</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
               <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">stbi__compute_transparency</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">tc</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">img_out_n</span><span class="p">))</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
               <span class="p">}</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">is_iphone</span> <span class="o">&amp;&amp;</span> <span class="n">stbi__de_iphone_flag</span> <span class="o">&amp;&amp;</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">img_out_n</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span>
               <span class="n">stbi__de_iphone</span><span class="p">(</span><span class="n">z</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">pal_img_n</span><span class="p">)</span> <span class="p">{</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-131'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-131'>#</a>
      </div>
      <p>pal_img_n == 3 or 4</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>               <span class="n">s</span><span class="o">-&gt;</span><span class="n">img_n</span> <span class="o">=</span> <span class="n">pal_img_n</span><span class="p">;</span> <span class="c1">// record the actual colors we had</span>
               <span class="n">s</span><span class="o">-&gt;</span><span class="n">img_out_n</span> <span class="o">=</span> <span class="n">pal_img_n</span><span class="p">;</span>
               <span class="k">if</span> <span class="p">(</span><span class="n">req_comp</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">)</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">img_out_n</span> <span class="o">=</span> <span class="n">req_comp</span><span class="p">;</span>
               <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">stbi__expand_png_palette</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">palette</span><span class="p">,</span> <span class="n">pal_len</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">img_out_n</span><span class="p">))</span>
                  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="n">STBI_FREE</span><span class="p">(</span><span class="n">z</span><span class="o">-&gt;</span><span class="n">expanded</span><span class="p">);</span> <span class="n">z</span><span class="o">-&gt;</span><span class="n">expanded</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
            <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
         <span class="p">}</span>

         <span class="k">default</span><span class="o">:</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-132'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-132'>#</a>
      </div>
      <p>if critical, fail</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="k">if</span> <span class="p">(</span><span class="n">first</span><span class="p">)</span> <span class="k">return</span> <span class="n">stbi__err</span><span class="p">(</span><span class="s">&quot;first not IHDR&quot;</span><span class="p">,</span> <span class="s">&quot;Corrupt PNG&quot;</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">((</span><span class="n">c</span><span class="p">.</span><span class="n">type</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">29</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
               <span class="cp">#ifndef STBI_NO_FAILURE_STRINGS</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-133'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-133'>#</a>
      </div>
      <p>not threadsafe</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>               <span class="k">static</span> <span class="kt">char</span> <span class="n">invalid_chunk</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;XXXX PNG chunk not known&quot;</span><span class="p">;</span>
               <span class="n">invalid_chunk</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">STBI__BYTECAST</span><span class="p">(</span><span class="n">c</span><span class="p">.</span><span class="n">type</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">);</span>
               <span class="n">invalid_chunk</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">STBI__BYTECAST</span><span class="p">(</span><span class="n">c</span><span class="p">.</span><span class="n">type</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
               <span class="n">invalid_chunk</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">STBI__BYTECAST</span><span class="p">(</span><span class="n">c</span><span class="p">.</span><span class="n">type</span> <span class="o">&gt;&gt;</span>  <span class="mi">8</span><span class="p">);</span>
               <span class="n">invalid_chunk</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">STBI__BYTECAST</span><span class="p">(</span><span class="n">c</span><span class="p">.</span><span class="n">type</span> <span class="o">&gt;&gt;</span>  <span class="mi">0</span><span class="p">);</span>
               <span class="cp">#endif</span>
               <span class="k">return</span> <span class="n">stbi__err</span><span class="p">(</span><span class="n">invalid_chunk</span><span class="p">,</span> <span class="s">&quot;PNG not supported: unknown PNG chunk type&quot;</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="n">stbi__skip</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">c</span><span class="p">.</span><span class="n">length</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>
      <span class="p">}</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-134'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-134'>#</a>
      </div>
      <p>end of PNG chunk, read and skip CRC</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>      <span class="n">stbi__get32be</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
   <span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">stbi__do_png</span><span class="p">(</span><span class="n">stbi__png</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">y</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">n</span><span class="p">,</span> <span class="kt">int</span> <span class="n">req_comp</span><span class="p">)</span>
<span class="p">{</span>
   <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">result</span><span class="o">=</span><span class="nb">NULL</span><span class="p">;</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">req_comp</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">req_comp</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="k">return</span> <span class="n">stbi__errpuc</span><span class="p">(</span><span class="s">&quot;bad req_comp&quot;</span><span class="p">,</span> <span class="s">&quot;Internal error&quot;</span><span class="p">);</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">stbi__parse_png_file</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">STBI__SCAN_load</span><span class="p">,</span> <span class="n">req_comp</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">depth</span> <span class="o">==</span> <span class="mi">16</span><span class="p">)</span> <span class="p">{</span>
         <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">stbi__reduce_png</span><span class="p">(</span><span class="n">p</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
         <span class="p">}</span>
      <span class="p">}</span>
      <span class="n">result</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">;</span>
      <span class="n">p</span><span class="o">-&gt;</span><span class="n">out</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">req_comp</span> <span class="o">&amp;&amp;</span> <span class="n">req_comp</span> <span class="o">!=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">img_out_n</span><span class="p">)</span> <span class="p">{</span>
         <span class="n">result</span> <span class="o">=</span> <span class="n">stbi__convert_format</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">img_out_n</span><span class="p">,</span> <span class="n">req_comp</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">img_x</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">img_y</span><span class="p">);</span>
         <span class="n">p</span><span class="o">-&gt;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">img_out_n</span> <span class="o">=</span> <span class="n">req_comp</span><span class="p">;</span>
         <span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="o">*</span><span class="n">x</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">img_x</span><span class="p">;</span>
      <span class="o">*</span><span class="n">y</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">img_y</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">*</span><span class="n">n</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">img_n</span><span class="p">;</span>
   <span class="p">}</span>
   <span class="n">STBI_FREE</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">);</span>      <span class="n">p</span><span class="o">-&gt;</span><span class="n">out</span>      <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
   <span class="n">STBI_FREE</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">expanded</span><span class="p">);</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">expanded</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
   <span class="n">STBI_FREE</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">idata</span><span class="p">);</span>    <span class="n">p</span><span class="o">-&gt;</span><span class="n">idata</span>    <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

   <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">stbi__png_load</span><span class="p">(</span><span class="n">stbi__context</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">y</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">comp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">req_comp</span><span class="p">)</span>
<span class="p">{</span>
   <span class="n">stbi__png</span> <span class="n">p</span><span class="p">;</span>
   <span class="n">p</span><span class="p">.</span><span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="p">;</span>
   <span class="k">return</span> <span class="n">stbi__do_png</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">comp</span><span class="p">,</span><span class="n">req_comp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">stbi__png_test</span><span class="p">(</span><span class="n">stbi__context</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
   <span class="kt">int</span> <span class="n">r</span><span class="p">;</span>
   <span class="n">r</span> <span class="o">=</span> <span class="n">stbi__check_png_header</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
   <span class="n">stbi__rewind</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
   <span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">stbi__png_info_raw</span><span class="p">(</span><span class="n">stbi__png</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">y</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">comp</span><span class="p">)</span>
<span class="p">{</span>
   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">stbi__parse_png_file</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">STBI__SCAN_header</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
      <span class="n">stbi__rewind</span><span class="p">(</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">s</span> <span class="p">);</span>
      <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
   <span class="p">}</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">*</span><span class="n">x</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">img_x</span><span class="p">;</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="o">*</span><span class="n">y</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">img_y</span><span class="p">;</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">comp</span><span class="p">)</span> <span class="o">*</span><span class="n">comp</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">img_n</span><span class="p">;</span>
   <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">stbi__png_info</span><span class="p">(</span><span class="n">stbi__context</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">y</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">comp</span><span class="p">)</span>
<span class="p">{</span>
   <span class="n">stbi__png</span> <span class="n">p</span><span class="p">;</span>
   <span class="n">p</span><span class="p">.</span><span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="p">;</span>
   <span class="k">return</span> <span class="n">stbi__png_info_raw</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">comp</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-135'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-135'>#</a>
      </div>
      <p>Microsoft/Windows BMP image</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="cp">#ifndef STBI_NO_BMP</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">stbi__bmp_test_raw</span><span class="p">(</span><span class="n">stbi__context</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
   <span class="kt">int</span> <span class="n">r</span><span class="p">;</span>
   <span class="kt">int</span> <span class="n">sz</span><span class="p">;</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">stbi__get8</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">!=</span> <span class="sc">&#39;B&#39;</span><span class="p">)</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">stbi__get8</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">!=</span> <span class="sc">&#39;M&#39;</span><span class="p">)</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
   <span class="n">stbi__get32le</span><span class="p">(</span><span class="n">s</span><span class="p">);</span> <span class="c1">// discard filesize</span>
   <span class="n">stbi__get16le</span><span class="p">(</span><span class="n">s</span><span class="p">);</span> <span class="c1">// discard reserved</span>
   <span class="n">stbi__get16le</span><span class="p">(</span><span class="n">s</span><span class="p">);</span> <span class="c1">// discard reserved</span>
   <span class="n">stbi__get32le</span><span class="p">(</span><span class="n">s</span><span class="p">);</span> <span class="c1">// discard data offset</span>
   <span class="n">sz</span> <span class="o">=</span> <span class="n">stbi__get32le</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
   <span class="n">r</span> <span class="o">=</span> <span class="p">(</span><span class="n">sz</span> <span class="o">==</span> <span class="mi">12</span> <span class="o">||</span> <span class="n">sz</span> <span class="o">==</span> <span class="mi">40</span> <span class="o">||</span> <span class="n">sz</span> <span class="o">==</span> <span class="mi">56</span> <span class="o">||</span> <span class="n">sz</span> <span class="o">==</span> <span class="mi">108</span> <span class="o">||</span> <span class="n">sz</span> <span class="o">==</span> <span class="mi">124</span><span class="p">);</span>
   <span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">stbi__bmp_test</span><span class="p">(</span><span class="n">stbi__context</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
   <span class="kt">int</span> <span class="n">r</span> <span class="o">=</span> <span class="n">stbi__bmp_test_raw</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
   <span class="n">stbi__rewind</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
   <span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-136'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-136'>#</a>
      </div>
      <p>returns 0..31 for the highest set bit</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">static</span> <span class="kt">int</span> <span class="nf">stbi__high_bit</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">z</span><span class="p">)</span>
<span class="p">{</span>
   <span class="kt">int</span> <span class="n">n</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">z</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">z</span> <span class="o">&gt;=</span> <span class="mh">0x10000</span><span class="p">)</span> <span class="n">n</span> <span class="o">+=</span> <span class="mi">16</span><span class="p">,</span> <span class="n">z</span> <span class="o">&gt;&gt;=</span> <span class="mi">16</span><span class="p">;</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">z</span> <span class="o">&gt;=</span> <span class="mh">0x00100</span><span class="p">)</span> <span class="n">n</span> <span class="o">+=</span>  <span class="mi">8</span><span class="p">,</span> <span class="n">z</span> <span class="o">&gt;&gt;=</span>  <span class="mi">8</span><span class="p">;</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">z</span> <span class="o">&gt;=</span> <span class="mh">0x00010</span><span class="p">)</span> <span class="n">n</span> <span class="o">+=</span>  <span class="mi">4</span><span class="p">,</span> <span class="n">z</span> <span class="o">&gt;&gt;=</span>  <span class="mi">4</span><span class="p">;</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">z</span> <span class="o">&gt;=</span> <span class="mh">0x00004</span><span class="p">)</span> <span class="n">n</span> <span class="o">+=</span>  <span class="mi">2</span><span class="p">,</span> <span class="n">z</span> <span class="o">&gt;&gt;=</span>  <span class="mi">2</span><span class="p">;</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">z</span> <span class="o">&gt;=</span> <span class="mh">0x00002</span><span class="p">)</span> <span class="n">n</span> <span class="o">+=</span>  <span class="mi">1</span><span class="p">,</span> <span class="n">z</span> <span class="o">&gt;&gt;=</span>  <span class="mi">1</span><span class="p">;</span>
   <span class="k">return</span> <span class="n">n</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">stbi__bitcount</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">a</span><span class="p">)</span>
<span class="p">{</span>
   <span class="n">a</span> <span class="o">=</span> <span class="p">(</span><span class="n">a</span> <span class="o">&amp;</span> <span class="mh">0x55555555</span><span class="p">)</span> <span class="o">+</span> <span class="p">((</span><span class="n">a</span> <span class="o">&gt;&gt;</span>  <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x55555555</span><span class="p">);</span> <span class="c1">// max 2</span>
   <span class="n">a</span> <span class="o">=</span> <span class="p">(</span><span class="n">a</span> <span class="o">&amp;</span> <span class="mh">0x33333333</span><span class="p">)</span> <span class="o">+</span> <span class="p">((</span><span class="n">a</span> <span class="o">&gt;&gt;</span>  <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x33333333</span><span class="p">);</span> <span class="c1">// max 4</span>
   <span class="n">a</span> <span class="o">=</span> <span class="p">(</span><span class="n">a</span> <span class="o">+</span> <span class="p">(</span><span class="n">a</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0x0f0f0f0f</span><span class="p">;</span> <span class="c1">// max 8 per 4, now 8 bits</span>
   <span class="n">a</span> <span class="o">=</span> <span class="p">(</span><span class="n">a</span> <span class="o">+</span> <span class="p">(</span><span class="n">a</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">));</span> <span class="c1">// max 16 per 8 bits</span>
   <span class="n">a</span> <span class="o">=</span> <span class="p">(</span><span class="n">a</span> <span class="o">+</span> <span class="p">(</span><span class="n">a</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">));</span> <span class="c1">// max 32 per 8 bits</span>
   <span class="k">return</span> <span class="n">a</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">stbi__shiftsigned</span><span class="p">(</span><span class="kt">int</span> <span class="n">v</span><span class="p">,</span> <span class="kt">int</span> <span class="n">shift</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bits</span><span class="p">)</span>
<span class="p">{</span>
   <span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
   <span class="kt">int</span> <span class="n">z</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>

   <span class="k">if</span> <span class="p">(</span><span class="n">shift</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="n">v</span> <span class="o">&lt;&lt;=</span> <span class="o">-</span><span class="n">shift</span><span class="p">;</span>
   <span class="k">else</span> <span class="n">v</span> <span class="o">&gt;&gt;=</span> <span class="n">shift</span><span class="p">;</span>
   <span class="n">result</span> <span class="o">=</span> <span class="n">v</span><span class="p">;</span>

   <span class="n">z</span> <span class="o">=</span> <span class="n">bits</span><span class="p">;</span>
   <span class="k">while</span> <span class="p">(</span><span class="n">z</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">result</span> <span class="o">+=</span> <span class="n">v</span> <span class="o">&gt;&gt;</span> <span class="n">z</span><span class="p">;</span>
      <span class="n">z</span> <span class="o">+=</span> <span class="n">bits</span><span class="p">;</span>
   <span class="p">}</span>
   <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">typedef</span> <span class="k">struct</span>
<span class="p">{</span>
   <span class="kt">int</span> <span class="n">bpp</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">hsz</span><span class="p">;</span>
   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mr</span><span class="p">,</span><span class="n">mg</span><span class="p">,</span><span class="n">mb</span><span class="p">,</span><span class="n">ma</span><span class="p">,</span> <span class="n">all_a</span><span class="p">;</span>
<span class="p">}</span> <span class="n">stbi__bmp_data</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">stbi__bmp_parse_header</span><span class="p">(</span><span class="n">stbi__context</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="n">stbi__bmp_data</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
   <span class="kt">int</span> <span class="n">hsz</span><span class="p">;</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">stbi__get8</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">!=</span> <span class="sc">&#39;B&#39;</span> <span class="o">||</span> <span class="n">stbi__get8</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">!=</span> <span class="sc">&#39;M&#39;</span><span class="p">)</span> <span class="k">return</span> <span class="n">stbi__errpuc</span><span class="p">(</span><span class="s">&quot;not BMP&quot;</span><span class="p">,</span> <span class="s">&quot;Corrupt BMP&quot;</span><span class="p">);</span>
   <span class="n">stbi__get32le</span><span class="p">(</span><span class="n">s</span><span class="p">);</span> <span class="c1">// discard filesize</span>
   <span class="n">stbi__get16le</span><span class="p">(</span><span class="n">s</span><span class="p">);</span> <span class="c1">// discard reserved</span>
   <span class="n">stbi__get16le</span><span class="p">(</span><span class="n">s</span><span class="p">);</span> <span class="c1">// discard reserved</span>
   <span class="n">info</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">=</span> <span class="n">stbi__get32le</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
   <span class="n">info</span><span class="o">-&gt;</span><span class="n">hsz</span> <span class="o">=</span> <span class="n">hsz</span> <span class="o">=</span> <span class="n">stbi__get32le</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
   <span class="n">info</span><span class="o">-&gt;</span><span class="n">mr</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">mg</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">mb</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ma</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
   
   <span class="k">if</span> <span class="p">(</span><span class="n">hsz</span> <span class="o">!=</span> <span class="mi">12</span> <span class="o">&amp;&amp;</span> <span class="n">hsz</span> <span class="o">!=</span> <span class="mi">40</span> <span class="o">&amp;&amp;</span> <span class="n">hsz</span> <span class="o">!=</span> <span class="mi">56</span> <span class="o">&amp;&amp;</span> <span class="n">hsz</span> <span class="o">!=</span> <span class="mi">108</span> <span class="o">&amp;&amp;</span> <span class="n">hsz</span> <span class="o">!=</span> <span class="mi">124</span><span class="p">)</span> <span class="k">return</span> <span class="n">stbi__errpuc</span><span class="p">(</span><span class="s">&quot;unknown BMP&quot;</span><span class="p">,</span> <span class="s">&quot;BMP type not supported: unknown&quot;</span><span class="p">);</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">hsz</span> <span class="o">==</span> <span class="mi">12</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">s</span><span class="o">-&gt;</span><span class="n">img_x</span> <span class="o">=</span> <span class="n">stbi__get16le</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
      <span class="n">s</span><span class="o">-&gt;</span><span class="n">img_y</span> <span class="o">=</span> <span class="n">stbi__get16le</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
   <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="n">s</span><span class="o">-&gt;</span><span class="n">img_x</span> <span class="o">=</span> <span class="n">stbi__get32le</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
      <span class="n">s</span><span class="o">-&gt;</span><span class="n">img_y</span> <span class="o">=</span> <span class="n">stbi__get32le</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
   <span class="p">}</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">stbi__get16le</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="k">return</span> <span class="n">stbi__errpuc</span><span class="p">(</span><span class="s">&quot;bad BMP&quot;</span><span class="p">,</span> <span class="s">&quot;bad BMP&quot;</span><span class="p">);</span>
   <span class="n">info</span><span class="o">-&gt;</span><span class="n">bpp</span> <span class="o">=</span> <span class="n">stbi__get16le</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">bpp</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="k">return</span> <span class="n">stbi__errpuc</span><span class="p">(</span><span class="s">&quot;monochrome&quot;</span><span class="p">,</span> <span class="s">&quot;BMP type not supported: 1-bit&quot;</span><span class="p">);</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">hsz</span> <span class="o">!=</span> <span class="mi">12</span><span class="p">)</span> <span class="p">{</span>
      <span class="kt">int</span> <span class="n">compress</span> <span class="o">=</span> <span class="n">stbi__get32le</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">compress</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">compress</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="k">return</span> <span class="n">stbi__errpuc</span><span class="p">(</span><span class="s">&quot;BMP RLE&quot;</span><span class="p">,</span> <span class="s">&quot;BMP type not supported: RLE&quot;</span><span class="p">);</span>
      <span class="n">stbi__get32le</span><span class="p">(</span><span class="n">s</span><span class="p">);</span> <span class="c1">// discard sizeof</span>
      <span class="n">stbi__get32le</span><span class="p">(</span><span class="n">s</span><span class="p">);</span> <span class="c1">// discard hres</span>
      <span class="n">stbi__get32le</span><span class="p">(</span><span class="n">s</span><span class="p">);</span> <span class="c1">// discard vres</span>
      <span class="n">stbi__get32le</span><span class="p">(</span><span class="n">s</span><span class="p">);</span> <span class="c1">// discard colorsused</span>
      <span class="n">stbi__get32le</span><span class="p">(</span><span class="n">s</span><span class="p">);</span> <span class="c1">// discard max important</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">hsz</span> <span class="o">==</span> <span class="mi">40</span> <span class="o">||</span> <span class="n">hsz</span> <span class="o">==</span> <span class="mi">56</span><span class="p">)</span> <span class="p">{</span>
         <span class="k">if</span> <span class="p">(</span><span class="n">hsz</span> <span class="o">==</span> <span class="mi">56</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">stbi__get32le</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
            <span class="n">stbi__get32le</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
            <span class="n">stbi__get32le</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
            <span class="n">stbi__get32le</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
         <span class="p">}</span>
         <span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">bpp</span> <span class="o">==</span> <span class="mi">16</span> <span class="o">||</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">bpp</span> <span class="o">==</span> <span class="mi">32</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">compress</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
               <span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">bpp</span> <span class="o">==</span> <span class="mi">32</span><span class="p">)</span> <span class="p">{</span>
                  <span class="n">info</span><span class="o">-&gt;</span><span class="n">mr</span> <span class="o">=</span> <span class="mh">0xffu</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
                  <span class="n">info</span><span class="o">-&gt;</span><span class="n">mg</span> <span class="o">=</span> <span class="mh">0xffu</span> <span class="o">&lt;&lt;</span>  <span class="mi">8</span><span class="p">;</span>
                  <span class="n">info</span><span class="o">-&gt;</span><span class="n">mb</span> <span class="o">=</span> <span class="mh">0xffu</span> <span class="o">&lt;&lt;</span>  <span class="mi">0</span><span class="p">;</span>
                  <span class="n">info</span><span class="o">-&gt;</span><span class="n">ma</span> <span class="o">=</span> <span class="mh">0xffu</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">;</span>
                  <span class="n">info</span><span class="o">-&gt;</span><span class="n">all_a</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="c1">// if all_a is 0 at end, then we loaded alpha channel but it was all 0</span>
               <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                  <span class="n">info</span><span class="o">-&gt;</span><span class="n">mr</span> <span class="o">=</span> <span class="mi">31u</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">;</span>
                  <span class="n">info</span><span class="o">-&gt;</span><span class="n">mg</span> <span class="o">=</span> <span class="mi">31u</span> <span class="o">&lt;&lt;</span>  <span class="mi">5</span><span class="p">;</span>
                  <span class="n">info</span><span class="o">-&gt;</span><span class="n">mb</span> <span class="o">=</span> <span class="mi">31u</span> <span class="o">&lt;&lt;</span>  <span class="mi">0</span><span class="p">;</span>
               <span class="p">}</span>
            <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">compress</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
               <span class="n">info</span><span class="o">-&gt;</span><span class="n">mr</span> <span class="o">=</span> <span class="n">stbi__get32le</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
               <span class="n">info</span><span class="o">-&gt;</span><span class="n">mg</span> <span class="o">=</span> <span class="n">stbi__get32le</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
               <span class="n">info</span><span class="o">-&gt;</span><span class="n">mb</span> <span class="o">=</span> <span class="n">stbi__get32le</span><span class="p">(</span><span class="n">s</span><span class="p">);</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-137'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-137'>#</a>
      </div>
      <p>not documented, but generated by photoshop and handled by mspaint</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>               <span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">mr</span> <span class="o">==</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">mg</span> <span class="o">&amp;&amp;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">mg</span> <span class="o">==</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">)</span> <span class="p">{</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-138'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-138'>#</a>
      </div>
      <p>?!?!?</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>                  <span class="k">return</span> <span class="n">stbi__errpuc</span><span class="p">(</span><span class="s">&quot;bad BMP&quot;</span><span class="p">,</span> <span class="s">&quot;bad BMP&quot;</span><span class="p">);</span>
               <span class="p">}</span>
            <span class="p">}</span> <span class="k">else</span>
               <span class="k">return</span> <span class="n">stbi__errpuc</span><span class="p">(</span><span class="s">&quot;bad BMP&quot;</span><span class="p">,</span> <span class="s">&quot;bad BMP&quot;</span><span class="p">);</span>
         <span class="p">}</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
         <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
         <span class="k">if</span> <span class="p">(</span><span class="n">hsz</span> <span class="o">!=</span> <span class="mi">108</span> <span class="o">&amp;&amp;</span> <span class="n">hsz</span> <span class="o">!=</span> <span class="mi">124</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">stbi__errpuc</span><span class="p">(</span><span class="s">&quot;bad BMP&quot;</span><span class="p">,</span> <span class="s">&quot;bad BMP&quot;</span><span class="p">);</span>
         <span class="n">info</span><span class="o">-&gt;</span><span class="n">mr</span> <span class="o">=</span> <span class="n">stbi__get32le</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
         <span class="n">info</span><span class="o">-&gt;</span><span class="n">mg</span> <span class="o">=</span> <span class="n">stbi__get32le</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
         <span class="n">info</span><span class="o">-&gt;</span><span class="n">mb</span> <span class="o">=</span> <span class="n">stbi__get32le</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
         <span class="n">info</span><span class="o">-&gt;</span><span class="n">ma</span> <span class="o">=</span> <span class="n">stbi__get32le</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
         <span class="n">stbi__get32le</span><span class="p">(</span><span class="n">s</span><span class="p">);</span> <span class="c1">// discard color space</span>
         <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">12</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
            <span class="n">stbi__get32le</span><span class="p">(</span><span class="n">s</span><span class="p">);</span> <span class="c1">// discard color space parameters</span>
         <span class="k">if</span> <span class="p">(</span><span class="n">hsz</span> <span class="o">==</span> <span class="mi">124</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">stbi__get32le</span><span class="p">(</span><span class="n">s</span><span class="p">);</span> <span class="c1">// discard rendering intent</span>
            <span class="n">stbi__get32le</span><span class="p">(</span><span class="n">s</span><span class="p">);</span> <span class="c1">// discard offset of profile data</span>
            <span class="n">stbi__get32le</span><span class="p">(</span><span class="n">s</span><span class="p">);</span> <span class="c1">// discard size of profile data</span>
            <span class="n">stbi__get32le</span><span class="p">(</span><span class="n">s</span><span class="p">);</span> <span class="c1">// discard reserved</span>
         <span class="p">}</span>
      <span class="p">}</span>
   <span class="p">}</span>
   <span class="k">return</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="n">stbi_uc</span> <span class="o">*</span><span class="nf">stbi__bmp_load</span><span class="p">(</span><span class="n">stbi__context</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">y</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">comp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">req_comp</span><span class="p">)</span>
<span class="p">{</span>
   <span class="n">stbi_uc</span> <span class="o">*</span><span class="n">out</span><span class="p">;</span>
   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mr</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">mg</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">mb</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">ma</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">all_a</span><span class="p">;</span>
   <span class="n">stbi_uc</span> <span class="n">pal</span><span class="p">[</span><span class="mi">256</span><span class="p">][</span><span class="mi">4</span><span class="p">];</span>
   <span class="kt">int</span> <span class="n">psize</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">width</span><span class="p">;</span>
   <span class="kt">int</span> <span class="n">flip_vertically</span><span class="p">,</span> <span class="n">pad</span><span class="p">,</span> <span class="n">target</span><span class="p">;</span>
   <span class="n">stbi__bmp_data</span> <span class="n">info</span><span class="p">;</span>

   <span class="n">info</span><span class="p">.</span><span class="n">all_a</span> <span class="o">=</span> <span class="mi">255</span><span class="p">;</span>   
   <span class="k">if</span> <span class="p">(</span><span class="n">stbi__bmp_parse_header</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">)</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
      <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span> <span class="c1">// error code already set</span>

   <span class="n">flip_vertically</span> <span class="o">=</span> <span class="p">((</span><span class="kt">int</span><span class="p">)</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">img_y</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span>
   <span class="n">s</span><span class="o">-&gt;</span><span class="n">img_y</span> <span class="o">=</span> <span class="n">abs</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">img_y</span><span class="p">);</span>

   <span class="n">mr</span> <span class="o">=</span> <span class="n">info</span><span class="p">.</span><span class="n">mr</span><span class="p">;</span>
   <span class="n">mg</span> <span class="o">=</span> <span class="n">info</span><span class="p">.</span><span class="n">mg</span><span class="p">;</span>
   <span class="n">mb</span> <span class="o">=</span> <span class="n">info</span><span class="p">.</span><span class="n">mb</span><span class="p">;</span>
   <span class="n">ma</span> <span class="o">=</span> <span class="n">info</span><span class="p">.</span><span class="n">ma</span><span class="p">;</span>
   <span class="n">all_a</span> <span class="o">=</span> <span class="n">info</span><span class="p">.</span><span class="n">all_a</span><span class="p">;</span>

   <span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">hsz</span> <span class="o">==</span> <span class="mi">12</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">bpp</span> <span class="o">&lt;</span> <span class="mi">24</span><span class="p">)</span>
         <span class="n">psize</span> <span class="o">=</span> <span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">offset</span> <span class="o">-</span> <span class="mi">14</span> <span class="o">-</span> <span class="mi">24</span><span class="p">)</span> <span class="o">/</span> <span class="mi">3</span><span class="p">;</span>
   <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">bpp</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">)</span>
         <span class="n">psize</span> <span class="o">=</span> <span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">offset</span> <span class="o">-</span> <span class="mi">14</span> <span class="o">-</span> <span class="n">info</span><span class="p">.</span><span class="n">hsz</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="n">s</span><span class="o">-&gt;</span><span class="n">img_n</span> <span class="o">=</span> <span class="n">ma</span> <span class="o">?</span> <span class="mi">4</span> <span class="o">:</span> <span class="mi">3</span><span class="p">;</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">req_comp</span> <span class="o">&amp;&amp;</span> <span class="n">req_comp</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">)</span> <span class="c1">// we can directly decode 3 or 4</span>
      <span class="n">target</span> <span class="o">=</span> <span class="n">req_comp</span><span class="p">;</span>
   <span class="k">else</span>
      <span class="n">target</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">img_n</span><span class="p">;</span> <span class="c1">// if they want monochrome, we&#39;ll post-convert</span>

   <span class="n">out</span> <span class="o">=</span> <span class="p">(</span><span class="n">stbi_uc</span> <span class="o">*</span><span class="p">)</span> <span class="n">stbi__malloc</span><span class="p">(</span><span class="n">target</span> <span class="o">*</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">img_x</span> <span class="o">*</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">img_y</span><span class="p">);</span>
   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">out</span><span class="p">)</span> <span class="k">return</span> <span class="n">stbi__errpuc</span><span class="p">(</span><span class="s">&quot;outofmem&quot;</span><span class="p">,</span> <span class="s">&quot;Out of memory&quot;</span><span class="p">);</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">bpp</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="p">{</span>
      <span class="kt">int</span> <span class="n">z</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">psize</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">psize</span> <span class="o">&gt;</span> <span class="mi">256</span><span class="p">)</span> <span class="p">{</span> <span class="n">STBI_FREE</span><span class="p">(</span><span class="n">out</span><span class="p">);</span> <span class="k">return</span> <span class="n">stbi__errpuc</span><span class="p">(</span><span class="s">&quot;invalid&quot;</span><span class="p">,</span> <span class="s">&quot;Corrupt BMP&quot;</span><span class="p">);</span> <span class="p">}</span>
      <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">psize</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
         <span class="n">pal</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">stbi__get8</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
         <span class="n">pal</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">stbi__get8</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
         <span class="n">pal</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">stbi__get8</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
         <span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">hsz</span> <span class="o">!=</span> <span class="mi">12</span><span class="p">)</span> <span class="n">stbi__get8</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
         <span class="n">pal</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">255</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="n">stbi__skip</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">info</span><span class="p">.</span><span class="n">offset</span> <span class="o">-</span> <span class="mi">14</span> <span class="o">-</span> <span class="n">info</span><span class="p">.</span><span class="n">hsz</span> <span class="o">-</span> <span class="n">psize</span> <span class="o">*</span> <span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">hsz</span> <span class="o">==</span> <span class="mi">12</span> <span class="o">?</span> <span class="mi">3</span> <span class="o">:</span> <span class="mi">4</span><span class="p">));</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">bpp</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="n">width</span> <span class="o">=</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">img_x</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
      <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">bpp</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span> <span class="n">width</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">img_x</span><span class="p">;</span>
      <span class="k">else</span> <span class="p">{</span> <span class="n">STBI_FREE</span><span class="p">(</span><span class="n">out</span><span class="p">);</span> <span class="k">return</span> <span class="n">stbi__errpuc</span><span class="p">(</span><span class="s">&quot;bad bpp&quot;</span><span class="p">,</span> <span class="s">&quot;Corrupt BMP&quot;</span><span class="p">);</span> <span class="p">}</span>
      <span class="n">pad</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">width</span><span class="p">)</span><span class="o">&amp;</span><span class="mi">3</span><span class="p">;</span>
      <span class="k">for</span> <span class="p">(</span><span class="n">j</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">img_y</span><span class="p">;</span> <span class="o">++</span><span class="n">j</span><span class="p">)</span> <span class="p">{</span>
         <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">img_x</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
            <span class="kt">int</span> <span class="n">v</span><span class="o">=</span><span class="n">stbi__get8</span><span class="p">(</span><span class="n">s</span><span class="p">),</span><span class="n">v2</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">bpp</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
               <span class="n">v2</span> <span class="o">=</span> <span class="n">v</span> <span class="o">&amp;</span> <span class="mi">15</span><span class="p">;</span>
               <span class="n">v</span> <span class="o">&gt;&gt;=</span> <span class="mi">4</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="n">out</span><span class="p">[</span><span class="n">z</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">pal</span><span class="p">[</span><span class="n">v</span><span class="p">][</span><span class="mi">0</span><span class="p">];</span>
            <span class="n">out</span><span class="p">[</span><span class="n">z</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">pal</span><span class="p">[</span><span class="n">v</span><span class="p">][</span><span class="mi">1</span><span class="p">];</span>
            <span class="n">out</span><span class="p">[</span><span class="n">z</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">pal</span><span class="p">[</span><span class="n">v</span><span class="p">][</span><span class="mi">2</span><span class="p">];</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">target</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="n">out</span><span class="p">[</span><span class="n">z</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mi">255</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span> <span class="o">==</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">img_x</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
            <span class="n">v</span> <span class="o">=</span> <span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">bpp</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span> <span class="o">?</span> <span class="n">stbi__get8</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">:</span> <span class="n">v2</span><span class="p">;</span>
            <span class="n">out</span><span class="p">[</span><span class="n">z</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">pal</span><span class="p">[</span><span class="n">v</span><span class="p">][</span><span class="mi">0</span><span class="p">];</span>
            <span class="n">out</span><span class="p">[</span><span class="n">z</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">pal</span><span class="p">[</span><span class="n">v</span><span class="p">][</span><span class="mi">1</span><span class="p">];</span>
            <span class="n">out</span><span class="p">[</span><span class="n">z</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">pal</span><span class="p">[</span><span class="n">v</span><span class="p">][</span><span class="mi">2</span><span class="p">];</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">target</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="n">out</span><span class="p">[</span><span class="n">z</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mi">255</span><span class="p">;</span>
         <span class="p">}</span>
         <span class="n">stbi__skip</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">pad</span><span class="p">);</span>
      <span class="p">}</span>
   <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="kt">int</span> <span class="n">rshift</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">gshift</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">bshift</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">ashift</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">rcount</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">gcount</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">bcount</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">acount</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
      <span class="kt">int</span> <span class="n">z</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="kt">int</span> <span class="n">easy</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
      <span class="n">stbi__skip</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">info</span><span class="p">.</span><span class="n">offset</span> <span class="o">-</span> <span class="mi">14</span> <span class="o">-</span> <span class="n">info</span><span class="p">.</span><span class="n">hsz</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">bpp</span> <span class="o">==</span> <span class="mi">24</span><span class="p">)</span> <span class="n">width</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">img_x</span><span class="p">;</span>
      <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">bpp</span> <span class="o">==</span> <span class="mi">16</span><span class="p">)</span> <span class="n">width</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">img_x</span><span class="p">;</span>
      <span class="k">else</span> <span class="cm">/* bpp = 32 and pad = 0 */</span> <span class="n">width</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
      <span class="n">pad</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">width</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">bpp</span> <span class="o">==</span> <span class="mi">24</span><span class="p">)</span> <span class="p">{</span>
         <span class="n">easy</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">bpp</span> <span class="o">==</span> <span class="mi">32</span><span class="p">)</span> <span class="p">{</span>
         <span class="k">if</span> <span class="p">(</span><span class="n">mb</span> <span class="o">==</span> <span class="mh">0xff</span> <span class="o">&amp;&amp;</span> <span class="n">mg</span> <span class="o">==</span> <span class="mh">0xff00</span> <span class="o">&amp;&amp;</span> <span class="n">mr</span> <span class="o">==</span> <span class="mh">0x00ff0000</span> <span class="o">&amp;&amp;</span> <span class="n">ma</span> <span class="o">==</span> <span class="mh">0xff000000</span><span class="p">)</span>
            <span class="n">easy</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">easy</span><span class="p">)</span> <span class="p">{</span>
         <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mr</span> <span class="o">||</span> <span class="o">!</span><span class="n">mg</span> <span class="o">||</span> <span class="o">!</span><span class="n">mb</span><span class="p">)</span> <span class="p">{</span> <span class="n">STBI_FREE</span><span class="p">(</span><span class="n">out</span><span class="p">);</span> <span class="k">return</span> <span class="n">stbi__errpuc</span><span class="p">(</span><span class="s">&quot;bad masks&quot;</span><span class="p">,</span> <span class="s">&quot;Corrupt BMP&quot;</span><span class="p">);</span> <span class="p">}</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-139'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-139'>#</a>
      </div>
      <p>right shift amt to put high bit in position #7</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>         <span class="n">rshift</span> <span class="o">=</span> <span class="n">stbi__high_bit</span><span class="p">(</span><span class="n">mr</span><span class="p">)</span><span class="o">-</span><span class="mi">7</span><span class="p">;</span> <span class="n">rcount</span> <span class="o">=</span> <span class="n">stbi__bitcount</span><span class="p">(</span><span class="n">mr</span><span class="p">);</span>
         <span class="n">gshift</span> <span class="o">=</span> <span class="n">stbi__high_bit</span><span class="p">(</span><span class="n">mg</span><span class="p">)</span><span class="o">-</span><span class="mi">7</span><span class="p">;</span> <span class="n">gcount</span> <span class="o">=</span> <span class="n">stbi__bitcount</span><span class="p">(</span><span class="n">mg</span><span class="p">);</span>
         <span class="n">bshift</span> <span class="o">=</span> <span class="n">stbi__high_bit</span><span class="p">(</span><span class="n">mb</span><span class="p">)</span><span class="o">-</span><span class="mi">7</span><span class="p">;</span> <span class="n">bcount</span> <span class="o">=</span> <span class="n">stbi__bitcount</span><span class="p">(</span><span class="n">mb</span><span class="p">);</span>
         <span class="n">ashift</span> <span class="o">=</span> <span class="n">stbi__high_bit</span><span class="p">(</span><span class="n">ma</span><span class="p">)</span><span class="o">-</span><span class="mi">7</span><span class="p">;</span> <span class="n">acount</span> <span class="o">=</span> <span class="n">stbi__bitcount</span><span class="p">(</span><span class="n">ma</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">for</span> <span class="p">(</span><span class="n">j</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">img_y</span><span class="p">;</span> <span class="o">++</span><span class="n">j</span><span class="p">)</span> <span class="p">{</span>
         <span class="k">if</span> <span class="p">(</span><span class="n">easy</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">img_x</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
               <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">a</span><span class="p">;</span>
               <span class="n">out</span><span class="p">[</span><span class="n">z</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">stbi__get8</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
               <span class="n">out</span><span class="p">[</span><span class="n">z</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">stbi__get8</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
               <span class="n">out</span><span class="p">[</span><span class="n">z</span><span class="o">+</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">stbi__get8</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
               <span class="n">z</span> <span class="o">+=</span> <span class="mi">3</span><span class="p">;</span>
               <span class="n">a</span> <span class="o">=</span> <span class="p">(</span><span class="n">easy</span> <span class="o">==</span> <span class="mi">2</span> <span class="o">?</span> <span class="n">stbi__get8</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">:</span> <span class="mi">255</span><span class="p">);</span>
               <span class="n">all_a</span> <span class="o">|=</span> <span class="n">a</span><span class="p">;</span>
               <span class="k">if</span> <span class="p">(</span><span class="n">target</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="n">out</span><span class="p">[</span><span class="n">z</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span><span class="p">;</span>
            <span class="p">}</span>
         <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="kt">int</span> <span class="n">bpp</span> <span class="o">=</span> <span class="n">info</span><span class="p">.</span><span class="n">bpp</span><span class="p">;</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">img_x</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
               <span class="n">stbi__uint32</span> <span class="n">v</span> <span class="o">=</span> <span class="p">(</span><span class="n">bpp</span> <span class="o">==</span> <span class="mi">16</span> <span class="o">?</span> <span class="p">(</span><span class="n">stbi__uint32</span><span class="p">)</span> <span class="n">stbi__get16le</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">:</span> <span class="n">stbi__get32le</span><span class="p">(</span><span class="n">s</span><span class="p">));</span>
               <span class="kt">int</span> <span class="n">a</span><span class="p">;</span>
               <span class="n">out</span><span class="p">[</span><span class="n">z</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">STBI__BYTECAST</span><span class="p">(</span><span class="n">stbi__shiftsigned</span><span class="p">(</span><span class="n">v</span> <span class="o">&amp;</span> <span class="n">mr</span><span class="p">,</span> <span class="n">rshift</span><span class="p">,</span> <span class="n">rcount</span><span class="p">));</span>
               <span class="n">out</span><span class="p">[</span><span class="n">z</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">STBI__BYTECAST</span><span class="p">(</span><span class="n">stbi__shiftsigned</span><span class="p">(</span><span class="n">v</span> <span class="o">&amp;</span> <span class="n">mg</span><span class="p">,</span> <span class="n">gshift</span><span class="p">,</span> <span class="n">gcount</span><span class="p">));</span>
               <span class="n">out</span><span class="p">[</span><span class="n">z</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">STBI__BYTECAST</span><span class="p">(</span><span class="n">stbi__shiftsigned</span><span class="p">(</span><span class="n">v</span> <span class="o">&amp;</span> <span class="n">mb</span><span class="p">,</span> <span class="n">bshift</span><span class="p">,</span> <span class="n">bcount</span><span class="p">));</span>
               <span class="n">a</span> <span class="o">=</span> <span class="p">(</span><span class="n">ma</span> <span class="o">?</span> <span class="n">stbi__shiftsigned</span><span class="p">(</span><span class="n">v</span> <span class="o">&amp;</span> <span class="n">ma</span><span class="p">,</span> <span class="n">ashift</span><span class="p">,</span> <span class="n">acount</span><span class="p">)</span> <span class="o">:</span> <span class="mi">255</span><span class="p">);</span>
               <span class="n">all_a</span> <span class="o">|=</span> <span class="n">a</span><span class="p">;</span>
               <span class="k">if</span> <span class="p">(</span><span class="n">target</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="n">out</span><span class="p">[</span><span class="n">z</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">STBI__BYTECAST</span><span class="p">(</span><span class="n">a</span><span class="p">);</span>
            <span class="p">}</span>
         <span class="p">}</span>
         <span class="n">stbi__skip</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">pad</span><span class="p">);</span>
      <span class="p">}</span>
   <span class="p">}</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-140'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-140'>#</a>
      </div>
      <p>if alpha channel is all 0s, replace with all 255s</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>   <span class="k">if</span> <span class="p">(</span><span class="n">target</span> <span class="o">==</span> <span class="mi">4</span> <span class="o">&amp;&amp;</span> <span class="n">all_a</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
      <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">4</span><span class="o">*</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">img_x</span><span class="o">*</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">img_y</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">-=</span> <span class="mi">4</span><span class="p">)</span>
         <span class="n">out</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">255</span><span class="p">;</span>

   <span class="k">if</span> <span class="p">(</span><span class="n">flip_vertically</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">stbi_uc</span> <span class="n">t</span><span class="p">;</span>
      <span class="k">for</span> <span class="p">(</span><span class="n">j</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">img_y</span><span class="o">&gt;&gt;</span><span class="mi">1</span><span class="p">;</span> <span class="o">++</span><span class="n">j</span><span class="p">)</span> <span class="p">{</span>
         <span class="n">stbi_uc</span> <span class="o">*</span><span class="n">p1</span> <span class="o">=</span> <span class="n">out</span> <span class="o">+</span>      <span class="n">j</span>     <span class="o">*</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">img_x</span><span class="o">*</span><span class="n">target</span><span class="p">;</span>
         <span class="n">stbi_uc</span> <span class="o">*</span><span class="n">p2</span> <span class="o">=</span> <span class="n">out</span> <span class="o">+</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">img_y</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="n">j</span><span class="p">)</span><span class="o">*</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">img_x</span><span class="o">*</span><span class="n">target</span><span class="p">;</span>
         <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">img_x</span><span class="o">*</span><span class="n">target</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">p1</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">p1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">p2</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">p2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">t</span><span class="p">;</span>
         <span class="p">}</span>
      <span class="p">}</span>
   <span class="p">}</span>

   <span class="k">if</span> <span class="p">(</span><span class="n">req_comp</span> <span class="o">&amp;&amp;</span> <span class="n">req_comp</span> <span class="o">!=</span> <span class="n">target</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">out</span> <span class="o">=</span> <span class="n">stbi__convert_format</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">req_comp</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">img_x</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">img_y</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">out</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="k">return</span> <span class="n">out</span><span class="p">;</span> <span class="c1">// stbi__convert_format frees input on failure</span>
   <span class="p">}</span>

   <span class="o">*</span><span class="n">x</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">img_x</span><span class="p">;</span>
   <span class="o">*</span><span class="n">y</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">img_y</span><span class="p">;</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">comp</span><span class="p">)</span> <span class="o">*</span><span class="n">comp</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">img_n</span><span class="p">;</span>
   <span class="k">return</span> <span class="n">out</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-141'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-141'>#</a>
      </div>
      <p>Targa Truevision - TGA
by Jonathan Dummer</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="cp">#ifndef STBI_NO_TGA</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-142'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-142'>#</a>
      </div>
      <p>returns STBI_rgb or whatever, 0 on error</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">static</span> <span class="kt">int</span> <span class="nf">stbi__tga_get_comp</span><span class="p">(</span><span class="kt">int</span> <span class="n">bits_per_pixel</span><span class="p">,</span> <span class="kt">int</span> <span class="n">is_grey</span><span class="p">,</span> <span class="kt">int</span><span class="o">*</span> <span class="n">is_rgb16</span><span class="p">)</span>
<span class="p">{</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-143'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-143'>#</a>
      </div>
      <p>only RGB or RGBA (incl. 16bit) or grey allowed</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>   <span class="k">if</span><span class="p">(</span><span class="n">is_rgb16</span><span class="p">)</span> <span class="o">*</span><span class="n">is_rgb16</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
   <span class="k">switch</span><span class="p">(</span><span class="n">bits_per_pixel</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">case</span> <span class="mi">8</span><span class="o">:</span>  <span class="k">return</span> <span class="n">STBI_grey</span><span class="p">;</span>
      <span class="k">case</span> <span class="mi">16</span><span class="o">:</span> <span class="k">if</span><span class="p">(</span><span class="n">is_grey</span><span class="p">)</span> <span class="k">return</span> <span class="n">STBI_grey_alpha</span><span class="p">;</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-144'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-144'>#</a>
      </div>
      <p>else: fall-through</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>      <span class="k">case</span> <span class="mi">15</span><span class="o">:</span> <span class="k">if</span><span class="p">(</span><span class="n">is_rgb16</span><span class="p">)</span> <span class="o">*</span><span class="n">is_rgb16</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
            <span class="k">return</span> <span class="n">STBI_rgb</span><span class="p">;</span>
      <span class="k">case</span> <span class="mi">24</span><span class="o">:</span> <span class="c1">// fall-through</span>
      <span class="k">case</span> <span class="mi">32</span><span class="o">:</span> <span class="k">return</span> <span class="n">bits_per_pixel</span><span class="o">/</span><span class="mi">8</span><span class="p">;</span>
      <span class="k">default</span><span class="o">:</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
   <span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">stbi__tga_info</span><span class="p">(</span><span class="n">stbi__context</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">y</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">comp</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">tga_w</span><span class="p">,</span> <span class="n">tga_h</span><span class="p">,</span> <span class="n">tga_comp</span><span class="p">,</span> <span class="n">tga_image_type</span><span class="p">,</span> <span class="n">tga_bits_per_pixel</span><span class="p">,</span> <span class="n">tga_colormap_bpp</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">sz</span><span class="p">,</span> <span class="n">tga_colormap_type</span><span class="p">;</span>
    <span class="n">stbi__get8</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>                   <span class="c1">// discard Offset</span>
    <span class="n">tga_colormap_type</span> <span class="o">=</span> <span class="n">stbi__get8</span><span class="p">(</span><span class="n">s</span><span class="p">);</span> <span class="c1">// colormap type</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">tga_colormap_type</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="p">)</span> <span class="p">{</span>
        <span class="n">stbi__rewind</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>      <span class="c1">// only RGB or indexed allowed</span>
    <span class="p">}</span>
    <span class="n">tga_image_type</span> <span class="o">=</span> <span class="n">stbi__get8</span><span class="p">(</span><span class="n">s</span><span class="p">);</span> <span class="c1">// image type</span>
    <span class="k">if</span> <span class="p">(</span> <span class="n">tga_colormap_type</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">)</span> <span class="p">{</span> <span class="c1">// colormapped (paletted) image</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">tga_image_type</span> <span class="o">!=</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">tga_image_type</span> <span class="o">!=</span> <span class="mi">9</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">stbi__rewind</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
            <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">stbi__skip</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="mi">4</span><span class="p">);</span>       <span class="c1">// skip index of first colormap entry and number of entries</span>
        <span class="n">sz</span> <span class="o">=</span> <span class="n">stbi__get8</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>    <span class="c1">//   check bits per palette color entry</span>
        <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">sz</span> <span class="o">!=</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">sz</span> <span class="o">!=</span> <span class="mi">15</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">sz</span> <span class="o">!=</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">sz</span> <span class="o">!=</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">sz</span> <span class="o">!=</span> <span class="mi">32</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
            <span class="n">stbi__rewind</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
            <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">stbi__skip</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="mi">4</span><span class="p">);</span>       <span class="c1">// skip image x and y origin</span>
        <span class="n">tga_colormap_bpp</span> <span class="o">=</span> <span class="n">sz</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="c1">// &quot;normal&quot; image w/o colormap - only RGB or grey allowed, +/- RLE</span>
        <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">tga_image_type</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">tga_image_type</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">tga_image_type</span> <span class="o">!=</span> <span class="mi">10</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">tga_image_type</span> <span class="o">!=</span> <span class="mi">11</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
            <span class="n">stbi__rewind</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
            <span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="c1">// only RGB or grey allowed, +/- RLE</span>
        <span class="p">}</span>
        <span class="n">stbi__skip</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="mi">9</span><span class="p">);</span> <span class="c1">// skip colormap specification and image x/y origin</span>
        <span class="n">tga_colormap_bpp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">tga_w</span> <span class="o">=</span> <span class="n">stbi__get16le</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">tga_w</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="p">)</span> <span class="p">{</span>
        <span class="n">stbi__rewind</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>   <span class="c1">// test width</span>
    <span class="p">}</span>
    <span class="n">tga_h</span> <span class="o">=</span> <span class="n">stbi__get16le</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">tga_h</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="p">)</span> <span class="p">{</span>
        <span class="n">stbi__rewind</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>   <span class="c1">// test height</span>
    <span class="p">}</span>
    <span class="n">tga_bits_per_pixel</span> <span class="o">=</span> <span class="n">stbi__get8</span><span class="p">(</span><span class="n">s</span><span class="p">);</span> <span class="c1">// bits per pixel</span>
    <span class="n">stbi__get8</span><span class="p">(</span><span class="n">s</span><span class="p">);</span> <span class="c1">// ignore alpha bits</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">tga_colormap_bpp</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span><span class="p">((</span><span class="n">tga_bits_per_pixel</span> <span class="o">!=</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">tga_bits_per_pixel</span> <span class="o">!=</span> <span class="mi">16</span><span class="p">))</span> <span class="p">{</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-145'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-145'>#</a>
      </div>
      <p>when using a colormap, tga_bits_per_pixel is the size of the indexes
I don't think anything but 8 or 16bit indexes makes sense</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="n">stbi__rewind</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
            <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">tga_comp</span> <span class="o">=</span> <span class="n">stbi__tga_get_comp</span><span class="p">(</span><span class="n">tga_colormap_bpp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">tga_comp</span> <span class="o">=</span> <span class="n">stbi__tga_get_comp</span><span class="p">(</span><span class="n">tga_bits_per_pixel</span><span class="p">,</span> <span class="p">(</span><span class="n">tga_image_type</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">tga_image_type</span> <span class="o">==</span> <span class="mi">11</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">tga_comp</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">stbi__rewind</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
      <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">*</span><span class="n">x</span> <span class="o">=</span> <span class="n">tga_w</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="o">*</span><span class="n">y</span> <span class="o">=</span> <span class="n">tga_h</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">comp</span><span class="p">)</span> <span class="o">*</span><span class="n">comp</span> <span class="o">=</span> <span class="n">tga_comp</span><span class="p">;</span>
    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>                   <span class="c1">// seems to have passed everything</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">stbi__tga_test</span><span class="p">(</span><span class="n">stbi__context</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
   <span class="kt">int</span> <span class="n">res</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
   <span class="kt">int</span> <span class="n">sz</span><span class="p">,</span> <span class="n">tga_color_type</span><span class="p">;</span>
   <span class="n">stbi__get8</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>      <span class="c1">//   discard Offset</span>
   <span class="n">tga_color_type</span> <span class="o">=</span> <span class="n">stbi__get8</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>   <span class="c1">//   color type</span>
   <span class="k">if</span> <span class="p">(</span> <span class="n">tga_color_type</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="p">)</span> <span class="k">goto</span> <span class="n">errorEnd</span><span class="p">;</span>   <span class="c1">//   only RGB or indexed allowed</span>
   <span class="n">sz</span> <span class="o">=</span> <span class="n">stbi__get8</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>   <span class="c1">//   image type</span>
   <span class="k">if</span> <span class="p">(</span> <span class="n">tga_color_type</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">)</span> <span class="p">{</span> <span class="c1">// colormapped (paletted) image</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">sz</span> <span class="o">!=</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">sz</span> <span class="o">!=</span> <span class="mi">9</span><span class="p">)</span> <span class="k">goto</span> <span class="n">errorEnd</span><span class="p">;</span> <span class="c1">// colortype 1 demands image type 1 or 9</span>
      <span class="n">stbi__skip</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="mi">4</span><span class="p">);</span>       <span class="c1">// skip index of first colormap entry and number of entries</span>
      <span class="n">sz</span> <span class="o">=</span> <span class="n">stbi__get8</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>    <span class="c1">//   check bits per palette color entry</span>
      <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">sz</span> <span class="o">!=</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">sz</span> <span class="o">!=</span> <span class="mi">15</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">sz</span> <span class="o">!=</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">sz</span> <span class="o">!=</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">sz</span> <span class="o">!=</span> <span class="mi">32</span><span class="p">)</span> <span class="p">)</span> <span class="k">goto</span> <span class="n">errorEnd</span><span class="p">;</span>
      <span class="n">stbi__skip</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="mi">4</span><span class="p">);</span>       <span class="c1">// skip image x and y origin</span>
   <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="c1">// &quot;normal&quot; image w/o colormap</span>
      <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">sz</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">sz</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">sz</span> <span class="o">!=</span> <span class="mi">10</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">sz</span> <span class="o">!=</span> <span class="mi">11</span><span class="p">)</span> <span class="p">)</span> <span class="k">goto</span> <span class="n">errorEnd</span><span class="p">;</span> <span class="c1">// only RGB or grey allowed, +/- RLE</span>
      <span class="n">stbi__skip</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="mi">9</span><span class="p">);</span> <span class="c1">// skip colormap specification and image x/y origin</span>
   <span class="p">}</span>
   <span class="k">if</span> <span class="p">(</span> <span class="n">stbi__get16le</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="p">)</span> <span class="k">goto</span> <span class="n">errorEnd</span><span class="p">;</span>      <span class="c1">//   test width</span>
   <span class="k">if</span> <span class="p">(</span> <span class="n">stbi__get16le</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="p">)</span> <span class="k">goto</span> <span class="n">errorEnd</span><span class="p">;</span>      <span class="c1">//   test height</span>
   <span class="n">sz</span> <span class="o">=</span> <span class="n">stbi__get8</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>   <span class="c1">//   bits per pixel</span>
   <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">tga_color_type</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">sz</span> <span class="o">!=</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">sz</span> <span class="o">!=</span> <span class="mi">16</span><span class="p">)</span> <span class="p">)</span> <span class="k">goto</span> <span class="n">errorEnd</span><span class="p">;</span> <span class="c1">// for colormapped images, bpp is size of an index</span>
   <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">sz</span> <span class="o">!=</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">sz</span> <span class="o">!=</span> <span class="mi">15</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">sz</span> <span class="o">!=</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">sz</span> <span class="o">!=</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">sz</span> <span class="o">!=</span> <span class="mi">32</span><span class="p">)</span> <span class="p">)</span> <span class="k">goto</span> <span class="n">errorEnd</span><span class="p">;</span>

   <span class="n">res</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="c1">// if we got this far, everything&#39;s good and we can return 1 instead of 0</span>

<span class="nl">errorEnd</span><span class="p">:</span>
   <span class="n">stbi__rewind</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
   <span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-146'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-146'>#</a>
      </div>
      <p>read 16bit value and convert to 24bit RGB</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="kt">void</span> <span class="nf">stbi__tga_read_rgb16</span><span class="p">(</span><span class="n">stbi__context</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="n">stbi_uc</span><span class="o">*</span> <span class="n">out</span><span class="p">)</span>
<span class="p">{</span>
   <span class="n">stbi__uint16</span> <span class="n">px</span> <span class="o">=</span> <span class="n">stbi__get16le</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
   <span class="n">stbi__uint16</span> <span class="n">fiveBitMask</span> <span class="o">=</span> <span class="mi">31</span><span class="p">;</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-147'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-147'>#</a>
      </div>
      <p>we have 3 channels with 5bits each</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>   <span class="kt">int</span> <span class="n">r</span> <span class="o">=</span> <span class="p">(</span><span class="n">px</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">fiveBitMask</span><span class="p">;</span>
   <span class="kt">int</span> <span class="n">g</span> <span class="o">=</span> <span class="p">(</span><span class="n">px</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">fiveBitMask</span><span class="p">;</span>
   <span class="kt">int</span> <span class="n">b</span> <span class="o">=</span> <span class="n">px</span> <span class="o">&amp;</span> <span class="n">fiveBitMask</span><span class="p">;</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-148'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-148'>#</a>
      </div>
      <p>Note that this saves the data in RGB(A) order, so it doesn't need to be swapped later</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>   <span class="n">out</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">r</span> <span class="o">*</span> <span class="mi">255</span><span class="p">)</span><span class="o">/</span><span class="mi">31</span><span class="p">;</span>
   <span class="n">out</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">g</span> <span class="o">*</span> <span class="mi">255</span><span class="p">)</span><span class="o">/</span><span class="mi">31</span><span class="p">;</span>
   <span class="n">out</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">b</span> <span class="o">*</span> <span class="mi">255</span><span class="p">)</span><span class="o">/</span><span class="mi">31</span><span class="p">;</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-149'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-149'>#</a>
      </div>
      <p>some people claim that the most significant bit might be used for alpha
(possibly if an alpha-bit is set in the "image descriptor byte")
but that only made 16bit test images completely translucent..
so let's treat all 15 and 16bit TGAs as RGB with no alpha.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="p">}</span>

<span class="k">static</span> <span class="n">stbi_uc</span> <span class="o">*</span><span class="nf">stbi__tga_load</span><span class="p">(</span><span class="n">stbi__context</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">y</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">comp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">req_comp</span><span class="p">)</span>
<span class="p">{</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-150'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-150'>#</a>
      </div>
      <p>read in the TGA header stuff</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>   <span class="kt">int</span> <span class="n">tga_offset</span> <span class="o">=</span> <span class="n">stbi__get8</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
   <span class="kt">int</span> <span class="n">tga_indexed</span> <span class="o">=</span> <span class="n">stbi__get8</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
   <span class="kt">int</span> <span class="n">tga_image_type</span> <span class="o">=</span> <span class="n">stbi__get8</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
   <span class="kt">int</span> <span class="n">tga_is_RLE</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
   <span class="kt">int</span> <span class="n">tga_palette_start</span> <span class="o">=</span> <span class="n">stbi__get16le</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
   <span class="kt">int</span> <span class="n">tga_palette_len</span> <span class="o">=</span> <span class="n">stbi__get16le</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
   <span class="kt">int</span> <span class="n">tga_palette_bits</span> <span class="o">=</span> <span class="n">stbi__get8</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
   <span class="kt">int</span> <span class="n">tga_x_origin</span> <span class="o">=</span> <span class="n">stbi__get16le</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
   <span class="kt">int</span> <span class="n">tga_y_origin</span> <span class="o">=</span> <span class="n">stbi__get16le</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
   <span class="kt">int</span> <span class="n">tga_width</span> <span class="o">=</span> <span class="n">stbi__get16le</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
   <span class="kt">int</span> <span class="n">tga_height</span> <span class="o">=</span> <span class="n">stbi__get16le</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
   <span class="kt">int</span> <span class="n">tga_bits_per_pixel</span> <span class="o">=</span> <span class="n">stbi__get8</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
   <span class="kt">int</span> <span class="n">tga_comp</span><span class="p">,</span> <span class="n">tga_rgb16</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
   <span class="kt">int</span> <span class="n">tga_inverted</span> <span class="o">=</span> <span class="n">stbi__get8</span><span class="p">(</span><span class="n">s</span><span class="p">);</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-151'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-151'>#</a>
      </div>
      <p>int tga_alpha_bits = tga_inverted &amp; 15; // the 4 lowest bits - unused (useless?)
  image data</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>   <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">tga_data</span><span class="p">;</span>
   <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">tga_palette</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
   <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
   <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">raw_data</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
   <span class="kt">int</span> <span class="n">RLE_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
   <span class="kt">int</span> <span class="n">RLE_repeating</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
   <span class="kt">int</span> <span class="n">read_next_pixel</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-152'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-152'>#</a>
      </div>
      <p>do a tiny bit of precessing</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>   <span class="k">if</span> <span class="p">(</span> <span class="n">tga_image_type</span> <span class="o">&gt;=</span> <span class="mi">8</span> <span class="p">)</span>
   <span class="p">{</span>
      <span class="n">tga_image_type</span> <span class="o">-=</span> <span class="mi">8</span><span class="p">;</span>
      <span class="n">tga_is_RLE</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
   <span class="p">}</span>
   <span class="n">tga_inverted</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="p">((</span><span class="n">tga_inverted</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">);</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-153'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-153'>#</a>
      </div>
      <p>If I'm paletted, then I'll use the number of bits from the palette</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>   <span class="k">if</span> <span class="p">(</span> <span class="n">tga_indexed</span> <span class="p">)</span> <span class="n">tga_comp</span> <span class="o">=</span> <span class="n">stbi__tga_get_comp</span><span class="p">(</span><span class="n">tga_palette_bits</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tga_rgb16</span><span class="p">);</span>
   <span class="k">else</span> <span class="n">tga_comp</span> <span class="o">=</span> <span class="n">stbi__tga_get_comp</span><span class="p">(</span><span class="n">tga_bits_per_pixel</span><span class="p">,</span> <span class="p">(</span><span class="n">tga_image_type</span> <span class="o">==</span> <span class="mi">3</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">tga_rgb16</span><span class="p">);</span>

   <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">tga_comp</span><span class="p">)</span> <span class="c1">// shouldn&#39;t really happen, stbi__tga_test() should have ensured basic consistency</span>
      <span class="k">return</span> <span class="n">stbi__errpuc</span><span class="p">(</span><span class="s">&quot;bad format&quot;</span><span class="p">,</span> <span class="s">&quot;Can&#39;t find out TGA pixelformat&quot;</span><span class="p">);</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-154'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-154'>#</a>
      </div>
      <p>tga info</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>   <span class="o">*</span><span class="n">x</span> <span class="o">=</span> <span class="n">tga_width</span><span class="p">;</span>
   <span class="o">*</span><span class="n">y</span> <span class="o">=</span> <span class="n">tga_height</span><span class="p">;</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">comp</span><span class="p">)</span> <span class="o">*</span><span class="n">comp</span> <span class="o">=</span> <span class="n">tga_comp</span><span class="p">;</span>

   <span class="n">tga_data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">stbi__malloc</span><span class="p">(</span> <span class="p">(</span><span class="kt">size_t</span><span class="p">)</span><span class="n">tga_width</span> <span class="o">*</span> <span class="n">tga_height</span> <span class="o">*</span> <span class="n">tga_comp</span> <span class="p">);</span>
   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tga_data</span><span class="p">)</span> <span class="k">return</span> <span class="n">stbi__errpuc</span><span class="p">(</span><span class="s">&quot;outofmem&quot;</span><span class="p">,</span> <span class="s">&quot;Out of memory&quot;</span><span class="p">);</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-155'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-155'>#</a>
      </div>
      <p>skip to the data's starting position (offset usually = 0)</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>   <span class="n">stbi__skip</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">tga_offset</span> <span class="p">);</span>

   <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">tga_indexed</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">tga_is_RLE</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">tga_rgb16</span> <span class="p">)</span> <span class="p">{</span>
      <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">tga_height</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
         <span class="kt">int</span> <span class="n">row</span> <span class="o">=</span> <span class="n">tga_inverted</span> <span class="o">?</span> <span class="n">tga_height</span> <span class="o">-</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">:</span> <span class="n">i</span><span class="p">;</span>
         <span class="n">stbi_uc</span> <span class="o">*</span><span class="n">tga_row</span> <span class="o">=</span> <span class="n">tga_data</span> <span class="o">+</span> <span class="n">row</span><span class="o">*</span><span class="n">tga_width</span><span class="o">*</span><span class="n">tga_comp</span><span class="p">;</span>
         <span class="n">stbi__getn</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">tga_row</span><span class="p">,</span> <span class="n">tga_width</span> <span class="o">*</span> <span class="n">tga_comp</span><span class="p">);</span>
      <span class="p">}</span>
   <span class="p">}</span> <span class="k">else</span>  <span class="p">{</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-156'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-156'>#</a>
      </div>
      <p>do I need to load a palette?</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>      <span class="k">if</span> <span class="p">(</span> <span class="n">tga_indexed</span><span class="p">)</span>
      <span class="p">{</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-157'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-157'>#</a>
      </div>
      <p>any data to skip? (offset usually = 0)</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>         <span class="n">stbi__skip</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">tga_palette_start</span> <span class="p">);</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-158'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-158'>#</a>
      </div>
      <p>load the palette</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>         <span class="n">tga_palette</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">stbi__malloc</span><span class="p">(</span> <span class="n">tga_palette_len</span> <span class="o">*</span> <span class="n">tga_comp</span> <span class="p">);</span>
         <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tga_palette</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">STBI_FREE</span><span class="p">(</span><span class="n">tga_data</span><span class="p">);</span>
            <span class="k">return</span> <span class="n">stbi__errpuc</span><span class="p">(</span><span class="s">&quot;outofmem&quot;</span><span class="p">,</span> <span class="s">&quot;Out of memory&quot;</span><span class="p">);</span>
         <span class="p">}</span>
         <span class="k">if</span> <span class="p">(</span><span class="n">tga_rgb16</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">stbi_uc</span> <span class="o">*</span><span class="n">pal_entry</span> <span class="o">=</span> <span class="n">tga_palette</span><span class="p">;</span>
            <span class="n">STBI_ASSERT</span><span class="p">(</span><span class="n">tga_comp</span> <span class="o">==</span> <span class="n">STBI_rgb</span><span class="p">);</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">tga_palette_len</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
               <span class="n">stbi__tga_read_rgb16</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">pal_entry</span><span class="p">);</span>
               <span class="n">pal_entry</span> <span class="o">+=</span> <span class="n">tga_comp</span><span class="p">;</span>
            <span class="p">}</span>
         <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">stbi__getn</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">tga_palette</span><span class="p">,</span> <span class="n">tga_palette_len</span> <span class="o">*</span> <span class="n">tga_comp</span><span class="p">))</span> <span class="p">{</span>
               <span class="n">STBI_FREE</span><span class="p">(</span><span class="n">tga_data</span><span class="p">);</span>
               <span class="n">STBI_FREE</span><span class="p">(</span><span class="n">tga_palette</span><span class="p">);</span>
               <span class="k">return</span> <span class="n">stbi__errpuc</span><span class="p">(</span><span class="s">&quot;bad palette&quot;</span><span class="p">,</span> <span class="s">&quot;Corrupt TGA&quot;</span><span class="p">);</span>
         <span class="p">}</span>
      <span class="p">}</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-159'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-159'>#</a>
      </div>
      <p>load the data</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>      <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">tga_width</span> <span class="o">*</span> <span class="n">tga_height</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
      <span class="p">{</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-160'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-160'>#</a>
      </div>
      <p>if I'm in RLE mode, do I need to get a RLE stbi__pngchunk?</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>         <span class="k">if</span> <span class="p">(</span> <span class="n">tga_is_RLE</span> <span class="p">)</span>
         <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span> <span class="n">RLE_count</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span>
            <span class="p">{</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-161'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-161'>#</a>
      </div>
      <p>yep, get the next byte as a RLE command</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>               <span class="kt">int</span> <span class="n">RLE_cmd</span> <span class="o">=</span> <span class="n">stbi__get8</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
               <span class="n">RLE_count</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="n">RLE_cmd</span> <span class="o">&amp;</span> <span class="mi">127</span><span class="p">);</span>
               <span class="n">RLE_repeating</span> <span class="o">=</span> <span class="n">RLE_cmd</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">;</span>
               <span class="n">read_next_pixel</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">RLE_repeating</span> <span class="p">)</span>
            <span class="p">{</span>
               <span class="n">read_next_pixel</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
            <span class="p">}</span>
         <span class="p">}</span> <span class="k">else</span>
         <span class="p">{</span>
            <span class="n">read_next_pixel</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
         <span class="p">}</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-162'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-162'>#</a>
      </div>
      <p>OK, if I need to read a pixel, do it now</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>         <span class="k">if</span> <span class="p">(</span> <span class="n">read_next_pixel</span> <span class="p">)</span>
         <span class="p">{</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-163'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-163'>#</a>
      </div>
      <p>load however much data we did have</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="k">if</span> <span class="p">(</span> <span class="n">tga_indexed</span> <span class="p">)</span>
            <span class="p">{</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-164'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-164'>#</a>
      </div>
      <p>read in index, then perform the lookup</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>               <span class="kt">int</span> <span class="n">pal_idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">tga_bits_per_pixel</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span> <span class="o">?</span> <span class="n">stbi__get8</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">:</span> <span class="n">stbi__get16le</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
               <span class="k">if</span> <span class="p">(</span> <span class="n">pal_idx</span> <span class="o">&gt;=</span> <span class="n">tga_palette_len</span> <span class="p">)</span> <span class="p">{</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-165'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-165'>#</a>
      </div>
      <p>invalid index</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>                  <span class="n">pal_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
               <span class="p">}</span>
               <span class="n">pal_idx</span> <span class="o">*=</span> <span class="n">tga_comp</span><span class="p">;</span>
               <span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">tga_comp</span><span class="p">;</span> <span class="o">++</span><span class="n">j</span><span class="p">)</span> <span class="p">{</span>
                  <span class="n">raw_data</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">tga_palette</span><span class="p">[</span><span class="n">pal_idx</span><span class="o">+</span><span class="n">j</span><span class="p">];</span>
               <span class="p">}</span>
            <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">tga_rgb16</span><span class="p">)</span> <span class="p">{</span>
               <span class="n">STBI_ASSERT</span><span class="p">(</span><span class="n">tga_comp</span> <span class="o">==</span> <span class="n">STBI_rgb</span><span class="p">);</span>
               <span class="n">stbi__tga_read_rgb16</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">raw_data</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-166'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-166'>#</a>
      </div>
      <p>read in the data raw</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>               <span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">tga_comp</span><span class="p">;</span> <span class="o">++</span><span class="n">j</span><span class="p">)</span> <span class="p">{</span>
                  <span class="n">raw_data</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">stbi__get8</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
               <span class="p">}</span>
            <span class="p">}</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-167'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-167'>#</a>
      </div>
      <p>clear the reading flag for the next pixel</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="n">read_next_pixel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
         <span class="p">}</span> <span class="c1">// end of reading a pixel</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-168'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-168'>#</a>
      </div>
      <p>copy data</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>         <span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">tga_comp</span><span class="p">;</span> <span class="o">++</span><span class="n">j</span><span class="p">)</span>
           <span class="n">tga_data</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="n">tga_comp</span><span class="o">+</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">raw_data</span><span class="p">[</span><span class="n">j</span><span class="p">];</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-169'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-169'>#</a>
      </div>
      <p>in case we're in RLE mode, keep counting down</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>         <span class="o">--</span><span class="n">RLE_count</span><span class="p">;</span>
      <span class="p">}</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-170'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-170'>#</a>
      </div>
      <p>do I need to invert the image?</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>      <span class="k">if</span> <span class="p">(</span> <span class="n">tga_inverted</span> <span class="p">)</span>
      <span class="p">{</span>
         <span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span><span class="o">*</span><span class="mi">2</span> <span class="o">&lt;</span> <span class="n">tga_height</span><span class="p">;</span> <span class="o">++</span><span class="n">j</span><span class="p">)</span>
         <span class="p">{</span>
            <span class="kt">int</span> <span class="n">index1</span> <span class="o">=</span> <span class="n">j</span> <span class="o">*</span> <span class="n">tga_width</span> <span class="o">*</span> <span class="n">tga_comp</span><span class="p">;</span>
            <span class="kt">int</span> <span class="n">index2</span> <span class="o">=</span> <span class="p">(</span><span class="n">tga_height</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">j</span><span class="p">)</span> <span class="o">*</span> <span class="n">tga_width</span> <span class="o">*</span> <span class="n">tga_comp</span><span class="p">;</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">tga_width</span> <span class="o">*</span> <span class="n">tga_comp</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="o">--</span><span class="n">i</span><span class="p">)</span>
            <span class="p">{</span>
               <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">temp</span> <span class="o">=</span> <span class="n">tga_data</span><span class="p">[</span><span class="n">index1</span><span class="p">];</span>
               <span class="n">tga_data</span><span class="p">[</span><span class="n">index1</span><span class="p">]</span> <span class="o">=</span> <span class="n">tga_data</span><span class="p">[</span><span class="n">index2</span><span class="p">];</span>
               <span class="n">tga_data</span><span class="p">[</span><span class="n">index2</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp</span><span class="p">;</span>
               <span class="o">++</span><span class="n">index1</span><span class="p">;</span>
               <span class="o">++</span><span class="n">index2</span><span class="p">;</span>
            <span class="p">}</span>
         <span class="p">}</span>
      <span class="p">}</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-171'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-171'>#</a>
      </div>
      <p>clear my palette, if I had one</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>      <span class="k">if</span> <span class="p">(</span> <span class="n">tga_palette</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="p">)</span>
      <span class="p">{</span>
         <span class="n">STBI_FREE</span><span class="p">(</span> <span class="n">tga_palette</span> <span class="p">);</span>
      <span class="p">}</span>
   <span class="p">}</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-172'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-172'>#</a>
      </div>
      <p>swap RGB - if the source data was RGB16, it already is in the right order</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>   <span class="k">if</span> <span class="p">(</span><span class="n">tga_comp</span> <span class="o">&gt;=</span> <span class="mi">3</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">tga_rgb16</span><span class="p">)</span>
   <span class="p">{</span>
      <span class="kt">unsigned</span> <span class="kt">char</span><span class="o">*</span> <span class="n">tga_pixel</span> <span class="o">=</span> <span class="n">tga_data</span><span class="p">;</span>
      <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">tga_width</span> <span class="o">*</span> <span class="n">tga_height</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
      <span class="p">{</span>
         <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">temp</span> <span class="o">=</span> <span class="n">tga_pixel</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
         <span class="n">tga_pixel</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">tga_pixel</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
         <span class="n">tga_pixel</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp</span><span class="p">;</span>
         <span class="n">tga_pixel</span> <span class="o">+=</span> <span class="n">tga_comp</span><span class="p">;</span>
      <span class="p">}</span>
   <span class="p">}</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-173'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-173'>#</a>
      </div>
      <p>convert to target component count</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>   <span class="k">if</span> <span class="p">(</span><span class="n">req_comp</span> <span class="o">&amp;&amp;</span> <span class="n">req_comp</span> <span class="o">!=</span> <span class="n">tga_comp</span><span class="p">)</span>
      <span class="n">tga_data</span> <span class="o">=</span> <span class="n">stbi__convert_format</span><span class="p">(</span><span class="n">tga_data</span><span class="p">,</span> <span class="n">tga_comp</span><span class="p">,</span> <span class="n">req_comp</span><span class="p">,</span> <span class="n">tga_width</span><span class="p">,</span> <span class="n">tga_height</span><span class="p">);</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-174'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-174'>#</a>
      </div>
      <p>the things I do to get rid of an error message, and yet keep
  Microsoft's C compilers happy... [8^(</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>   <span class="n">tga_palette_start</span> <span class="o">=</span> <span class="n">tga_palette_len</span> <span class="o">=</span> <span class="n">tga_palette_bits</span> <span class="o">=</span>
         <span class="n">tga_x_origin</span> <span class="o">=</span> <span class="n">tga_y_origin</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-175'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-175'>#</a>
      </div>
      <p>OK, done</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>   <span class="k">return</span> <span class="n">tga_data</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-176'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-176'>#</a>
      </div>
      <hr />
<p>Photoshop PSD loader -- PD by Thatcher Ulrich, integration by Nicolas Schulz, tweaked by STB</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="cp">#ifndef STBI_NO_PSD</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">stbi__psd_test</span><span class="p">(</span><span class="n">stbi__context</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
   <span class="kt">int</span> <span class="n">r</span> <span class="o">=</span> <span class="p">(</span><span class="n">stbi__get32be</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x38425053</span><span class="p">);</span>
   <span class="n">stbi__rewind</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
   <span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">stbi_uc</span> <span class="o">*</span><span class="nf">stbi__psd_load</span><span class="p">(</span><span class="n">stbi__context</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">y</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">comp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">req_comp</span><span class="p">)</span>
<span class="p">{</span>
   <span class="kt">int</span>   <span class="n">pixelCount</span><span class="p">;</span>
   <span class="kt">int</span> <span class="n">channelCount</span><span class="p">,</span> <span class="n">compression</span><span class="p">;</span>
   <span class="kt">int</span> <span class="n">channel</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">len</span><span class="p">;</span>
   <span class="kt">int</span> <span class="n">bitdepth</span><span class="p">;</span>
   <span class="kt">int</span> <span class="n">w</span><span class="p">,</span><span class="n">h</span><span class="p">;</span>
   <span class="n">stbi_uc</span> <span class="o">*</span><span class="n">out</span><span class="p">;</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-177'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-177'>#</a>
      </div>
      <p>Check identifier</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>   <span class="k">if</span> <span class="p">(</span><span class="n">stbi__get32be</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x38425053</span><span class="p">)</span>   <span class="c1">// &quot;8BPS&quot;</span>
      <span class="k">return</span> <span class="n">stbi__errpuc</span><span class="p">(</span><span class="s">&quot;not PSD&quot;</span><span class="p">,</span> <span class="s">&quot;Corrupt PSD image&quot;</span><span class="p">);</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-178'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-178'>#</a>
      </div>
      <p>Check file type version.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>   <span class="k">if</span> <span class="p">(</span><span class="n">stbi__get16be</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">stbi__errpuc</span><span class="p">(</span><span class="s">&quot;wrong version&quot;</span><span class="p">,</span> <span class="s">&quot;Unsupported version of PSD image&quot;</span><span class="p">);</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-179'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-179'>#</a>
      </div>
      <p>Skip 6 reserved bytes.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>   <span class="n">stbi__skip</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="mi">6</span> <span class="p">);</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-180'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-180'>#</a>
      </div>
      <p>Read the number of channels (R, G, B, A, etc).</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>   <span class="n">channelCount</span> <span class="o">=</span> <span class="n">stbi__get16be</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">channelCount</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">channelCount</span> <span class="o">&gt;</span> <span class="mi">16</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">stbi__errpuc</span><span class="p">(</span><span class="s">&quot;wrong channel count&quot;</span><span class="p">,</span> <span class="s">&quot;Unsupported number of channels in PSD image&quot;</span><span class="p">);</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-181'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-181'>#</a>
      </div>
      <p>Read the rows and columns of the image.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>   <span class="n">h</span> <span class="o">=</span> <span class="n">stbi__get32be</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
   <span class="n">w</span> <span class="o">=</span> <span class="n">stbi__get32be</span><span class="p">(</span><span class="n">s</span><span class="p">);</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-182'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-182'>#</a>
      </div>
      <p>Make sure the depth is 8 bits.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>   <span class="n">bitdepth</span> <span class="o">=</span> <span class="n">stbi__get16be</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">bitdepth</span> <span class="o">!=</span> <span class="mi">8</span> <span class="o">&amp;&amp;</span> <span class="n">bitdepth</span> <span class="o">!=</span> <span class="mi">16</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">stbi__errpuc</span><span class="p">(</span><span class="s">&quot;unsupported bit depth&quot;</span><span class="p">,</span> <span class="s">&quot;PSD bit depth is not 8 or 16 bit&quot;</span><span class="p">);</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-183'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-183'>#</a>
      </div>
      <p>Make sure the color mode is RGB.
Valid options are:
  0: Bitmap
  1: Grayscale
  2: Indexed color
  3: RGB color
  4: CMYK color
  7: Multichannel
  8: Duotone
  9: Lab color</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>   <span class="k">if</span> <span class="p">(</span><span class="n">stbi__get16be</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">stbi__errpuc</span><span class="p">(</span><span class="s">&quot;wrong color format&quot;</span><span class="p">,</span> <span class="s">&quot;PSD is not in RGB color format&quot;</span><span class="p">);</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-184'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-184'>#</a>
      </div>
      <p>Skip the Mode Data.  (It's the palette for indexed color; other info for other modes.)</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>   <span class="n">stbi__skip</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">stbi__get32be</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="p">);</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-185'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-185'>#</a>
      </div>
      <p>Skip the image resources.  (resolution, pen tool paths, etc)</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>   <span class="n">stbi__skip</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">stbi__get32be</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="p">);</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-186'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-186'>#</a>
      </div>
      <p>Skip the reserved data.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>   <span class="n">stbi__skip</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">stbi__get32be</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="p">);</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-187'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-187'>#</a>
      </div>
      <p>Find out if the data is compressed.
Known values:
  0: no compression
  1: RLE compressed</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>   <span class="n">compression</span> <span class="o">=</span> <span class="n">stbi__get16be</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">compression</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">stbi__errpuc</span><span class="p">(</span><span class="s">&quot;bad compression&quot;</span><span class="p">,</span> <span class="s">&quot;PSD has an unknown compression format&quot;</span><span class="p">);</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-188'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-188'>#</a>
      </div>
      <p>Create the destination image.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>   <span class="n">out</span> <span class="o">=</span> <span class="p">(</span><span class="n">stbi_uc</span> <span class="o">*</span><span class="p">)</span> <span class="n">stbi__malloc</span><span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">w</span><span class="o">*</span><span class="n">h</span><span class="p">);</span>
   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">out</span><span class="p">)</span> <span class="k">return</span> <span class="n">stbi__errpuc</span><span class="p">(</span><span class="s">&quot;outofmem&quot;</span><span class="p">,</span> <span class="s">&quot;Out of memory&quot;</span><span class="p">);</span>
   <span class="n">pixelCount</span> <span class="o">=</span> <span class="n">w</span><span class="o">*</span><span class="n">h</span><span class="p">;</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-189'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-189'>#</a>
      </div>
      <p>Initialize the data to zero.
memset( out, 0, pixelCount * 4 );</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-190'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-190'>#</a>
      </div>
      <p>Finally, the image data.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>   <span class="k">if</span> <span class="p">(</span><span class="n">compression</span><span class="p">)</span> <span class="p">{</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-191'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-191'>#</a>
      </div>
      <p>RLE as used by .PSD and .TIFF
Loop until you get the number of unpacked bytes you are expecting:
    Read the next source byte into n.
    If n is between 0 and 127 inclusive, copy the next n+1 bytes literally.
    Else if n is between -127 and -1 inclusive, copy the next byte -n+1 times.
    Else if n is 128, noop.
Endloop</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-192'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-192'>#</a>
      </div>
      <p>The RLE-compressed data is preceeded by a 2-byte data count for each row in the data,
which we're going to just skip.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>      <span class="n">stbi__skip</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">h</span> <span class="o">*</span> <span class="n">channelCount</span> <span class="o">*</span> <span class="mi">2</span> <span class="p">);</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-193'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-193'>#</a>
      </div>
      <p>Read the RLE data by channel.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>      <span class="k">for</span> <span class="p">(</span><span class="n">channel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">channel</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">channel</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
         <span class="n">stbi_uc</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>

         <span class="n">p</span> <span class="o">=</span> <span class="n">out</span><span class="o">+</span><span class="n">channel</span><span class="p">;</span>
         <span class="k">if</span> <span class="p">(</span><span class="n">channel</span> <span class="o">&gt;=</span> <span class="n">channelCount</span><span class="p">)</span> <span class="p">{</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-194'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-194'>#</a>
      </div>
      <p>Fill this channel with default data.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">pixelCount</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">p</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">)</span>
               <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">channel</span> <span class="o">==</span> <span class="mi">3</span> <span class="o">?</span> <span class="mi">255</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
         <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-195'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-195'>#</a>
      </div>
      <p>Read the RLE data.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="k">while</span> <span class="p">(</span><span class="n">count</span> <span class="o">&lt;</span> <span class="n">pixelCount</span><span class="p">)</span> <span class="p">{</span>
               <span class="n">len</span> <span class="o">=</span> <span class="n">stbi__get8</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
               <span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">==</span> <span class="mi">128</span><span class="p">)</span> <span class="p">{</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-196'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-196'>#</a>
      </div>
      <p>No-op.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>               <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">128</span><span class="p">)</span> <span class="p">{</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-197'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-197'>#</a>
      </div>
      <p>Copy next len+1 bytes literally.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>                  <span class="n">len</span><span class="o">++</span><span class="p">;</span>
                  <span class="n">count</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
                  <span class="k">while</span> <span class="p">(</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
                     <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">stbi__get8</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
                     <span class="n">p</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
                     <span class="n">len</span><span class="o">--</span><span class="p">;</span>
                  <span class="p">}</span>
               <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">128</span><span class="p">)</span> <span class="p">{</span>
                  <span class="n">stbi_uc</span>   <span class="n">val</span><span class="p">;</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-198'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-198'>#</a>
      </div>
      <p>Next -len+1 bytes in the dest are replicated from next source byte.
(Interpret len as a negative 8-bit int.)</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>                  <span class="n">len</span> <span class="o">^=</span> <span class="mh">0x0FF</span><span class="p">;</span>
                  <span class="n">len</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
                  <span class="n">val</span> <span class="o">=</span> <span class="n">stbi__get8</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
                  <span class="n">count</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
                  <span class="k">while</span> <span class="p">(</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
                     <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
                     <span class="n">p</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
                     <span class="n">len</span><span class="o">--</span><span class="p">;</span>
                  <span class="p">}</span>
               <span class="p">}</span>
            <span class="p">}</span>
         <span class="p">}</span>
      <span class="p">}</span>

   <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-199'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-199'>#</a>
      </div>
      <p>We're at the raw image data.  It's each channel in order (Red, Green, Blue, Alpha, ...)
where each channel consists of an 8-bit value for each pixel in the image.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-200'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-200'>#</a>
      </div>
      <p>Read the data by channel.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>      <span class="k">for</span> <span class="p">(</span><span class="n">channel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">channel</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">channel</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
         <span class="n">stbi_uc</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>

         <span class="n">p</span> <span class="o">=</span> <span class="n">out</span> <span class="o">+</span> <span class="n">channel</span><span class="p">;</span>
         <span class="k">if</span> <span class="p">(</span><span class="n">channel</span> <span class="o">&gt;=</span> <span class="n">channelCount</span><span class="p">)</span> <span class="p">{</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-201'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-201'>#</a>
      </div>
      <p>Fill this channel with default data.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="n">stbi_uc</span> <span class="n">val</span> <span class="o">=</span> <span class="n">channel</span> <span class="o">==</span> <span class="mi">3</span> <span class="o">?</span> <span class="mi">255</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">pixelCount</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">p</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">)</span>
               <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
         <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-202'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-202'>#</a>
      </div>
      <p>Read the data.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="k">if</span> <span class="p">(</span><span class="n">bitdepth</span> <span class="o">==</span> <span class="mi">16</span><span class="p">)</span> <span class="p">{</span>
               <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">pixelCount</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">p</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">)</span>
                  <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">stbi_uc</span><span class="p">)</span> <span class="p">(</span><span class="n">stbi__get16be</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
               <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">pixelCount</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">p</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">)</span>
                  <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">stbi__get8</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
            <span class="p">}</span>
         <span class="p">}</span>
      <span class="p">}</span>
   <span class="p">}</span>

   <span class="k">if</span> <span class="p">(</span><span class="n">channelCount</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">w</span><span class="o">*</span><span class="n">h</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
         <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pixel</span> <span class="o">=</span> <span class="n">out</span> <span class="o">+</span> <span class="mi">4</span><span class="o">*</span><span class="n">i</span><span class="p">;</span>
         <span class="k">if</span> <span class="p">(</span><span class="n">pixel</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">pixel</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">255</span><span class="p">)</span> <span class="p">{</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-203'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-203'>#</a>
      </div>
      <p>remove weird white matte from PSD</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="kt">float</span> <span class="n">a</span> <span class="o">=</span> <span class="n">pixel</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">/</span> <span class="mf">255.0f</span><span class="p">;</span>
            <span class="kt">float</span> <span class="n">ra</span> <span class="o">=</span> <span class="mf">1.0f</span> <span class="o">/</span> <span class="n">a</span><span class="p">;</span>
            <span class="kt">float</span> <span class="n">inv_a</span> <span class="o">=</span> <span class="mf">255.0f</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">ra</span><span class="p">);</span>
            <span class="n">pixel</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="p">(</span><span class="n">pixel</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">ra</span> <span class="o">+</span> <span class="n">inv_a</span><span class="p">);</span>
            <span class="n">pixel</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="p">(</span><span class="n">pixel</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">ra</span> <span class="o">+</span> <span class="n">inv_a</span><span class="p">);</span>
            <span class="n">pixel</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="p">(</span><span class="n">pixel</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">ra</span> <span class="o">+</span> <span class="n">inv_a</span><span class="p">);</span>
         <span class="p">}</span>
      <span class="p">}</span>
   <span class="p">}</span>

   <span class="k">if</span> <span class="p">(</span><span class="n">req_comp</span> <span class="o">&amp;&amp;</span> <span class="n">req_comp</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">out</span> <span class="o">=</span> <span class="n">stbi__convert_format</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">req_comp</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">out</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="k">return</span> <span class="n">out</span><span class="p">;</span> <span class="c1">// stbi__convert_format frees input on failure</span>
   <span class="p">}</span>

   <span class="k">if</span> <span class="p">(</span><span class="n">comp</span><span class="p">)</span> <span class="o">*</span><span class="n">comp</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
   <span class="o">*</span><span class="n">y</span> <span class="o">=</span> <span class="n">h</span><span class="p">;</span>
   <span class="o">*</span><span class="n">x</span> <span class="o">=</span> <span class="n">w</span><span class="p">;</span>

   <span class="k">return</span> <span class="n">out</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-204'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-204'>#</a>
      </div>
      <hr />
<p>Softimage PIC loader
by Tom Seddon</p>
<p>See http://softimage.wiki.softimage.com/index.php/INFO:_PIC_file_format
See http://ozviz.wasp.uwa.edu.au/~pbourke/dataformats/softimagepic/</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="cp">#ifndef STBI_NO_PIC</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">stbi__pic_is4</span><span class="p">(</span><span class="n">stbi__context</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">)</span>
<span class="p">{</span>
   <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
   <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="mi">4</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">stbi__get8</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">!=</span> <span class="p">(</span><span class="n">stbi_uc</span><span class="p">)</span><span class="n">str</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
         <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

   <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">stbi__pic_test_core</span><span class="p">(</span><span class="n">stbi__context</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
   <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">stbi__pic_is4</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="s">&quot;</span><span class="se">\x53\x80\xF6\x34</span><span class="s">&quot;</span><span class="p">))</span>
      <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

   <span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="mi">84</span><span class="p">;</span><span class="o">++</span><span class="n">i</span><span class="p">)</span>
      <span class="n">stbi__get8</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>

   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">stbi__pic_is4</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="s">&quot;PICT&quot;</span><span class="p">))</span>
      <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

   <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">typedef</span> <span class="k">struct</span>
<span class="p">{</span>
   <span class="n">stbi_uc</span> <span class="n">size</span><span class="p">,</span><span class="n">type</span><span class="p">,</span><span class="n">channel</span><span class="p">;</span>
<span class="p">}</span> <span class="n">stbi__pic_packet</span><span class="p">;</span>

<span class="k">static</span> <span class="n">stbi_uc</span> <span class="o">*</span><span class="nf">stbi__readval</span><span class="p">(</span><span class="n">stbi__context</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">int</span> <span class="n">channel</span><span class="p">,</span> <span class="n">stbi_uc</span> <span class="o">*</span><span class="n">dest</span><span class="p">)</span>
<span class="p">{</span>
   <span class="kt">int</span> <span class="n">mask</span><span class="o">=</span><span class="mh">0x80</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

   <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="mi">4</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">,</span> <span class="n">mask</span><span class="o">&gt;&gt;=</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">channel</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">)</span> <span class="p">{</span>
         <span class="k">if</span> <span class="p">(</span><span class="n">stbi__at_eof</span><span class="p">(</span><span class="n">s</span><span class="p">))</span> <span class="k">return</span> <span class="n">stbi__errpuc</span><span class="p">(</span><span class="s">&quot;bad file&quot;</span><span class="p">,</span><span class="s">&quot;PIC file too short&quot;</span><span class="p">);</span>
         <span class="n">dest</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">stbi__get8</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
      <span class="p">}</span>
   <span class="p">}</span>

   <span class="k">return</span> <span class="n">dest</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">stbi__copyval</span><span class="p">(</span><span class="kt">int</span> <span class="n">channel</span><span class="p">,</span><span class="n">stbi_uc</span> <span class="o">*</span><span class="n">dest</span><span class="p">,</span><span class="k">const</span> <span class="n">stbi_uc</span> <span class="o">*</span><span class="n">src</span><span class="p">)</span>
<span class="p">{</span>
   <span class="kt">int</span> <span class="n">mask</span><span class="o">=</span><span class="mh">0x80</span><span class="p">,</span><span class="n">i</span><span class="p">;</span>

   <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="mi">4</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">,</span> <span class="n">mask</span><span class="o">&gt;&gt;=</span><span class="mi">1</span><span class="p">)</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">channel</span><span class="o">&amp;</span><span class="n">mask</span><span class="p">)</span>
         <span class="n">dest</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">src</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">stbi_uc</span> <span class="o">*</span><span class="nf">stbi__pic_load_core</span><span class="p">(</span><span class="n">stbi__context</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span><span class="kt">int</span> <span class="n">width</span><span class="p">,</span><span class="kt">int</span> <span class="n">height</span><span class="p">,</span><span class="kt">int</span> <span class="o">*</span><span class="n">comp</span><span class="p">,</span> <span class="n">stbi_uc</span> <span class="o">*</span><span class="n">result</span><span class="p">)</span>
<span class="p">{</span>
   <span class="kt">int</span> <span class="n">act_comp</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">num_packets</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">chained</span><span class="p">;</span>
   <span class="n">stbi__pic_packet</span> <span class="n">packets</span><span class="p">[</span><span class="mi">10</span><span class="p">];</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-205'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-205'>#</a>
      </div>
      <p>this will (should...) cater for even some bizarre stuff like having data
for the same channel in multiple packets.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>   <span class="k">do</span> <span class="p">{</span>
      <span class="n">stbi__pic_packet</span> <span class="o">*</span><span class="n">packet</span><span class="p">;</span>

      <span class="k">if</span> <span class="p">(</span><span class="n">num_packets</span><span class="o">==</span><span class="k">sizeof</span><span class="p">(</span><span class="n">packets</span><span class="p">)</span><span class="o">/</span><span class="k">sizeof</span><span class="p">(</span><span class="n">packets</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
         <span class="k">return</span> <span class="n">stbi__errpuc</span><span class="p">(</span><span class="s">&quot;bad format&quot;</span><span class="p">,</span><span class="s">&quot;too many packets&quot;</span><span class="p">);</span>

      <span class="n">packet</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">packets</span><span class="p">[</span><span class="n">num_packets</span><span class="o">++</span><span class="p">];</span>

      <span class="n">chained</span> <span class="o">=</span> <span class="n">stbi__get8</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
      <span class="n">packet</span><span class="o">-&gt;</span><span class="n">size</span>    <span class="o">=</span> <span class="n">stbi__get8</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
      <span class="n">packet</span><span class="o">-&gt;</span><span class="n">type</span>    <span class="o">=</span> <span class="n">stbi__get8</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
      <span class="n">packet</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">=</span> <span class="n">stbi__get8</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>

      <span class="n">act_comp</span> <span class="o">|=</span> <span class="n">packet</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">;</span>

      <span class="k">if</span> <span class="p">(</span><span class="n">stbi__at_eof</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>          <span class="k">return</span> <span class="n">stbi__errpuc</span><span class="p">(</span><span class="s">&quot;bad file&quot;</span><span class="p">,</span><span class="s">&quot;file too short (reading packets)&quot;</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">!=</span> <span class="mi">8</span><span class="p">)</span>  <span class="k">return</span> <span class="n">stbi__errpuc</span><span class="p">(</span><span class="s">&quot;bad format&quot;</span><span class="p">,</span><span class="s">&quot;packet isn&#39;t 8bpp&quot;</span><span class="p">);</span>
   <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">chained</span><span class="p">);</span>

   <span class="o">*</span><span class="n">comp</span> <span class="o">=</span> <span class="p">(</span><span class="n">act_comp</span> <span class="o">&amp;</span> <span class="mh">0x10</span> <span class="o">?</span> <span class="mi">4</span> <span class="o">:</span> <span class="mi">3</span><span class="p">);</span> <span class="c1">// has alpha channel?</span>

   <span class="k">for</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">y</span><span class="o">&lt;</span><span class="n">height</span><span class="p">;</span> <span class="o">++</span><span class="n">y</span><span class="p">)</span> <span class="p">{</span>
      <span class="kt">int</span> <span class="n">packet_idx</span><span class="p">;</span>

      <span class="k">for</span><span class="p">(</span><span class="n">packet_idx</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">packet_idx</span> <span class="o">&lt;</span> <span class="n">num_packets</span><span class="p">;</span> <span class="o">++</span><span class="n">packet_idx</span><span class="p">)</span> <span class="p">{</span>
         <span class="n">stbi__pic_packet</span> <span class="o">*</span><span class="n">packet</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">packets</span><span class="p">[</span><span class="n">packet_idx</span><span class="p">];</span>
         <span class="n">stbi_uc</span> <span class="o">*</span><span class="n">dest</span> <span class="o">=</span> <span class="n">result</span><span class="o">+</span><span class="n">y</span><span class="o">*</span><span class="n">width</span><span class="o">*</span><span class="mi">4</span><span class="p">;</span>

         <span class="k">switch</span> <span class="p">(</span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">default</span><span class="o">:</span>
               <span class="k">return</span> <span class="n">stbi__errpuc</span><span class="p">(</span><span class="s">&quot;bad format&quot;</span><span class="p">,</span><span class="s">&quot;packet has bad compression type&quot;</span><span class="p">);</span>

            <span class="k">case</span> <span class="mi">0</span><span class="o">:</span> <span class="p">{</span><span class="c1">//uncompressed</span>
               <span class="kt">int</span> <span class="n">x</span><span class="p">;</span>

               <span class="k">for</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">x</span><span class="o">&lt;</span><span class="n">width</span><span class="p">;</span><span class="o">++</span><span class="n">x</span><span class="p">,</span> <span class="n">dest</span><span class="o">+=</span><span class="mi">4</span><span class="p">)</span>
                  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">stbi__readval</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span><span class="n">dest</span><span class="p">))</span>
                     <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
               <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="k">case</span> <span class="mi">1</span><span class="o">:</span><span class="c1">//Pure RLE</span>
               <span class="p">{</span>
                  <span class="kt">int</span> <span class="n">left</span><span class="o">=</span><span class="n">width</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

                  <span class="k">while</span> <span class="p">(</span><span class="n">left</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                     <span class="n">stbi_uc</span> <span class="n">count</span><span class="p">,</span><span class="n">value</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>

                     <span class="n">count</span><span class="o">=</span><span class="n">stbi__get8</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
                     <span class="k">if</span> <span class="p">(</span><span class="n">stbi__at_eof</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>   <span class="k">return</span> <span class="n">stbi__errpuc</span><span class="p">(</span><span class="s">&quot;bad file&quot;</span><span class="p">,</span><span class="s">&quot;file too short (pure read count)&quot;</span><span class="p">);</span>

                     <span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="n">left</span><span class="p">)</span>
                        <span class="n">count</span> <span class="o">=</span> <span class="p">(</span><span class="n">stbi_uc</span><span class="p">)</span> <span class="n">left</span><span class="p">;</span>

                     <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">stbi__readval</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span><span class="n">value</span><span class="p">))</span>  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

                     <span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">count</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">,</span><span class="n">dest</span><span class="o">+=</span><span class="mi">4</span><span class="p">)</span>
                        <span class="n">stbi__copyval</span><span class="p">(</span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span><span class="n">dest</span><span class="p">,</span><span class="n">value</span><span class="p">);</span>
                     <span class="n">left</span> <span class="o">-=</span> <span class="n">count</span><span class="p">;</span>
                  <span class="p">}</span>
               <span class="p">}</span>
               <span class="k">break</span><span class="p">;</span>

            <span class="k">case</span> <span class="mi">2</span><span class="o">:</span> <span class="p">{</span><span class="c1">//Mixed RLE</span>
               <span class="kt">int</span> <span class="n">left</span><span class="o">=</span><span class="n">width</span><span class="p">;</span>
               <span class="k">while</span> <span class="p">(</span><span class="n">left</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                  <span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="n">stbi__get8</span><span class="p">(</span><span class="n">s</span><span class="p">),</span> <span class="n">i</span><span class="p">;</span>
                  <span class="k">if</span> <span class="p">(</span><span class="n">stbi__at_eof</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>  <span class="k">return</span> <span class="n">stbi__errpuc</span><span class="p">(</span><span class="s">&quot;bad file&quot;</span><span class="p">,</span><span class="s">&quot;file too short (mixed read count)&quot;</span><span class="p">);</span>

                  <span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;=</span> <span class="mi">128</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// Repeated</span>
                     <span class="n">stbi_uc</span> <span class="n">value</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>

                     <span class="k">if</span> <span class="p">(</span><span class="n">count</span><span class="o">==</span><span class="mi">128</span><span class="p">)</span>
                        <span class="n">count</span> <span class="o">=</span> <span class="n">stbi__get16be</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
                     <span class="k">else</span>
                        <span class="n">count</span> <span class="o">-=</span> <span class="mi">127</span><span class="p">;</span>
                     <span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="n">left</span><span class="p">)</span>
                        <span class="k">return</span> <span class="n">stbi__errpuc</span><span class="p">(</span><span class="s">&quot;bad file&quot;</span><span class="p">,</span><span class="s">&quot;scanline overrun&quot;</span><span class="p">);</span>

                     <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">stbi__readval</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span><span class="n">value</span><span class="p">))</span>
                        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

                     <span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">count</span><span class="p">;</span><span class="o">++</span><span class="n">i</span><span class="p">,</span> <span class="n">dest</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">)</span>
                        <span class="n">stbi__copyval</span><span class="p">(</span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span><span class="n">dest</span><span class="p">,</span><span class="n">value</span><span class="p">);</span>
                  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="c1">// Raw</span>
                     <span class="o">++</span><span class="n">count</span><span class="p">;</span>
                     <span class="k">if</span> <span class="p">(</span><span class="n">count</span><span class="o">&gt;</span><span class="n">left</span><span class="p">)</span> <span class="k">return</span> <span class="n">stbi__errpuc</span><span class="p">(</span><span class="s">&quot;bad file&quot;</span><span class="p">,</span><span class="s">&quot;scanline overrun&quot;</span><span class="p">);</span>

                     <span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">count</span><span class="p">;</span><span class="o">++</span><span class="n">i</span><span class="p">,</span> <span class="n">dest</span><span class="o">+=</span><span class="mi">4</span><span class="p">)</span>
                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">stbi__readval</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span><span class="n">dest</span><span class="p">))</span>
                           <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
                  <span class="p">}</span>
                  <span class="n">left</span><span class="o">-=</span><span class="n">count</span><span class="p">;</span>
               <span class="p">}</span>
               <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span>
         <span class="p">}</span>
      <span class="p">}</span>
   <span class="p">}</span>

   <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">stbi_uc</span> <span class="o">*</span><span class="nf">stbi__pic_load</span><span class="p">(</span><span class="n">stbi__context</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span><span class="kt">int</span> <span class="o">*</span><span class="n">px</span><span class="p">,</span><span class="kt">int</span> <span class="o">*</span><span class="n">py</span><span class="p">,</span><span class="kt">int</span> <span class="o">*</span><span class="n">comp</span><span class="p">,</span><span class="kt">int</span> <span class="n">req_comp</span><span class="p">)</span>
<span class="p">{</span>
   <span class="n">stbi_uc</span> <span class="o">*</span><span class="n">result</span><span class="p">;</span>
   <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">;</span>

   <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="mi">92</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
      <span class="n">stbi__get8</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>

   <span class="n">x</span> <span class="o">=</span> <span class="n">stbi__get16be</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
   <span class="n">y</span> <span class="o">=</span> <span class="n">stbi__get16be</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">stbi__at_eof</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>  <span class="k">return</span> <span class="n">stbi__errpuc</span><span class="p">(</span><span class="s">&quot;bad file&quot;</span><span class="p">,</span><span class="s">&quot;file too short (pic header)&quot;</span><span class="p">);</span>
   <span class="k">if</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">28</span><span class="p">)</span> <span class="o">/</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">y</span><span class="p">)</span> <span class="k">return</span> <span class="n">stbi__errpuc</span><span class="p">(</span><span class="s">&quot;too large&quot;</span><span class="p">,</span> <span class="s">&quot;Image too large to decode&quot;</span><span class="p">);</span>

   <span class="n">stbi__get32be</span><span class="p">(</span><span class="n">s</span><span class="p">);</span> <span class="c1">//skip `ratio&#39;</span>
   <span class="n">stbi__get16be</span><span class="p">(</span><span class="n">s</span><span class="p">);</span> <span class="c1">//skip `fields&#39;</span>
   <span class="n">stbi__get16be</span><span class="p">(</span><span class="n">s</span><span class="p">);</span> <span class="c1">//skip `pad&#39;</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-206'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-206'>#</a>
      </div>
      <p>intermediate buffer is RGBA</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>   <span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="n">stbi_uc</span> <span class="o">*</span><span class="p">)</span> <span class="n">stbi__malloc</span><span class="p">(</span><span class="n">x</span><span class="o">*</span><span class="n">y</span><span class="o">*</span><span class="mi">4</span><span class="p">);</span>
   <span class="n">memset</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">x</span><span class="o">*</span><span class="n">y</span><span class="o">*</span><span class="mi">4</span><span class="p">);</span>

   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">stbi__pic_load_core</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">comp</span><span class="p">,</span> <span class="n">result</span><span class="p">))</span> <span class="p">{</span>
      <span class="n">STBI_FREE</span><span class="p">(</span><span class="n">result</span><span class="p">);</span>
      <span class="n">result</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
   <span class="p">}</span>
   <span class="o">*</span><span class="n">px</span> <span class="o">=</span> <span class="n">x</span><span class="p">;</span>
   <span class="o">*</span><span class="n">py</span> <span class="o">=</span> <span class="n">y</span><span class="p">;</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">req_comp</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="n">req_comp</span> <span class="o">=</span> <span class="o">*</span><span class="n">comp</span><span class="p">;</span>
   <span class="n">result</span><span class="o">=</span><span class="n">stbi__convert_format</span><span class="p">(</span><span class="n">result</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="n">req_comp</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">);</span>

   <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">stbi__pic_test</span><span class="p">(</span><span class="n">stbi__context</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
   <span class="kt">int</span> <span class="n">r</span> <span class="o">=</span> <span class="n">stbi__pic_test_core</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
   <span class="n">stbi__rewind</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
   <span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-207'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-207'>#</a>
      </div>
      <hr />
<p>GIF loader -- public domain by Jean-Marc Lienher -- simplified/shrunk by stb</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="cp">#ifndef STBI_NO_GIF</span>
<span class="k">typedef</span> <span class="k">struct</span>
<span class="p">{</span>
   <span class="n">stbi__int16</span> <span class="n">prefix</span><span class="p">;</span>
   <span class="n">stbi_uc</span> <span class="n">first</span><span class="p">;</span>
   <span class="n">stbi_uc</span> <span class="n">suffix</span><span class="p">;</span>
<span class="p">}</span> <span class="n">stbi__gif_lzw</span><span class="p">;</span>

<span class="k">typedef</span> <span class="k">struct</span>
<span class="p">{</span>
   <span class="kt">int</span> <span class="n">w</span><span class="p">,</span><span class="n">h</span><span class="p">;</span>
   <span class="n">stbi_uc</span> <span class="o">*</span><span class="n">out</span><span class="p">,</span> <span class="o">*</span><span class="n">old_out</span><span class="p">;</span>             <span class="c1">// output buffer (always 4 components)</span>
   <span class="kt">int</span> <span class="n">flags</span><span class="p">,</span> <span class="n">bgindex</span><span class="p">,</span> <span class="n">ratio</span><span class="p">,</span> <span class="n">transparent</span><span class="p">,</span> <span class="n">eflags</span><span class="p">,</span> <span class="n">delay</span><span class="p">;</span>
   <span class="n">stbi_uc</span>  <span class="n">pal</span><span class="p">[</span><span class="mi">256</span><span class="p">][</span><span class="mi">4</span><span class="p">];</span>
   <span class="n">stbi_uc</span> <span class="n">lpal</span><span class="p">[</span><span class="mi">256</span><span class="p">][</span><span class="mi">4</span><span class="p">];</span>
   <span class="n">stbi__gif_lzw</span> <span class="n">codes</span><span class="p">[</span><span class="mi">4096</span><span class="p">];</span>
   <span class="n">stbi_uc</span> <span class="o">*</span><span class="n">color_table</span><span class="p">;</span>
   <span class="kt">int</span> <span class="n">parse</span><span class="p">,</span> <span class="n">step</span><span class="p">;</span>
   <span class="kt">int</span> <span class="n">lflags</span><span class="p">;</span>
   <span class="kt">int</span> <span class="n">start_x</span><span class="p">,</span> <span class="n">start_y</span><span class="p">;</span>
   <span class="kt">int</span> <span class="n">max_x</span><span class="p">,</span> <span class="n">max_y</span><span class="p">;</span>
   <span class="kt">int</span> <span class="n">cur_x</span><span class="p">,</span> <span class="n">cur_y</span><span class="p">;</span>
   <span class="kt">int</span> <span class="n">line_size</span><span class="p">;</span>
<span class="p">}</span> <span class="n">stbi__gif</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">stbi__gif_test_raw</span><span class="p">(</span><span class="n">stbi__context</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
   <span class="kt">int</span> <span class="n">sz</span><span class="p">;</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">stbi__get8</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">!=</span> <span class="sc">&#39;G&#39;</span> <span class="o">||</span> <span class="n">stbi__get8</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">!=</span> <span class="sc">&#39;I&#39;</span> <span class="o">||</span> <span class="n">stbi__get8</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">!=</span> <span class="sc">&#39;F&#39;</span> <span class="o">||</span> <span class="n">stbi__get8</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">!=</span> <span class="sc">&#39;8&#39;</span><span class="p">)</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
   <span class="n">sz</span> <span class="o">=</span> <span class="n">stbi__get8</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">sz</span> <span class="o">!=</span> <span class="sc">&#39;9&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">sz</span> <span class="o">!=</span> <span class="sc">&#39;7&#39;</span><span class="p">)</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">stbi__get8</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">!=</span> <span class="sc">&#39;a&#39;</span><span class="p">)</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
   <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">stbi__gif_test</span><span class="p">(</span><span class="n">stbi__context</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
   <span class="kt">int</span> <span class="n">r</span> <span class="o">=</span> <span class="n">stbi__gif_test_raw</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
   <span class="n">stbi__rewind</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
   <span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">stbi__gif_parse_colortable</span><span class="p">(</span><span class="n">stbi__context</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="n">stbi_uc</span> <span class="n">pal</span><span class="p">[</span><span class="mi">256</span><span class="p">][</span><span class="mi">4</span><span class="p">],</span> <span class="kt">int</span> <span class="n">num_entries</span><span class="p">,</span> <span class="kt">int</span> <span class="n">transp</span><span class="p">)</span>
<span class="p">{</span>
   <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
   <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_entries</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">pal</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">stbi__get8</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
      <span class="n">pal</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">stbi__get8</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
      <span class="n">pal</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">stbi__get8</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
      <span class="n">pal</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">transp</span> <span class="o">==</span> <span class="n">i</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">255</span><span class="p">;</span>
   <span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">stbi__gif_header</span><span class="p">(</span><span class="n">stbi__context</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="n">stbi__gif</span> <span class="o">*</span><span class="n">g</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">comp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">is_info</span><span class="p">)</span>
<span class="p">{</span>
   <span class="n">stbi_uc</span> <span class="n">version</span><span class="p">;</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">stbi__get8</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">!=</span> <span class="sc">&#39;G&#39;</span> <span class="o">||</span> <span class="n">stbi__get8</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">!=</span> <span class="sc">&#39;I&#39;</span> <span class="o">||</span> <span class="n">stbi__get8</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">!=</span> <span class="sc">&#39;F&#39;</span> <span class="o">||</span> <span class="n">stbi__get8</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">!=</span> <span class="sc">&#39;8&#39;</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">stbi__err</span><span class="p">(</span><span class="s">&quot;not GIF&quot;</span><span class="p">,</span> <span class="s">&quot;Corrupt GIF&quot;</span><span class="p">);</span>

   <span class="n">version</span> <span class="o">=</span> <span class="n">stbi__get8</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">version</span> <span class="o">!=</span> <span class="sc">&#39;7&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">version</span> <span class="o">!=</span> <span class="sc">&#39;9&#39;</span><span class="p">)</span>    <span class="k">return</span> <span class="n">stbi__err</span><span class="p">(</span><span class="s">&quot;not GIF&quot;</span><span class="p">,</span> <span class="s">&quot;Corrupt GIF&quot;</span><span class="p">);</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">stbi__get8</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">!=</span> <span class="sc">&#39;a&#39;</span><span class="p">)</span>                <span class="k">return</span> <span class="n">stbi__err</span><span class="p">(</span><span class="s">&quot;not GIF&quot;</span><span class="p">,</span> <span class="s">&quot;Corrupt GIF&quot;</span><span class="p">);</span>

   <span class="n">stbi__g_failure_reason</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
   <span class="n">g</span><span class="o">-&gt;</span><span class="n">w</span> <span class="o">=</span> <span class="n">stbi__get16le</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
   <span class="n">g</span><span class="o">-&gt;</span><span class="n">h</span> <span class="o">=</span> <span class="n">stbi__get16le</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
   <span class="n">g</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">stbi__get8</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
   <span class="n">g</span><span class="o">-&gt;</span><span class="n">bgindex</span> <span class="o">=</span> <span class="n">stbi__get8</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
   <span class="n">g</span><span class="o">-&gt;</span><span class="n">ratio</span> <span class="o">=</span> <span class="n">stbi__get8</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
   <span class="n">g</span><span class="o">-&gt;</span><span class="n">transparent</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

   <span class="k">if</span> <span class="p">(</span><span class="n">comp</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">*</span><span class="n">comp</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>  <span class="c1">// can&#39;t actually tell whether it&#39;s 3 or 4 until we parse the comments</span>

   <span class="k">if</span> <span class="p">(</span><span class="n">is_info</span><span class="p">)</span> <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

   <span class="k">if</span> <span class="p">(</span><span class="n">g</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span>
      <span class="n">stbi__gif_parse_colortable</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">g</span><span class="o">-&gt;</span><span class="n">pal</span><span class="p">,</span> <span class="mi">2</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">g</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>

   <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">stbi__gif_info_raw</span><span class="p">(</span><span class="n">stbi__context</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">y</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">comp</span><span class="p">)</span>
<span class="p">{</span>
   <span class="n">stbi__gif</span><span class="o">*</span> <span class="n">g</span> <span class="o">=</span> <span class="p">(</span><span class="n">stbi__gif</span><span class="o">*</span><span class="p">)</span> <span class="n">stbi__malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">stbi__gif</span><span class="p">));</span>
   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">stbi__gif_header</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">comp</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
      <span class="n">STBI_FREE</span><span class="p">(</span><span class="n">g</span><span class="p">);</span>
      <span class="n">stbi__rewind</span><span class="p">(</span> <span class="n">s</span> <span class="p">);</span>
      <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
   <span class="p">}</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">*</span><span class="n">x</span> <span class="o">=</span> <span class="n">g</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">;</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="o">*</span><span class="n">y</span> <span class="o">=</span> <span class="n">g</span><span class="o">-&gt;</span><span class="n">h</span><span class="p">;</span>
   <span class="n">STBI_FREE</span><span class="p">(</span><span class="n">g</span><span class="p">);</span>
   <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">stbi__out_gif_code</span><span class="p">(</span><span class="n">stbi__gif</span> <span class="o">*</span><span class="n">g</span><span class="p">,</span> <span class="n">stbi__uint16</span> <span class="n">code</span><span class="p">)</span>
<span class="p">{</span>
   <span class="n">stbi_uc</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="o">*</span><span class="n">c</span><span class="p">;</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-208'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-208'>#</a>
      </div>
      <p>recurse to decode the prefixes, since the linked-list is backwards,
and working backwards through an interleaved image would be nasty</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>   <span class="k">if</span> <span class="p">(</span><span class="n">g</span><span class="o">-&gt;</span><span class="n">codes</span><span class="p">[</span><span class="n">code</span><span class="p">].</span><span class="n">prefix</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
      <span class="n">stbi__out_gif_code</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">g</span><span class="o">-&gt;</span><span class="n">codes</span><span class="p">[</span><span class="n">code</span><span class="p">].</span><span class="n">prefix</span><span class="p">);</span>

   <span class="k">if</span> <span class="p">(</span><span class="n">g</span><span class="o">-&gt;</span><span class="n">cur_y</span> <span class="o">&gt;=</span> <span class="n">g</span><span class="o">-&gt;</span><span class="n">max_y</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>

   <span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">g</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">[</span><span class="n">g</span><span class="o">-&gt;</span><span class="n">cur_x</span> <span class="o">+</span> <span class="n">g</span><span class="o">-&gt;</span><span class="n">cur_y</span><span class="p">];</span>
   <span class="n">c</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">g</span><span class="o">-&gt;</span><span class="n">color_table</span><span class="p">[</span><span class="n">g</span><span class="o">-&gt;</span><span class="n">codes</span><span class="p">[</span><span class="n">code</span><span class="p">].</span><span class="n">suffix</span> <span class="o">*</span> <span class="mi">4</span><span class="p">];</span>

   <span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">128</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
      <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
      <span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
      <span class="n">p</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
   <span class="p">}</span>
   <span class="n">g</span><span class="o">-&gt;</span><span class="n">cur_x</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>

   <span class="k">if</span> <span class="p">(</span><span class="n">g</span><span class="o">-&gt;</span><span class="n">cur_x</span> <span class="o">&gt;=</span> <span class="n">g</span><span class="o">-&gt;</span><span class="n">max_x</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">g</span><span class="o">-&gt;</span><span class="n">cur_x</span> <span class="o">=</span> <span class="n">g</span><span class="o">-&gt;</span><span class="n">start_x</span><span class="p">;</span>
      <span class="n">g</span><span class="o">-&gt;</span><span class="n">cur_y</span> <span class="o">+=</span> <span class="n">g</span><span class="o">-&gt;</span><span class="n">step</span><span class="p">;</span>

      <span class="k">while</span> <span class="p">(</span><span class="n">g</span><span class="o">-&gt;</span><span class="n">cur_y</span> <span class="o">&gt;=</span> <span class="n">g</span><span class="o">-&gt;</span><span class="n">max_y</span> <span class="o">&amp;&amp;</span> <span class="n">g</span><span class="o">-&gt;</span><span class="n">parse</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
         <span class="n">g</span><span class="o">-&gt;</span><span class="n">step</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">g</span><span class="o">-&gt;</span><span class="n">parse</span><span class="p">)</span> <span class="o">*</span> <span class="n">g</span><span class="o">-&gt;</span><span class="n">line_size</span><span class="p">;</span>
         <span class="n">g</span><span class="o">-&gt;</span><span class="n">cur_y</span> <span class="o">=</span> <span class="n">g</span><span class="o">-&gt;</span><span class="n">start_y</span> <span class="o">+</span> <span class="p">(</span><span class="n">g</span><span class="o">-&gt;</span><span class="n">step</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">);</span>
         <span class="o">--</span><span class="n">g</span><span class="o">-&gt;</span><span class="n">parse</span><span class="p">;</span>
      <span class="p">}</span>
   <span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">stbi_uc</span> <span class="o">*</span><span class="nf">stbi__process_gif_raster</span><span class="p">(</span><span class="n">stbi__context</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="n">stbi__gif</span> <span class="o">*</span><span class="n">g</span><span class="p">)</span>
<span class="p">{</span>
   <span class="n">stbi_uc</span> <span class="n">lzw_cs</span><span class="p">;</span>
   <span class="n">stbi__int32</span> <span class="n">len</span><span class="p">,</span> <span class="n">init_code</span><span class="p">;</span>
   <span class="n">stbi__uint32</span> <span class="n">first</span><span class="p">;</span>
   <span class="n">stbi__int32</span> <span class="n">codesize</span><span class="p">,</span> <span class="n">codemask</span><span class="p">,</span> <span class="n">avail</span><span class="p">,</span> <span class="n">oldcode</span><span class="p">,</span> <span class="n">bits</span><span class="p">,</span> <span class="n">valid_bits</span><span class="p">,</span> <span class="n">clear</span><span class="p">;</span>
   <span class="n">stbi__gif_lzw</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>

   <span class="n">lzw_cs</span> <span class="o">=</span> <span class="n">stbi__get8</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">lzw_cs</span> <span class="o">&gt;</span> <span class="mi">12</span><span class="p">)</span> <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
   <span class="n">clear</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">lzw_cs</span><span class="p">;</span>
   <span class="n">first</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
   <span class="n">codesize</span> <span class="o">=</span> <span class="n">lzw_cs</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
   <span class="n">codemask</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">codesize</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
   <span class="n">bits</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
   <span class="n">valid_bits</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
   <span class="k">for</span> <span class="p">(</span><span class="n">init_code</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">init_code</span> <span class="o">&lt;</span> <span class="n">clear</span><span class="p">;</span> <span class="n">init_code</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">g</span><span class="o">-&gt;</span><span class="n">codes</span><span class="p">[</span><span class="n">init_code</span><span class="p">].</span><span class="n">prefix</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
      <span class="n">g</span><span class="o">-&gt;</span><span class="n">codes</span><span class="p">[</span><span class="n">init_code</span><span class="p">].</span><span class="n">first</span> <span class="o">=</span> <span class="p">(</span><span class="n">stbi_uc</span><span class="p">)</span> <span class="n">init_code</span><span class="p">;</span>
      <span class="n">g</span><span class="o">-&gt;</span><span class="n">codes</span><span class="p">[</span><span class="n">init_code</span><span class="p">].</span><span class="n">suffix</span> <span class="o">=</span> <span class="p">(</span><span class="n">stbi_uc</span><span class="p">)</span> <span class="n">init_code</span><span class="p">;</span>
   <span class="p">}</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-209'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-209'>#</a>
      </div>
      <p>support no starting clear code</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>   <span class="n">avail</span> <span class="o">=</span> <span class="n">clear</span><span class="o">+</span><span class="mi">2</span><span class="p">;</span>
   <span class="n">oldcode</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

   <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
   <span class="k">for</span><span class="p">(;;)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">valid_bits</span> <span class="o">&lt;</span> <span class="n">codesize</span><span class="p">)</span> <span class="p">{</span>
         <span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">len</span> <span class="o">=</span> <span class="n">stbi__get8</span><span class="p">(</span><span class="n">s</span><span class="p">);</span> <span class="c1">// start new block</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
               <span class="k">return</span> <span class="n">g</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">;</span>
         <span class="p">}</span>
         <span class="o">--</span><span class="n">len</span><span class="p">;</span>
         <span class="n">bits</span> <span class="o">|=</span> <span class="p">(</span><span class="n">stbi__int32</span><span class="p">)</span> <span class="n">stbi__get8</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">valid_bits</span><span class="p">;</span>
         <span class="n">valid_bits</span> <span class="o">+=</span> <span class="mi">8</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
         <span class="n">stbi__int32</span> <span class="n">code</span> <span class="o">=</span> <span class="n">bits</span> <span class="o">&amp;</span> <span class="n">codemask</span><span class="p">;</span>
         <span class="n">bits</span> <span class="o">&gt;&gt;=</span> <span class="n">codesize</span><span class="p">;</span>
         <span class="n">valid_bits</span> <span class="o">-=</span> <span class="n">codesize</span><span class="p">;</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-210'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-210'>#</a>
      </div>
      <p>@OPTIMIZE: is there some way we can accelerate the non-clear path?</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>         <span class="k">if</span> <span class="p">(</span><span class="n">code</span> <span class="o">==</span> <span class="n">clear</span><span class="p">)</span> <span class="p">{</span>  <span class="c1">// clear code</span>
            <span class="n">codesize</span> <span class="o">=</span> <span class="n">lzw_cs</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
            <span class="n">codemask</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">codesize</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
            <span class="n">avail</span> <span class="o">=</span> <span class="n">clear</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
            <span class="n">oldcode</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
            <span class="n">first</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
         <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">code</span> <span class="o">==</span> <span class="n">clear</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// end of stream code</span>
            <span class="n">stbi__skip</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
            <span class="k">while</span> <span class="p">((</span><span class="n">len</span> <span class="o">=</span> <span class="n">stbi__get8</span><span class="p">(</span><span class="n">s</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
               <span class="n">stbi__skip</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">len</span><span class="p">);</span>
            <span class="k">return</span> <span class="n">g</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">;</span>
         <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">code</span> <span class="o">&lt;=</span> <span class="n">avail</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">first</span><span class="p">)</span> <span class="k">return</span> <span class="n">stbi__errpuc</span><span class="p">(</span><span class="s">&quot;no clear code&quot;</span><span class="p">,</span> <span class="s">&quot;Corrupt GIF&quot;</span><span class="p">);</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">oldcode</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
               <span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">g</span><span class="o">-&gt;</span><span class="n">codes</span><span class="p">[</span><span class="n">avail</span><span class="o">++</span><span class="p">];</span>
               <span class="k">if</span> <span class="p">(</span><span class="n">avail</span> <span class="o">&gt;</span> <span class="mi">4096</span><span class="p">)</span>        <span class="k">return</span> <span class="n">stbi__errpuc</span><span class="p">(</span><span class="s">&quot;too many codes&quot;</span><span class="p">,</span> <span class="s">&quot;Corrupt GIF&quot;</span><span class="p">);</span>
               <span class="n">p</span><span class="o">-&gt;</span><span class="n">prefix</span> <span class="o">=</span> <span class="p">(</span><span class="n">stbi__int16</span><span class="p">)</span> <span class="n">oldcode</span><span class="p">;</span>
               <span class="n">p</span><span class="o">-&gt;</span><span class="n">first</span> <span class="o">=</span> <span class="n">g</span><span class="o">-&gt;</span><span class="n">codes</span><span class="p">[</span><span class="n">oldcode</span><span class="p">].</span><span class="n">first</span><span class="p">;</span>
               <span class="n">p</span><span class="o">-&gt;</span><span class="n">suffix</span> <span class="o">=</span> <span class="p">(</span><span class="n">code</span> <span class="o">==</span> <span class="n">avail</span><span class="p">)</span> <span class="o">?</span> <span class="n">p</span><span class="o">-&gt;</span><span class="nl">first</span> <span class="p">:</span> <span class="n">g</span><span class="o">-&gt;</span><span class="n">codes</span><span class="p">[</span><span class="n">code</span><span class="p">].</span><span class="n">first</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">code</span> <span class="o">==</span> <span class="n">avail</span><span class="p">)</span>
               <span class="k">return</span> <span class="n">stbi__errpuc</span><span class="p">(</span><span class="s">&quot;illegal code in raster&quot;</span><span class="p">,</span> <span class="s">&quot;Corrupt GIF&quot;</span><span class="p">);</span>

            <span class="n">stbi__out_gif_code</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="p">(</span><span class="n">stbi__uint16</span><span class="p">)</span> <span class="n">code</span><span class="p">);</span>

            <span class="k">if</span> <span class="p">((</span><span class="n">avail</span> <span class="o">&amp;</span> <span class="n">codemask</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">avail</span> <span class="o">&lt;=</span> <span class="mh">0x0FFF</span><span class="p">)</span> <span class="p">{</span>
               <span class="n">codesize</span><span class="o">++</span><span class="p">;</span>
               <span class="n">codemask</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">codesize</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="n">oldcode</span> <span class="o">=</span> <span class="n">code</span><span class="p">;</span>
         <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span> <span class="n">stbi__errpuc</span><span class="p">(</span><span class="s">&quot;illegal code in raster&quot;</span><span class="p">,</span> <span class="s">&quot;Corrupt GIF&quot;</span><span class="p">);</span>
         <span class="p">}</span>
      <span class="p">}</span>
   <span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">stbi__fill_gif_background</span><span class="p">(</span><span class="n">stbi__gif</span> <span class="o">*</span><span class="n">g</span><span class="p">,</span> <span class="kt">int</span> <span class="n">x0</span><span class="p">,</span> <span class="kt">int</span> <span class="n">y0</span><span class="p">,</span> <span class="kt">int</span> <span class="n">x1</span><span class="p">,</span> <span class="kt">int</span> <span class="n">y1</span><span class="p">)</span>
<span class="p">{</span>
   <span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">;</span>
   <span class="n">stbi_uc</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="n">g</span><span class="o">-&gt;</span><span class="n">pal</span><span class="p">[</span><span class="n">g</span><span class="o">-&gt;</span><span class="n">bgindex</span><span class="p">];</span>
   <span class="k">for</span> <span class="p">(</span><span class="n">y</span> <span class="o">=</span> <span class="n">y0</span><span class="p">;</span> <span class="n">y</span> <span class="o">&lt;</span> <span class="n">y1</span><span class="p">;</span> <span class="n">y</span> <span class="o">+=</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">g</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">for</span> <span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="n">x0</span><span class="p">;</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">x1</span><span class="p">;</span> <span class="n">x</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
         <span class="n">stbi_uc</span> <span class="o">*</span><span class="n">p</span>  <span class="o">=</span> <span class="o">&amp;</span><span class="n">g</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">[</span><span class="n">y</span> <span class="o">+</span> <span class="n">x</span><span class="p">];</span>
         <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
         <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
         <span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
         <span class="n">p</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="p">}</span>
   <span class="p">}</span>
<span class="p">}</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-211'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-211'>#</a>
      </div>
      <p>this function is designed to support animated gifs, although stb_image doesn't support it</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">static</span> <span class="n">stbi_uc</span> <span class="o">*</span><span class="nf">stbi__gif_load_next</span><span class="p">(</span><span class="n">stbi__context</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="n">stbi__gif</span> <span class="o">*</span><span class="n">g</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">comp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">req_comp</span><span class="p">)</span>
<span class="p">{</span>
   <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
   <span class="n">stbi_uc</span> <span class="o">*</span><span class="n">prev_out</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

   <span class="k">if</span> <span class="p">(</span><span class="n">g</span><span class="o">-&gt;</span><span class="n">out</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">stbi__gif_header</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">comp</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span>
      <span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="c1">// stbi__g_failure_reason set by stbi__gif_header</span>

   <span class="n">prev_out</span> <span class="o">=</span> <span class="n">g</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">;</span>
   <span class="n">g</span><span class="o">-&gt;</span><span class="n">out</span> <span class="o">=</span> <span class="p">(</span><span class="n">stbi_uc</span> <span class="o">*</span><span class="p">)</span> <span class="n">stbi__malloc</span><span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">g</span><span class="o">-&gt;</span><span class="n">w</span> <span class="o">*</span> <span class="n">g</span><span class="o">-&gt;</span><span class="n">h</span><span class="p">);</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">g</span><span class="o">-&gt;</span><span class="n">out</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="n">stbi__errpuc</span><span class="p">(</span><span class="s">&quot;outofmem&quot;</span><span class="p">,</span> <span class="s">&quot;Out of memory&quot;</span><span class="p">);</span>

   <span class="k">switch</span> <span class="p">((</span><span class="n">g</span><span class="o">-&gt;</span><span class="n">eflags</span> <span class="o">&amp;</span> <span class="mh">0x1C</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">case</span> <span class="mi">0</span><span class="o">:</span> <span class="c1">// unspecified (also always used on 1st frame)</span>
         <span class="n">stbi__fill_gif_background</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">g</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">,</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">g</span><span class="o">-&gt;</span><span class="n">w</span> <span class="o">*</span> <span class="n">g</span><span class="o">-&gt;</span><span class="n">h</span><span class="p">);</span>
         <span class="k">break</span><span class="p">;</span>
      <span class="k">case</span> <span class="mi">1</span><span class="o">:</span> <span class="c1">// do not dispose</span>
         <span class="k">if</span> <span class="p">(</span><span class="n">prev_out</span><span class="p">)</span> <span class="n">memcpy</span><span class="p">(</span><span class="n">g</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">,</span> <span class="n">prev_out</span><span class="p">,</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">g</span><span class="o">-&gt;</span><span class="n">w</span> <span class="o">*</span> <span class="n">g</span><span class="o">-&gt;</span><span class="n">h</span><span class="p">);</span>
         <span class="n">g</span><span class="o">-&gt;</span><span class="n">old_out</span> <span class="o">=</span> <span class="n">prev_out</span><span class="p">;</span>
         <span class="k">break</span><span class="p">;</span>
      <span class="k">case</span> <span class="mi">2</span><span class="o">:</span> <span class="c1">// dispose to background</span>
         <span class="k">if</span> <span class="p">(</span><span class="n">prev_out</span><span class="p">)</span> <span class="n">memcpy</span><span class="p">(</span><span class="n">g</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">,</span> <span class="n">prev_out</span><span class="p">,</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">g</span><span class="o">-&gt;</span><span class="n">w</span> <span class="o">*</span> <span class="n">g</span><span class="o">-&gt;</span><span class="n">h</span><span class="p">);</span>
         <span class="n">stbi__fill_gif_background</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">g</span><span class="o">-&gt;</span><span class="n">start_x</span><span class="p">,</span> <span class="n">g</span><span class="o">-&gt;</span><span class="n">start_y</span><span class="p">,</span> <span class="n">g</span><span class="o">-&gt;</span><span class="n">max_x</span><span class="p">,</span> <span class="n">g</span><span class="o">-&gt;</span><span class="n">max_y</span><span class="p">);</span>
         <span class="k">break</span><span class="p">;</span>
      <span class="k">case</span> <span class="mi">3</span><span class="o">:</span> <span class="c1">// dispose to previous</span>
         <span class="k">if</span> <span class="p">(</span><span class="n">g</span><span class="o">-&gt;</span><span class="n">old_out</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">g</span><span class="o">-&gt;</span><span class="n">start_y</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">g</span><span class="o">-&gt;</span><span class="n">max_y</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">g</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">)</span>
               <span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">g</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="n">g</span><span class="o">-&gt;</span><span class="n">start_x</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">g</span><span class="o">-&gt;</span><span class="n">old_out</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="n">g</span><span class="o">-&gt;</span><span class="n">start_x</span><span class="p">],</span> <span class="n">g</span><span class="o">-&gt;</span><span class="n">max_x</span> <span class="o">-</span> <span class="n">g</span><span class="o">-&gt;</span><span class="n">start_x</span><span class="p">);</span>
         <span class="p">}</span>
         <span class="k">break</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
      <span class="k">switch</span> <span class="p">(</span><span class="n">stbi__get8</span><span class="p">(</span><span class="n">s</span><span class="p">))</span> <span class="p">{</span>
         <span class="k">case</span> <span class="mh">0x2C</span><span class="o">:</span> <span class="cm">/* Image Descriptor */</span>
         <span class="p">{</span>
            <span class="kt">int</span> <span class="n">prev_trans</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
            <span class="n">stbi__int32</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">;</span>
            <span class="n">stbi_uc</span> <span class="o">*</span><span class="n">o</span><span class="p">;</span>

            <span class="n">x</span> <span class="o">=</span> <span class="n">stbi__get16le</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">stbi__get16le</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
            <span class="n">w</span> <span class="o">=</span> <span class="n">stbi__get16le</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
            <span class="n">h</span> <span class="o">=</span> <span class="n">stbi__get16le</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(((</span><span class="n">x</span> <span class="o">+</span> <span class="n">w</span><span class="p">)</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">g</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">))</span> <span class="o">||</span> <span class="p">((</span><span class="n">y</span> <span class="o">+</span> <span class="n">h</span><span class="p">)</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">g</span><span class="o">-&gt;</span><span class="n">h</span><span class="p">)))</span>
               <span class="k">return</span> <span class="n">stbi__errpuc</span><span class="p">(</span><span class="s">&quot;bad Image Descriptor&quot;</span><span class="p">,</span> <span class="s">&quot;Corrupt GIF&quot;</span><span class="p">);</span>

            <span class="n">g</span><span class="o">-&gt;</span><span class="n">line_size</span> <span class="o">=</span> <span class="n">g</span><span class="o">-&gt;</span><span class="n">w</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span>
            <span class="n">g</span><span class="o">-&gt;</span><span class="n">start_x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span>
            <span class="n">g</span><span class="o">-&gt;</span><span class="n">start_y</span> <span class="o">=</span> <span class="n">y</span> <span class="o">*</span> <span class="n">g</span><span class="o">-&gt;</span><span class="n">line_size</span><span class="p">;</span>
            <span class="n">g</span><span class="o">-&gt;</span><span class="n">max_x</span>   <span class="o">=</span> <span class="n">g</span><span class="o">-&gt;</span><span class="n">start_x</span> <span class="o">+</span> <span class="n">w</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span>
            <span class="n">g</span><span class="o">-&gt;</span><span class="n">max_y</span>   <span class="o">=</span> <span class="n">g</span><span class="o">-&gt;</span><span class="n">start_y</span> <span class="o">+</span> <span class="n">h</span> <span class="o">*</span> <span class="n">g</span><span class="o">-&gt;</span><span class="n">line_size</span><span class="p">;</span>
            <span class="n">g</span><span class="o">-&gt;</span><span class="n">cur_x</span>   <span class="o">=</span> <span class="n">g</span><span class="o">-&gt;</span><span class="n">start_x</span><span class="p">;</span>
            <span class="n">g</span><span class="o">-&gt;</span><span class="n">cur_y</span>   <span class="o">=</span> <span class="n">g</span><span class="o">-&gt;</span><span class="n">start_y</span><span class="p">;</span>

            <span class="n">g</span><span class="o">-&gt;</span><span class="n">lflags</span> <span class="o">=</span> <span class="n">stbi__get8</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">g</span><span class="o">-&gt;</span><span class="n">lflags</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">)</span> <span class="p">{</span>
               <span class="n">g</span><span class="o">-&gt;</span><span class="n">step</span> <span class="o">=</span> <span class="mi">8</span> <span class="o">*</span> <span class="n">g</span><span class="o">-&gt;</span><span class="n">line_size</span><span class="p">;</span> <span class="c1">// first interlaced spacing</span>
               <span class="n">g</span><span class="o">-&gt;</span><span class="n">parse</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
               <span class="n">g</span><span class="o">-&gt;</span><span class="n">step</span> <span class="o">=</span> <span class="n">g</span><span class="o">-&gt;</span><span class="n">line_size</span><span class="p">;</span>
               <span class="n">g</span><span class="o">-&gt;</span><span class="n">parse</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">g</span><span class="o">-&gt;</span><span class="n">lflags</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="p">{</span>
               <span class="n">stbi__gif_parse_colortable</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">g</span><span class="o">-&gt;</span><span class="n">lpal</span><span class="p">,</span> <span class="mi">2</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">g</span><span class="o">-&gt;</span><span class="n">lflags</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">),</span> <span class="n">g</span><span class="o">-&gt;</span><span class="n">eflags</span> <span class="o">&amp;</span> <span class="mh">0x01</span> <span class="o">?</span> <span class="n">g</span><span class="o">-&gt;</span><span class="nl">transparent</span> <span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
               <span class="n">g</span><span class="o">-&gt;</span><span class="n">color_table</span> <span class="o">=</span> <span class="p">(</span><span class="n">stbi_uc</span> <span class="o">*</span><span class="p">)</span> <span class="n">g</span><span class="o">-&gt;</span><span class="n">lpal</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">g</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="p">{</span>
               <span class="k">if</span> <span class="p">(</span><span class="n">g</span><span class="o">-&gt;</span><span class="n">transparent</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">g</span><span class="o">-&gt;</span><span class="n">eflags</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">))</span> <span class="p">{</span>
                  <span class="n">prev_trans</span> <span class="o">=</span> <span class="n">g</span><span class="o">-&gt;</span><span class="n">pal</span><span class="p">[</span><span class="n">g</span><span class="o">-&gt;</span><span class="n">transparent</span><span class="p">][</span><span class="mi">3</span><span class="p">];</span>
                  <span class="n">g</span><span class="o">-&gt;</span><span class="n">pal</span><span class="p">[</span><span class="n">g</span><span class="o">-&gt;</span><span class="n">transparent</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
               <span class="p">}</span>
               <span class="n">g</span><span class="o">-&gt;</span><span class="n">color_table</span> <span class="o">=</span> <span class="p">(</span><span class="n">stbi_uc</span> <span class="o">*</span><span class="p">)</span> <span class="n">g</span><span class="o">-&gt;</span><span class="n">pal</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">else</span>
               <span class="k">return</span> <span class="n">stbi__errpuc</span><span class="p">(</span><span class="s">&quot;missing color table&quot;</span><span class="p">,</span> <span class="s">&quot;Corrupt GIF&quot;</span><span class="p">);</span>

            <span class="n">o</span> <span class="o">=</span> <span class="n">stbi__process_gif_raster</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">g</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">o</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">prev_trans</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
               <span class="n">g</span><span class="o">-&gt;</span><span class="n">pal</span><span class="p">[</span><span class="n">g</span><span class="o">-&gt;</span><span class="n">transparent</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">stbi_uc</span><span class="p">)</span> <span class="n">prev_trans</span><span class="p">;</span>

            <span class="k">return</span> <span class="n">o</span><span class="p">;</span>
         <span class="p">}</span>

         <span class="k">case</span> <span class="mh">0x21</span><span class="o">:</span> <span class="c1">// Comment Extension.</span>
         <span class="p">{</span>
            <span class="kt">int</span> <span class="n">len</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">stbi__get8</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0xF9</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// Graphic Control Extension.</span>
               <span class="n">len</span> <span class="o">=</span> <span class="n">stbi__get8</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
               <span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
                  <span class="n">g</span><span class="o">-&gt;</span><span class="n">eflags</span> <span class="o">=</span> <span class="n">stbi__get8</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
                  <span class="n">g</span><span class="o">-&gt;</span><span class="n">delay</span> <span class="o">=</span> <span class="n">stbi__get16le</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
                  <span class="n">g</span><span class="o">-&gt;</span><span class="n">transparent</span> <span class="o">=</span> <span class="n">stbi__get8</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
               <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                  <span class="n">stbi__skip</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
                  <span class="k">break</span><span class="p">;</span>
               <span class="p">}</span>
            <span class="p">}</span>
            <span class="k">while</span> <span class="p">((</span><span class="n">len</span> <span class="o">=</span> <span class="n">stbi__get8</span><span class="p">(</span><span class="n">s</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
               <span class="n">stbi__skip</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>
         <span class="p">}</span>

         <span class="k">case</span> <span class="mh">0x3B</span><span class="o">:</span> <span class="c1">// gif stream termination code</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">stbi_uc</span> <span class="o">*</span><span class="p">)</span> <span class="n">s</span><span class="p">;</span> <span class="c1">// using &#39;1&#39; causes warning on some compilers</span>

         <span class="k">default</span><span class="o">:</span>
            <span class="k">return</span> <span class="n">stbi__errpuc</span><span class="p">(</span><span class="s">&quot;unknown code&quot;</span><span class="p">,</span> <span class="s">&quot;Corrupt GIF&quot;</span><span class="p">);</span>
      <span class="p">}</span>
   <span class="p">}</span>

   <span class="n">STBI_NOTUSED</span><span class="p">(</span><span class="n">req_comp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">stbi_uc</span> <span class="o">*</span><span class="nf">stbi__gif_load</span><span class="p">(</span><span class="n">stbi__context</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">y</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">comp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">req_comp</span><span class="p">)</span>
<span class="p">{</span>
   <span class="n">stbi_uc</span> <span class="o">*</span><span class="n">u</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
   <span class="n">stbi__gif</span><span class="o">*</span> <span class="n">g</span> <span class="o">=</span> <span class="p">(</span><span class="n">stbi__gif</span><span class="o">*</span><span class="p">)</span> <span class="n">stbi__malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">stbi__gif</span><span class="p">));</span>
   <span class="n">memset</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">g</span><span class="p">));</span>

   <span class="n">u</span> <span class="o">=</span> <span class="n">stbi__gif_load_next</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">comp</span><span class="p">,</span> <span class="n">req_comp</span><span class="p">);</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">u</span> <span class="o">==</span> <span class="p">(</span><span class="n">stbi_uc</span> <span class="o">*</span><span class="p">)</span> <span class="n">s</span><span class="p">)</span> <span class="n">u</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>  <span class="c1">// end of animated gif marker</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="p">{</span>
      <span class="o">*</span><span class="n">x</span> <span class="o">=</span> <span class="n">g</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">;</span>
      <span class="o">*</span><span class="n">y</span> <span class="o">=</span> <span class="n">g</span><span class="o">-&gt;</span><span class="n">h</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">req_comp</span> <span class="o">&amp;&amp;</span> <span class="n">req_comp</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">)</span>
         <span class="n">u</span> <span class="o">=</span> <span class="n">stbi__convert_format</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">req_comp</span><span class="p">,</span> <span class="n">g</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">,</span> <span class="n">g</span><span class="o">-&gt;</span><span class="n">h</span><span class="p">);</span>
   <span class="p">}</span>
   <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">g</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">)</span>
      <span class="n">STBI_FREE</span><span class="p">(</span><span class="n">g</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">);</span>
   <span class="n">STBI_FREE</span><span class="p">(</span><span class="n">g</span><span class="p">);</span>
   <span class="k">return</span> <span class="n">u</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">stbi__gif_info</span><span class="p">(</span><span class="n">stbi__context</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">y</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">comp</span><span class="p">)</span>
<span class="p">{</span>
   <span class="k">return</span> <span class="n">stbi__gif_info_raw</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">comp</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-212'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-212'>#</a>
      </div>
      <hr />
<p>Radiance RGBE HDR loader
originally by Nicolas Schulz</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="cp">#ifndef STBI_NO_HDR</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">stbi__hdr_test_core</span><span class="p">(</span><span class="n">stbi__context</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
   <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">signature</span> <span class="o">=</span> <span class="s">&quot;#?RADIANCE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
   <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
   <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">signature</span><span class="p">[</span><span class="n">i</span><span class="p">];</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">stbi__get8</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">!=</span> <span class="n">signature</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
         <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
   <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">stbi__hdr_test</span><span class="p">(</span><span class="n">stbi__context</span><span class="o">*</span> <span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
   <span class="kt">int</span> <span class="n">r</span> <span class="o">=</span> <span class="n">stbi__hdr_test_core</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
   <span class="n">stbi__rewind</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
   <span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define STBI__HDR_BUFLEN  1024</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">stbi__hdr_gettoken</span><span class="p">(</span><span class="n">stbi__context</span> <span class="o">*</span><span class="n">z</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">)</span>
<span class="p">{</span>
   <span class="kt">int</span> <span class="n">len</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
   <span class="kt">char</span> <span class="n">c</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>

   <span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="p">)</span> <span class="n">stbi__get8</span><span class="p">(</span><span class="n">z</span><span class="p">);</span>

   <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">stbi__at_eof</span><span class="p">(</span><span class="n">z</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">c</span> <span class="o">!=</span> <span class="sc">&#39;\n&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">buffer</span><span class="p">[</span><span class="n">len</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">==</span> <span class="n">STBI__HDR_BUFLEN</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-213'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-213'>#</a>
      </div>
      <p>flush to end of line</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>         <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">stbi__at_eof</span><span class="p">(</span><span class="n">z</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">stbi__get8</span><span class="p">(</span><span class="n">z</span><span class="p">)</span> <span class="o">!=</span> <span class="sc">&#39;\n&#39;</span><span class="p">)</span>
            <span class="p">;</span>
         <span class="k">break</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="p">)</span> <span class="n">stbi__get8</span><span class="p">(</span><span class="n">z</span><span class="p">);</span>
   <span class="p">}</span>

   <span class="n">buffer</span><span class="p">[</span><span class="n">len</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
   <span class="k">return</span> <span class="n">buffer</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">stbi__hdr_convert</span><span class="p">(</span><span class="kt">float</span> <span class="o">*</span><span class="n">output</span><span class="p">,</span> <span class="n">stbi_uc</span> <span class="o">*</span><span class="n">input</span><span class="p">,</span> <span class="kt">int</span> <span class="n">req_comp</span><span class="p">)</span>
<span class="p">{</span>
   <span class="k">if</span> <span class="p">(</span> <span class="n">input</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">{</span>
      <span class="kt">float</span> <span class="n">f1</span><span class="p">;</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-214'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-214'>#</a>
      </div>
      <p>Exponent</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>      <span class="n">f1</span> <span class="o">=</span> <span class="p">(</span><span class="kt">float</span><span class="p">)</span> <span class="n">ldexp</span><span class="p">(</span><span class="mf">1.0f</span><span class="p">,</span> <span class="n">input</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="mi">128</span> <span class="o">+</span> <span class="mi">8</span><span class="p">));</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">req_comp</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">)</span>
         <span class="n">output</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">input</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">input</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">input</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">*</span> <span class="n">f1</span> <span class="o">/</span> <span class="mi">3</span><span class="p">;</span>
      <span class="k">else</span> <span class="p">{</span>
         <span class="n">output</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">input</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">f1</span><span class="p">;</span>
         <span class="n">output</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">input</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">f1</span><span class="p">;</span>
         <span class="n">output</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">input</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">f1</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">req_comp</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="n">output</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">req_comp</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="n">output</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
   <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="k">switch</span> <span class="p">(</span><span class="n">req_comp</span><span class="p">)</span> <span class="p">{</span>
         <span class="k">case</span> <span class="mi">4</span><span class="o">:</span> <span class="n">output</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* fallthrough */</span>
         <span class="k">case</span> <span class="mi">3</span><span class="o">:</span> <span class="n">output</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">output</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">output</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                 <span class="k">break</span><span class="p">;</span>
         <span class="k">case</span> <span class="mi">2</span><span class="o">:</span> <span class="n">output</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* fallthrough */</span>
         <span class="k">case</span> <span class="mi">1</span><span class="o">:</span> <span class="n">output</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                 <span class="k">break</span><span class="p">;</span>
      <span class="p">}</span>
   <span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">float</span> <span class="o">*</span><span class="nf">stbi__hdr_load</span><span class="p">(</span><span class="n">stbi__context</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">y</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">comp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">req_comp</span><span class="p">)</span>
<span class="p">{</span>
   <span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="n">STBI__HDR_BUFLEN</span><span class="p">];</span>
   <span class="kt">char</span> <span class="o">*</span><span class="n">token</span><span class="p">;</span>
   <span class="kt">int</span> <span class="n">valid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
   <span class="kt">int</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">;</span>
   <span class="n">stbi_uc</span> <span class="o">*</span><span class="n">scanline</span><span class="p">;</span>
   <span class="kt">float</span> <span class="o">*</span><span class="n">hdr_data</span><span class="p">;</span>
   <span class="kt">int</span> <span class="n">len</span><span class="p">;</span>
   <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">count</span><span class="p">,</span> <span class="n">value</span><span class="p">;</span>
   <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">c1</span><span class="p">,</span><span class="n">c2</span><span class="p">,</span> <span class="n">z</span><span class="p">;</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-215'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-215'>#</a>
      </div>
      <p>Check identifier</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>   <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">stbi__hdr_gettoken</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">buffer</span><span class="p">),</span> <span class="s">&quot;#?RADIANCE&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">stbi__errpf</span><span class="p">(</span><span class="s">&quot;not HDR&quot;</span><span class="p">,</span> <span class="s">&quot;Corrupt HDR image&quot;</span><span class="p">);</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-216'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-216'>#</a>
      </div>
      <p>Parse header</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>   <span class="k">for</span><span class="p">(;;)</span> <span class="p">{</span>
      <span class="n">token</span> <span class="o">=</span> <span class="n">stbi__hdr_gettoken</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">buffer</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">token</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="s">&quot;FORMAT=32-bit_rle_rgbe&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="n">valid</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">valid</span><span class="p">)</span>    <span class="k">return</span> <span class="n">stbi__errpf</span><span class="p">(</span><span class="s">&quot;unsupported format&quot;</span><span class="p">,</span> <span class="s">&quot;Unsupported HDR format&quot;</span><span class="p">);</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-217'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-217'>#</a>
      </div>
      <p>Parse width and height
can't use sscanf() if we're not using stdio!</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>   <span class="n">token</span> <span class="o">=</span> <span class="n">stbi__hdr_gettoken</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">buffer</span><span class="p">);</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="s">&quot;-Y &quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>  <span class="k">return</span> <span class="n">stbi__errpf</span><span class="p">(</span><span class="s">&quot;unsupported data layout&quot;</span><span class="p">,</span> <span class="s">&quot;Unsupported HDR format&quot;</span><span class="p">);</span>
   <span class="n">token</span> <span class="o">+=</span> <span class="mi">3</span><span class="p">;</span>
   <span class="n">height</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">strtol</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">token</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
   <span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">token</span> <span class="o">==</span> <span class="sc">&#39; &#39;</span><span class="p">)</span> <span class="o">++</span><span class="n">token</span><span class="p">;</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="s">&quot;+X &quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>  <span class="k">return</span> <span class="n">stbi__errpf</span><span class="p">(</span><span class="s">&quot;unsupported data layout&quot;</span><span class="p">,</span> <span class="s">&quot;Unsupported HDR format&quot;</span><span class="p">);</span>
   <span class="n">token</span> <span class="o">+=</span> <span class="mi">3</span><span class="p">;</span>
   <span class="n">width</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">strtol</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>

   <span class="o">*</span><span class="n">x</span> <span class="o">=</span> <span class="n">width</span><span class="p">;</span>
   <span class="o">*</span><span class="n">y</span> <span class="o">=</span> <span class="n">height</span><span class="p">;</span>

   <span class="k">if</span> <span class="p">(</span><span class="n">comp</span><span class="p">)</span> <span class="o">*</span><span class="n">comp</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">req_comp</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="n">req_comp</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-218'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-218'>#</a>
      </div>
      <p>Read data</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>   <span class="n">hdr_data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">float</span> <span class="o">*</span><span class="p">)</span> <span class="n">stbi__malloc</span><span class="p">(</span><span class="n">height</span> <span class="o">*</span> <span class="n">width</span> <span class="o">*</span> <span class="n">req_comp</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">));</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-219'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-219'>#</a>
      </div>
      <p>Load image data
image data is stored as some number of sca</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>   <span class="k">if</span> <span class="p">(</span> <span class="n">width</span> <span class="o">&lt;</span> <span class="mi">8</span> <span class="o">||</span> <span class="n">width</span> <span class="o">&gt;=</span> <span class="mi">32768</span><span class="p">)</span> <span class="p">{</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-220'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-220'>#</a>
      </div>
      <p>Read flat data</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>      <span class="k">for</span> <span class="p">(</span><span class="n">j</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">height</span><span class="p">;</span> <span class="o">++</span><span class="n">j</span><span class="p">)</span> <span class="p">{</span>
         <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">width</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">stbi_uc</span> <span class="n">rgbe</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
           <span class="nl">main_decode_loop</span><span class="p">:</span>
            <span class="n">stbi__getn</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">rgbe</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
            <span class="n">stbi__hdr_convert</span><span class="p">(</span><span class="n">hdr_data</span> <span class="o">+</span> <span class="n">j</span> <span class="o">*</span> <span class="n">width</span> <span class="o">*</span> <span class="n">req_comp</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="n">req_comp</span><span class="p">,</span> <span class="n">rgbe</span><span class="p">,</span> <span class="n">req_comp</span><span class="p">);</span>
         <span class="p">}</span>
      <span class="p">}</span>
   <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-221'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-221'>#</a>
      </div>
      <p>Read RLE-encoded data</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>      <span class="n">scanline</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

      <span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">height</span><span class="p">;</span> <span class="o">++</span><span class="n">j</span><span class="p">)</span> <span class="p">{</span>
         <span class="n">c1</span> <span class="o">=</span> <span class="n">stbi__get8</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
         <span class="n">c2</span> <span class="o">=</span> <span class="n">stbi__get8</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
         <span class="n">len</span> <span class="o">=</span> <span class="n">stbi__get8</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
         <span class="k">if</span> <span class="p">(</span><span class="n">c1</span> <span class="o">!=</span> <span class="mi">2</span> <span class="o">||</span> <span class="n">c2</span> <span class="o">!=</span> <span class="mi">2</span> <span class="o">||</span> <span class="p">(</span><span class="n">len</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">))</span> <span class="p">{</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-222'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-222'>#</a>
      </div>
      <p>not run-length encoded, so we have to actually use THIS data as a decoded
pixel (note this can't be a valid pixel--one of RGB must be &gt;= 128)</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="n">stbi_uc</span> <span class="n">rgbe</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
            <span class="n">rgbe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">stbi_uc</span><span class="p">)</span> <span class="n">c1</span><span class="p">;</span>
            <span class="n">rgbe</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">stbi_uc</span><span class="p">)</span> <span class="n">c2</span><span class="p">;</span>
            <span class="n">rgbe</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">stbi_uc</span><span class="p">)</span> <span class="n">len</span><span class="p">;</span>
            <span class="n">rgbe</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">stbi_uc</span><span class="p">)</span> <span class="n">stbi__get8</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
            <span class="n">stbi__hdr_convert</span><span class="p">(</span><span class="n">hdr_data</span><span class="p">,</span> <span class="n">rgbe</span><span class="p">,</span> <span class="n">req_comp</span><span class="p">);</span>
            <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
            <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="n">STBI_FREE</span><span class="p">(</span><span class="n">scanline</span><span class="p">);</span>
            <span class="k">goto</span> <span class="n">main_decode_loop</span><span class="p">;</span> <span class="c1">// yes, this makes no sense</span>
         <span class="p">}</span>
         <span class="n">len</span> <span class="o">&lt;&lt;=</span> <span class="mi">8</span><span class="p">;</span>
         <span class="n">len</span> <span class="o">|=</span> <span class="n">stbi__get8</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
         <span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">!=</span> <span class="n">width</span><span class="p">)</span> <span class="p">{</span> <span class="n">STBI_FREE</span><span class="p">(</span><span class="n">hdr_data</span><span class="p">);</span> <span class="n">STBI_FREE</span><span class="p">(</span><span class="n">scanline</span><span class="p">);</span> <span class="k">return</span> <span class="n">stbi__errpf</span><span class="p">(</span><span class="s">&quot;invalid decoded scanline length&quot;</span><span class="p">,</span> <span class="s">&quot;corrupt HDR&quot;</span><span class="p">);</span> <span class="p">}</span>
         <span class="k">if</span> <span class="p">(</span><span class="n">scanline</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="n">scanline</span> <span class="o">=</span> <span class="p">(</span><span class="n">stbi_uc</span> <span class="o">*</span><span class="p">)</span> <span class="n">stbi__malloc</span><span class="p">(</span><span class="n">width</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>

         <span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="o">++</span><span class="n">k</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">width</span><span class="p">)</span> <span class="p">{</span>
               <span class="n">count</span> <span class="o">=</span> <span class="n">stbi__get8</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
               <span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">128</span><span class="p">)</span> <span class="p">{</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-223'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-223'>#</a>
      </div>
      <p>Run</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>                  <span class="n">value</span> <span class="o">=</span> <span class="n">stbi__get8</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
                  <span class="n">count</span> <span class="o">-=</span> <span class="mi">128</span><span class="p">;</span>
                  <span class="k">for</span> <span class="p">(</span><span class="n">z</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">z</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">;</span> <span class="o">++</span><span class="n">z</span><span class="p">)</span>
                     <span class="n">scanline</span><span class="p">[</span><span class="n">i</span><span class="o">++</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
               <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-224'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-224'>#</a>
      </div>
      <p>Dump</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>                  <span class="k">for</span> <span class="p">(</span><span class="n">z</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">z</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">;</span> <span class="o">++</span><span class="n">z</span><span class="p">)</span>
                     <span class="n">scanline</span><span class="p">[</span><span class="n">i</span><span class="o">++</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">stbi__get8</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
               <span class="p">}</span>
            <span class="p">}</span>
         <span class="p">}</span>
         <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">width</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
            <span class="n">stbi__hdr_convert</span><span class="p">(</span><span class="n">hdr_data</span><span class="o">+</span><span class="p">(</span><span class="n">j</span><span class="o">*</span><span class="n">width</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span><span class="o">*</span><span class="n">req_comp</span><span class="p">,</span> <span class="n">scanline</span> <span class="o">+</span> <span class="n">i</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span> <span class="n">req_comp</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="n">STBI_FREE</span><span class="p">(</span><span class="n">scanline</span><span class="p">);</span>
   <span class="p">}</span>

   <span class="k">return</span> <span class="n">hdr_data</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">stbi__hdr_info</span><span class="p">(</span><span class="n">stbi__context</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">y</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">comp</span><span class="p">)</span>
<span class="p">{</span>
   <span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="n">STBI__HDR_BUFLEN</span><span class="p">];</span>
   <span class="kt">char</span> <span class="o">*</span><span class="n">token</span><span class="p">;</span>
   <span class="kt">int</span> <span class="n">valid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

   <span class="k">if</span> <span class="p">(</span><span class="n">stbi__hdr_test</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
       <span class="n">stbi__rewind</span><span class="p">(</span> <span class="n">s</span> <span class="p">);</span>
       <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="k">for</span><span class="p">(;;)</span> <span class="p">{</span>
      <span class="n">token</span> <span class="o">=</span> <span class="n">stbi__hdr_gettoken</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">buffer</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">token</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="s">&quot;FORMAT=32-bit_rle_rgbe&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="n">valid</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">valid</span><span class="p">)</span> <span class="p">{</span>
       <span class="n">stbi__rewind</span><span class="p">(</span> <span class="n">s</span> <span class="p">);</span>
       <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
   <span class="p">}</span>
   <span class="n">token</span> <span class="o">=</span> <span class="n">stbi__hdr_gettoken</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">buffer</span><span class="p">);</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="s">&quot;-Y &quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span> <span class="p">{</span>
       <span class="n">stbi__rewind</span><span class="p">(</span> <span class="n">s</span> <span class="p">);</span>
       <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
   <span class="p">}</span>
   <span class="n">token</span> <span class="o">+=</span> <span class="mi">3</span><span class="p">;</span>
   <span class="o">*</span><span class="n">y</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">strtol</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">token</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
   <span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">token</span> <span class="o">==</span> <span class="sc">&#39; &#39;</span><span class="p">)</span> <span class="o">++</span><span class="n">token</span><span class="p">;</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="s">&quot;+X &quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span> <span class="p">{</span>
       <span class="n">stbi__rewind</span><span class="p">(</span> <span class="n">s</span> <span class="p">);</span>
       <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
   <span class="p">}</span>
   <span class="n">token</span> <span class="o">+=</span> <span class="mi">3</span><span class="p">;</span>
   <span class="o">*</span><span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">strtol</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
   <span class="o">*</span><span class="n">comp</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
   <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="c1">// STBI_NO_HDR</span>

<span class="cp">#ifndef STBI_NO_BMP</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">stbi__bmp_info</span><span class="p">(</span><span class="n">stbi__context</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">y</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">comp</span><span class="p">)</span>
<span class="p">{</span>
   <span class="kt">void</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
   <span class="n">stbi__bmp_data</span> <span class="n">info</span><span class="p">;</span>

   <span class="n">info</span><span class="p">.</span><span class="n">all_a</span> <span class="o">=</span> <span class="mi">255</span><span class="p">;</span>   
   <span class="n">p</span> <span class="o">=</span> <span class="n">stbi__bmp_parse_header</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">);</span>
   <span class="n">stbi__rewind</span><span class="p">(</span> <span class="n">s</span> <span class="p">);</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
      <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
   <span class="o">*</span><span class="n">x</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">img_x</span><span class="p">;</span>
   <span class="o">*</span><span class="n">y</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">img_y</span><span class="p">;</span>
   <span class="o">*</span><span class="n">comp</span> <span class="o">=</span> <span class="n">info</span><span class="p">.</span><span class="n">ma</span> <span class="o">?</span> <span class="mi">4</span> <span class="o">:</span> <span class="mi">3</span><span class="p">;</span>
   <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cp">#ifndef STBI_NO_PSD</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">stbi__psd_info</span><span class="p">(</span><span class="n">stbi__context</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">y</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">comp</span><span class="p">)</span>
<span class="p">{</span>
   <span class="kt">int</span> <span class="n">channelCount</span><span class="p">;</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">stbi__get32be</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x38425053</span><span class="p">)</span> <span class="p">{</span>
       <span class="n">stbi__rewind</span><span class="p">(</span> <span class="n">s</span> <span class="p">);</span>
       <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
   <span class="p">}</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">stbi__get16be</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
       <span class="n">stbi__rewind</span><span class="p">(</span> <span class="n">s</span> <span class="p">);</span>
       <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
   <span class="p">}</span>
   <span class="n">stbi__skip</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
   <span class="n">channelCount</span> <span class="o">=</span> <span class="n">stbi__get16be</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">channelCount</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">channelCount</span> <span class="o">&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="p">{</span>
       <span class="n">stbi__rewind</span><span class="p">(</span> <span class="n">s</span> <span class="p">);</span>
       <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
   <span class="p">}</span>
   <span class="o">*</span><span class="n">y</span> <span class="o">=</span> <span class="n">stbi__get32be</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
   <span class="o">*</span><span class="n">x</span> <span class="o">=</span> <span class="n">stbi__get32be</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">stbi__get16be</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
       <span class="n">stbi__rewind</span><span class="p">(</span> <span class="n">s</span> <span class="p">);</span>
       <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
   <span class="p">}</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">stbi__get16be</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
       <span class="n">stbi__rewind</span><span class="p">(</span> <span class="n">s</span> <span class="p">);</span>
       <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
   <span class="p">}</span>
   <span class="o">*</span><span class="n">comp</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
   <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cp">#ifndef STBI_NO_PIC</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">stbi__pic_info</span><span class="p">(</span><span class="n">stbi__context</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">y</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">comp</span><span class="p">)</span>
<span class="p">{</span>
   <span class="kt">int</span> <span class="n">act_comp</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">num_packets</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">chained</span><span class="p">;</span>
   <span class="n">stbi__pic_packet</span> <span class="n">packets</span><span class="p">[</span><span class="mi">10</span><span class="p">];</span>

   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">stbi__pic_is4</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="s">&quot;</span><span class="se">\x53\x80\xF6\x34</span><span class="s">&quot;</span><span class="p">))</span> <span class="p">{</span>
      <span class="n">stbi__rewind</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
      <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="n">stbi__skip</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="mi">88</span><span class="p">);</span>

   <span class="o">*</span><span class="n">x</span> <span class="o">=</span> <span class="n">stbi__get16be</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
   <span class="o">*</span><span class="n">y</span> <span class="o">=</span> <span class="n">stbi__get16be</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">stbi__at_eof</span><span class="p">(</span><span class="n">s</span><span class="p">))</span> <span class="p">{</span>
      <span class="n">stbi__rewind</span><span class="p">(</span> <span class="n">s</span><span class="p">);</span>
      <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
   <span class="p">}</span>
   <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="o">*</span><span class="n">x</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">28</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="o">*</span><span class="n">x</span><span class="p">)</span> <span class="o">&lt;</span> <span class="p">(</span><span class="o">*</span><span class="n">y</span><span class="p">))</span> <span class="p">{</span>
      <span class="n">stbi__rewind</span><span class="p">(</span> <span class="n">s</span> <span class="p">);</span>
      <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="n">stbi__skip</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>

   <span class="k">do</span> <span class="p">{</span>
      <span class="n">stbi__pic_packet</span> <span class="o">*</span><span class="n">packet</span><span class="p">;</span>

      <span class="k">if</span> <span class="p">(</span><span class="n">num_packets</span><span class="o">==</span><span class="k">sizeof</span><span class="p">(</span><span class="n">packets</span><span class="p">)</span><span class="o">/</span><span class="k">sizeof</span><span class="p">(</span><span class="n">packets</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
         <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

      <span class="n">packet</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">packets</span><span class="p">[</span><span class="n">num_packets</span><span class="o">++</span><span class="p">];</span>
      <span class="n">chained</span> <span class="o">=</span> <span class="n">stbi__get8</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
      <span class="n">packet</span><span class="o">-&gt;</span><span class="n">size</span>    <span class="o">=</span> <span class="n">stbi__get8</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
      <span class="n">packet</span><span class="o">-&gt;</span><span class="n">type</span>    <span class="o">=</span> <span class="n">stbi__get8</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
      <span class="n">packet</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">=</span> <span class="n">stbi__get8</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
      <span class="n">act_comp</span> <span class="o">|=</span> <span class="n">packet</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">;</span>

      <span class="k">if</span> <span class="p">(</span><span class="n">stbi__at_eof</span><span class="p">(</span><span class="n">s</span><span class="p">))</span> <span class="p">{</span>
          <span class="n">stbi__rewind</span><span class="p">(</span> <span class="n">s</span> <span class="p">);</span>
          <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">!=</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">stbi__rewind</span><span class="p">(</span> <span class="n">s</span> <span class="p">);</span>
          <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
      <span class="p">}</span>
   <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">chained</span><span class="p">);</span>

   <span class="o">*</span><span class="n">comp</span> <span class="o">=</span> <span class="p">(</span><span class="n">act_comp</span> <span class="o">&amp;</span> <span class="mh">0x10</span> <span class="o">?</span> <span class="mi">4</span> <span class="o">:</span> <span class="mi">3</span><span class="p">);</span>

   <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-225'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-225'>#</a>
      </div>
      <hr />
<p>Portable Gray Map and Portable Pixel Map loader
by Ken Miller</p>
<p>PGM: http://netpbm.sourceforge.net/doc/pgm.html
PPM: http://netpbm.sourceforge.net/doc/ppm.html</p>
<p>Known limitations:
   Does not support comments in the header section
   Does not support ASCII image data (formats P2 and P3)
   Does not support 16-bit-per-channel</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="cp">#ifndef STBI_NO_PNM</span>

<span class="k">static</span> <span class="kt">int</span>      <span class="nf">stbi__pnm_test</span><span class="p">(</span><span class="n">stbi__context</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
   <span class="kt">char</span> <span class="n">p</span><span class="p">,</span> <span class="n">t</span><span class="p">;</span>
   <span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="p">)</span> <span class="n">stbi__get8</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
   <span class="n">t</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="p">)</span> <span class="n">stbi__get8</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="o">!=</span> <span class="sc">&#39;P&#39;</span> <span class="o">||</span> <span class="p">(</span><span class="n">t</span> <span class="o">!=</span> <span class="sc">&#39;5&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">t</span> <span class="o">!=</span> <span class="sc">&#39;6&#39;</span><span class="p">))</span> <span class="p">{</span>
       <span class="n">stbi__rewind</span><span class="p">(</span> <span class="n">s</span> <span class="p">);</span>
       <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
   <span class="p">}</span>
   <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">stbi_uc</span> <span class="o">*</span><span class="nf">stbi__pnm_load</span><span class="p">(</span><span class="n">stbi__context</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">y</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">comp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">req_comp</span><span class="p">)</span>
<span class="p">{</span>
   <span class="n">stbi_uc</span> <span class="o">*</span><span class="n">out</span><span class="p">;</span>
   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">stbi__pnm_info</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">img_x</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">img_y</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">img_n</span><span class="p">))</span>
      <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
   <span class="o">*</span><span class="n">x</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">img_x</span><span class="p">;</span>
   <span class="o">*</span><span class="n">y</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">img_y</span><span class="p">;</span>
   <span class="o">*</span><span class="n">comp</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">img_n</span><span class="p">;</span>

   <span class="n">out</span> <span class="o">=</span> <span class="p">(</span><span class="n">stbi_uc</span> <span class="o">*</span><span class="p">)</span> <span class="n">stbi__malloc</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">img_n</span> <span class="o">*</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">img_x</span> <span class="o">*</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">img_y</span><span class="p">);</span>
   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">out</span><span class="p">)</span> <span class="k">return</span> <span class="n">stbi__errpuc</span><span class="p">(</span><span class="s">&quot;outofmem&quot;</span><span class="p">,</span> <span class="s">&quot;Out of memory&quot;</span><span class="p">);</span>
   <span class="n">stbi__getn</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">img_n</span> <span class="o">*</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">img_x</span> <span class="o">*</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">img_y</span><span class="p">);</span>

   <span class="k">if</span> <span class="p">(</span><span class="n">req_comp</span> <span class="o">&amp;&amp;</span> <span class="n">req_comp</span> <span class="o">!=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">img_n</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">out</span> <span class="o">=</span> <span class="n">stbi__convert_format</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">img_n</span><span class="p">,</span> <span class="n">req_comp</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">img_x</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">img_y</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">out</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="k">return</span> <span class="n">out</span><span class="p">;</span> <span class="c1">// stbi__convert_format frees input on failure</span>
   <span class="p">}</span>
   <span class="k">return</span> <span class="n">out</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>      <span class="nf">stbi__pnm_isspace</span><span class="p">(</span><span class="kt">char</span> <span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
   <span class="k">return</span> <span class="n">c</span> <span class="o">==</span> <span class="sc">&#39; &#39;</span> <span class="o">||</span> <span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;\t&#39;</span> <span class="o">||</span> <span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;\n&#39;</span> <span class="o">||</span> <span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;\v&#39;</span> <span class="o">||</span> <span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;\f&#39;</span> <span class="o">||</span> <span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;\r&#39;</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>     <span class="nf">stbi__pnm_skip_whitespace</span><span class="p">(</span><span class="n">stbi__context</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
   <span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
      <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">stbi__at_eof</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">stbi__pnm_isspace</span><span class="p">(</span><span class="o">*</span><span class="n">c</span><span class="p">))</span>
         <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="p">)</span> <span class="n">stbi__get8</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>

      <span class="k">if</span> <span class="p">(</span><span class="n">stbi__at_eof</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">||</span> <span class="o">*</span><span class="n">c</span> <span class="o">!=</span> <span class="sc">&#39;#&#39;</span><span class="p">)</span>
         <span class="k">break</span><span class="p">;</span>

      <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">stbi__at_eof</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">c</span> <span class="o">!=</span> <span class="sc">&#39;\n&#39;</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">c</span> <span class="o">!=</span> <span class="sc">&#39;\r&#39;</span> <span class="p">)</span>
         <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="p">)</span> <span class="n">stbi__get8</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
   <span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>      <span class="nf">stbi__pnm_isdigit</span><span class="p">(</span><span class="kt">char</span> <span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
   <span class="k">return</span> <span class="n">c</span> <span class="o">&gt;=</span> <span class="sc">&#39;0&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">c</span> <span class="o">&lt;=</span> <span class="sc">&#39;9&#39;</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>      <span class="nf">stbi__pnm_getinteger</span><span class="p">(</span><span class="n">stbi__context</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
   <span class="kt">int</span> <span class="n">value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

   <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">stbi__at_eof</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">stbi__pnm_isdigit</span><span class="p">(</span><span class="o">*</span><span class="n">c</span><span class="p">))</span> <span class="p">{</span>
      <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">*</span><span class="mi">10</span> <span class="o">+</span> <span class="p">(</span><span class="o">*</span><span class="n">c</span> <span class="o">-</span> <span class="sc">&#39;0&#39;</span><span class="p">);</span>
      <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="p">)</span> <span class="n">stbi__get8</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
   <span class="p">}</span>

   <span class="k">return</span> <span class="n">value</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>      <span class="nf">stbi__pnm_info</span><span class="p">(</span><span class="n">stbi__context</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">y</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">comp</span><span class="p">)</span>
<span class="p">{</span>
   <span class="kt">int</span> <span class="n">maxv</span><span class="p">;</span>
   <span class="kt">char</span> <span class="n">c</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">t</span><span class="p">;</span>

   <span class="n">stbi__rewind</span><span class="p">(</span> <span class="n">s</span> <span class="p">);</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-226'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-226'>#</a>
      </div>
      <p>Get identifier</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>   <span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="p">)</span> <span class="n">stbi__get8</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
   <span class="n">t</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="p">)</span> <span class="n">stbi__get8</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="o">!=</span> <span class="sc">&#39;P&#39;</span> <span class="o">||</span> <span class="p">(</span><span class="n">t</span> <span class="o">!=</span> <span class="sc">&#39;5&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">t</span> <span class="o">!=</span> <span class="sc">&#39;6&#39;</span><span class="p">))</span> <span class="p">{</span>
       <span class="n">stbi__rewind</span><span class="p">(</span> <span class="n">s</span> <span class="p">);</span>
       <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="o">*</span><span class="n">comp</span> <span class="o">=</span> <span class="p">(</span><span class="n">t</span> <span class="o">==</span> <span class="sc">&#39;6&#39;</span><span class="p">)</span> <span class="o">?</span> <span class="mi">3</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>  <span class="c1">// &#39;5&#39; is 1-component .pgm; &#39;6&#39; is 3-component .ppm</span>

   <span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="p">)</span> <span class="n">stbi__get8</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
   <span class="n">stbi__pnm_skip_whitespace</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="p">);</span>

   <span class="o">*</span><span class="n">x</span> <span class="o">=</span> <span class="n">stbi__pnm_getinteger</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="p">);</span> <span class="c1">// read width</span>
   <span class="n">stbi__pnm_skip_whitespace</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="p">);</span>

   <span class="o">*</span><span class="n">y</span> <span class="o">=</span> <span class="n">stbi__pnm_getinteger</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="p">);</span> <span class="c1">// read height</span>
   <span class="n">stbi__pnm_skip_whitespace</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="p">);</span>

   <span class="n">maxv</span> <span class="o">=</span> <span class="n">stbi__pnm_getinteger</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="p">);</span>  <span class="c1">// read max value</span>

   <span class="k">if</span> <span class="p">(</span><span class="n">maxv</span> <span class="o">&gt;</span> <span class="mi">255</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">stbi__err</span><span class="p">(</span><span class="s">&quot;max value &gt; 255&quot;</span><span class="p">,</span> <span class="s">&quot;PPM image not 8-bit&quot;</span><span class="p">);</span>
   <span class="k">else</span>
      <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">stbi__info_main</span><span class="p">(</span><span class="n">stbi__context</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">y</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">comp</span><span class="p">)</span>
<span class="p">{</span>
   <span class="cp">#ifndef STBI_NO_JPEG</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">stbi__jpeg_info</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">comp</span><span class="p">))</span> <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
   <span class="cp">#endif</span>

   <span class="cp">#ifndef STBI_NO_PNG</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">stbi__png_info</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">comp</span><span class="p">))</span>  <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
   <span class="cp">#endif</span>

   <span class="cp">#ifndef STBI_NO_GIF</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">stbi__gif_info</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">comp</span><span class="p">))</span>  <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
   <span class="cp">#endif</span>

   <span class="cp">#ifndef STBI_NO_BMP</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">stbi__bmp_info</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">comp</span><span class="p">))</span>  <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
   <span class="cp">#endif</span>

   <span class="cp">#ifndef STBI_NO_PSD</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">stbi__psd_info</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">comp</span><span class="p">))</span>  <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
   <span class="cp">#endif</span>

   <span class="cp">#ifndef STBI_NO_PIC</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">stbi__pic_info</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">comp</span><span class="p">))</span>  <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
   <span class="cp">#endif</span>

   <span class="cp">#ifndef STBI_NO_PNM</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">stbi__pnm_info</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">comp</span><span class="p">))</span>  <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
   <span class="cp">#endif</span>

   <span class="cp">#ifndef STBI_NO_HDR</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">stbi__hdr_info</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">comp</span><span class="p">))</span>  <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
   <span class="cp">#endif</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-227'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-227'>#</a>
      </div>
      <p>test tga last because it's a crappy test!</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>   <span class="cp">#ifndef STBI_NO_TGA</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">stbi__tga_info</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">comp</span><span class="p">))</span>
       <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
   <span class="cp">#endif</span>
   <span class="k">return</span> <span class="n">stbi__err</span><span class="p">(</span><span class="s">&quot;unknown image type&quot;</span><span class="p">,</span> <span class="s">&quot;Image not of any known type, or corrupt&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifndef STBI_NO_STDIO</span>
<span class="n">STBIDEF</span> <span class="kt">int</span> <span class="nf">stbi_info</span><span class="p">(</span><span class="kt">char</span> <span class="k">const</span> <span class="o">*</span><span class="n">filename</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">y</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">comp</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">FILE</span> <span class="o">*</span><span class="n">f</span> <span class="o">=</span> <span class="n">stbi__fopen</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">&quot;rb&quot;</span><span class="p">);</span>
    <span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">f</span><span class="p">)</span> <span class="k">return</span> <span class="n">stbi__err</span><span class="p">(</span><span class="s">&quot;can&#39;t fopen&quot;</span><span class="p">,</span> <span class="s">&quot;Unable to open file&quot;</span><span class="p">);</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">stbi_info_from_file</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">comp</span><span class="p">);</span>
    <span class="n">fclose</span><span class="p">(</span><span class="n">f</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">STBIDEF</span> <span class="kt">int</span> <span class="nf">stbi_info_from_file</span><span class="p">(</span><span class="kt">FILE</span> <span class="o">*</span><span class="n">f</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">y</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">comp</span><span class="p">)</span>
<span class="p">{</span>
   <span class="kt">int</span> <span class="n">r</span><span class="p">;</span>
   <span class="n">stbi__context</span> <span class="n">s</span><span class="p">;</span>
   <span class="kt">long</span> <span class="n">pos</span> <span class="o">=</span> <span class="n">ftell</span><span class="p">(</span><span class="n">f</span><span class="p">);</span>
   <span class="n">stbi__start_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="p">,</span> <span class="n">f</span><span class="p">);</span>
   <span class="n">r</span> <span class="o">=</span> <span class="n">stbi__info_main</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">comp</span><span class="p">);</span>
   <span class="n">fseek</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="n">pos</span><span class="p">,</span><span class="n">SEEK_SET</span><span class="p">);</span>
   <span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="c1">// !STBI_NO_STDIO</span>

<span class="n">STBIDEF</span> <span class="kt">int</span> <span class="nf">stbi_info_from_memory</span><span class="p">(</span><span class="n">stbi_uc</span> <span class="k">const</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">y</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">comp</span><span class="p">)</span>
<span class="p">{</span>
   <span class="n">stbi__context</span> <span class="n">s</span><span class="p">;</span>
   <span class="n">stbi__start_mem</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="p">,</span><span class="n">buffer</span><span class="p">,</span><span class="n">len</span><span class="p">);</span>
   <span class="k">return</span> <span class="n">stbi__info_main</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">comp</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">STBIDEF</span> <span class="kt">int</span> <span class="nf">stbi_info_from_callbacks</span><span class="p">(</span><span class="n">stbi_io_callbacks</span> <span class="k">const</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">user</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">y</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">comp</span><span class="p">)</span>
<span class="p">{</span>
   <span class="n">stbi__context</span> <span class="n">s</span><span class="p">;</span>
   <span class="n">stbi__start_callbacks</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="p">,</span> <span class="p">(</span><span class="n">stbi_io_callbacks</span> <span class="o">*</span><span class="p">)</span> <span class="n">c</span><span class="p">,</span> <span class="n">user</span><span class="p">);</span>
   <span class="k">return</span> <span class="n">stbi__info_main</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">comp</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#endif </span><span class="c1">// STB_IMAGE_IMPLEMENTATION</span>

<span class="o">/*</span>
   <span class="n">revision</span> <span class="nl">history</span><span class="p">:</span>
      <span class="mf">2.12</span>  <span class="p">(</span><span class="mi">2016</span><span class="o">-</span><span class="mo">04</span><span class="o">-</span><span class="mo">02</span><span class="p">)</span> <span class="n">fix</span> <span class="n">typo</span> <span class="n">in</span> <span class="mf">2.11</span> <span class="n">PSD</span> <span class="n">fix</span> <span class="n">that</span> <span class="n">caused</span> <span class="n">crashes</span>
      <span class="mf">2.11</span>  <span class="p">(</span><span class="mi">2016</span><span class="o">-</span><span class="mo">04</span><span class="o">-</span><span class="mo">02</span><span class="p">)</span> <span class="n">allocate</span> <span class="n">large</span> <span class="n">structures</span> <span class="n">on</span> <span class="n">the</span> <span class="n">stack</span>
                         <span class="n">remove</span> <span class="n">white</span> <span class="n">matting</span> <span class="k">for</span> <span class="n">transparent</span> <span class="n">PSD</span>
                         <span class="n">fix</span> <span class="n">reported</span> <span class="n">channel</span> <span class="n">count</span> <span class="k">for</span> <span class="n">PNG</span> <span class="o">&amp;</span> <span class="n">BMP</span>
                         <span class="n">re</span><span class="o">-</span><span class="n">enable</span> <span class="n">SSE2</span> <span class="n">in</span> <span class="n">non</span><span class="o">-</span><span class="n">gcc</span> <span class="mi">64</span><span class="o">-</span><span class="n">bit</span>
                         <span class="n">support</span> <span class="n">RGB</span><span class="o">-</span><span class="n">formatted</span> <span class="n">JPEG</span>
                         <span class="n">read</span> <span class="mi">16</span><span class="o">-</span><span class="n">bit</span> <span class="n">PNGs</span> <span class="p">(</span><span class="n">only</span> <span class="n">as</span> <span class="mi">8</span><span class="o">-</span><span class="n">bit</span><span class="p">)</span>
      <span class="mf">2.10</span>  <span class="p">(</span><span class="mi">2016</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">22</span><span class="p">)</span> <span class="n">avoid</span> <span class="n">warning</span> <span class="n">introduced</span> <span class="n">in</span> <span class="mf">2.09</span> <span class="n">by</span> <span class="n">STBI_REALLOC_SIZED</span>
      <span class="mf">2.09</span>  <span class="p">(</span><span class="mi">2016</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">16</span><span class="p">)</span> <span class="n">allow</span> <span class="n">comments</span> <span class="n">in</span> <span class="n">PNM</span> <span class="n">files</span>
                         <span class="mi">16</span><span class="o">-</span><span class="n">bit</span><span class="o">-</span><span class="n">per</span><span class="o">-</span><span class="n">pixel</span> <span class="n">TGA</span> <span class="p">(</span><span class="n">not</span> <span class="n">bit</span><span class="o">-</span><span class="n">per</span><span class="o">-</span><span class="n">component</span><span class="p">)</span>
                         <span class="n">info</span><span class="p">()</span> <span class="k">for</span> <span class="n">TGA</span> <span class="n">could</span> <span class="k">break</span> <span class="n">due</span> <span class="n">to</span> <span class="p">.</span><span class="n">hdr</span> <span class="n">handling</span>
                         <span class="n">info</span><span class="p">()</span> <span class="k">for</span> <span class="n">BMP</span> <span class="n">to</span> <span class="n">shares</span> <span class="n">code</span> <span class="n">instead</span> <span class="n">of</span> <span class="n">sloppy</span> <span class="n">parse</span>
                         <span class="n">can</span> <span class="n">use</span> <span class="n">STBI_REALLOC_SIZED</span> <span class="k">if</span> <span class="n">allocator</span> <span class="n">doesn</span><span class="err">&#39;</span><span class="n">t</span> <span class="n">support</span> <span class="n">realloc</span>
                         <span class="n">code</span> <span class="n">cleanup</span>
      <span class="mf">2.08</span>  <span class="p">(</span><span class="mi">2015</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">13</span><span class="p">)</span> <span class="n">fix</span> <span class="n">to</span> <span class="mf">2.07</span> <span class="n">cleanup</span><span class="p">,</span> <span class="n">reading</span> <span class="n">RGB</span> <span class="n">PSD</span> <span class="n">as</span> <span class="n">RGBA</span>
      <span class="mf">2.07</span>  <span class="p">(</span><span class="mi">2015</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">13</span><span class="p">)</span> <span class="n">fix</span> <span class="n">compiler</span> <span class="n">warnings</span>
                         <span class="n">partial</span> <span class="n">animated</span> <span class="n">GIF</span> <span class="n">support</span>
                         <span class="n">limited</span> <span class="mi">16</span><span class="o">-</span><span class="n">bpc</span> <span class="n">PSD</span> <span class="n">support</span>
                         <span class="cp">#ifdef unused functions</span>
                         <span class="n">bug</span> <span class="n">with</span> <span class="o">&lt;</span> <span class="mi">92</span> <span class="n">byte</span> <span class="n">PIC</span><span class="p">,</span><span class="n">PNM</span><span class="p">,</span><span class="n">HDR</span><span class="p">,</span><span class="n">TGA</span>
      <span class="mf">2.06</span>  <span class="p">(</span><span class="mi">2015</span><span class="o">-</span><span class="mo">04</span><span class="o">-</span><span class="mi">19</span><span class="p">)</span> <span class="n">fix</span> <span class="n">bug</span> <span class="n">where</span> <span class="n">PSD</span> <span class="n">returns</span> <span class="n">wrong</span> <span class="err">&#39;</span><span class="o">*</span><span class="n">comp</span><span class="err">&#39;</span> <span class="n">value</span>
      <span class="mf">2.05</span>  <span class="p">(</span><span class="mi">2015</span><span class="o">-</span><span class="mo">04</span><span class="o">-</span><span class="mi">19</span><span class="p">)</span> <span class="n">fix</span> <span class="n">bug</span> <span class="n">in</span> <span class="n">progressive</span> <span class="n">JPEG</span> <span class="n">handling</span><span class="p">,</span> <span class="n">fix</span> <span class="n">warning</span>
      <span class="mf">2.04</span>  <span class="p">(</span><span class="mi">2015</span><span class="o">-</span><span class="mo">04</span><span class="o">-</span><span class="mi">15</span><span class="p">)</span> <span class="n">try</span> <span class="n">to</span> <span class="n">re</span><span class="o">-</span><span class="n">enable</span> <span class="n">SIMD</span> <span class="n">on</span> <span class="n">MinGW</span> <span class="mi">64</span><span class="o">-</span><span class="n">bit</span>
      <span class="mf">2.03</span>  <span class="p">(</span><span class="mi">2015</span><span class="o">-</span><span class="mo">04</span><span class="o">-</span><span class="mi">12</span><span class="p">)</span> <span class="n">extra</span> <span class="n">corruption</span> <span class="n">checking</span> <span class="p">(</span><span class="n">mmozeiko</span><span class="p">)</span>
                         <span class="n">stbi_set_flip_vertically_on_load</span> <span class="p">(</span><span class="n">nguillemot</span><span class="p">)</span>
                         <span class="n">fix</span> <span class="n">NEON</span> <span class="n">support</span><span class="p">;</span> <span class="n">fix</span> <span class="n">mingw</span> <span class="n">support</span>
      <span class="mf">2.02</span>  <span class="p">(</span><span class="mi">2015</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">19</span><span class="p">)</span> <span class="n">fix</span> <span class="n">incorrect</span> <span class="n">assert</span><span class="p">,</span> <span class="n">fix</span> <span class="n">warning</span>
      <span class="mf">2.01</span>  <span class="p">(</span><span class="mi">2015</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">17</span><span class="p">)</span> <span class="n">fix</span> <span class="n">various</span> <span class="n">warnings</span><span class="p">;</span> <span class="n">suppress</span> <span class="n">SIMD</span> <span class="n">on</span> <span class="n">gcc</span> <span class="mi">32</span><span class="o">-</span><span class="n">bit</span> <span class="n">without</span> <span class="o">-</span><span class="n">msse2</span>
      <span class="mf">2.00</span><span class="n">b</span> <span class="p">(</span><span class="mi">2014</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">25</span><span class="p">)</span> <span class="n">fix</span> <span class="n">STBI_MALLOC</span> <span class="n">in</span> <span class="n">progressive</span> <span class="n">JPEG</span>
      <span class="mf">2.00</span>  <span class="p">(</span><span class="mi">2014</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">25</span><span class="p">)</span> <span class="n">optimize</span> <span class="n">JPG</span><span class="p">,</span> <span class="n">including</span> <span class="n">x86</span> <span class="n">SSE2</span> <span class="o">&amp;</span> <span class="n">NEON</span> <span class="n">SIMD</span> <span class="p">(</span><span class="n">ryg</span><span class="p">)</span>
                         <span class="n">progressive</span> <span class="n">JPEG</span> <span class="p">(</span><span class="n">stb</span><span class="p">)</span>
                         <span class="n">PGM</span><span class="o">/</span><span class="n">PPM</span> <span class="n">support</span> <span class="p">(</span><span class="n">Ken</span> <span class="n">Miller</span><span class="p">)</span>
                         <span class="n">STBI_MALLOC</span><span class="p">,</span><span class="n">STBI_REALLOC</span><span class="p">,</span><span class="n">STBI_FREE</span>
                         <span class="n">GIF</span> <span class="n">bugfix</span> <span class="o">--</span> <span class="n">seemingly</span> <span class="n">never</span> <span class="n">worked</span>
                         <span class="n">STBI_NO_</span><span class="o">*</span><span class="p">,</span> <span class="n">STBI_ONLY_</span><span class="o">*</span>
      <span class="mf">1.48</span>  <span class="p">(</span><span class="mi">2014</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">14</span><span class="p">)</span> <span class="n">fix</span> <span class="n">incorrectly</span><span class="o">-</span><span class="n">named</span> <span class="n">assert</span><span class="p">()</span>
      <span class="mf">1.47</span>  <span class="p">(</span><span class="mi">2014</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">14</span><span class="p">)</span> <span class="mi">1</span><span class="o">/</span><span class="mi">2</span><span class="o">/</span><span class="mi">4</span><span class="o">-</span><span class="n">bit</span> <span class="n">PNG</span> <span class="n">support</span><span class="p">,</span> <span class="n">both</span> <span class="n">direct</span> <span class="n">and</span> <span class="n">paletted</span> <span class="p">(</span><span class="n">Omar</span> <span class="n">Cornut</span> <span class="o">&amp;</span> <span class="n">stb</span><span class="p">)</span>
                         <span class="n">optimize</span> <span class="n">PNG</span> <span class="p">(</span><span class="n">ryg</span><span class="p">)</span>
                         <span class="n">fix</span> <span class="n">bug</span> <span class="n">in</span> <span class="n">interlaced</span> <span class="n">PNG</span> <span class="n">with</span> <span class="n">user</span><span class="o">-</span><span class="n">specified</span> <span class="n">channel</span> <span class="n">count</span> <span class="p">(</span><span class="n">stb</span><span class="p">)</span>
      <span class="mf">1.46</span>  <span class="p">(</span><span class="mi">2014</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">26</span><span class="p">)</span>
              <span class="n">fix</span> <span class="n">broken</span> <span class="n">tRNS</span> <span class="n">chunk</span> <span class="p">(</span><span class="n">colorkey</span><span class="o">-</span><span class="n">style</span> <span class="n">transparency</span><span class="p">)</span> <span class="n">in</span> <span class="n">non</span><span class="o">-</span><span class="n">paletted</span> <span class="n">PNG</span>
      <span class="mf">1.45</span>  <span class="p">(</span><span class="mi">2014</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">16</span><span class="p">)</span>
              <span class="n">fix</span> <span class="n">MSVC</span><span class="o">-</span><span class="n">ARM</span> <span class="n">internal</span> <span class="n">compiler</span> <span class="n">error</span> <span class="n">by</span> <span class="n">wrapping</span> <span class="n">malloc</span>
      <span class="mf">1.44</span>  <span class="p">(</span><span class="mi">2014</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mo">07</span><span class="p">)</span>
              <span class="n">various</span> <span class="n">warning</span> <span class="n">fixes</span> <span class="n">from</span> <span class="n">Ronny</span> <span class="n">Chevalier</span>
      <span class="mf">1.43</span>  <span class="p">(</span><span class="mi">2014</span><span class="o">-</span><span class="mo">07</span><span class="o">-</span><span class="mi">15</span><span class="p">)</span>
              <span class="n">fix</span> <span class="n">MSVC</span><span class="o">-</span><span class="n">only</span> <span class="n">compiler</span> <span class="n">problem</span> <span class="n">in</span> <span class="n">code</span> <span class="n">changed</span> <span class="n">in</span> <span class="mf">1.42</span>
      <span class="mf">1.42</span>  <span class="p">(</span><span class="mi">2014</span><span class="o">-</span><span class="mo">07</span><span class="o">-</span><span class="mi">09</span><span class="p">)</span>
              <span class="n">don</span><span class="err">&#39;</span><span class="n">t</span> <span class="n">define</span> <span class="n">_CRT_SECURE_NO_WARNINGS</span> <span class="p">(</span><span class="n">affects</span> <span class="n">user</span> <span class="n">code</span><span class="p">)</span>
              <span class="n">fixes</span> <span class="n">to</span> <span class="n">stbi__cleanup_jpeg</span> <span class="n">path</span>
              <span class="n">added</span> <span class="n">STBI_ASSERT</span> <span class="n">to</span> <span class="n">avoid</span> <span class="n">requiring</span> <span class="n">assert</span><span class="p">.</span><span class="n">h</span>
      <span class="mf">1.41</span>  <span class="p">(</span><span class="mi">2014</span><span class="o">-</span><span class="mo">06</span><span class="o">-</span><span class="mi">25</span><span class="p">)</span>
              <span class="n">fix</span> <span class="n">search</span><span class="o">&amp;</span><span class="n">replace</span> <span class="n">from</span> <span class="mf">1.36</span> <span class="n">that</span> <span class="n">messed</span> <span class="n">up</span> <span class="n">comments</span><span class="o">/</span><span class="n">error</span> <span class="n">messages</span>
      <span class="mf">1.40</span>  <span class="p">(</span><span class="mi">2014</span><span class="o">-</span><span class="mo">06</span><span class="o">-</span><span class="mi">22</span><span class="p">)</span>
              <span class="n">fix</span> <span class="n">gcc</span> <span class="k">struct</span><span class="o">-</span><span class="n">initialization</span> <span class="n">warning</span>
      <span class="mf">1.39</span>  <span class="p">(</span><span class="mi">2014</span><span class="o">-</span><span class="mo">06</span><span class="o">-</span><span class="mi">15</span><span class="p">)</span>
              <span class="n">fix</span> <span class="n">to</span> <span class="n">TGA</span> <span class="n">optimization</span> <span class="n">when</span> <span class="n">req_comp</span> <span class="o">!=</span> <span class="n">number</span> <span class="n">of</span> <span class="n">components</span> <span class="n">in</span> <span class="n">TGA</span><span class="p">;</span>
              <span class="n">fix</span> <span class="n">to</span> <span class="n">GIF</span> <span class="n">loading</span> <span class="n">because</span> <span class="n">BMP</span> <span class="n">wasn</span><span class="err">&#39;</span><span class="n">t</span> <span class="n">rewinding</span> <span class="p">(</span><span class="n">whoops</span><span class="p">,</span> <span class="n">no</span> <span class="n">GIFs</span> <span class="n">in</span> <span class="n">my</span> <span class="n">test</span> <span class="n">suite</span><span class="p">)</span>
              <span class="n">add</span> <span class="n">support</span> <span class="k">for</span> <span class="n">BMP</span> <span class="n">version</span> <span class="mi">5</span> <span class="p">(</span><span class="n">more</span> <span class="n">ignored</span> <span class="n">fields</span><span class="p">)</span>
      <span class="mf">1.38</span>  <span class="p">(</span><span class="mi">2014</span><span class="o">-</span><span class="mo">06</span><span class="o">-</span><span class="mo">06</span><span class="p">)</span>
              <span class="n">suppress</span> <span class="n">MSVC</span> <span class="n">warnings</span> <span class="n">on</span> <span class="n">integer</span> <span class="n">casts</span> <span class="n">truncating</span> <span class="n">values</span>
              <span class="n">fix</span> <span class="n">accidental</span> <span class="n">rename</span> <span class="n">of</span> <span class="err">&#39;</span><span class="n">skip</span><span class="err">&#39;</span> <span class="n">field</span> <span class="n">of</span> <span class="n">I</span><span class="o">/</span><span class="n">O</span>
      <span class="mf">1.37</span>  <span class="p">(</span><span class="mi">2014</span><span class="o">-</span><span class="mo">06</span><span class="o">-</span><span class="mo">04</span><span class="p">)</span>
              <span class="n">remove</span> <span class="n">duplicate</span> <span class="k">typedef</span>
      <span class="mf">1.36</span>  <span class="p">(</span><span class="mi">2014</span><span class="o">-</span><span class="mo">06</span><span class="o">-</span><span class="mo">03</span><span class="p">)</span>
              <span class="n">convert</span> <span class="n">to</span> <span class="n">header</span> <span class="n">file</span> <span class="n">single</span><span class="o">-</span><span class="n">file</span> <span class="n">library</span>
              <span class="k">if</span> <span class="n">de</span><span class="o">-</span><span class="n">iphone</span> <span class="n">isn</span><span class="err">&#39;</span><span class="n">t</span> <span class="n">set</span><span class="p">,</span> <span class="n">load</span> <span class="n">iphone</span> <span class="n">images</span> <span class="n">color</span><span class="o">-</span><span class="n">swapped</span> <span class="n">instead</span> <span class="n">of</span> <span class="n">returning</span> <span class="nb">NULL</span>
      <span class="mf">1.35</span>  <span class="p">(</span><span class="mi">2014</span><span class="o">-</span><span class="mo">05</span><span class="o">-</span><span class="mi">27</span><span class="p">)</span>
              <span class="n">various</span> <span class="n">warnings</span>
              <span class="n">fix</span> <span class="n">broken</span> <span class="n">STBI_SIMD</span> <span class="n">path</span>
              <span class="n">fix</span> <span class="n">bug</span> <span class="n">where</span> <span class="n">stbi_load_from_file</span> <span class="n">no</span> <span class="n">longer</span> <span class="n">left</span> <span class="n">file</span> <span class="n">pointer</span> <span class="n">in</span> <span class="n">correct</span> <span class="n">place</span>
              <span class="n">fix</span> <span class="n">broken</span> <span class="n">non</span><span class="o">-</span><span class="n">easy</span> <span class="n">path</span> <span class="k">for</span> <span class="mi">32</span><span class="o">-</span><span class="n">bit</span> <span class="n">BMP</span> <span class="p">(</span><span class="n">possibly</span> <span class="n">never</span> <span class="n">used</span><span class="p">)</span>
              <span class="n">TGA</span> <span class="n">optimization</span> <span class="n">by</span> <span class="n">Arseny</span> <span class="n">Kapoulkine</span>
      <span class="mf">1.34</span>  <span class="p">(</span><span class="n">unknown</span><span class="p">)</span>
              <span class="n">use</span> <span class="n">STBI_NOTUSED</span> <span class="n">in</span> <span class="n">stbi__resample_row_generic</span><span class="p">(),</span> <span class="n">fix</span> <span class="n">one</span> <span class="n">more</span> <span class="n">leak</span> <span class="n">in</span> <span class="n">tga</span> <span class="n">failure</span> <span class="k">case</span>
      <span class="mf">1.33</span>  <span class="p">(</span><span class="mi">2011</span><span class="o">-</span><span class="mo">07</span><span class="o">-</span><span class="mi">14</span><span class="p">)</span>
              <span class="n">make</span> <span class="n">stbi_is_hdr</span> <span class="n">work</span> <span class="n">in</span> <span class="n">STBI_NO_HDR</span> <span class="p">(</span><span class="n">as</span> <span class="n">specified</span><span class="p">),</span> <span class="n">minor</span> <span class="n">compiler</span><span class="o">-</span><span class="n">friendly</span> <span class="n">improvements</span>
      <span class="mf">1.32</span>  <span class="p">(</span><span class="mi">2011</span><span class="o">-</span><span class="mo">07</span><span class="o">-</span><span class="mi">13</span><span class="p">)</span>
              <span class="n">support</span> <span class="k">for</span> <span class="s">&quot;info&quot;</span> <span class="n">function</span> <span class="k">for</span> <span class="n">all</span> <span class="n">supported</span> <span class="n">filetypes</span> <span class="p">(</span><span class="n">SpartanJ</span><span class="p">)</span>
      <span class="mf">1.31</span>  <span class="p">(</span><span class="mi">2011</span><span class="o">-</span><span class="mo">06</span><span class="o">-</span><span class="mi">20</span><span class="p">)</span>
              <span class="n">a</span> <span class="n">few</span> <span class="n">more</span> <span class="n">leak</span> <span class="n">fixes</span><span class="p">,</span> <span class="n">bug</span> <span class="n">in</span> <span class="n">PNG</span> <span class="n">handling</span> <span class="p">(</span><span class="n">SpartanJ</span><span class="p">)</span>
      <span class="mf">1.30</span>  <span class="p">(</span><span class="mi">2011</span><span class="o">-</span><span class="mo">06</span><span class="o">-</span><span class="mi">11</span><span class="p">)</span>
              <span class="n">added</span> <span class="n">ability</span> <span class="n">to</span> <span class="n">load</span> <span class="n">files</span> <span class="n">via</span> <span class="n">callbacks</span> <span class="n">to</span> <span class="n">accomidate</span> <span class="n">custom</span> <span class="n">input</span> <span class="n">streams</span> <span class="p">(</span><span class="n">Ben</span> <span class="n">Wenger</span><span class="p">)</span>
              <span class="n">removed</span> <span class="n">deprecated</span> <span class="n">format</span><span class="o">-</span><span class="n">specific</span> <span class="n">test</span><span class="o">/</span><span class="n">load</span> <span class="n">functions</span>
              <span class="n">removed</span> <span class="n">support</span> <span class="k">for</span> <span class="n">installable</span> <span class="n">file</span> <span class="n">formats</span> <span class="p">(</span><span class="n">stbi_loader</span><span class="p">)</span> <span class="o">--</span> <span class="n">would</span> <span class="n">have</span> <span class="n">been</span> <span class="n">broken</span> <span class="k">for</span> <span class="n">IO</span> <span class="n">callbacks</span> <span class="n">anyway</span>
              <span class="n">error</span> <span class="n">cases</span> <span class="n">in</span> <span class="n">bmp</span> <span class="n">and</span> <span class="n">tga</span> <span class="n">give</span> <span class="n">messages</span> <span class="n">and</span> <span class="n">don</span><span class="err">&#39;</span><span class="n">t</span> <span class="n">leak</span> <span class="p">(</span><span class="n">Raymond</span> <span class="n">Barbiero</span><span class="p">,</span> <span class="n">grisha</span><span class="p">)</span>
              <span class="n">fix</span> <span class="n">inefficiency</span> <span class="n">in</span> <span class="n">decoding</span> <span class="mi">32</span><span class="o">-</span><span class="n">bit</span> <span class="n">BMP</span> <span class="p">(</span><span class="n">David</span> <span class="n">Woo</span><span class="p">)</span>
      <span class="mf">1.29</span>  <span class="p">(</span><span class="mi">2010</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">16</span><span class="p">)</span>
              <span class="n">various</span> <span class="n">warning</span> <span class="n">fixes</span> <span class="n">from</span> <span class="n">Aurelien</span> <span class="n">Pocheville</span>
      <span class="mf">1.28</span>  <span class="p">(</span><span class="mi">2010</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mo">01</span><span class="p">)</span>
              <span class="n">fix</span> <span class="n">bug</span> <span class="n">in</span> <span class="n">GIF</span> <span class="n">palette</span> <span class="n">transparency</span> <span class="p">(</span><span class="n">SpartanJ</span><span class="p">)</span>
      <span class="mf">1.27</span>  <span class="p">(</span><span class="mi">2010</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mo">01</span><span class="p">)</span>
              <span class="n">cast</span><span class="o">-</span><span class="n">to</span><span class="o">-</span><span class="n">stbi_uc</span> <span class="n">to</span> <span class="n">fix</span> <span class="n">warnings</span>
      <span class="mf">1.26</span>  <span class="p">(</span><span class="mi">2010</span><span class="o">-</span><span class="mo">07</span><span class="o">-</span><span class="mi">24</span><span class="p">)</span>
              <span class="n">fix</span> <span class="n">bug</span> <span class="n">in</span> <span class="n">file</span> <span class="n">buffering</span> <span class="k">for</span> <span class="n">PNG</span> <span class="n">reported</span> <span class="n">by</span> <span class="n">SpartanJ</span>
      <span class="mf">1.25</span>  <span class="p">(</span><span class="mi">2010</span><span class="o">-</span><span class="mo">07</span><span class="o">-</span><span class="mi">17</span><span class="p">)</span>
              <span class="n">refix</span> <span class="n">trans_data</span> <span class="n">warning</span> <span class="p">(</span><span class="n">Won</span> <span class="n">Chun</span><span class="p">)</span>
      <span class="mf">1.24</span>  <span class="p">(</span><span class="mi">2010</span><span class="o">-</span><span class="mo">07</span><span class="o">-</span><span class="mi">12</span><span class="p">)</span>
              <span class="n">perf</span> <span class="n">improvements</span> <span class="n">reading</span> <span class="n">from</span> <span class="n">files</span> <span class="n">on</span> <span class="n">platforms</span> <span class="n">with</span> <span class="n">lock</span><span class="o">-</span><span class="n">heavy</span> <span class="n">fgetc</span><span class="p">()</span>
              <span class="n">minor</span> <span class="n">perf</span> <span class="n">improvements</span> <span class="k">for</span> <span class="n">jpeg</span>
              <span class="n">deprecated</span> <span class="n">type</span><span class="o">-</span><span class="n">specific</span> <span class="n">functions</span> <span class="n">so</span> <span class="n">we</span><span class="err">&#39;</span><span class="n">ll</span> <span class="n">get</span> <span class="n">feedback</span> <span class="k">if</span> <span class="n">they</span><span class="err">&#39;</span><span class="n">re</span> <span class="n">needed</span>
              <span class="n">attempt</span> <span class="n">to</span> <span class="n">fix</span> <span class="n">trans_data</span> <span class="n">warning</span> <span class="p">(</span><span class="n">Won</span> <span class="n">Chun</span><span class="p">)</span>
      <span class="mf">1.23</span>    <span class="n">fixed</span> <span class="n">bug</span> <span class="n">in</span> <span class="n">iPhone</span> <span class="n">support</span>
      <span class="mf">1.22</span>  <span class="p">(</span><span class="mi">2010</span><span class="o">-</span><span class="mo">07</span><span class="o">-</span><span class="mi">10</span><span class="p">)</span>
              <span class="n">removed</span> <span class="n">image</span> <span class="o">*</span><span class="n">writing</span><span class="o">*</span> <span class="n">support</span>
              <span class="n">stbi_info</span> <span class="n">support</span> <span class="n">from</span> <span class="n">Jetro</span> <span class="n">Lauha</span>
              <span class="n">GIF</span> <span class="n">support</span> <span class="n">from</span> <span class="n">Jean</span><span class="o">-</span><span class="n">Marc</span> <span class="n">Lienher</span>
              <span class="n">iPhone</span> <span class="n">PNG</span><span class="o">-</span><span class="n">extensions</span> <span class="n">from</span> <span class="n">James</span> <span class="n">Brown</span>
              <span class="n">warning</span><span class="o">-</span><span class="n">fixes</span> <span class="n">from</span> <span class="n">Nicolas</span> <span class="n">Schulz</span> <span class="n">and</span> <span class="n">Janez</span> <span class="n">Zemva</span> <span class="p">(</span><span class="n">i</span><span class="p">.</span><span class="n">stbi__err</span><span class="p">.</span> <span class="n">Janez</span> <span class="p">(</span><span class="n">U</span><span class="o">+</span><span class="mo">017</span><span class="n">D</span><span class="p">)</span><span class="n">emva</span><span class="p">)</span>
      <span class="mf">1.21</span>    <span class="n">fix</span> <span class="n">use</span> <span class="n">of</span> <span class="err">&#39;</span><span class="n">stbi_uc</span><span class="err">&#39;</span> <span class="n">in</span> <span class="n">header</span> <span class="p">(</span><span class="n">reported</span> <span class="n">by</span> <span class="n">jon</span> <span class="n">blow</span><span class="p">)</span>
      <span class="mf">1.20</span>    <span class="n">added</span> <span class="n">support</span> <span class="k">for</span> <span class="n">Softimage</span> <span class="n">PIC</span><span class="p">,</span> <span class="n">by</span> <span class="n">Tom</span> <span class="n">Seddon</span>
      <span class="mf">1.19</span>    <span class="n">bug</span> <span class="n">in</span> <span class="n">interlaced</span> <span class="n">PNG</span> <span class="n">corruption</span> <span class="n">check</span> <span class="p">(</span><span class="n">found</span> <span class="n">by</span> <span class="n">ryg</span><span class="p">)</span>
      <span class="mf">1.18</span>  <span class="p">(</span><span class="mi">2008</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mo">02</span><span class="p">)</span>
              <span class="n">fix</span> <span class="n">a</span> <span class="n">threading</span> <span class="n">bug</span> <span class="p">(</span><span class="n">local</span> <span class="n">mutable</span> <span class="k">static</span><span class="p">)</span>
      <span class="mf">1.17</span>    <span class="n">support</span> <span class="n">interlaced</span> <span class="n">PNG</span>
      <span class="mf">1.16</span>    <span class="n">major</span> <span class="n">bugfix</span> <span class="o">-</span> <span class="n">stbi__convert_format</span> <span class="n">converted</span> <span class="n">one</span> <span class="n">too</span> <span class="n">many</span> <span class="n">pixels</span>
      <span class="mf">1.15</span>    <span class="n">initialize</span> <span class="n">some</span> <span class="n">fields</span> <span class="k">for</span> <span class="kr">thread</span> <span class="n">safety</span>
      <span class="mf">1.14</span>    <span class="n">fix</span> <span class="n">threadsafe</span> <span class="n">conversion</span> <span class="n">bug</span>
              <span class="n">header</span><span class="o">-</span><span class="n">file</span><span class="o">-</span><span class="n">only</span> <span class="n">version</span> <span class="p">(</span><span class="err">#</span><span class="n">define</span> <span class="n">STBI_HEADER_FILE_ONLY</span> <span class="n">before</span> <span class="n">including</span><span class="p">)</span>
      <span class="mf">1.13</span>    <span class="n">threadsafe</span>
      <span class="mf">1.12</span>    <span class="k">const</span> <span class="n">qualifiers</span> <span class="n">in</span> <span class="n">the</span> <span class="n">API</span>
      <span class="mf">1.11</span>    <span class="n">Support</span> <span class="n">installable</span> <span class="n">IDCT</span><span class="p">,</span> <span class="n">colorspace</span> <span class="n">conversion</span> <span class="n">routines</span>
      <span class="mf">1.10</span>    <span class="n">Fixes</span> <span class="k">for</span> <span class="mi">64</span><span class="o">-</span><span class="n">bit</span> <span class="p">(</span><span class="n">don</span><span class="err">&#39;</span><span class="n">t</span> <span class="n">use</span> <span class="s">&quot;unsigned long&quot;</span><span class="p">)</span>
              <span class="n">optimized</span> <span class="n">upsampling</span> <span class="n">by</span> <span class="n">Fabian</span> <span class="s">&quot;ryg&quot;</span> <span class="n">Giesen</span>
      <span class="mf">1.09</span>    <span class="n">Fix</span> <span class="n">format</span><span class="o">-</span><span class="n">conversion</span> <span class="k">for</span> <span class="n">PSD</span> <span class="n">code</span> <span class="p">(</span><span class="n">bad</span> <span class="n">global</span> <span class="n">variables</span><span class="o">!</span><span class="p">)</span>
      <span class="mf">1.08</span>    <span class="n">Thatcher</span> <span class="n">Ulrich</span><span class="err">&#39;</span><span class="n">s</span> <span class="n">PSD</span> <span class="n">code</span> <span class="n">integrated</span> <span class="n">by</span> <span class="n">Nicolas</span> <span class="n">Schulz</span>
      <span class="mf">1.07</span>    <span class="n">attempt</span> <span class="n">to</span> <span class="n">fix</span> <span class="n">C</span><span class="o">++</span> <span class="n">warning</span><span class="o">/</span><span class="n">errors</span> <span class="n">again</span>
      <span class="mf">1.06</span>    <span class="n">attempt</span> <span class="n">to</span> <span class="n">fix</span> <span class="n">C</span><span class="o">++</span> <span class="n">warning</span><span class="o">/</span><span class="n">errors</span> <span class="n">again</span>
      <span class="mf">1.05</span>    <span class="n">fix</span> <span class="n">TGA</span> <span class="n">loading</span> <span class="n">to</span> <span class="k">return</span> <span class="n">correct</span> <span class="o">*</span><span class="n">comp</span> <span class="n">and</span> <span class="n">use</span> <span class="n">good</span> <span class="n">luminance</span> <span class="n">calc</span>
      <span class="mf">1.04</span>    <span class="k">default</span> <span class="kt">float</span> <span class="n">alpha</span> <span class="n">is</span> <span class="mi">1</span><span class="p">,</span> <span class="n">not</span> <span class="mi">255</span><span class="p">;</span> <span class="n">use</span> <span class="err">&#39;</span><span class="kt">void</span> <span class="o">*</span><span class="err">&#39;</span> <span class="k">for</span> <span class="n">stbi_image_free</span>
      <span class="mf">1.03</span>    <span class="n">bugfixes</span> <span class="n">to</span> <span class="n">STBI_NO_STDIO</span><span class="p">,</span> <span class="n">STBI_NO_HDR</span>
      <span class="mf">1.02</span>    <span class="n">support</span> <span class="k">for</span> <span class="p">(</span><span class="n">subset</span> <span class="n">of</span><span class="p">)</span> <span class="n">HDR</span> <span class="n">files</span><span class="p">,</span> <span class="kt">float</span> <span class="n">interface</span> <span class="k">for</span> <span class="n">preferred</span> <span class="n">access</span> <span class="n">to</span> <span class="n">them</span>
      <span class="mf">1.01</span>    <span class="n">fix</span> <span class="nl">bug</span><span class="p">:</span> <span class="n">possible</span> <span class="n">bug</span> <span class="n">in</span> <span class="n">handling</span> <span class="n">right</span><span class="o">-</span><span class="n">side</span> <span class="n">up</span> <span class="n">bmps</span><span class="p">...</span> <span class="n">not</span> <span class="n">sure</span>
              <span class="n">fix</span> <span class="nl">bug</span><span class="p">:</span> <span class="n">the</span> <span class="n">stbi__bmp_load</span><span class="p">()</span> <span class="n">and</span> <span class="n">stbi__tga_load</span><span class="p">()</span> <span class="n">functions</span> <span class="n">didn</span><span class="err">&#39;</span><span class="n">t</span> <span class="n">work</span> <span class="n">at</span> <span class="n">all</span>
      <span class="mf">1.00</span>    <span class="n">interface</span> <span class="n">to</span> <span class="n">zlib</span> <span class="n">that</span> <span class="n">skips</span> <span class="n">zlib</span> <span class="n">header</span>
      <span class="mf">0.99</span>    <span class="n">correct</span> <span class="n">handling</span> <span class="n">of</span> <span class="n">alpha</span> <span class="n">in</span> <span class="n">palette</span>
      <span class="mf">0.98</span>    <span class="n">TGA</span> <span class="n">loader</span> <span class="n">by</span> <span class="n">lonesock</span><span class="p">;</span> <span class="n">dynamically</span> <span class="n">add</span> <span class="nf">loaders</span> <span class="p">(</span><span class="n">untested</span><span class="p">)</span>
      <span class="mf">0.97</span>    <span class="n">jpeg</span> <span class="n">errors</span> <span class="n">on</span> <span class="n">too</span> <span class="n">large</span> <span class="n">a</span> <span class="n">file</span><span class="p">;</span> <span class="n">also</span> <span class="n">catch</span> <span class="n">another</span> <span class="n">malloc</span> <span class="n">failure</span>
      <span class="mf">0.96</span>    <span class="n">fix</span> <span class="n">detection</span> <span class="n">of</span> <span class="n">invalid</span> <span class="n">v</span> <span class="n">value</span> <span class="o">-</span> <span class="n">particleman</span><span class="err">@</span><span class="n">mollyrocket</span> <span class="n">forum</span>
      <span class="mf">0.95</span>    <span class="n">during</span> <span class="n">header</span> <span class="n">scan</span><span class="p">,</span> <span class="n">seek</span> <span class="n">to</span> <span class="n">markers</span> <span class="n">in</span> <span class="k">case</span> <span class="n">of</span> <span class="n">padding</span>
      <span class="mf">0.94</span>    <span class="n">STBI_NO_STDIO</span> <span class="n">to</span> <span class="n">disable</span> <span class="n">stdio</span> <span class="n">usage</span><span class="p">;</span> <span class="n">rename</span> <span class="n">all</span> <span class="err">#</span><span class="n">defines</span> <span class="n">the</span> <span class="n">same</span>
      <span class="mf">0.93</span>    <span class="n">handle</span> <span class="n">jpegtran</span> <span class="n">output</span><span class="p">;</span> <span class="n">verbose</span> <span class="n">errors</span>
      <span class="mf">0.92</span>    <span class="n">read</span> <span class="mi">4</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">16</span><span class="p">,</span><span class="mi">24</span><span class="p">,</span><span class="mi">32</span><span class="o">-</span><span class="n">bit</span> <span class="n">BMP</span> <span class="n">files</span> <span class="n">of</span> <span class="n">several</span> <span class="n">formats</span>
      <span class="mf">0.91</span>    <span class="n">output</span> <span class="mi">24</span><span class="o">-</span><span class="n">bit</span> <span class="n">Windows</span> <span class="mf">3.0</span> <span class="n">BMP</span> <span class="n">files</span>
      <span class="mf">0.90</span>    <span class="n">fix</span> <span class="n">a</span> <span class="n">few</span> <span class="n">more</span> <span class="n">warnings</span><span class="p">;</span> <span class="n">bump</span> <span class="n">version</span> <span class="n">number</span> <span class="n">to</span> <span class="n">approach</span> <span class="mf">1.0</span>
      <span class="mf">0.61</span>    <span class="n">bugfixes</span> <span class="n">due</span> <span class="n">to</span> <span class="n">Marc</span> <span class="n">LeBlanc</span><span class="p">,</span> <span class="n">Christopher</span> <span class="n">Lloyd</span>
      <span class="mf">0.60</span>    <span class="n">fix</span> <span class="n">compiling</span> <span class="n">as</span> <span class="n">c</span><span class="o">++</span>
      <span class="mf">0.59</span>    <span class="n">fix</span> <span class="nl">warnings</span><span class="p">:</span> <span class="n">merge</span> <span class="n">Dave</span> <span class="n">Moore</span><span class="err">&#39;</span><span class="n">s</span> <span class="o">-</span><span class="n">Wall</span> <span class="n">fixes</span>
      <span class="mf">0.58</span>    <span class="n">fix</span> <span class="nl">bug</span><span class="p">:</span> <span class="n">zlib</span> <span class="n">uncompressed</span> <span class="n">mode</span> <span class="n">len</span><span class="o">/</span><span class="n">nlen</span> <span class="n">was</span> <span class="n">wrong</span> <span class="n">endian</span>
      <span class="mf">0.57</span>    <span class="n">fix</span> <span class="nl">bug</span><span class="p">:</span> <span class="n">jpg</span> <span class="n">last</span> <span class="n">huffman</span> <span class="n">symbol</span> <span class="n">before</span> <span class="n">marker</span> <span class="n">was</span> <span class="o">&gt;</span><span class="mi">9</span> <span class="n">bits</span> <span class="n">but</span> <span class="n">less</span> <span class="n">than</span> <span class="mi">16</span> <span class="n">available</span>
      <span class="mf">0.56</span>    <span class="n">fix</span> <span class="nl">bug</span><span class="p">:</span> <span class="n">zlib</span> <span class="n">uncompressed</span> <span class="n">mode</span> <span class="n">len</span> <span class="n">vs</span><span class="p">.</span> <span class="n">nlen</span>
      <span class="mf">0.55</span>    <span class="n">fix</span> <span class="nl">bug</span><span class="p">:</span> <span class="n">restart_interval</span> <span class="n">not</span> <span class="n">initialized</span> <span class="n">to</span> <span class="mi">0</span>
      <span class="mf">0.54</span>    <span class="n">allow</span> <span class="nb">NULL</span> <span class="k">for</span> <span class="err">&#39;</span><span class="kt">int</span> <span class="o">*</span><span class="n">comp</span><span class="err">&#39;</span>
      <span class="mf">0.53</span>    <span class="n">fix</span> <span class="n">bug</span> <span class="n">in</span> <span class="n">png</span> <span class="mi">3</span><span class="o">-&gt;</span><span class="mi">4</span><span class="p">;</span> <span class="n">speedup</span> <span class="n">png</span> <span class="n">decoding</span>
      <span class="mf">0.52</span>    <span class="n">png</span> <span class="n">handles</span> <span class="n">req_comp</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span> <span class="n">directly</span><span class="p">;</span> <span class="n">minor</span> <span class="n">cleanup</span><span class="p">;</span> <span class="n">jpeg</span> <span class="n">comments</span>
      <span class="mf">0.51</span>    <span class="n">obey</span> <span class="n">req_comp</span> <span class="n">requests</span><span class="p">,</span> <span class="mi">1</span><span class="o">-</span><span class="n">component</span> <span class="n">jpegs</span> <span class="k">return</span> <span class="n">as</span> <span class="mi">1</span><span class="o">-</span><span class="n">component</span><span class="p">,</span>
              <span class="n">on</span> <span class="err">&#39;</span><span class="n">test</span><span class="err">&#39;</span> <span class="n">only</span> <span class="n">check</span> <span class="n">type</span><span class="p">,</span> <span class="n">not</span> <span class="n">whether</span> <span class="n">we</span> <span class="n">support</span> <span class="n">this</span> <span class="n">variant</span>
      <span class="mf">0.50</span>  <span class="p">(</span><span class="mi">2006</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mi">19</span><span class="p">)</span>
              <span class="n">first</span> <span class="n">released</span> <span class="n">version</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-228'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-228'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
</div>
</body>
